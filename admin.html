<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-6">📊 Dashboard Tracking</h1>

  <!-- Mode exclusion -->
  <div class="bg-white rounded-lg shadow p-4 mb-6 flex items-center gap-3">
    <span class="text-sm text-gray-600">Mon trafic :</span>
    <button id="btn-exclude" class="px-3 py-1 rounded bg-red-600 text-white text-sm">Exclure</button>
    <button id="btn-include" class="px-3 py-1 rounded bg-gray-300 text-sm">Ré-inclure</button>
    <span id="dnt-state" class="ml-2 text-sm text-gray-500"></span>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <p class="text-gray-500 text-sm">Sessions totales</p>
      <p id="count-sessions" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <p class="text-gray-500 text-sm">Événements totaux</p>
      <p id="count-events" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <p class="text-gray-500 text-sm">Sessions aujourd’hui</p>
      <p id="count-sessions-today" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <p class="text-gray-500 text-sm">Événements aujourd’hui</p>
      <p id="count-events-today" class="text-2xl font-bold">0</p>
    </div>
  </div>

  <!-- Sessions récentes -->
  <div class="bg-white rounded-lg shadow mb-6 overflow-x-auto">
    <h2 class="text-lg font-semibold p-4 border-b">📌 Sessions récentes</h2>
    <table class="min-w-full text-sm text-left">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2">Session ID</th>
          <th class="px-4 py-2">Dernier event</th>
          <th class="px-4 py-2">Dernière activité</th>
        </tr>
      </thead>
      <tbody id="sessions-list"></tbody>
    </table>
  </div>

  <!-- Événements récents -->
  <div class="bg-white rounded-lg shadow mb-6 overflow-x-auto">
    <h2 class="text-lg font-semibold p-4 border-b">📜 Événements récents</h2>
    <table class="min-w-full text-sm text-left">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2">Event</th>
          <th class="px-4 py-2">Page</th>
          <th class="px-4 py-2">Date</th>
        </tr>
      </thead>
      <tbody id="events-list"></tbody>
    </table>
  </div>

  <!-- Debug JSON -->
  <div class="bg-white rounded-lg shadow mb-6 p-4">
    <button id="toggle-debug" class="px-3 py-1 rounded bg-gray-300 text-sm">Afficher Debug JSON</button>
    <pre id="debug-json" class="hidden text-xs mt-4 bg-gray-900 text-green-400 p-3 rounded overflow-auto"></pre>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ----- Mode exclusion -----
  function setDNT(v){ localStorage.setItem('pc_dnt', v ? '1' : '0'); updateDNTLabel(); }
  function updateDNTLabel(){
    const on = localStorage.getItem('pc_dnt') === '1';
    document.getElementById('dnt-state').textContent = on ? 'Exclusion ACTIVE' : 'Exclusion désactivée';
  }
  document.getElementById('btn-exclude').onclick = () => setDNT(1);
  document.getElementById('btn-include').onclick = () => setDNT(0);
  (function(){
    const p = new URLSearchParams(location.search);
    if (p.has('dnt')) localStorage.setItem('pc_dnt', p.get('dnt') === '1' ? '1' : '0');
    updateDNTLabel();
  })();

  // ----- Connexion Supabase -----
  const SUPABASE_URL = "https://swjnpvfkloubshksobau.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3am5wdmZrbG91YnNoa3NvYmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwOTUxMzEsImV4cCI6MjA2OTY3MTEzMX0.A6rnIJyfIIxDT0c2XW_zGeUXpdYCgBFd6MTzBGFZ-Cg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadDashboard() {
    console.log("🔍 Chargement du dashboard...");

    // Sessions
    let { data: sessions, error: errSessions } = await supabase
      .from('sessions')
      .select('*')
      .order('last_activity_at', { ascending: false })
      .limit(20);
    if (errSessions) console.error("Erreur sessions:", errSessions);

    // Events
    let { data: events, error: errEvents } = await supabase
      .from('events')
      .select('*')
      .order('occurred_at', { ascending: false })
      .limit(20);
    if (errEvents) console.error("Erreur events:", errEvents);

    // Compteurs totaux
    const { count: totalSessions } = await supabase.from('sessions').select('*', { count: 'exact', head: true });
    const { count: totalEvents } = await supabase.from('events').select('*', { count: 'exact', head: true });

    // Compteurs du jour
    const today = new Date();
    today.setHours(0,0,0,0);
    const sessionsToday = sessions?.filter(s => new Date(s.last_activity_at) >= today).length || 0;
    const eventsToday = events?.filter(e => new Date(e.occurred_at) >= today).length || 0;

    // Affichage compteurs
    document.getElementById('count-sessions').textContent = totalSessions ?? 0;
    document.getElementById('count-events').textContent = totalEvents ?? 0;
    document.getElementById('count-sessions-today').textContent = sessionsToday;
    document.getElementById('count-events-today').textContent = eventsToday;

    // Sessions list
    const sList = document.getElementById('sessions-list');
    sList.innerHTML = sessions?.length
      ? sessions.map(s => `<tr><td class="px-4 py-2">${s.session_id}</td><td class="px-4 py-2">${s.last_event_name || '-'}</td><td class="px-4 py-2">${s.last_activity_at || '-'}</td></tr>`).join('')
      : '<tr><td colspan="3" class="px-4 py-2 text-center text-gray-500">Aucune session</td></tr>';

    // Events list
    const eList = document.getElementById('events-list');
    eList.innerHTML = events?.length
      ? events.map(e => `<tr><td class="px-4 py-2">${e.event_name}</td><td class="px-4 py-2">${e.page_url || '-'}</td><td class="px-4 py-2">${e.occurred_at || '-'}</td></tr>`).join('')
      : '<tr><td colspan="3" class="px-4 py-2 text-center text-gray-500">Aucun événement</td></tr>';

    // Debug JSON
    document.getElementById('debug-json').textContent = JSON.stringify({ sessions, events }, null, 2);
    console.log("✅ Données chargées:", { sessions, events });
  }

  document.getElementById('toggle-debug').onclick = () => {
    document.getElementById('debug-json').classList.toggle('hidden');
  };

  loadDashboard();
</script>
</body>
</html>
