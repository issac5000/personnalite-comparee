<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tableau de bord – Personnalité Comparée</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .hint { position: relative; cursor: help; }
    .hint:hover .hint-bubble { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .hint-bubble {
      position: absolute; top: 100%; left: 0; transform: translateY(4px);
      background: #111827; color: #fff; font-size: .75rem; line-height: 1.1;
      padding: .5rem .6rem; border-radius: .5rem; max-width: 18rem;
      opacity: 0; transition: .15s ease; pointer-events: none; z-index: 40;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    .skeleton { animation: pulse 1.4s ease-in-out infinite; background: linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 37%,#e5e7eb 63%); background-size: 400% 100%; }
    @keyframes pulse { 0% {background-position: 100% 0} 100% {background-position: 0 0} }
  </style>
</head>

<body class="h-full bg-gray-50 text-gray-800">
  <!-- Topbar -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur shadow-sm">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-blue-600 text-white font-bold">PC</span>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold leading-5">Dashboard Analytics</h1>
          <p id="last-updated" class="text-xs text-gray-500 mt-1">Dernière mise à jour — …</p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span class="text-xs text-gray-500 hidden sm:inline">Auto-refresh : 5 min</span>
        <button id="refresh-btn" class="px-3.5 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 focus:outline-none">
          Actualiser
        </button>
      </div>
    </div>
  </header>

  <!-- Conteneur -->
  <main class="max-w-7xl mx-auto px-5 py-6 space-y-8" id="root">
    <!-- KPIs -->
    <section id="kpi-row" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-soft p-5">
        <div class="h-4 w-28 skeleton rounded mb-4"></div>
        <div class="h-8 w-24 skeleton rounded"></div>
        <div class="h-3 w-40 skeleton rounded mt-4"></div>
      </div>
      <div class="bg-white rounded-xl shadow-soft p-5">
        <div class="h-4 w-36 skeleton rounded mb-4"></div>
        <div class="h-8 w-24 skeleton rounded"></div>
        <div class="h-3 w-40 skeleton rounded mt-4"></div>
      </div>
      <div class="bg-white rounded-xl shadow-soft p-5">
        <div class="h-4 w-32 skeleton rounded mb-4"></div>
        <div class="h-8 w-24 skeleton rounded"></div>
        <div class="h-3 w-40 skeleton rounded mt-4"></div>
      </div>
      <div class="bg-white rounded-xl shadow-soft p-5">
        <div class="h-4 w-40 skeleton rounded mb-4"></div>
        <div class="h-8 w-24 skeleton rounded"></div>
        <div class="h-3 w-40 skeleton rounded mt-4"></div>
      </div>
    </section>

    <!-- Sections dynamiques -->
    <section id="dashboard-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></section>

    <!-- Zone messages -->
    <section id="dashboard-messages"></section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ====== Supabase (⚠️ service_role utilisé pour lire les vues matérialisées) ======
    const supabaseUrl = 'https://swjnpvfkloubshksobau.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3am5wdmZrbG91YnNoa3NvYmF1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDA5NTEzMSwiZXhwIjoyMDY5NjcxMTMxfQ.rNwvk8XijCdB6HmX-OTfj8BXH4y88NP58yfUJB7G_YI';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ====== Utils ======
    const fmt = {
      int: (n) => (n ?? 0).toLocaleString('fr-FR'),
      sec: (s) => (s ?? 0).toLocaleString('fr-FR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + ' s',
      date: (d) => new Date(d).toLocaleDateString('fr-FR')
    };

    function setUpdatedNow() {
      const el = document.getElementById('last-updated');
      el.textContent = 'Dernière mise à jour — ' + new Date().toLocaleString('fr-FR');
    }

    function sectionShell({ title, description, hint }) {
      const wrap = document.createElement('div');
      wrap.className = 'bg-white rounded-xl shadow-soft p-6 flex flex-col';

      const head = document.createElement('div');
      head.className = 'flex items-start justify-between gap-3 mb-4';

      const left = document.createElement('div');
      const h2 = document.createElement('h2');
      h2.className = 'text-lg font-semibold';
      h2.textContent = title || '';
      const p = document.createElement('p');
      p.className = 'text-sm text-gray-500 mt-1';
      p.textContent = description || '';
      left.appendChild(h2);
      if (description) left.appendChild(p);

      head.appendChild(left);

      if (hint) {
        const info = document.createElement('div');
        info.className = 'hint text-gray-400 text-sm';
        info.innerHTML = 'ℹ️<span class="hint-bubble">'+hint+'</span>';
        head.appendChild(info);
      }

      wrap.appendChild(head);
      return wrap;
    }

    function addChart({ grid, title, description, hint, type, labels, datasets, height='h-64' }) {
      const s = sectionShell({ title, description, hint });
      const box = document.createElement('div');
      box.className = height;
      const canvas = document.createElement('canvas');
      canvas.className = 'w-full h-full';
      box.appendChild(canvas);
      s.appendChild(box);
      grid.appendChild(s);

      new Chart(canvas, {
        type,
        data: { labels, datasets },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, boxHeight: 12 } },
            tooltip: { intersect: false, mode: 'index' }
          },
          elements: { line: { tension: 0.3 } },
          scales: (type === 'line' || type === 'bar') ? { x: { grid: { display:false } }, y: { beginAtZero: true } } : {}
        }
      });
    }

    function addTable({ grid, title, description, hint, columns, rows, height='max-h-80' }) {
      const s = sectionShell({ title, description, hint });
      const wrap = document.createElement('div');
      wrap.className = height + ' overflow-auto rounded border border-gray-100';

      const table = document.createElement('table');
      table.className = 'min-w-full text-sm';
      const thead = document.createElement('thead');
      thead.className = 'bg-gray-50';
      thead.innerHTML = '<tr>' + columns.map(c => `<th class="px-3 py-2 text-left font-semibold text-gray-600">${c}</th>`).join('') + '</tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach((r,i) => {
        const tr = document.createElement('tr');
        tr.className = (i%2 ? 'bg-white' : 'bg-gray-50');
        tr.innerHTML = r.map((cell, j) =>
          `<td class="px-3 py-2 ${j===r.length-1 ? 'text-right' : 'text-left'} break-all">${cell}</td>`
        ).join('');
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      s.appendChild(wrap);
      grid.appendChild(s);
    }

    function showMessage(kind, text) {
      const zone = document.getElementById('dashboard-messages');
      const base = 'rounded-xl p-4 border';
      const cls = kind === 'error'
        ? 'bg-red-50 border-red-200 text-red-800'
        : 'bg-yellow-50 border-yellow-200 text-yellow-800';
      const div = document.createElement('div');
      div.className = base + ' ' + cls;
      div.textContent = text;
      zone.innerHTML = '';
      zone.appendChild(div);
    }

    // ====== Fetch (inclut un panneau "Sessions récentes") ======
    async function fetchRecentSessions() {
      // On essaie avec ip ; si erreur (colonne absente), on retombe sans ip
      let recent = [];
      let q = await supabase
        .from('sessions')
        .select('session_id,country,city,device_type,last_activity_at,ip')
        .order('last_activity_at', { ascending: false })
        .limit(20);
      if (q.error) {
        const q2 = await supabase
          .from('sessions')
          .select('session_id,country,city,device_type,last_activity_at')
          .order('last_activity_at', { ascending: false })
          .limit(20);
        if (!q2.error) recent = q2.data || [];
      } else {
        recent = q.data || [];
      }
      return recent;
    }

    async function fetchStats() {
      const queries = [
        supabase.from('stats_sessions_par_jour').select('jour,sessions').order('jour', { ascending: true }),
        supabase.from('stats_events_par_jour').select('jour,events').order('jour', { ascending: true }),
        supabase.from('stats_device_type').select('device_type,sessions'),
        supabase.from('stats_pays').select('country,sessions'),
        supabase.from('stats_top_pages').select('page_url,vues'),
        supabase.from('stats_pages_entree').select('first_page_url,nb'),
        supabase.from('stats_pages_sortie').select('last_page_url,nb'),
        supabase.from('stats_nouveaux_vs_revenants').select('is_returning,sessions'),
        supabase.from('stats_categories_events').select('category,nb'),
        supabase.from('stats_elements_cliques').select('element_selector,clics'),
        supabase.from('stats_engagement_moyen').select('engagement_sec'),
        supabase.from('stats_daily_global').select('jour,sessions_uniques,total_events').order('jour',{ascending:true})
      ];

      const [
        { data: sessionsParJour, error: e1 },
        { data: eventsParJour, error: e2 },
        { data: deviceTypes, error: e3 },
        { data: countries, error: e4 },
        { data: topPages, error: e5 },
        { data: entryPages, error: e6 },
        { data: exitPages, error: e7 },
        { data: newVsReturning, error: e8 },
        { data: categories, error: e9 },
        { data: clicks, error: e10 },
        { data: avgEngagement, error: e11 },
        { data: dailyGlobal, error: e12 },
      ] = await Promise.all(queries);

      // sessions récentes (debug)
      const recentSessions = await fetchRecentSessions();

      const errs = [e1,e2,e3,e4,e5,e6,e7,e8,e9,e10,e11,e12].filter(Boolean);
      if (errs.length) {
        console.error('Erreurs Supabase:', errs);
        showMessage('error', 'Certaines données n’ont pas pu être chargées. Réessaie plus tard ou clique sur “Actualiser”.');
      } else {
        document.getElementById('dashboard-messages').innerHTML = '';
      }

      return {
        sessionsParJour, eventsParJour, deviceTypes, countries,
        topPages, entryPages, exitPages, newVsReturning,
        categories, clicks, avgEngagement, dailyGlobal,
        recentSessions
      };
    }

    // ====== KPI ======
    function renderKPIs(stats) {
      const box = document.getElementById('kpi-row');
      box.innerHTML = '';

      const totalSessions = (stats.sessionsParJour ?? []).reduce((a,b)=>a+(b.sessions||0),0);
      const totalEvents = (stats.eventsParJour ?? []).reduce((a,b)=>a+(b.events||0),0);
      const engagement = stats.avgEngagement?.[0]?.engagement_sec ?? 0;
      const topCountry = (stats.countries ?? []).slice().sort((a,b)=>(b.sessions||0)-(a.sessions||0))[0]?.country ?? '—';

      // % nouveaux
      let pctNew = null;
      if (stats.newVsReturning?.length) {
        const total = stats.newVsReturning.reduce((a,b)=>a+(b.sessions||0),0);
        const newCount = stats.newVsReturning.find(r => !r.is_returning)?.sessions || 0;
        pctNew = total ? Math.round((newCount / total) * 100) : 0;
      }

      const kpis = [
        {
          label: 'Sessions (période)',
          value: fmt.int(totalSessions),
          sub: 'Visiteurs uniques cumulés.',
          hint: 'Nombre de sessions distinctes sur la période (≈ une visite).'
        },
        {
          label: 'Événements (période)',
          value: fmt.int(totalEvents),
          sub: 'Pages vues, clics, etc.',
          hint: 'Somme des interactions trackées (pages vues, clics…).'
        },
        {
          label: 'Engagement moyen',
          value: fmt.sec(engagement),
          sub: 'Temps actif par session.',
          hint: 'Durée moyenne d’activité réelle durant une session.'
        },
        {
          label: 'Pays #1',
          value: topCountry,
          sub: 'Origine la plus fréquente.',
          hint: 'Basé sur sessions.country (détecté via IP).'
        }
      ];
      if (pctNew !== null) {
        kpis.push({
          label: 'Nouveaux visiteurs',
          value: pctNew + '%',
          sub: 'Part des nouveaux.',
          hint: 'Pourcentage de sessions par des nouveaux visiteurs.'
        });
      }

      kpis.forEach(k => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-soft p-5';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm text-gray-500">${k.label}</p>
              <p class="mt-2 text-2xl font-bold">${k.value}</p>
              <p class="mt-1 text-xs text-gray-500">${k.sub}</p>
            </div>
            <div class="hint text-gray-400">ℹ️
              <span class="hint-bubble">${k.hint}</span>
            </div>
          </div>
        `;
        box.appendChild(card);
      });
    }

    // ====== Render principal ======
    function renderDashboard(stats) {
      setUpdatedNow();
      renderKPIs(stats);

      const grid = document.getElementById('dashboard-container');
      grid.innerHTML = '';

      // Sessions par jour
      if (stats.sessionsParJour?.length) {
        addChart({
          grid,
          title: 'Sessions par jour',
          description: 'Visiteurs uniques par jour.',
          hint: 'Un pic = afflux ce jour-là.',
          type: 'bar',
          labels: stats.sessionsParJour.map(r => fmt.date(r.jour)),
          datasets: [{ label:'Sessions', data: stats.sessionsParJour.map(r=>r.sessions), backgroundColor:'#3b82f6' }]
        });
      }

      // Événements par jour
      if (stats.eventsParJour?.length) {
        addChart({
          grid,
          title: 'Événements par jour',
          description: 'Total des interactions par jour.',
          hint: 'Si la courbe grimpe alors que les sessions stagnent → meilleure interaction.',
          type: 'line',
          labels: stats.eventsParJour.map(r => fmt.date(r.jour)),
          datasets: [{
            label:'Événements', data: stats.eventsParJour.map(r=>r.events),
            borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.2)', fill:true
          }]
        });
      }

      // Type d’appareil
      if (stats.deviceTypes?.length) {
        addChart({
          grid,
          title: 'Répartition par type d’appareil',
          description: 'Ordinateur, mobile, tablette…',
          hint: 'Optimise pour l’appareil majoritaire.',
          type: 'doughnut',
          labels: stats.deviceTypes.map(r => r.device_type ?? 'Inconnu'),
          datasets: [{ label:'Sessions', data: stats.deviceTypes.map(r=>r.sessions),
            backgroundColor:['#60a5fa','#fb923c','#84cc16','#c084fc','#10b981'] }]
        });
      }

      // Répartition par pays (basée sur sessions.country)
      if (stats.countries?.length) {
        addChart({
          grid,
          title: 'Répartition par pays',
          description: 'Origine géographique des visiteurs.',
          hint: 'Basé sur la colonne country de sessions.',
          type: 'doughnut',
          labels: stats.countries.map(r => r.country ?? 'Inconnu'),
          datasets: [{ label:'Sessions', data: stats.countries.map(r=>r.sessions),
            backgroundColor:['#facc15','#38bdf8','#f472b6','#34d399','#f87171'] }]
        });
      }

      // Nouveaux vs revenants
      if (stats.newVsReturning?.length) {
        addChart({
          grid,
          title: 'Nouveaux vs revenants',
          description: 'Découverte vs fidélisation.',
          hint: 'Plus de revenants = communauté qui revient.',
          type: 'pie',
          labels: stats.newVsReturning.map(r => r.is_returning ? 'Revenants' : 'Nouveaux'),
          datasets: [{ label:'Sessions', data: stats.newVsReturning.map(r=>r.sessions),
            backgroundColor:['#6366f1','#d946ef'] }]
        });
      }

      // Catégories d’événements
      if (stats.categories?.length) {
        addChart({
          grid,
          title: 'Catégories d’événements',
          description: 'Types d’interactions.',
          hint: 'Repère les catégories dominantes.',
          type: 'pie',
          labels: stats.categories.map(r => r.category ?? 'Inconnu'),
          datasets: [{ label:'Événements', data: stats.categories.map(r=>r.nb),
            backgroundColor:['#fbbf24','#34d399','#f87171','#a78bfa','#f472b6'] }]
        });
      }

      // Pages populaires
      if (stats.topPages?.length) {
        addTable({
          grid,
          title: 'Pages les plus visitées',
          description: 'Classement par vues.',
          hint: 'Ces pages méritent un soin particulier.',
          columns: ['URL', 'Vues'],
          rows: stats.topPages.map(r => [r.page_url, fmt.int(r.vues)])
        });
      }

      // Pages d’entrée
      if (stats.entryPages?.length) {
        addTable({
          grid,
          title: 'Pages d’entrée',
          description: 'Première page de la session.',
          hint: 'Soigne la première impression.',
          columns: ['URL', 'Entrées'],
          rows: stats.entryPages.map(r => [r.first_page_url, fmt.int(r.nb)])
        });
      }

      // Pages de sortie
      if (stats.exitPages?.length) {
        addTable({
          grid,
          title: 'Pages de sortie',
          description: 'Dernière page avant de quitter.',
          hint: 'Si une page sort trop : contenu/CTA à revoir.',
          columns: ['URL', 'Sorties'],
          rows: stats.exitPages.map(r => [r.last_page_url, fmt.int(r.nb)])
        });
      }

      // Éléments cliqués
      if (stats.clicks?.length) {
        addTable({
          grid,
          title: 'Éléments les plus cliqués',
          description: 'Sélecteurs HTML les plus cliqués.',
          hint: 'Aide à comprendre où les gens cliquent.',
          columns: ['Sélecteur', 'Clics'],
          rows: stats.clicks.map(r => [r.element_selector, fmt.int(r.clics)])
        });
      }

      // Sessions & événements quotidiens
      if (stats.dailyGlobal?.length) {
        addChart({
          grid,
          title: 'Sessions & événements quotidiens',
          description: 'Comparaison sessions uniques vs total événements.',
          hint: 'Si les événements montent plus vite que les sessions : meilleure interaction moyenne par visite.',
          type: 'line',
          labels: stats.dailyGlobal.map(r => fmt.date(r.jour)),
          datasets: [
            { label:'Sessions uniques', data: stats.dailyGlobal.map(r=>r.sessions_uniques), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.2)', fill:true },
            { label:'Total événements', data: stats.dailyGlobal.map(r=>r.total_events), borderColor:'#f97316', backgroundColor:'rgba(249,115,22,0.2)', fill:true }
          ],
          height: 'h-72'
        });
      }

      // 🔎 Sessions récentes (debug)
      if ((stats.recentSessions ?? []).length) {
        const hasIp = 'ip' in (stats.recentSessions[0] || {});
        addTable({
          grid,
          title: 'Sessions récentes (debug)',
          description: 'Dernières sessions insérées dans public.sessions (pour vérifier country/city).',
          hint: 'Si country/city restent vides, vérifie le tracking côté site.',
          columns: hasIp ? ['Dernière activité','Pays','Ville','Device','IP','Session ID'] : ['Dernière activité','Pays','Ville','Device','Session ID'],
          rows: stats.recentSessions.map(r => hasIp
            ? [new Date(r.last_activity_at).toLocaleString('fr-FR'), r.country ?? '—', r.city ?? '—', r.device_type ?? '—', r.ip ?? '—', r.session_id]
            : [new Date(r.last_activity_at).toLocaleString('fr-FR'), r.country ?? '—', r.city ?? '—', r.device_type ?? '—', r.session_id]
          ),
          height: 'max-h-96'
        });
      }

      // Empty state
      if (!stats.sessionsParJour?.length && !stats.eventsParJour?.length && !stats.dailyGlobal?.length) {
        const notice = document.createElement('div');
        notice.className = 'col-span-full bg-white rounded-xl shadow-soft p-8 text-center text-gray-600';
        notice.innerHTML = `
          <p class="text-lg font-medium">Aucune donnée pour le moment</p>
          <p class="text-sm mt-2">Visite le site principal pour générer des sessions et des événements, puis reviens ici.</p>
        `;
        grid.appendChild(notice);
      }
    }

    // ====== Init & Refresh ======
    async function boot() {
      const stats = await fetchStats();
      renderDashboard(stats);
    }

    document.getElementById('refresh-btn').addEventListener('click', boot);

    boot();
    setInterval(boot, 5 * 60 * 1000);
  </script>
</body>
</html>
