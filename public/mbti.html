<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBTI ‚Äî Personnalit√© Compar√©e</title>

  <!-- Supabase JS -->

  <!-- SEO Meta Tags -->
  <meta name="description" content="Explorez le MBTI et ses 16 types de personnalit√©.">
  <meta name="keywords" content="test personnalit√©, MBTI, enn√©agramme, psychologie, 16 types, auto-√©valuation, gratuit">
  <meta name="author" content="Personnalit√© Compar√©e">
  <meta name="robots" content="index, follow">


  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="Personnalit√© Compar√©e | Test MBTI & Enn√©agramme Gratuit">
  <meta property="og:description" content="D√©couvrez votre vraie personnalit√© avec notre test MBTI et Enn√©agramme gratuit. Analyse objective combinant votre auto-√©valuation et l'avis de vos proches.">
    <meta property="og:image" content="logo.jpg">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="Personnalit√© Compar√©e | Test MBTI & Enn√©agramme Gratuit">
    <meta property="twitter:description" content="D√©couvrez votre vraie personnalit√© avec notre test MBTI et Enn√©agramme gratuit. Analyse objective combinant votre auto-√©valuation et l'avis de vos proches.">
      <meta property="twitter:image" content="logo.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="/flavicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Supabase JS library -->
   
    <style>
        html, body {
            overflow-x: hidden;
        }
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        button,
        [class*="card"] {
            transition: all 0.3s ease;
        }

        button:hover {
            transform: rotateX(3deg) rotateY(3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        [class*="card"]:hover {
            transform: perspective(600px) rotateX(3deg) rotateY(-3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .question-card {
            min-height: 300px;
        }
        .floating-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .personality-badge {
            border-radius: 50px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Styles pour les modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .close {
            color: #9ca3af;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover,
        .close:focus {
            color: #374151;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @media (max-width: 768px) {
            .desktop-nav {
                display: none;
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .question-container {
            display: none;
        }
        .question-container.active {
            display: block;
        }

        .section-clair {
            background-color: #ffffff;
        }

        .section-fonce {
            background-color: #fbfbfb;
        }
        #site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: inherit;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        body {
            padding-top: 64px;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1100;
            display: none;
        }

        .mobile-menu.active {
            display: block;
        }

        @media (max-width: 768px) {
            #site-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                background: inherit;
                box-shadow: 0 2px 10px rgba(0,0,0,0.06);
                height: 56px;
            }
            body {
                padding-top: 56px;
            }
            [id],
            .section {
                scroll-margin-top: 64px;
            }
        }

        .scroll-highlight {
            animation: scrollHighlight 1s ease;
        }
        @keyframes scrollHighlight {
            from { background-color: #fef3c7; }
            to { background-color: #ffffff; }
        }

        /* Chat styles */
        .chat-row {
            display: flex;
            margin-bottom: 8px;
        }
        .chat-row.user {
            justify-content: flex-end;
        }
        .chat-row.assistant {
            justify-content: flex-start;
        }
        .chat-bubble {
            display: inline-block;
            padding: 10px 14px;
            font-size: 15px;
        }
        .assistant-bubble {
            background: #e0f0ff;
            color: #003b5c;
            border-radius: 16px 16px 16px 4px;
        }
        .user-bubble {
            background: #d1ffe0;
            color: #084d28;
            border-radius: 16px 16px 4px 16px;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .assistant-bubble.limit-error {
            background: #ffe5e5;
            border: 1px solid #ff0000;
            color: #b30000;
            font-weight: bold;
            animation: shake 0.4s;
        }
        .question-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 14px;
            margin-top: auto;
            padding: 12px;
        }
        .question-buttons button {
            padding: 6px 12px;
            border-radius: 8px;
            background-color: #e7f1fb;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .question-buttons button:hover {
            background-color: #d0e7f7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .pc-typing {
            position: sticky;
            bottom: 0;
            padding: 8px 12px;
            background: rgba(0,0,0,0.04);
            backdrop-filter: blur(2px);
            border-top: 1px solid rgba(0,0,0,0.06);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .pc-typing[hidden] { display: none; }
        .pc-dots span {
            animation: pc-blink 1.2s infinite;
            display: inline-block;
            padding-left: 2px;
        }
        .pc-dots span:nth-child(2) { animation-delay: .2s; }
        .pc-dots span:nth-child(3) { animation-delay: .4s; }
        @keyframes pc-blink {
            0% { opacity: 0.2; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-1px); }
            100% { opacity: 0.2; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: -2px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        :root{
          --pc-line: rgba(59,130,246,.30);  /* bleu doux (#3B82F6) */
          --pc-dot:  rgba(10,15,26,.62);
        }
        /* le conteneur de la banni√®re doit d√©j√† √™tre positionn√© ; sinon: */
        .pc-hero { position: relative; isolation: isolate; z-index: 0; margin-top: 2rem; }
        @media (min-width: 768px) {
          .pc-hero { margin-top: 3rem; }
        }

        #pc-constellation{
          position: absolute; inset: 0; width: 100%; height: 100%;
          pointer-events: none; z-index: -1; /* contenu texte reste au-dessus */
        }

        @media (prefers-reduced-motion: reduce){
          #pc-constellation{ display:none !important; }
        }

        .pc-info-banner{
          background:#eef2ff;
          color:#0f172a;
          border:1px solid rgba(59,130,246,.25);
          border-radius:12px;
          padding:14px 16px;
          margin:16px 0 12px;
          line-height:1.5;
          font-size:.95rem;
        }
        @media (max-width:768px){
          .pc-info-banner{ margin:12px 0; font-size:.93rem; }
        }

       /* Styles sp√©cifiques au chatbot Psycho'Bot */
#chat-window {
  border-radius: 32px !important;
  overflow: hidden !important;
}

#chat-input {
  border-top-left-radius: 9999px !important;
  border-bottom-left-radius: 9999px !important;
  border: none !important;
}

#chat-send {
  border-top-right-radius: 9999px !important;
  border-bottom-right-radius: 9999px !important;
  border: none !important;
}

    </style>

</head>
<body id="top" class="font-sans bg-white text-gray-900">
<!-- Navigation -->
<div id="header"></div>

    <main>
<section id="mbti-hero" class="px-4 sm:px-6 lg:px-8 relative overflow-hidden pc-hero mt-8 sm:mt-12" data-hero>
  <canvas id="pc-constellation" aria-hidden="true"></canvas>
  <div class="absolute inset-0 opacity-[0.02]">
    <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgb(15 23 42) 1px, transparent 0); background-size: 40px 40px;"></div>
  </div>
  <div class="absolute top-1/4 right-1/4 w-2 h-2 bg-blue-400/20 rounded-full"></div>
  <div class="absolute bottom-1/3 left-1/5 w-1 h-1 bg-slate-400/30 rounded-full"></div>
  <div class="absolute top-2/3 right-1/3 w-1.5 h-1.5 bg-blue-300/25 rounded-full"></div>
  <div class="relative max-w-3xl mx-auto px-6 pb-16 text-center">
    <img src="/logobanniere.jpeg" alt="Nouveau logo" class="mx-auto mb-8 w-36 sm:w-40 h-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-6">Comprendre le MBTI</h1>
    <p class="text-lg text-gray-700">Le MBTI est un outil de compr√©hension de soi bas√© sur 4 dimensions fondamentales de la personnalit√©...</p>
  </div>
</section>

<section id="mbti-history" class="py-16 px-4 sm:px-6 lg:px-8 bg-gray-50">
  <div class="max-w-3xl mx-auto">
    <div class="text-center">
      <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">Un peu d'histoire</h2>
    </div>
    <div class="mt-12 text-gray-700 space-y-6 leading-relaxed">
      
      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">1. Les origines ‚Äì Carl Jung</h3>
        <p>En 1921, le psychiatre suisse <strong>Carl Gustav Jung</strong> publie <em>Psychological Types</em>, dans lequel il d√©veloppe une th√©orie des fonctions psychologiques : sensation, intuition, pens√©e, et sentiment. Il propose que chaque personne privil√©gie une fonction dominante, et que cette fonction peut √™tre introvertie ou extravertie.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">2. Katharine Cook Briggs ‚Äì Premiers pas</h3>
        <p>D√®s 1917, <strong>Katharine Cook Briggs</strong> se passionne pour les diff√©rences de personnalit√© apr√®s avoir remarqu√© le profil psychologique particulier du futur mari de sa fille. Elle se lance dans la lecture de biographies, d√©veloppe une typologie initiale de quatre temp√©raments : contemplatif, spontan√©, ex√©cutif, social.</p>
        <p>Apr√®s la traduction de <em>Psychological Types</em> en anglais (1923), elle fait le lien entre ses temp√©raments et la typologie de Jung. Elle publie des articles en 1926 et 1928 (‚ÄúMeet Yourself Using the Personality Paint Box‚Äù, ‚ÄúUp From Barbarism‚Äù) pour diffuser la th√©orie.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">3. Isabel Briggs Myers ‚Äì Formalisation durant la Seconde Guerre mondiale</h3>
        <p><strong>Isabel Briggs Myers</strong>, fille de Katharine, dipl√¥m√©e en sciences politiques, s‚Äôinitie aux m√©thodes statistiques et au test psychom√©trique aupr√®s d‚ÄôEdward N. Hay.</p>
        <p>Pendant la Seconde Guerre mondiale, m√®re et fille d√©veloppent un outil psychologique permettant d‚Äôaider les femmes √† s‚Äôorienter vers des emplois plus adapt√©s √† leur personnalit√©. En 1943, elles auto-publient le <em>Briggs Myers Type Indicator Handbook</em>, puis en 1956, il sera republi√© officiellement comme le MBTI.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">4. Diffusion et d√©veloppement</h3>
        <p>En 1962, l‚Äô<em>Educational Testing Service</em> (ETS) publie la premi√®re version manuelle du MBTI. Il re√ßoit notamment le soutien d‚Äôuniversitaires comme Donald MacKinnon ou Mary McCaulley. La publication est transf√©r√©e √† <em>Consulting Psychologists Press</em> en 1975, qui devient The Myers-Briggs Company, avec le Center for Applications of Psychological Type (CAPT) comme centre de recherche.</p>
        <p>Apr√®s le d√©c√®s d‚ÄôIsabel en 1980, Mary McCaulley publie la deuxi√®me √©dition du manuel en 1985, puis une troisi√®me en 1998.</p>
        <p>Le test a √©t√© r√©guli√®rement r√©vis√© (Forme M, Forme Q) avec des m√©thodes modernes comme la <em>th√©orie de la r√©ponse √† l‚Äôitem</em> (IRT) pour am√©liorer la pr√©cision technique.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">5. Popularit√©‚Ä¶ et controverses</h3>
        <p>Le MBTI est aujourd‚Äôhui l‚Äôun des tests de personnalit√© les plus utilis√©s : plus de <strong>2 millions de personnes</strong> l‚Äôentrent chaque ann√©e, et il est couramment employ√© dans les entreprises, les universit√©s, le conseil professionnel et m√™me l‚Äôarm√©e.</p>
        <p>Mais scientifiquement, il est souvent critiqu√© :</p>
        <ul class="list-disc list-inside">
          <li>Manque de fiabilit√© (r√©test : 50% des types peuvent changer en quelques semaines)</li>
          <li>Validit√© psychom√©trique faible, absence de mesure de trait continu</li>
          <li>Effet de Barnum (descriptions trop vagues)</li>
          <li>Jug√© pseudo-scientifique par la communaut√© acad√©mique</li>
        </ul>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">6. Influence d√©riv√©e ‚Äì Keirsey, les temp√©raments</h3>
        <p><strong>David Keirsey</strong> s‚Äôest inspir√© du MBTI pour proposer un mod√®le √† quatre temp√©raments (Gardien, Artisan, Id√©aliste, Rationnel) qui correspondent aux axes MBTI (SJ, SP, NF, NT). Son syst√®me <em>Please Understand Me</em> a largement popularis√© ces types.</p>
      </div>

    </div>
  </div>
</section>



    <div id="mbti-types" data-aos="fade-right" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                    Les 16 types de personnalit√© MBTI
                </h2>
                <p class="mt-4 max-w-2xl text-xl text-gray-500 mx-auto">
                    D√©couvrez les diff√©rents profils de la typologie Myers-Briggs
                </p>
            </div>
            
            <div class="mt-12 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Analystes (NT) -->
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                <i class="fas fa-brain text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">INTJ</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Architecte</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Visionnaires strat√©giques avec un plan pour tout. Ind√©pendants et d√©termin√©s √† atteindre leurs objectifs.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('INTJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                <i class="fas fa-user text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ENTJ</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Commandant</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Leaders naturels, charismatiques et d√©termin√©s. Excellents pour organiser et mettre en ≈ìuvre des plans.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ENTJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-microscope text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">INTP</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Penseur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Penseurs logiques et cr√©atifs, toujours √† la recherche de nouvelles id√©es et possibilit√©s th√©oriques.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('INTP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Diplomates (NF) -->
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                                <i class="fas fa-lightbulb text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ENFJ</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Donateur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Charismatiques et empathiques, motiv√©s par le d√©sir d'aider les autres √† r√©aliser leur potentiel.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ENFJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-red-500 rounded-md p-3">
                                <i class="fas fa-heart text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ENFP</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Inspirateur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Enthousiastes, cr√©atifs et sociables, toujours √† la recherche de nouvelles id√©es et exp√©riences.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ENFP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-teal-500 rounded-md p-3">
                                <i class="fas fa-dove text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">INFJ</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Avocat</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Id√©alistes cr√©atifs et perspicaces, motiv√©s par leurs valeurs profondes et leur vision du futur.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('INFJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-pink-500 rounded-md p-3">
                                <i class="fas fa-palette text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">INFP</h3>
                                <p class="mt-1 text-sm text-gray-500">Le M√©diateur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Po√©tiques, gentils et altruistes, toujours d√©sireux d'aider une bonne cause ou une personne importante.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('INFP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sentinelles (SJ) -->
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-gray-600 rounded-md p-3">
                                <i class="fas fa-balance-scale text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ISTJ</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Logisticien</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Pratiques et factuels, fiables et responsables. Ils aiment l'ordre et respectent les traditions.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ISTJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-orange-500 rounded-md p-3">
                                <i class="fas fa-shield-alt text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ISFJ</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Protecteur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Chaleureux et consciencieux, toujours pr√™ts √† prot√©ger leurs proches et √† maintenir l'harmonie.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ISFJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-red-600 rounded-md p-3">
                                <i class="fas fa-bullhorn text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ESTJ</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Ex√©cutif</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Excellents administrateurs, incomparables pour g√©rer les choses et les personnes avec efficacit√©.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ESTJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-600 rounded-md p-3">
                                <i class="fas fa-hands-helping text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ESFJ</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Consul</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Extraordinairement attentionn√©s, sociables et populaires, toujours d√©sireux d'aider les autres.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ESFJ')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Explorateurs (SP) -->
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-yellow-600 rounded-md p-3">
                                <i class="fas fa-tools text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ISTP</h3>
                                <p class="mt-1 text-sm text-gray-500">Le Virtuose</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                M√©caniciens audacieux et pratiques, ma√Ætres de tous les types d'outils et de techniques.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ISTP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-600 rounded-md p-3">
                                <i class="fas fa-music text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ISFP</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Aventurier</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Artistes flexibles et charmants, toujours pr√™ts √† explorer de nouvelles possibilit√©s cr√©atives.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ISFP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-600 rounded-md p-3">
                                <i class="fas fa-rocket text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ESTP</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Entrepreneur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Intelligents, √©nergiques et tr√®s perceptifs, vraiment appr√©ci√©s pour leur spontan√©it√© et leur humour.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ESTP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="type-card bg-white overflow-hidden shadow rounded-lg transition-all duration-300">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-pink-600 rounded-md p-3">
                                <i class="fas fa-theater-masks text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <h3 class="text-lg font-medium text-gray-900">ESFP</h3>
                                <p class="mt-1 text-sm text-gray-500">L'Amuseur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">
                                Spontan√©s, √©nergiques et enthousiastes, la vie n'est jamais ennuyeuse autour d'eux.
                            </p>
                        </div>
                        <div class="mt-5">
                            <button onclick="showMBTIDetails('ESFP')" class="text-sm font-medium text-black hover:text-gray-800">
                                En savoir plus <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    </main>
        <div id="mbti-faq" data-aos="fade-up" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto">
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                    Questions fr√©quentes
                </h2>
                <p class="mt-4 text-xl text-gray-500">
                    Trouvez des r√©ponses aux questions les plus courantes
                </p>
            </div>

            <div class="mt-12 space-y-6">
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-1" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-1-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Le MBTI est-il scientifique et fiable ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-1-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-1" aria-hidden="true">
                            <p class="text-gray-600">
                                Le MBTI est largement utilis√© mais sa validit√© psychom√©trique est d√©battue. Il mesure des pr√©f√©rences plut√¥t que des traits continus. En pratique, il est utile pour le dialogue et la connaissance de soi, mais il ne remplace pas une √©valuation clinique ou des mod√®les de recherche (ex. Big Five).
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-2" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-2-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Quelle est la diff√©rence entre MBTI et Big Five ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-2-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-2" aria-hidden="true">
                            <p class="text-gray-600">
                                Le MBTI classe en 16 types via 4 dichotomies (E/I, S/N, T/F, J/P). Le Big Five mesure 5 grands traits continus (Ouverture, Conscienciosit√©, Extraversion, Agr√©abilit√©, N√©vrosisme). Le Big Five est plus valid√© scientifiquement ; le MBTI est plus p√©dagogique et typologique.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-3" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-3-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Mon type peut-il changer ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-3-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-3" aria-hidden="true">
                            <p class="text-gray-600">
                                Les pr√©f√©rences sont relativement stables, mais le r√©sultat d‚Äôun test peut varier selon le contexte, l‚Äôhumeur et l‚Äôexp√©rience. On peut aussi mieux comprendre ses pr√©f√©rences avec le temps et ‚Äúaffiner‚Äù son type.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-4" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-4-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Les ‚Äúfonctions cognitives‚Äù sont-elles indispensables ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-4-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-4" aria-hidden="true">
                            <p class="text-gray-600">
                                Les lettres (E/I, S/N, T/F, J/P) suffisent pour un premier niveau. Les fonctions (Si, Se, Ni, Ne, Ti, Te, Fi, Fe) apportent une lecture plus fine des dynamiques internes du type, mais sont optionnelles pour un usage basique.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-5" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-5-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">√Ä quoi sert le MBTI concr√®tement (travail, couple, parentalit√©) ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-5-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-5" aria-hidden="true">
                            <p class="text-gray-600">
                                Il facilite la communication, la r√©partition des r√¥les, la compr√©hension des styles de d√©cision et d‚Äô√©nergie. Il ne ‚Äúpr√©voit‚Äù pas la compatibilit√©, mais aide √† expliciter les pr√©f√©rences, donc √† r√©duire les malentendus.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <button id="faq-mbti-6" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-mbti-6-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Comment trouver mon type avec plus de certitude ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-mbti-6-content" class="faq-content mt-2 hidden" aria-labelledby="faq-mbti-6" aria-hidden="true">
                            <p class="text-gray-600">
                                Combine un questionnaire, la lecture des descriptions, et un retour de ton entourage sur ton comportement r√©el. La coh√©rence entre auto-perception et comportements observables vaut plus qu‚Äôun unique score.
                            </p>
                        </div>
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <p class="text-gray-600">
                    Vous avez d'autres questions ? <a href="mailto:contact@personnalitecomparee.com" class="text-blue-600 hover:text-blue-500 font-medium">Contactez-nous</a>
                </p>
            </div>
        </div>
    </div>

    <div id="footer"></div>
    <script src="questions-v2.js"></script>

   
      
    <script>
        // Configuration et donn√©es
                // R√©cup√®re les questions externes depuis Supabase si l'utilisateur est un proche
let questions = AUTO_QUESTIONS;
// üîê G√©n√©re un code al√©atoire
function genererUniqueCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// üîÑ Envoie vers Supabase
async function enregistrerQuestionsPourProches(questionsAutoEvaluation, userCode) {
  // Mettre √† jour l'enregistrement existant avec les questions pour les proches
  const { data, error } = await supabase
    .from("users")
    .update({
      external_questions: questionsAutoEvaluation
    })
    .eq('code', userCode);

  if (error) {
    console.error("‚ùå Erreur lors de l'enregistrement Supabase :", error);
  } else {
    console.log("‚úÖ Questions pour proches enregistr√©es avec succ√®s :", data);
    alert("Voici ton code √† donner √† 3 proches : " + userCode);
  }
}


if (window.location.href.includes("external")) {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");
  console.log("Code re√ßu dans l'URL :", code);

  if (code) {
    // Appelle Supabase pour r√©cup√©rer les questions li√©es √† ce code
    supabase
      .from("users")
      .select("external_questions")
      .eq("code", code)
      .then(({ data, error }) => {
        if (!error && data && data.length > 0 && data[0].external_questions) {
          questions = data[0].external_questions;
          console.log("Questions externes charg√©es :", questions);
          afficherQuestions(); // appel explicite
        } else {
          console.error("Aucune question externe trouv√©e ou erreur :", error);
        }
      });
  }
}


        // √âtat de l'application
        let currentQuestionIndex = 0;
        let answers = {};
        let testType = 'auto'; // 'auto' ou 'proche'
        let userCode = genererUniqueCode();



        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupMobileMenu();
            setupFAQ();
            setupSmoothScrolling();
            setupProgressBars();
            setupEvaluationForm();
            loadFirstQuestion();
            initCountUp();
        }

        // Menu mobile
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.classList.contains('active');
                    
                    if (isOpen) {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.classList.add('active');
                        menuIcon.classList.remove('fa-bars');
                        menuIcon.classList.add('fa-times');
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                });

                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
            }
        }

        // FAQ Accordion
        function setupFAQ() {
            const faqButtons = document.querySelectorAll('.faq-button');
            faqButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.querySelector('.faq-content');
                    const icon = this.querySelector('i');
                    const isOpen = this.getAttribute('aria-expanded') === 'true';

                    // Fermer toutes les autres FAQ
                    faqButtons.forEach(otherButton => {
                        if (otherButton !== this) {
                            const otherContent = otherButton.querySelector('.faq-content');
                            const otherIcon = otherButton.querySelector('i');
                            otherContent.classList.add('hidden');
                            otherIcon.classList.remove('rotate-180');
                            otherButton.setAttribute('aria-expanded', 'false');
                            otherContent.setAttribute('aria-hidden', 'true');
                        }
                    });

                    // Toggle la FAQ actuelle
                    if (isOpen) {
                        content.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                        this.setAttribute('aria-expanded', 'false');
                        content.setAttribute('aria-hidden', 'true');
                    } else {
                        content.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                        this.setAttribute('aria-expanded', 'true');
                        content.setAttribute('aria-hidden', 'false');
                    }
                });
            });
        }

        // Smooth scrolling
        function setupSmoothScrolling() {
            const links = document.querySelectorAll('a[href^="#"]');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        const offsetTop = targetElement.offsetTop - 80; // Account for fixed nav
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        }

        // Animation des barres de progression
        function setupProgressBars() {
            const progressBars = document.querySelectorAll('.progress-bar');
            
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -100px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const targetWidth = bar.style.width;
                        bar.style.width = '0';
                        setTimeout(() => {
                            bar.style.width = targetWidth;
                        }, 100);
                    }
                });
            }, observerOptions);
            
            progressBars.forEach(bar => {
                observer.observe(bar);
            });
        }

        // Configuration du formulaire d'√©valuation
        function setupEvaluationForm() {
            const evaluationForm = document.getElementById('evaluation-form');
            if (evaluationForm) {
                evaluationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const code = formData.get('code');
                    const relation = formData.get('relation');
                    
                    if (code && relation) {
                        userCode = code;
                        testType = 'proche';
                        startEvaluationTest(relation);
                    } else {
                        alert('Veuillez remplir tous les champs requis.');
                    }
                });
            }
        }

        // Chargement de la premi√®re question
        function loadFirstQuestion() {
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                displayQuestion(0);
                setupQuestionNavigation();
            }
        }

       // Affichage d'une question
function displayQuestion(index) {
  const questionsContainer = document.getElementById('questions-container');
  const question = AUTO_QUESTIONS[index];

  if (!question || !questionsContainer) return;

  const progress = ((index + 1) / AUTO_QUESTIONS.length) * 100;

  const questionHTML = `
    <div class="question-container fade active bg-transparent overflow-hidden">
      <div class="px-6 py-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm font-medium text-blue-600">
            Question ${index + 1}/${AUTO_QUESTIONS.length}
          </span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
            <div class="progress-bar bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                 style="width: ${progress}%"></div>
          </div>
        </div>

        <h3 class="text-xl font-medium text-gray-900 mb-6">${question.question}</h3>

        <div class="space-y-4">
          ${question.options.map((option, optionIndex) => `
            <div class="flex items-start">
              <input id="q${question.id}-${optionIndex}"
                     name="question${question.id}"
                     type="radio"
                     value="${optionIndex}"
                     class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 mt-1"
                     ${answers[question.id] === optionIndex ? 'checked' : ''}>
              <label for="q${question.id}-${optionIndex}"
                     class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors">
                ${option.text}
              </label>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
            
            questionsContainer.innerHTML = questionHTML;
            
            // √âcouter les changements de r√©ponse
            const radioButtons = questionsContainer.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    answers[question.id] = parseInt(this.value);
                    saveProgress();
                    updateNavigationButtons();
                });
            });
            
            updateNavigationButtons();
        }

        // Configuration de la navigation entre questions
        function setupQuestionNavigation() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        displayQuestion(currentQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined) {
                        if (currentQuestionIndex < AUTO_QUESTIONS.length - 1) {
                            currentQuestionIndex++;
                            displayQuestion(currentQuestionIndex);
                        }
                    } else {
                        alert('Veuillez s√©lectionner une r√©ponse avant de continuer.');
                    }
                });
            }
            
            if (finishButton) {
                finishButton.addEventListener('click', function() {
                    if (Object.keys(answers).length === AUTO_QUESTIONS.length) {
                        calculateResults();
                    } else {
                        alert('Veuillez r√©pondre √† toutes les questions avant de terminer.');
                    }
                });
            }
        }

        // Mise √† jour des boutons de navigation
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
            }
            
            const isLastQuestion = currentQuestionIndex === AUTO_QUESTIONS.length - 1;
            const hasAnswer = answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined;
            
            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        // Sauvegarde de la progression
        function saveProgress() {
            const progressData = {
                currentQuestionIndex,
                answers,
                testType,
                userCode,
                timestamp: Date.now()
            };
            localStorage.setItem('personalityTestProgress', JSON.stringify(progressData));

        }

        // Chargement de la progression sauvegard√©e
        function loadProgress() {
            const saved = localStorage.getItem('personalityTestProgress');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // V√©rifier si la sauvegarde n'est pas trop ancienne (24h)
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        currentQuestionIndex = data.currentQuestionIndex || 0;
                        answers = data.answers || {};
                        testType = data.testType || 'auto';
                        userCode = data.userCode || '';
                        return true;
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement de la progression:', e);
                }
            }
            return false;
        }

        // === Configuration Supabase ===

        const SUPABASE_URL = 'https://swjnpvfkloubshksobau.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3am5wdmZrbG91YnNoa3NvYmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwOTUxMzEsImV4cCI6MjA2OTY3MTEzMX0.A6rnIJyfIIxDT0c2XW_zGeUXpdYCgBFd6MTzBGFZ-Cg';

// Le client Supabase sera initialis√© apr√®s le chargement du script


        /**
         * Enregistre le profil utilisateur (auto‚Äë√©valuation) dans Supabase.
         * Cette fonction ins√®re un enregistrement dans la table "users".
         * @param {Object} userProfile Contient le code unique, les types MBTI/Enn√©agramme,
         * les scores d√©taill√©s et le niveau de certitude.
         */
         async function saveUserProfileToSupabase(userProfile) {
  try {
    const { data, error } = await supabase
      .from('users')
      .insert({
        code: userProfile.code,
        mbti_scores: userProfile.mbtiScores,
        enneagram_scores: userProfile.enneagramScores,
        mbti_type: userProfile.mbtiType,
        enneagram_type: userProfile.enneagramType,
        certainty_score: 0
      })
      .select()
      .single();

    if (error) {
      console.error('Erreur lors de l\'enregistrement du profil utilisateur :', error);
    } else {
      console.log('Profil enregistr√© dans Supabase', data);

      if (testType === "auto") {
        enregistrerQuestionsPourProches(answers, userProfile.code);
      }
    }
  } catch (err) {
    console.error('Exception lors de l\'enregistrement du profil utilisateur :', err);
  }
}



        /**
         * Enregistre une √©valuation externe dans Supabase.
         * Cette fonction r√©cup√®re l'utilisateur par son code unique, puis ins√®re une √©valuation li√©e.
         * @param {String} code Code unique de l'utilisateur √©valu√©.
         * @param {String} relation Relation entre l'√©valuateur et l'utilisateur ("family", "partner", "friend", "colleague").
         * @param {Object} mbtiScores Scores MBTI calcul√©s √† partir des r√©ponses de l'√©valuation externe.
         * @param {Object} enneagramScores Scores Enn√©agramme calcul√©s √† partir des r√©ponses.
         */
        async function saveExternalEvaluationToSupabase(code, relation, mbtiScores, enneagramScores) {
            try {
                // R√©cup√©rer l'utilisateur par code
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('code', code)
                    .single();
                if (userError || !user) {
                    console.error('Utilisateur introuvable pour ce code :', code, userError);
                    return;
                }
                const userId = user.id;
                // Ins√©rer l'√©valuation
                const { error: insertError } = await supabase
                    .from('external_evaluations')
                    .insert({
                        user_id: userId,
                        relation: relation,
                        mbti_scores: mbtiScores,
                        enneagram_scores: enneagramScores
                    });
                if (insertError) {
                    console.error('Erreur lors de l‚Äôenregistrement de l‚Äô√©valuation externe :', insertError);
                } else {
                    console.log('√âvaluation externe enregistr√©e dans Supabase');
                    await calculateFinalProfile(code);
                }
            } catch (err) {
                console.error('Exception lors de l‚Äôenregistrement de l‚Äô√©valuation externe :', err);
            }
        }

        /**
         * Calcule et enregistre le r√©sultat final si au moins trois √©valuations externes sont disponibles.
         * @param {String} userId Identifiant de l'utilisateur.
         */
        function getProfileFromScores(mbtiScores, enneagramScores) {
            const mbtiType =
                (mbtiScores.E > mbtiScores.I ? 'E' : 'I') +
                (mbtiScores.S > mbtiScores.N ? 'S' : 'N') +
                (mbtiScores.T > mbtiScores.F ? 'T' : 'F') +
                (mbtiScores.J > mbtiScores.P ? 'J' : 'P');
            let topEnnea = '1';
            Object.keys(enneagramScores).forEach(type => {
                if (enneagramScores[type] > enneagramScores[topEnnea]) {
                    topEnnea = type;
                }
            });
            return { mbtiType, enneagramType: topEnnea };
        }

        function getCoh√©renceMBTI(scores) {
            if (!scores) return "Inconnue";

            const pairs = [
                ["I", "E"],
                ["S", "N"],
                ["T", "F"],
                ["J", "P"]
            ];

            const √©carts = pairs.map(([a, b]) => {
                if (scores[a] == null || scores[b] == null) return 0;
                return Math.abs(scores[a] - scores[b]);
            });

            const moyenne = √©carts.reduce((sum, val) => sum + val, 0) / √©carts.length;

            if (moyenne >= 30) return "Forte";
            if (moyenne >= 15) return "Moyenne";
            return "Faible";
        }

        function getCoh√©renceEnn√©agramme(scores) {
            if (!scores) return "Inconnue";

            const types = Object.keys(scores);
            if (types.length === 0) return "Inconnue";

            let dominantType = types[0];
            types.forEach(type => {
                if ((scores[type] || 0) > (scores[dominantType] || 0)) {
                    dominantType = type;
                }
            });

            const dominantScore = scores[dominantType] || 0;
            const autres = types.filter(t => t !== dominantType).map(t => scores[t] || 0);
            const moyenneAutres = autres.reduce((sum, v) => sum + v, 0) / (autres.length || 1);

            const √©cart = dominantScore - moyenneAutres;

            if (√©cart > 20) return "Forte";
            if (√©cart >= 10) return "Moyenne";
            return "Faible";
        }

       function computeWeightedResults(evaluations) {
    const baseWeights = {
        family: 30,
        partner: 25,
        friend: 25,
        colleague: 15
    };

    const combinedMbti = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
    const combinedEnneagram = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

    const availableRelations = {};
    let totalBaseWeight = 0;

    evaluations.forEach(ev => {
        if (baseWeights[ev.relation]) {
            if (!availableRelations[ev.relation]) {
                availableRelations[ev.relation] = [];
                totalBaseWeight += baseWeights[ev.relation];
            }
            availableRelations[ev.relation].push(ev);
        }
    });

    if (totalBaseWeight === 0) {
        return {
            mbtiType: null,
            enneagramType: null,
            mbtiCertainty: 0,
            enneagramCertainty: 0,
            overallCertainty: 0,
            combinedMbti,
            combinedEnneagram
        };
    }

    const normalizedWeights = {};
    Object.keys(availableRelations).forEach(relation => {
        normalizedWeights[relation] = (baseWeights[relation] / totalBaseWeight) * 100;
    });

    Object.keys(availableRelations).forEach(relation => {
        const weight = normalizedWeights[relation];
        const relEvaluations = availableRelations[relation];
        const avgMbti = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        const avgEnneagram = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

        relEvaluations.forEach(ev => {
            Object.keys(ev.mbti_scores).forEach(trait => {
                avgMbti[trait] += ev.mbti_scores[trait];
            });
            Object.keys(ev.enneagram_scores).forEach(type => {
                avgEnneagram[type] += ev.enneagram_scores[type];
            });
        });

        Object.keys(avgMbti).forEach(trait => {
            avgMbti[trait] = avgMbti[trait] / relEvaluations.length;
            combinedMbti[trait] += avgMbti[trait] * (weight / 100);
        });
        Object.keys(avgEnneagram).forEach(type => {
            avgEnneagram[type] = avgEnneagram[type] / relEvaluations.length;
            combinedEnneagram[type] += avgEnneagram[type] * (weight / 100);
        });
    });

    const mbtiType =
        (combinedMbti.E > combinedMbti.I ? 'E' : 'I') +
        (combinedMbti.S > combinedMbti.N ? 'S' : 'N') +
        (combinedMbti.T > combinedMbti.F ? 'T' : 'F') +
        (combinedMbti.J > combinedMbti.P ? 'J' : 'P');

    let topEnnea = '1';
    Object.keys(combinedEnneagram).forEach(type => {
        if (combinedEnneagram[type] > combinedEnneagram[topEnnea]) {
            topEnnea = type;
        }
    });

    const COHERENCE_WEIGHTS = { Forte:1.0, Moyenne:0.7, Faible:0.4 };
    const mbtiWeights = {};
    const enneagramWeights = {};
    evaluations.forEach(ev => {
        const { mbtiType: evMbti, enneagramType: evEnnea } = getProfileFromScores(ev.mbti_scores, ev.enneagram_scores);
        const cohMbti = getCoh√©renceMBTI(ev.mbti_scores);
        const cohEnnea = getCoh√©renceEnn√©agramme(ev.enneagram_scores);
        const wMbti = COHERENCE_WEIGHTS[cohMbti] || 0;
        const wEnnea = COHERENCE_WEIGHTS[cohEnnea] || 0;
        mbtiWeights[evMbti] = (mbtiWeights[evMbti] || 0) + wMbti;
        enneagramWeights[evEnnea] = (enneagramWeights[evEnnea] || 0) + wEnnea;
    });
    const totalEvals = evaluations.length;
    const mbtiTop = Math.max(...Object.values(mbtiWeights), 0);
    const enneaTop = Math.max(...Object.values(enneagramWeights), 0);
    const mbtiCertainty = Math.round((mbtiTop / totalEvals) * 100);
    const enneagramCertainty = Math.round((enneaTop / totalEvals) * 100);
    const overallCertainty = Math.round((mbtiCertainty + enneagramCertainty) / 2);

    return {
        mbtiType,
        enneagramType: topEnnea,
        mbtiCertainty,
        enneagramCertainty,
        overallCertainty,
        combinedMbti,
        combinedEnneagram
    };
}

async function calculateFinalProfile(code) {
    try {
        const { data: user, error: userError } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score')
            .eq('code', code)
            .single();
        if (userError || !user) {
            console.error('Utilisateur introuvable pour ce code :', code, userError);
            return null;
        }
        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);
        if (evalError) {
            console.error('Erreur lors de la r√©cup√©ration des √©valuations externes :', evalError);
            return null;
        }
        if (!evaluations || evaluations.length === 0) {
            return { user, evaluations: [] };
        }

        const weighted = computeWeightedResults(evaluations);
        const overallCertainty = weighted.overallCertainty;

        await supabase
            .from('users')
            .update({
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                certainty_score: overallCertainty,
                mbti_scores: weighted.combinedMbti,
                enneagram_scores: weighted.combinedEnneagram
            })
            .eq('code', code);

        return {
            user: {
                id: user.id,
                code,
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                mbti_scores: weighted.combinedMbti,
                enneagram_scores: weighted.combinedEnneagram,
                certainty_score: overallCertainty
            },
            evaluations,
            mbtiCertainty: weighted.mbtiCertainty,
            enneagramCertainty: weighted.enneagramCertainty,
            overallCertainty
        };
    } catch (err) {
        console.error('Erreur lors du calcul du profil final :', err);
        return null;
    }
}

async function fetchUserProfileFromSupabase(code) {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score')
            .eq('code', code);

        if (error) {
            console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur :', error);
            return null;
        }

        if (!data || data.length === 0) {
            return null;
        }

        const user = data[0];

        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);

        if (evalError) {
            console.error('Erreur lors de la r√©cup√©ration des √©valuations externes :', evalError);
        }

        return { user, evaluations: evaluations || [] };
    } catch (err) {
        console.error('Exception lors de la r√©cup√©ration du profil :', err);
        return null;
    }
}

async function calculateResults() {
    console.log("Bouton Terminer cliqu√©");
    const mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
    const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
    
    Object.keys(answers).forEach(questionId => {
        const questionIndex = parseInt(questionId) - 1;
        const answerIndex = answers[questionId];
        const question = AUTO_QUESTIONS[questionIndex];
        const selectedOption = question.options[answerIndex];
        
        Object.keys(selectedOption.mbti).forEach(trait => {
            mbtiScores[trait] += selectedOption.mbti[trait];
        });
        
        Object.keys(selectedOption.enneagram).forEach(type => {
            enneagramScores[type] += selectedOption.enneagram[type];
        });
    });
    
    const mbtiType = 
        (mbtiScores.E > mbtiScores.I ? 'E' : 'I') +
        (mbtiScores.S > mbtiScores.N ? 'S' : 'N') +
        (mbtiScores.T > mbtiScores.F ? 'T' : 'F') +
        (mbtiScores.J > mbtiScores.P ? 'J' : 'P');
    
    const enneagramType = Object.keys(enneagramScores).reduce((a, b) => 
        enneagramScores[a] > enneagramScores[b] ? a : b
    );
    
    const mbtiPairs = [
        ['E', 'I'],
        ['S', 'N'],
        ['T', 'F'],
        ['J', 'P']
    ];
    let mbtiCertaintySum = 0;
    mbtiPairs.forEach(([a, b]) => {
        const pairTotal = mbtiScores[a] + mbtiScores[b];
        if (pairTotal > 0) {
            mbtiCertaintySum += Math.abs(mbtiScores[a] - mbtiScores[b]) / pairTotal;
        }
    });
    const mbtiCertainty = Math.min(95, Math.round((mbtiCertaintySum / mbtiPairs.length) * 100));

    const totalEnneagramScore = Object.values(enneagramScores).reduce((a, b) => a + b, 0);
    const enneagramCertainty = totalEnneagramScore
        ? Math.min(95, Math.round((enneagramScores[enneagramType] / totalEnneagramScore) * 100))
        : 0;

    const certaintyScore = Math.round((mbtiCertainty + enneagramCertainty) / 2);
    
    const uniqueCode = genererUniqueCode();
    
    const userProfile = {
        code: uniqueCode,
        mbtiType,
        enneagramType,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores,
        enneagramScores,
        timestamp: Date.now()
    };

    await saveUserProfileToSupabase(userProfile);
    localStorage.setItem('userProfile_' + uniqueCode, JSON.stringify(userProfile));
    
    displayResults({
        code: uniqueCode,
        mbtiType,
        enneagramType,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores,
        enneagramScores
    });
}

function displayResults(results) {
    const resultsHTML = generateResultsHTML(results);
    
    const resultsSection = document.createElement('div');
    resultsSection.className = 'bg-blue-50 py-16 px-4 sm:px-6 lg:px-8';
    resultsSection.innerHTML = resultsHTML;
    
    const autoEvalSection = document.getElementById('home-mbti');
    if (autoEvalSection) {
        autoEvalSection.parentNode.insertBefore(resultsSection, autoEvalSection.nextSibling);
        initCountUp(resultsSection);
        addPDFDownloadHandler(resultsSection);

        setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    localStorage.setItem('personalityTestResults', JSON.stringify(results));
    localStorage.removeItem('personalityTestProgress');
}

        // G√©n√©ration du HTML des r√©sultats
        function generateResultsHTML(results) {
            const mbtiDescriptions = {
                'INTJ': 'L\'Architecte - Visionnaires strat√©giques avec un plan pour tout.',
                'INTP': 'Le Penseur - Penseurs logiques et cr√©atifs, toujours √† la recherche de nouvelles id√©es.',
                'ENTJ': 'Le Commandant - Leaders naturels, charismatiques et d√©termin√©s.',
                'ENTP': 'L\'Innovateur - Inventifs et curieux, excellents pour trouver des solutions originales.',
                'INFJ': 'L\'Avocat - Id√©alistes cr√©atifs et perspicaces, motiv√©s par leurs valeurs profondes.',
                'INFP': 'Le M√©diateur - Po√©tiques, gentils et altruistes, toujours d√©sireux d\'aider.',
                'ENFJ': 'Le Donateur - Charismatiques et empathiques, motiv√©s par le d√©sir d\'aider les autres.',
                'ENFP': 'L\'Inspirateur - Enthousiastes, cr√©atifs et sociables, toujours √† la recherche de nouvelles exp√©riences.',
                'ISTJ': 'Le Logisticien - Pratiques et factuels, fiables et responsables.',
                'ISFJ': 'Le Protecteur - Chaleureux et consciencieux, toujours pr√™ts √† prot√©ger leurs proches.',
                'ESTJ': 'L\'Ex√©cutif - Excellents administrateurs, incomparables pour g√©rer avec efficacit√©.',
                'ESFJ': 'Le Consul - Extraordinairement attentionn√©s, sociables et populaires.',
                'ISTP': 'Le Virtuose - M√©caniciens audacieux et pratiques, ma√Ætres de tous les types d\'outils.',
                'ISFP': 'L\'Aventurier - Artistes flexibles et charmants, toujours pr√™ts √† explorer.',
                'ESTP': 'L\'Entrepreneur - Intelligents, √©nergiques et tr√®s perceptifs.',
                'ESFP': 'L\'Amuseur - Spontan√©s, √©nergiques et enthousiastes.'
            };
            
            const enneagramDescriptions = {
                '1': 'Le Perfectionniste - Motiv√© par le besoin de vivre correctement et d\'am√©liorer le monde.',
                '2': 'L\'Altruiste - Motiv√© par le besoin d\'√™tre aim√© et d\'aider les autres.',
                '3': 'Le B√¢tisseur - Motiv√© par le besoin de r√©ussir et d\'√™tre reconnu.',
                '4': 'L\'Artiste - Motiv√© par le besoin d\'exprimer son authenticit√© unique.',
                '5': 'L\'Investigateur - Motiv√© par le besoin de comprendre le monde.',
                '6': 'Le Loyaliste - Motiv√© par le besoin de s√©curit√© et de soutien.',
                '7': 'L\'Enthousiaste - Motiv√© par le besoin de maintenir le bonheur et l\'enthousiasme.',
                '8': 'Le Challenger - Motiv√© par le besoin d\'√™tre autonome et de contr√¥ler sa vie.',
                '9': 'Le M√©diateur - Motiv√© par le besoin de maintenir la paix int√©rieure et ext√©rieure.'
            };
            
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                            Vos r√©sultats
                        </h2>
                        <p class="mt-4 text-xl text-gray-600">
                            Voici votre profil de personnalit√© bas√© sur vos r√©ponses
                        </p>
                    </div>
                    
                    <div class="mt-12 bg-white shadow-xl rounded-lg overflow-hidden">
                        <div class="px-6 py-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900">Votre profil</h3>
                                    <p class="mt-1 text-gray-500">Analyse compl√©t√©e le ${new Date().toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div class="mt-4 md:mt-0">
                                    <span class="personality-badge bg-green-100 text-green-800">${results.mbtiType}</span>
                                    <span class="personality-badge bg-blue-100 text-blue-800 ml-2">Type ${results.enneagramType}</span>
                                </div>
                            </div>
                            
                            <!-- Code unique pour partage -->
                            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-medium text-blue-900">Votre code unique</h4>
                                        <p class="text-sm text-blue-700 mt-1">Partagez ce code avec vos proches pour qu'ils puissent vous √©valuer</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="bg-white border-2 border-blue-300 rounded-lg px-4 py-2">
                                            <span class="text-2xl font-bold text-blue-900 tracking-wider" id="unique-code">${results.code}</span>
                                        </div>
                                        <button onclick="copyCode('${results.code}')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                            <i class="fas fa-copy mr-1"></i> Copier
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                         <div class="pc-info-banner" role="note" aria-live="polite" style="text-align: center;">
  Voici les profils avec lesquels vous vous identifiez. Partagez votre code unique √† 3 proches, puis consultez vos r√©sultats d√©taill√©s dans la section 
  <strong>¬´ Mon profil ¬ª</strong> ou <strong>¬´ Retrouver un profil ¬ª</strong>.
</div>


                            <div class="mt-8 grid grid-cols-1 gap-8 md:grid-cols-2">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900">Profil MBTI</h4>
                                    <div class="mt-4 bg-green-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">${results.mbtiType}</p>
                                        <p class="text-gray-600 text-sm mt-1">${mbtiDescriptions[results.mbtiType]}</p>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-lg font-medium text-gray-900">Profil Enn√©agramme</h4>
                                    <div class="mt-4 bg-blue-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">Type ${results.enneagramType}</p>
                                        <p class="text-gray-600 text-sm mt-1">${enneagramDescriptions[results.enneagramType]}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 flex flex-wrap justify-center gap-4">
                                <button onclick="shareCode()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                    <i class="fas fa-share mr-2"></i> Partager
                                </button>
                                <button class="download-pdf-btn inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-download mr-2"></i> T√©l√©charger PDF
                                </button>
                                <button onclick="restartTest()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-redo mr-2"></i> Refaire le test
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fonctions utilitaires
        function initCountUp(root = document) {
            const elements = root.querySelectorAll('.countup');
            if (!elements.length) return;
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const endVal = parseFloat(el.dataset.value) || 0;
                        const suffix = el.dataset.suffix || '';
                        const counter = new CountUp(el, endVal, { duration: 1.5, suffix });
                        if (!counter.error) {
                            counter.start();
                        } else {
                            console.error(counter.error);
                        }
                        obs.unobserve(el);
                    }
                });
            }, { threshold: 0.5 });

            elements.forEach(el => {
                const suffix = el.dataset.suffix || '';
                el.textContent = '0' + suffix;
                observer.observe(el);
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                // Changer temporairement le texte du bouton
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i> Copi√© !';
                button.classList.remove('bg-black', 'hover:bg-gray-800');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-black', 'hover:bg-gray-800');
                }, 2000);
            }).catch(() => {
                alert('Code copi√© : ' + code);
            });
        }

        function restartTest() {
            if (confirm('√ätes-vous s√ªr de vouloir recommencer le test ? Vos r√©ponses actuelles seront perdues.')) {
                localStorage.removeItem('personalityTestProgress');
                localStorage.removeItem('personalityTestResults');
                currentQuestionIndex = 0;
                answers = {};
                
                // Supprimer la section des r√©sultats si elle existe
                const resultsSection = document.querySelector('.bg-blue-50');
                if (resultsSection && resultsSection.innerHTML.includes('Vos r√©sultats')) {
                    resultsSection.remove();
                }
                
                displayQuestion(0);
            }
        }

        function startEvaluationTest(relation) {
            alert(`√âvaluation pour un ${relation} - Fonctionnalit√© en cours de d√©veloppement`);
        }

        // Gestion des modales
        function showModal(title, content) {
            const modalContainer = document.getElementById('modal-container');
            const modalHTML = `
                <div class="modal show" id="current-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="text-xl font-bold text-gray-900">${title}</h2>
                            <span class="close" onclick="closeModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            
            // Fermer avec ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
            
            // Fermer en cliquant √† l'ext√©rieur
            document.getElementById('current-modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        function closeModal() {
            const modal = document.getElementById('current-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }

        // Descriptions d√©taill√©es MBTI
        const mbtiDetailedDescriptions = {
            'INTJ': {
                title: 'INTJ - L\'Architecte',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTJ sont des visionnaires strat√©giques avec un plan pour tout. Ils sont ind√©pendants, d√©termin√©s et ont une forte capacit√© √† voir les possibilit√©s futures.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Penseurs strat√©giques et visionnaires</li>
                            <li>Ind√©pendants et autonomes</li>
                            <li>Orient√©s vers les objectifs √† long terme</li>
                            <li>Excellents planificateurs</li>
                            <li>Pr√©f√®rent travailler seuls ou en petits groupes</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Architecte, ing√©nieur, scientifique, consultant en strat√©gie, d√©veloppeur de logiciels, chercheur.</p>
                    </div>
                `
            },
            'INTP': {
                title: 'INTP - Le Penseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTP sont des penseurs logiques et cr√©atifs, toujours √† la recherche de nouvelles id√©es et possibilit√©s th√©oriques.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Analystes logiques et objectifs</li>
                            <li>Curieux et ouverts aux nouvelles id√©es</li>
                            <li>Ind√©pendants et flexibles</li>
                            <li>Excellents r√©solveurs de probl√®mes</li>
                            <li>Pr√©f√®rent la th√©orie √† la pratique</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Chercheur, philosophe, math√©maticien, programmeur, analyste, professeur d'universit√©.</p>
                    </div>
                `
            }
            ,
            'ISTJ': {
                title: 'ISTJ - Le Logisticien',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTJ sont s√©rieux et fiables. Ils respectent les r√®gles et traditions, travaillent m√©thodiquement et prennent leurs responsabilit√©s au s√©rieux. Leur approche est pragmatique et organis√©e.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Responsables, pratiques et factuels</li>
                            <li>Respectent les traditions et les structures √©tablies</li>
                            <li>Mettent l'accent sur la pr√©cision et la loyaut√©</li>
                            <li>Pr√©f√©rent la stabilit√© et la planification</li>
                            <li>Peuvent √™tre r√©serv√©s et rigides face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Comptable, auditeur, administrateur, officier militaire, juge, gestionnaire de projet.</p>
                    </div>
                `
            },
            'ISTP': {
                title: 'ISTP - Le Virtuose',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTP sont pragmatiques et analytiques. Ils aiment comprendre comment fonctionnent les choses et s'attaquer √† des probl√®mes concrets. Flexibles et observateurs, ils pr√©f√®rent apprendre par l'exp√©rience.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Calmes et r√©alistes</li>
                            <li>Analytiques et logiques</li>
                            <li>Aiment d√©monter et r√©parer des objets</li>
                            <li>S'adaptent rapidement aux situations de crise</li>
                            <li>Peuvent para√Ætre distants √©motionnellement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">M√©canicien, ing√©nieur, pilote, technicien, enqu√™teur.</p>
                    </div>
                `
            },
            'ISFJ': {
                title: 'ISFJ - Le Protecteur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFJ sont chaleureux et consciencieux. Ils veillent √† pr√©server l'harmonie et la s√©curit√© de leur entourage. Ils respectent les traditions et sont attentifs aux besoins des autres.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Bienveillants, loyaux et responsables</li>
                            <li>Organis√©s et m√©thodiques</li>
                            <li>Souvent modestes et discrets</li>
                            <li>Se soucient des besoins des autres avant les leurs</li>
                            <li>Peuvent √™tre r√©ticents face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, biblioth√©caire, assistant social, gestionnaire administratif.</p>
                    </div>
                `
            },
            'ISFP': {
                title: 'ISFP - L\'Aventurier',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFP sont sensibles, discrets et artistiques. Ils appr√©cient l'harmonie, la beaut√© et la libert√© de s'exprimer. Ils vivent l‚Äôinstant pr√©sent et recherchent l'√©quilibre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Cr√©atifs et artistiques</li>
                            <li>Empathiques et chaleureux</li>
                            <li>Discrets et r√©serv√©s</li>
                            <li>Appr√©cient la libert√© et l‚Äôind√©pendance</li>
                            <li>Peuvent √©viter les conflits et les planifications rigides</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Artiste, designer, photographe, chef cuisinier, travailleur social.</p>
                    </div>
                `
            },
            'INFJ': {
                title: 'INFJ - L\'Avocat',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFJ sont perspicaces et id√©alistes. Ils sont guid√©s par leurs valeurs et cherchent √† comprendre les motivations profondes des autres. Ils sont cr√©atifs et se consacrent √† aider autrui.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Visionnaires et orient√©s vers un sens profond</li>
                            <li>Empathiques et compatissants</li>
                            <li>Cr√©atifs et originaux</li>
                            <li>Organis√©s et d√©termin√©s</li>
                            <li>Peuvent se sentir incompris ou retir√©s</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Conseiller, psychologue, √©crivain, enseignant, humanitaire.</p>
                    </div>
                `
            },
            'INFP': {
                title: 'INFP - Le M√©diateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFP sont id√©alistes et empathiques. Guid√©s par leurs valeurs, ils cherchent un sens profond √† la vie et s‚Äôefforcent de rendre le monde meilleur. Ils sont cr√©atifs et sensibles.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Id√©alistes et guid√©s par leurs valeurs</li>
                            <li>Empathiques et compatissants</li>
                            <li>Cr√©atifs et expressifs</li>
                            <li>Aiment l'authenticit√© et l'individualit√©</li>
                            <li>Peuvent √™tre r√©serv√©s et √©viter les conflits</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">√âcrivain, psychologue, conseiller, artiste, musicien.</p>
                    </div>
                `
            },
            'ENTJ': {
                title: 'ENTJ - Le Commandant',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTJ sont des leaders n√©s, charismatiques et logiques. Ils aiment structurer des organisations, planifier l'avenir et relever des d√©fis. Ils sont d√©termin√©s et ax√©s sur l‚Äôefficacit√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Leaders strat√©giques et assertifs</li>
                            <li>D√©cisifs et organis√©s</li>
                            <li>Adeptes de la planification et de l'ex√©cution</li>
                            <li>Orient√©s vers les objectifs et la r√©ussite</li>
                            <li>Peuvent para√Ætre autoritaires ou impatients</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Directeur g√©n√©ral, avocat, chef de projet, politicien, entrepreneur.</p>
                    </div>
                `
            },
            'ENTP': {
                title: 'ENTP - L\'Innovateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTP sont cr√©atifs et curieux. Ils aiment explorer de nouvelles id√©es, d√©battre et remettre en question le statu quo. Flexibles, ils pr√©f√®rent les possibilit√©s ouvertes aux routines strictes.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Inventifs et plein d'esprit</li>
                            <li>Aiment d√©battre et argumenter</li>
                            <li>S'adaptent rapidement √† de nouveaux concepts</li>
                            <li>Aiment les d√©fis intellectuels</li>
                            <li>Peuvent s'ennuyer avec la routine et la gestion des d√©tails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Avocat, consultant, entrepreneur, inventeur, journaliste.</p>
                    </div>
                `
            },
            'ENFJ': {
                title: 'ENFJ - Le Donateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFJ sont charismatiques et attentifs aux autres. Ils comprennent intuitivement les besoins des gens et aiment motiver et inspirer. Ils recherchent l‚Äôharmonie et le d√©veloppement personnel et collectif.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux, empathiques et organis√©s</li>
                            <li>Communicateurs naturels</li>
                            <li>Aident les autres √† r√©aliser leur potentiel</li>
                            <li>Orient√©s vers les valeurs et l'harmonie</li>
                            <li>Peuvent s'oublier au profit des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Professeur, coach, psychologue, coordinateur d‚Äô√©v√©nements, diplomate.</p>
                    </div>
                `
            },
            'ENFP': {
                title: 'ENFP - L\'Inspirateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFP sont enthousiastes et cr√©atifs. Ils s‚Äô√©panouissent dans l'exploration de nouvelles id√©es et inspirent les autres gr√¢ce √† leur vision optimiste. Ils cherchent l‚Äôauthenticit√© et la libert√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>√ânerg√©tiques et imaginatifs</li>
                            <li>Empathiques et communicatifs</li>
                            <li>S'√©panouissent dans les relations</li>
                            <li>Aiment l'innovation et la diversit√©</li>
                            <li>Peuvent se disperser et n√©gliger les d√©tails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Journaliste, conseiller, animateur, auteur, professionnel des relations publiques.</p>
                    </div>
                `
            },
            'ESTP': {
                title: 'ESTP - L\'Entrepreneur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTP sont √©nergiques et orient√©s vers l'action. Ils aiment vivre l'instant pr√©sent et r√©soudre des situations concr√®tes. Adaptables et sociables, ils prennent des d√©cisions rapides.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Dynamiques et aventuriers</li>
                            <li>Pragmatiques et r√©alistes</li>
                            <li>Orient√©s vers les r√©sultats imm√©diats</li>
                            <li>Bons communicateurs et n√©gociateurs</li>
                            <li>Peuvent se montrer impatients et risquer l'impulsivit√©</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Entrepreneur, d√©tective, pilote, vendeur, pompier.</p>
                    </div>
                `
            },
            'ESTJ': {
                title: 'ESTJ - L\'Ex√©cutif',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTJ sont organis√©s et directs. Ils se fient aux faits et aiment structurer les activit√©s pour obtenir des r√©sultats efficaces. Ils valorisent la tradition et l‚Äôordre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Pragmatiques et responsables</li>
                            <li>Directs et orient√©s vers l'action</li>
                            <li>Logiques et objectifs</li>
                            <li>Aiment organiser et diriger</li>
                            <li>Peuvent √™tre inflexibles ou autoritaires</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Gestionnaire, officier militaire, policier, juge, chef de projet.</p>
                    </div>
                `
            },
            'ESFP': {
                title: 'ESFP - L\'Amuseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFP sont spontan√©s et sociables. Ils aiment profiter de la vie et attirer l'attention. Pratiques et chaleureux, ils encouragent les autres √† vivre pleinement chaque moment.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Sociables et enthousiastes</li>
                            <li>Spontan√©s et √©nergiques</li>
                            <li>Aiment le divertissement et la vari√©t√©</li>
                            <li>Observateurs et pratiques</li>
                            <li>Peuvent √™tre sensibles aux critiques et √©viter la planification</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Acteur, animateur, h√¥te, vendeur, infirmier p√©diatrique.</p>
                    </div>
                `
            },
            'ESFJ': {
                title: 'ESFJ - Le Consul',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFJ sont aimables et sociables. Ils prennent soin des autres et veillent √† maintenir l'harmonie. Organis√©s et consciencieux, ils travaillent pour soutenir leur communaut√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux et serviables</li>
                            <li>Organis√©s et responsables</li>
                            <li>Centr√©s sur la communaut√© et la tradition</li>
                            <li>Communicateurs empathiques</li>
                            <li>Peuvent √™tre sensibles √† la critique et rechercher l'approbation</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, gestionnaire d'√©v√©nements, conseiller, travailleur social.</p>
                    </div>
                `
            }
        };

        // Descriptions d√©taill√©es Enn√©agramme
        const enneagramDetailedDescriptions = {
            '1': {
                title: 'Type 1 - Le Perfectionniste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type 1 sont motiv√©s par le besoin de vivre correctement, d'am√©liorer le monde et d'√©viter la col√®re.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre corrompu, d√©fectueux ou mauvais</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre bon, vertueux et parfait</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Id√©alistes et responsables</li>
                            <li>Fort sens moral et √©thique</li>
                            <li>Perfectionnistes et critiques</li>
                            <li>Organis√©s et m√©thodiques</li>
                            <li>Peuvent √™tre rigides et col√©riques</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Sages, discernants, r√©alistes et nobles. Peuvent √™tre moralement h√©ro√Øques.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Deviennent critiques, perfectionnistes et peuvent exploser de col√®re.</p>
                    </div>
                `
            },
            '2': {
                title: 'Type 2 - L\'Altruiste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†2 sont motiv√©s par le besoin d'√™tre aim√©s et n√©cessaires. Ils sont empathiques, chaleureux et g√©n√©reux, mais peuvent devenir possessifs et trop ax√©s sur la reconnaissance.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas √™tre aim√©s ou √™tre inutiles</p>
                            <p><strong>D√©sir fondamental :</strong> Se sentir appr√©ci√©s, aim√©s et n√©cessaires</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Empathiques et chaleureux</li>
                            <li>Serviables et g√©n√©reux</li>
                            <li>Adapt√©s aux besoins des autres</li>
                            <li>Peuvent √™tre d√©pendants de la reconnaissance</li>
                            <li>Parfois possessifs ou envahissants</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont altruistes, aimants et d√©sint√©ress√©s. Ils soutiennent les autres de mani√®re authentique sans attendre de retour.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir envahissants, ressentir de la jalousie et s'√©puiser en donnant trop.</p>
                    </div>
                `
            },
            '3': {
                title: 'Type 3 - Le B√¢tisseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†3 sont motiv√©s par le besoin de r√©ussir et d'√™tre admir√©s. Ambitieux et √©nergiques, ils sont adaptables et conscients de leur image, mais peuvent devenir pr√©occup√©s par leur statut.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas avoir de valeur personnelle</p>
                            <p><strong>D√©sir fondamental :</strong> Se sentir pr√©cieux et admir√© pour leurs r√©alisations</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Ambitieux et charismatiques</li>
                            <li>Efficaces et comp√©titifs</li>
                            <li>Flexibles et orient√©s vers les objectifs</li>
                            <li>Tr√®s conscients de leur image</li>
                            <li>Peuvent n√©gliger leurs √©motions ou celles des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont authentiques, inspirants et encouragent les autres √† r√©ussir. Ils assument leurs valeurs personnelles plut√¥t que de rechercher uniquement la reconnaissance.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir obs√©d√©s par leur image, ignorer leurs besoins √©motionnels et craindre l'√©chec.</p>
                    </div>
                `
            },
            '4': {
                title: 'Type 4 - L\'Artiste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†4 recherchent l'authenticit√© et un sens personnel. Sensibles et cr√©atifs, ils veulent √™tre compris et exprimer leur individualit√©. Ils peuvent √™tre introspectifs et parfois m√©lancoliques.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas avoir d'identit√© ou de valeur personnelle</p>
                            <p><strong>D√©sir fondamental :</strong> Trouver leur v√©ritable identit√© et s'exprimer de mani√®re authentique</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Sensibles et introspectifs</li>
                            <li>Cr√©atifs et expressifs</li>
                            <li>Appr√©cient la profondeur et l'authenticit√©</li>
                            <li>Peuvent √™tre m√©lancoliques et se sentir diff√©rents</li>
                            <li>Recherchent souvent un sens et une connexion profonde</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont hautement cr√©atifs, inspir√©s et capables de transformer leur exp√©rience personnelle en quelque chose d'universel.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent se sentir incompris, se retirer et devenir auto‚Äëindulgents ou envieux des autres.</p>
                    </div>
                `
            },
            '5': {
                title: 'Type 5 - L\'Investigateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†5 veulent comprendre le monde. Ils sont observateurs, innovants et autonomes. Ils peuvent se retirer pour pr√©server leur √©nergie et d√©velopper leurs connaissances.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre impuissant, inutile ou incapable</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre comp√©tent et comprendre l'environnement</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Observateurs et analytiques</li>
                            <li>Innovants et cr√©atifs</li>
                            <li>Ind√©pendants et r√©serv√©s</li>
                            <li>Recherchent la ma√Ætrise de leurs domaines d'int√©r√™t</li>
                            <li>Peuvent se couper de leurs √©motions ou des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont visionnaires, pionniers et apportent des id√©es novatrices qui am√©liorent la soci√©t√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir d√©tach√©s, trop rationnels et √©viter la participation sociale.</p>
                    </div>
                `
            },
            '6': {
                title: 'Type 6 - Le Loyaliste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†6 recherchent la s√©curit√© et la confiance. Loyaux et fiables, ils anticipent les probl√®mes et recherchent le soutien. Ils peuvent osciller entre la prudence et l'audace.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre sans soutien ou sans direction</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre en s√©curit√© et soutenu</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Fiables et d√©vou√©s</li>
                            <li>Consciencieux et travailleurs</li>
                            <li>Tendance √† anticiper les probl√®mes</li>
                            <li>Peuvent osciller entre doute et confiance</li>
                            <li>Parfois anxieux ou sceptiques</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont courageux, engag√©s et se mettent au service d'une cause plus grande qu'eux.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir m√©fiants, autoritaires ou excessivement anxieux.</p>
                    </div>
                `
            },
            '7': {
                title: 'Type 7 - L\'Enthousiaste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†7 sont optimistes et aventuriers. Ils recherchent des exp√©riences stimulantes et veulent √©viter la douleur et l'ennui. Souvent joyeux, ils peuvent se disperser.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre priv√©s ou coinc√©s dans la souffrance</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre heureux, satisfaits et libres</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Extravertis et optimistes</li>
                            <li>Polyvalents et spontan√©s</li>
                            <li>Curieux et enthousiastes</li>
                            <li>Aiment planifier des projets et des voyages</li>
                            <li>Peuvent √™tre dispers√©s ou √©viter la douleur √† tout prix</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils canaliseront leur √©nergie dans des objectifs significatifs et appr√©cieront la simplicit√© et la gratitude.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent fuir les responsabilit√©s, se disperser ou chercher des distractions excessives.</p>
                    </div>
                `
            },
            '8': {
                title: 'Type 8 - Le Challenger',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†8 valorisent l'ind√©pendance et la protection. Ils sont confiants, forts et veulent se prot√©ger et prot√©ger les autres. Ils peuvent devenir dominants s'ils se sentent menac√©s.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre bless√©s ou contr√¥l√©s par autrui</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre ma√Ætres de leur vie et prot√©ger les faibles</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Assertifs et d√©cisifs</li>
                            <li>Confiants et protecteurs</li>
                            <li>Dirigeants naturels</li>
                            <li>D√©fendent leurs convictions</li>
                            <li>Peuvent √™tre contr√¥lants ou impulsifs</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils utilisent leur force pour am√©liorer le monde et prot√©ger les vuln√©rables. Ils sont magnanimes et courageux.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir dominateurs, se m√©fier des autres et r√©agir avec col√®re.</p>
                    </div>
                `
            },
            '9': {
                title: 'Type 9 - Le M√©diateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†9 recherchent la paix int√©rieure et ext√©rieure. Ils sont r√©ceptifs, conciliants et stables. Ils fuient les conflits et peuvent devenir complaisants pour pr√©server l'harmonie.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-teal-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Perdre la connexion ou √™tre s√©par√© des autres</p>
                            <p><strong>D√©sir fondamental :</strong> Maintenir la paix et l'harmonie</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>R√©ceptifs et rassurants</li>
                            <li>Stables et accommodants</li>
                            <li>M√©diateurs naturels</li>
                            <li>√âvitent les conflits et la prise de d√©cision</li>
                            <li>Peuvent devenir complaisants ou inertes</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils apportent la paix et la coh√©sion, aident les autres √† coop√©rer et deviennent des sources d'unit√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent ignorer leurs propres besoins, √©viter les conflits et se dissocier √©motionnellement.</p>
                    </div>
                `
            }
        };

        // Fonctions pour afficher les d√©tails
        function showMBTIDetails(type) {
            const details = mbtiDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`${type} - Description`, `<p>Description d√©taill√©e du type ${type} en cours de d√©veloppement.</p>`);
            }
        }

        function showEnneagramDetails(type) {
            const details = enneagramDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`Type ${type} - Description`, `<p>Description d√©taill√©e du type ${type} en cours de d√©veloppement.</p>`);
            }
        }

        function showAboutProject() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-700">"Personnalit√© Compar√©e" est n√© de la volont√© de cr√©er un outil plus objectif pour comprendre sa personnalit√©.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Notre approche unique :</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-eye text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Vision objective</h4>
                            <p class="text-sm text-gray-600">Combiner plusieurs perspectives pour une analyse plus compl√®te</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-shield-alt text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Confidentialit√©</h4>
                            <p class="text-sm text-gray-600">Vos donn√©es sont prot√©g√©es et ne sont jamais partag√©es</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <i class="fas fa-graduation-cap text-green-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Base scientifique</h4>
                            <p class="text-sm text-gray-600">Fond√© sur les recherches en psychologie de la personnalit√©</p>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Pourquoi cette approche ?</h3>
                    <p class="text-gray-700">Contrairement aux tests traditionnels qui reposent uniquement sur l'auto-√©valuation, notre approche combine votre perception avec celle de votre entourage pour un r√©sultat plus nuanc√© et fid√®le.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Comment √ßa marche ?</h3>
                    <ol class="list-decimal list-inside text-gray-700 space-y-1">
                        <li>Vous r√©pondez √† 16 questions d'auto-√©valuation</li>
                        <li>Vous partagez votre code unique avec vos proches</li>
                        <li>Ils r√©pondent √† 20 questions sur votre personnalit√©</li>
                        <li>Notre algorithme combine toutes les r√©ponses avec une pond√©ration scientifique</li>
                        <li>Vous obtenez votre profil MBTI et Enn√©agramme avec un score de certitude</li>
                    </ol>
                </div>
            `;
            showModal('√Ä propos du projet', content);
        }

        // Fonctions pour les pages l√©gales et contact



        // Fonction pour d√©marrer l'√©valuation externe
        function startExternalEvaluation() {
            const codeInput = document.querySelector('input[placeholder="Ex: ABC123"]');
            const relationInputs = document.querySelectorAll('input[name="relation"]');
            
            if (!codeInput || !codeInput.value.trim()) {
                alert('Veuillez entrer le code unique de la personne √† √©valuer.');
                return;
            }
            
            let selectedRelation = null;
            relationInputs.forEach(input => {
                if (input.checked) {
                    selectedRelation = input.value;
                }
            });
            
            if (!selectedRelation) {
                alert('Veuillez s√©lectionner votre relation avec cette personne.');
                return;
            }
            
            // Sauvegarder les informations de l'√©valuation externe
            localStorage.setItem('externalEvaluationCode', codeInput.value.trim().toUpperCase());
            localStorage.setItem('externalEvaluationRelation', selectedRelation);
            
            // Ouvrir les questions d'√©valuation externe dans une fen√™tre modale
            showExternalEvaluationQuestions();
        }

        // Fonction pour afficher les questions d'√©valuation externe
        function showExternalEvaluationQuestions() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');
            
            const relationLabels = {
                'family': 'Membre de la famille',
                'partner': 'Partenaire amoureux',
                'friend': 'Ami(e)',
                'colleague': 'Coll√®gue de travail'
            };
            
            const content = `
                <div class="max-w-4xl mx-auto">
<div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-white">√âvaluation externe</h2>
                                <p class="text-blue-100 mt-1">Code: ${code} | Relation: ${relationLabels[relation]}</p>
                            </div>
                            <span class="close" onclick="closeModal()" style="color: white;">&times;</span>
                        </div>
                        <div class="p-6">
                            <form id="eval-form">
                                <div id="external-questions-content">
                                    <!-- Les questions seront ajout√©es ici -->
                                </div>
                                <div class="mt-6 flex justify-between">
                                    <button type="button" id="prev-external-question" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" style="display: none;">
                                        <i class="fas fa-arrow-left mr-2"></i> Question pr√©c√©dente
                                    </button>
                                    <button type="button" id="next-external-question" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                        Question suivante <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                    <button type="submit" id="submit-eval" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" style="display: none;">
                                        <i class="fas fa-check mr-2"></i> Terminer l'√©valuation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            showModal('', content);

            // Masquer l'en-t√™te par d√©faut de la modale et ajuster la taille
            const defaultHeader = document.querySelector('#current-modal .modal-header');
            if (defaultHeader) defaultHeader.style.display = 'none';

            const modalContent = document.querySelector('#current-modal .modal-content');
            if (modalContent) {
                modalContent.style.maxWidth = '900px';
                modalContent.style.width = '90%';
                modalContent.style.padding = '0';
            }

            // Initialiser les questions externes
            currentExternalQuestionIndex = 0;
            externalAnswers = {};
            displayExternalQuestion(0);
            setupExternalQuestionNavigation();
            setupEvalFormSubmit();
        }
        
        // Variables pour l'√©valuation externe
        let currentExternalQuestionIndex = 0;
        let externalAnswers = {};
        
        // Questions pour l'√©valuation externe (20 questions)
        // Ajout de l'option "Je ne sais pas" √† chaque question d'√©valuation externe
        EXTERNAL_QUESTIONS.forEach(q => {
            q.options.push({ text: "Je ne sais pas", functions: {}, enneagram: {} });
        });

        // Fonction pour afficher une question externe
        function displayExternalQuestion(index) {
            const question = EXTERNAL_QUESTIONS[index];
            if (!question) return;
            
            const progress = ((index + 1) / EXTERNAL_QUESTIONS.length) * 100;
            const questionsContent = document.getElementById('external-questions-content');
            
            questionsContent.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-medium text-blue-600">Question ${index + 1}/${EXTERNAL_QUESTIONS.length}</span>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <h3 class="text-xl font-medium text-gray-900 mb-6">${question.question}</h3>
                    
                    <div class="space-y-4">
                        ${question.options.map((option, optionIndex) => {
                            const value = optionIndex === question.options.length - 1 ? 0 : optionIndex + 1;
                            const extraClass = optionIndex === question.options.length - 1 ? ' mt-1' : '';
                            const dataChoice = value === 0 ? ' data-choice="unknown"' : '';
                            return `
                            <div class="flex items-start${extraClass}">
                                <input id="eq${question.id}-${optionIndex}" name="external_question${question.id}" type="radio" value="${value}"${dataChoice} class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 mt-1" ${externalAnswers[question.id] === value ? 'checked' : ''}>
                                <label for="eq${question.id}-${optionIndex}" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors">
                                    ${option.text}
                                </label>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;

            // √âcouter les changements de r√©ponse
            const radioButtons = questionsContent.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    externalAnswers[question.id] = parseInt(this.value);
                    updateExternalNavigationButtons();
                });
            });
            
            updateExternalNavigationButtons();
        }
        
        // Configuration de la navigation pour les questions externes
        function setupExternalQuestionNavigation() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentExternalQuestionIndex > 0) {
                        currentExternalQuestionIndex--;
                        displayExternalQuestion(currentExternalQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined) {
                        if (currentExternalQuestionIndex < EXTERNAL_QUESTIONS.length - 1) {
                            currentExternalQuestionIndex++;
                            displayExternalQuestion(currentExternalQuestionIndex);
                        }
                    } else {
                        alert('Veuillez s√©lectionner une r√©ponse avant de continuer.');
                    }
                });
            }
        }
        
        // Mise √† jour des boutons de navigation externes
        function updateExternalNavigationButtons() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            const finishButton = document.getElementById('submit-eval');

            if (prevButton) {
                prevButton.style.display = currentExternalQuestionIndex > 0 ? 'inline-flex' : 'none';
            }

            const isLastQuestion = currentExternalQuestionIndex === EXTERNAL_QUESTIONS.length - 1;
            const hasAnswer = externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined;

            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        function setupEvalFormSubmit() {
            const form = document.getElementById('eval-form');
            const btn = document.getElementById('submit-eval');
            if (!form || !btn) return;

            const statusEl = document.createElement('span');
            statusEl.className = 'sr-only';
            statusEl.setAttribute('aria-live', 'polite');
            btn.after(statusEl);

            function setLoadingState() {
                btn.disabled = true;
                btn.classList.remove('bg-green-500', 'bg-red-500');
                btn.innerHTML = '<span class="spinner"></span> Veuillez patienter, nous enregistrons vos r√©ponses...';
                statusEl.textContent = 'Enregistrement en cours...';
            }

            function setSuccessState() {
                btn.disabled = true;
                btn.classList.remove('bg-red-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-green-500', 'text-white');
                btn.innerHTML = 'Succ√®s ‚úÖ';
                statusEl.textContent = 'Enregistrement r√©ussi';
            }

            function setRetryState() {
                btn.disabled = false;
                btn.classList.remove('bg-green-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-500', 'text-white');
                btn.innerHTML = 'R√©essayer';
                statusEl.textContent = '√âchec, r√©essayez';
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (btn.disabled) return;
                if (Object.keys(externalAnswers).length !== EXTERNAL_QUESTIONS.length) {
                    alert('Veuillez r√©pondre √† toutes les questions avant de terminer.');
                    return;
                }
                setLoadingState();
                await new Promise(r => setTimeout(r, 0));

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);
                try {
                    await Promise.race([
                        submitExternalEvaluation(),
                        new Promise((_, reject) => {
                            controller.signal.addEventListener('abort', () => reject(new DOMException('Timeout', 'AbortError')));
                        })
                    ]);
                    setSuccessState();
                } catch (err) {
                    if (err.name === 'AbortError') {
                        alert('La requ√™te a expir√©. Veuillez r√©essayer.');
                    } else {
                        console.error(err);
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                    setRetryState();
                } finally {
                    clearTimeout(timeoutId);
                }
            }, { once: false });
        }

        // Fonction pour soumettre l'√©valuation externe
        async function submitExternalEvaluation() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');
            
            // Calculer les scores MBTI et Enn√©agramme pour cette √©valuation
            const mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
            Object.keys(externalAnswers).forEach(questionId => {
                const question = EXTERNAL_QUESTIONS.find(q => q.id === parseInt(questionId));
                const value = externalAnswers[questionId];
                if (value === 0) {
                    return;
                }
                const selectedOption = question.options[value - 1];
                // Ajouter les scores MBTI
                Object.keys(selectedOption.mbti).forEach(trait => {
                    mbtiScores[trait] += selectedOption.mbti[trait];
                });
                // Ajouter les scores Enn√©agramme
                Object.keys(selectedOption.enneagram).forEach(type => {
                    enneagramScores[type] += selectedOption.enneagram[type];
                });
            });
            // Enregistrer dans Supabase
            await saveExternalEvaluationToSupabase(code, relation, mbtiScores, enneagramScores);
            // Nettoyer le stockage local temporaire
            localStorage.removeItem('externalEvaluationCode');
            localStorage.removeItem('externalEvaluationRelation');
            // Afficher un message de confirmation
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                questionsContainer.innerHTML = '';
            }
            const modalHTML = `
                <div id="evaluation-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div id="evaluation-modal" class="bg-white rounded-lg shadow-lg p-8 max-w-md w-11/12 transform opacity-0 scale-95 transition-all duration-300">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <i class="fas fa-check text-green-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">√âvaluation termin√©e !</h2>
                        <p class="text-gray-600 mb-6">
                            Merci d'avoir pris le temps d'√©valuer cette personne. Votre √©valuation a √©t√© enregistr√©e avec le code <strong>${code}</strong>.
                        </p>
                        <p class="text-sm text-gray-500 mb-6">
                            La personne recevra ses r√©sultats complets une fois que toutes les √©valuations seront termin√©es.
                        </p>
                        <button id="close-evaluation-modal" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-home mr-2"></i> Retour √† l'accueil
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('evaluation-modal');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            });
            document.getElementById('close-evaluation-modal').addEventListener('click', () => {
                const overlay = document.getElementById('evaluation-modal-overlay');
                if (overlay) {
                    overlay.remove();
                }
                window.location.href = 'index.html';
            });
        }

        // Chargement de la progression au d√©marrage
        if (loadProgress()) {
            displayQuestion(currentQuestionIndex);
        }
        
        // Gestion du menu mobile
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.style.display === 'block';
                    
                    if (isOpen) {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.style.display = 'block';
                        menuIcon.className = 'fas fa-times';
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                });
                
                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
            }
        });
        
        // ===== ESPACE PERSONNEL =====
        
        // Base de donn√©es simul√©e des profils (non utilis√©e, conserv√©e pour r√©f√©rence)
        /* const profilesDatabase = {
            'ABC123': {
                name: 'Jean Dupont',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-15' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-16' },
                    { relation: 'Coll√®gue de travail', completed: false, completedAt: null }
                ],
                results: {
                    mbti: 'ENFJ',
                    enneagram: 'Type 2',
                    certainty: 91
                }
            },
            'XYZ789': {
                name: 'Marie Martin',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Partenaire amoureux', completed: true, completedAt: '2024-01-10' },
                    { relation: 'Ami(e)', completed: false, completedAt: null },
                    { relation: 'Membre de la famille', completed: false, completedAt: null }
                ],
                results: null
            },
            'DEF456': {
                name: 'Pierre Durand',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-12' },
                    { relation: 'Coll√®gue de travail', completed: true, completedAt: '2024-01-13' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-14' }
                ],
                results: {
                    mbti: 'INTJ',
                    enneagram: 'Type 5',
                    certainty: 87
                }
            }
        }; */

        // Fonctions de gestion de la modale
        function openProfileModal(prefillCode) {
            document.getElementById('profile-modal').classList.add('show');
            resetProfileModal();
            if (prefillCode) {
                const input = document.getElementById('profile-code');
                input.value = prefillCode.trim().toUpperCase();
                checkProfileCode();
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('show');
        }

        function resetProfileModal() {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'√©tape de saisie du code
            document.getElementById('code-input-step').style.display = 'block';
            
            // R√©initialiser le champ de saisie
            document.getElementById('profile-code').value = '';
        }

        async function checkProfileCode() {
            const code = document.getElementById('profile-code').value.trim().toUpperCase();

            if (!code) {
                alert('Veuillez entrer un code');
                return;
            }

            // R√©cup√©ration du profil via Supabase
            let result = await fetchUserProfileFromSupabase(code);
            console.log("üß† R√©sultat brut depuis Supabase :", result);
            console.log("üìò MBTI :", result.user?.mbti_type);
            console.log("üìó Enn√©agramme :", result.user?.enneagram_type);

            if (!result || !result.user) {
                // Afficher le message d'erreur
                document.querySelectorAll('.profile-step').forEach(step => {
                    step.style.display = 'none';
                });
                document.getElementById('error-message').style.display = 'block';
                return;
            }
            if (result.evaluations.length > 0) {
                const updated = await calculateFinalProfile(code);
                if (updated) {
                    result = updated;
                }
            }

            const { user, evaluations } = result;
            const overallCertainty = result.overallCertainty ?? user.certainty_score ?? null;
            // Construire un objet de profil simplifi√© compatible avec displayProfile
            const simplifiedProfile = {
                name: user.mbti_type && user.enneagram_type
                    ? `${user.mbti_type} ‚Äî type ${user.enneagram_type}`
                    : user.mbti_type || 'Profil',
                selfEvaluationCompleted: true,
                externalEvaluations: evaluations.map(ev => ({
                    relation: ev.relation,
                    completed: true,
                    completedAt: ev.created_at
                })),
                results: user.mbti_type && user.enneagram_type
                    ? {
                        mbti: user.mbti_type,
                        enneagram: user.enneagram_type,
                        certainty: overallCertainty
                    }
                    : null
            };
            displayProfile(code, simplifiedProfile);
        }

        function displayProfile(code, profile) {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'√©tape du statut
            document.getElementById('profile-status-step').style.display = 'block';
            
            // Remplir les informations du profil
            document.getElementById('profile-name').textContent = profile.name;
            document.getElementById('display-code').textContent = code;
            
            // Calculer le statut des √©valuations
            const completedEvaluations = profile.externalEvaluations.filter(ev => ev.completed).length;
            // Dans notre syst√®me, un minimum de trois √©valuations externes est requis
            const totalEvaluationsRequired = 3;
            const totalProgress = profile.selfEvaluationCompleted ? completedEvaluations + 1 : completedEvaluations;
            const maxProgress = totalEvaluationsRequired + 1; // +1 pour l'auto-√©valuation
            
            // Mettre √† jour le statut des √©valuations
            const evaluationsStatus = document.getElementById('evaluations-status');
            // Si toutes les √©valuations requises sont termin√©es, afficher le statut vert, sinon statut orange.
            if (completedEvaluations >= totalEvaluationsRequired) {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                evaluationsStatus.innerHTML = '<i class="fas fa-check mr-1"></i> Toutes termin√©es';
            } else {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                evaluationsStatus.innerHTML = `<i class="fas fa-clock mr-1"></i> ${completedEvaluations}/${totalEvaluationsRequired} termin√©es`;
            }
            
            // Mettre √† jour la barre de progression
            updateProgress(totalProgress, maxProgress);
            
            // Afficher le message selon le statut (3 √©valuations requises)
            displayStatusMessage(profile, completedEvaluations, 3);
        }




        async function viewResults(codeParam) {
            const userCode = (codeParam || document.getElementById('display-code').textContent)
                .trim()
                .toUpperCase();

            if (!userCode) {
                alert('Veuillez entrer un code');
                return;
            }

            const initial = await fetchUserProfileFromSupabase(userCode);

            if (!initial) {
                alert('Code introuvable');
                return;
            }

            if (initial.evaluations.length === 0) {
                alert('Au moins une √©valuation externe est n√©cessaire pour afficher le r√©sultat final.');
                return;
            }

            const selfProfile = getProfileFromScores(initial.user.mbti_scores || {}, initial.user.enneagram_scores || {});

            const result = await calculateFinalProfile(userCode);

            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Le r√©sultat final n‚Äôest pas encore pr√™t.');
                return;
            }

            const externalProfiles = result.evaluations.map(ev => {
                const { mbtiType, enneagramType } = getProfileFromScores(ev.mbti_scores, ev.enneagram_scores);
                const coherenceMBTI = getCoh√©renceMBTI(ev.mbti_scores);
                const coherenceEnneagramme = getCoh√©renceEnn√©agramme(ev.enneagram_scores);
                return {
                    relation: ev.relation,
                    mbti: mbtiType,
                    enneagram: enneagramType,
                    coherenceMBTI,
                    coherenceEnneagramme,
                    completed: true,
                    completedAt: ev.created_at
                };
            });
            const certaintyScore = result.overallCertainty ??
                (result.user.certainty_score != null ? Number(result.user.certainty_score) : null);
            const finalProfile = {
                uniqueCode: userCode,
                name: `${result.user.mbti_type} ‚Äî type ${result.user.enneagram_type}`,
                self: { mbti: selfProfile.mbtiType, enneagram: selfProfile.enneagramType },
                results: {
                    mbti: result.user.mbti_type,
                    mbtiCertainty: result.mbtiCertainty ?? certaintyScore,
                    enneagram: result.user.enneagram_type,
                    enneagramCertainty: result.enneagramCertainty ?? certaintyScore,
                    overallCertainty: certaintyScore
                },
                externalEvaluations: externalProfiles,
                mbtiScores: result.user.mbti_scores,
                enneagramScores: result.user.enneagram_scores,
                externalCount: result.evaluations.length
            };
            closeProfileModal();
            displayDetailedResults(finalProfile, userCode);
        }

        function displayDetailedResults(profile, code) {
            // Cr√©er une nouvelle modale pour les r√©sultats
            const resultsModal = document.createElement('div');
            resultsModal.id = 'results-modal';
            resultsModal.className = 'modal show';
            resultsModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="text-xl font-bold text-gray-900">R√©sultats D√©taill√©s - ${profile.name}</h2>
                        <span class="close" onclick="closeResultsModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-6">
                            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                                <i class="fas fa-chart-pie text-green-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Analyse Compl√®te</h3>
                            <p class="text-sm text-gray-500">Code: <span class="font-mono font-bold">${code}</span></p>
                        </div>

                        <!-- R√©sultats MBTI et Enn√©agramme -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-semibold text-blue-900 mb-2">Type MBTI</h4>
            <div class="text-2xl font-bold text-blue-600 mb-2">${profile.results.mbti}</div>
            <div class="mt-2">
              ${
                profile.results.mbtiCertainty != null
                  ? `<p class="mb-1">Certitude</p>
                     <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
                       <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-blue-500 transition-all duration-1000" data-width="${profile.results.mbtiCertainty}" style="width:0"></div>
                       <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.mbtiCertainty}%</span>
                     </div>`
                  : `<p>Certitude : Donn√©es en cours...</p>`
              }
            </div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <h4 class="font-semibold text-purple-900 mb-2">Enn√©agramme</h4>
            <div class="text-2xl font-bold text-purple-600 mb-2">${profile.results.enneagram}</div>
            <div class="mt-2">
              ${
                profile.results.enneagramCertainty != null
                  ? `<p class="mb-1">Certitude</p>
                     <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
                       <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-purple-500 transition-all duration-1000" data-width="${profile.results.enneagramCertainty}" style="width:0"></div>
                       <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.enneagramCertainty}%</span>
                     </div>`
                  : `<p>Certitude : Donn√©es en cours...</p>`
              }
            </div>
          </div>
        </div>

        <!-- Certitude globale -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          ${
            profile.results.overallCertainty != null
              ? `<p class="mb-1">Certitude globale</p>
                 <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
                   <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-green-500 transition-all duration-1000" data-width="${profile.results.overallCertainty}" style="width:0"></div>
                   <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.overallCertainty}%</span>
                 </div>`
              : `<p>Certitude : Donn√©es en cours...</p>`
          }
          <p class="text-sm text-gray-600 mt-2">Bas√© sur les √©valuations de vos proches</p>
          ${profile.externalCount < 3 ? `<p class="text-sm text-yellow-700 mt-2">üîé Augmentez votre niveau de certitude en compl√©tant les 3 √©valuations externes (famille, partenaire, ami ou coll√®gue).</p>` : ''}
        </div>


        <!-- Graphiques MBTI & Enn√©agramme -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Dichotomies MBTI</h4>
            <canvas id="mbtiChart" height="220"></canvas>
          </div>
          <div class="bg-white rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Types Enn√©agramme</h4>
            <canvas id="enneagramChart" height="220"></canvas>
          </div>
        </div>

        <div id="ai-profile-summary" class="mt-6 bg-gray-50 rounded-lg p-5 shadow-sm mb-6">
            <h4 class="font-semibold text-gray-900 text-lg mb-3">Description succincte du profil par Psycho'Bot</h4>
            <div id="ai-summary-content" class="relative text-sm leading-relaxed text-gray-700 max-h-80 overflow-y-auto">
                G√©n√©ration en cours‚Ä¶
                <div id="scroll-indicator" aria-hidden="true" class="pointer-events-none hidden absolute inset-x-0 bottom-0 h-10 bg-gradient-to-b from-transparent to-white flex items-end justify-center pb-1 text-gray-500">
                    <span class="text-xl animate-bounce">‚åÑ</span>
                </div>
            </div>
        </div>

                            <!-- D√©tail des √©valuations -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">D√©tail des √©valuations</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">Auto-√©valuation</span>
                                        <div class="text-xs text-gray-500">${profile.self.mbti} ‚Äî type ${profile.self.enneagram}</div>
                                    </div>
                                    <span class="text-sm text-green-600 font-medium">‚úì Compl√©t√©e</span>
                                </div>
                                ${profile.externalEvaluations.map(eval => `
                                    <div class="flex items-center justify-between p-3 ${eval.completed ? 'bg-green-50' : 'bg-gray-50'} rounded-lg">
                                        <div>
                                            <span class="text-sm font-medium text-gray-700">${eval.relation}</span>
                                            <div class="text-xs text-gray-500">${eval.mbti} ‚Äî type ${eval.enneagram} ‚Äî MBTI : <strong>Coh√©rence ${eval.coherenceMBTI}</strong> ‚Äî Enn√©agramme : <strong>Coh√©rence ${eval.coherenceEnneagramme}</strong></div>
                                        </div>
                                        <span class="text-sm ${eval.completed ? 'text-green-600' : 'text-gray-500'} font-medium">
                                            ${eval.completed ? '‚úì Compl√©t√©e le ' + new Date(eval.completedAt).toLocaleDateString('fr-FR') : '‚è≥ En attente'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

<div class="mt-8 mb-6 p-4 rounded-lg bg-gray-100 border border-gray-300 text-xs text-gray-700 leading-relaxed">
  <p class="mb-2"><strong> Coh√©rence</strong> : d√©termine dans quelle mesure les r√©ponses d‚Äôun proche sont logiquement stables.</p>
  <ul class="list-disc list-inside space-y-1">
    <li><strong>Forte</strong> ‚Üí peu voire pas de contradictions, r√©ponses align√©es</li>
    <li><strong>Moyenne</strong> ‚Üí quelques h√©sitations ou contradictions</li>
    <li><strong>Faible</strong> ‚Üí r√©ponses peu coh√©rentes entre elles</li>
  </ul>
</div>

<div class="mt-6 mb-6 flex justify-center">
  <img src="/logobanniere.jpeg" alt="Logo Personnalit√© Compar√©e" class="h-24 object-contain opacity-90" />
</div>




                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button class="download-pdf-btn flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                <i class="fas fa-download mr-2"></i>
                                T√©l√©charger PDF
                            </button>
                            <button onclick="shareProfileResults('${code}')" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                <i class="fas fa-share mr-2"></i>
                                Partager
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
    document.body.appendChild(resultsModal);
    initCountUp(resultsModal);
    addPDFDownloadHandler(resultsModal);

            // Animer les barres de certitude
            resultsModal.querySelectorAll('.certainty-bar').forEach(bar => {
                const width = bar.dataset.width;
                requestAnimationFrame(() => {
                    bar.style.width = width + '%';
                });
            });
            if (window.AOS) {
                AOS.refresh();
            }
            renderCharts(profile, resultsModal);
            initAiProfileSummary(profile, code);
        }

        function renderCharts(profile, container) {
            const mbtiCanvas = container.querySelector('#mbtiChart');
            const enneaCanvas = container.querySelector('#enneagramChart');
            const enoughEvaluations = profile.externalCount >= 3;
            const hasMbtiScores = profile.mbtiScores && Object.values(profile.mbtiScores).some(v => v > 0);
            const hasEnneaScores = profile.enneagramScores && Object.values(profile.enneagramScores).some(v => v > 0);

            if (!enoughEvaluations || !hasMbtiScores || !hasEnneaScores) {
                const message = document.createElement('p');
                message.className = 'text-sm text-gray-500 text-center';
                message.textContent = 'Donn√©es en attente (minimum 3 √©valuations externes requises).';
                if (mbtiCanvas) {
                    mbtiCanvas.remove();
                    mbtiCanvas.parentElement.appendChild(message.cloneNode(true));
                }
                if (enneaCanvas) {
                    enneaCanvas.remove();
                    enneaCanvas.parentElement.appendChild(message);
                }
                return;
            }

            const mbtiCtx = mbtiCanvas.getContext('2d');
            const mbtiPairs = [
                { label: 'E / I', a: 'E', b: 'I' },
                { label: 'S / N', a: 'S', b: 'N' },
                { label: 'T / F', a: 'T', b: 'F' },
                { label: 'J / P', a: 'J', b: 'P' }
            ];
            const mbtiData = mbtiPairs.map(pair => {
                const aScore = profile.mbtiScores[pair.a];
                const bScore = profile.mbtiScores[pair.b];
                const dominant = aScore > bScore ? pair.a : pair.b;
                const value = Math.round((Math.max(aScore, bScore) / (aScore + bScore)) * 100);
                return { label: pair.label, value, dominant };
            });
            const mbtiDescriptions = { E: 'Extraversion', I: 'Introversion', S: 'Sensation', N: 'Intuition', T: 'Pens√©e', F: 'Sentiment', J: 'Jugement', P: 'Perception' };
            Chart.register(ChartDataLabels);
            new Chart(mbtiCtx, {
                type: 'bar',
                data: {
                    labels: mbtiData.map(d => d.label),
                    datasets: [{
                        data: mbtiData.map(d => d.value),
                        backgroundColor: '#93C5FD',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${mbtiDescriptions[mbtiData[ctx.dataIndex].dominant]}: ${ctx.parsed.x}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value, ctx) => `${value}% ${mbtiData[ctx.dataIndex].dominant}`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });

            const enneaCtx = enneaCanvas.getContext('2d');
            const enneaLabels = Object.keys(profile.enneagramScores).sort();
            const enneaValues = enneaLabels.map(k => Math.round(profile.enneagramScores[k]));
            const maxIndex = enneaValues.indexOf(Math.max(...enneaValues));
            const enneaColors = enneaValues.map((v, i) => i === maxIndex ? '#A855F7' : '#D8B4FE');
            const enneagramDescriptions = {
                1: 'Le R√©formateur',
                2: "L'Altruiste",
                3: 'Le Performeur',
                4: "L'Individualiste",
                5: "L'Investigateur",
                6: 'Le Loyaliste',
                7: "L'√âpicurien",
                8: 'Le Chef',
                9: 'Le M√©diateur'
            };
            new Chart(enneaCtx, {
                type: 'bar',
                data: {
                    labels: enneaLabels.map(t => `Type ${t}`),
                    datasets: [{
                        data: enneaValues,
                        backgroundColor: enneaColors,
                        borderColor: enneaValues.map((v, i) => i === maxIndex ? '#7C3AED' : 'transparent'),
                        borderWidth: enneaValues.map((v, i) => i === maxIndex ? 2 : 0),
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.parsed.x}% - ${enneagramDescriptions[enneaLabels[ctx.dataIndex]]}`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${value}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }

        function setupScrollIndicator(container) {
            if (!container || container.__scrollIndicatorInitialized) return;
            const indicator = container.querySelector('#scroll-indicator');
            if (!indicator) return;

            const update = () => {
                const needsScroll = container.scrollHeight > container.clientHeight + 1;
                const scrolled = container.scrollTop > 8;
                const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 4;
                if (needsScroll && !scrolled && !atBottom) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            };

            container.addEventListener('scroll', update);
            window.addEventListener('resize', update);
            const observer = new MutationObserver(() => requestAnimationFrame(update));
            observer.observe(container, { childList: true, characterData: true, subtree: true });

            container.__scrollIndicatorInitialized = true;
            requestAnimationFrame(update);
        }

        async function initAiProfileSummary(profile, code) {
            const container = document.querySelector('#results-modal #ai-summary-content');
            if (!container || container.dataset.loading === '1') return;

            const { mbti, enneagram } = profile.results || {};
            const cacheKey = `ai-summary:${code}:${mbti}:${enneagram}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                console.info('[AI Summary]', 'cache hit', cacheKey);
                container.textContent = cached;
                setupScrollIndicator(container);
                return;
            }

            console.info('[AI Summary]', 'cache miss', cacheKey);
            container.setAttribute('data-loading', '1');

            let messages = [
                { role: 'system', content: 'Tu es un psychologue p√©dagogique. √âcris en fran√ßais, clair et nuanc√©, sans jargon.' },
                { role: 'user', content: `Profil combin√© : MBTI=${mbti}, Enn√©agramme=${enneagram}.\nR√©dige une description concise (max 150 mots) :\n1) forces principales, 2) point faible r√©current, 3) piste d‚Äôam√©lioration.\nLangage clair, ton positif, phrases courtes.` }
            ];

            let totalText = '';
            let attempts = 0;

            while (true) {
                try {
                    const response = await fetch('/api/psy-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages })
                    });

                    if (!response.ok) throw new Error('bad response');
                    const data = await response.json();
                    totalText += data.content || '';

                    if (data.finish_reason && data.finish_reason !== 'stop') {
                        messages.push({ role: 'assistant', content: data.content || '' });
                        messages.push({ role: 'user', content: 'continue' });
                        continue;
                    }

                    const finalText = totalText.trim();
                    container.textContent = finalText || "Description indisponible pour le moment.";
                    if (finalText) localStorage.setItem(cacheKey, finalText);
                    break;
                } catch (e) {
                    console.error('Erreur IA:', e);
                    attempts++;
                    if (attempts < 2) {
                        container.textContent = "√âchec de la g√©n√©ration, nouvelle tentative‚Ä¶";
                        continue;
                    }
                    container.textContent = "Impossible de terminer la description";
                    break;
                }
            }

            container.removeAttribute('data-loading');
            setupScrollIndicator(container);
        }

        function closeResultsModal() {
            const modal = document.getElementById('results-modal');
            if (modal) {
                modal.remove();
            }
        }

        function addPDFDownloadHandler(root) {
            const btn = root.querySelector('.download-pdf-btn');
            if (btn) {
                btn.addEventListener('click', downloadResultsPDF);
            }
        }

        function downloadResultsPDF() {
            let container = document.querySelector('#results-modal .modal-content');
            let actionsSelector = '.flex.space-x-3';
            if (!container) {
                container = document.querySelector('.bg-blue-50 .bg-white.shadow-xl');
                actionsSelector = '.flex.flex-wrap.justify-center.gap-4';
            }
            if (!container) return;

            const clone = container.cloneNode(true);

            const actions = clone.querySelector(actionsSelector);
            if (actions) actions.remove();

            const canvases = container.querySelectorAll('canvas');
            const cloneCanvases = clone.querySelectorAll('canvas');
            canvases.forEach((canvas, idx) => {
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                const rect = canvas.getBoundingClientRect();
                img.style.width = rect.width + 'px';
                img.style.height = rect.height + 'px';
                cloneCanvases[idx].replaceWith(img);
            });

            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            document.body.appendChild(clone);

            const opt = {
                margin: 0,
                filename: 'personnalite-comparee-resultats.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(clone).save().then(() => {
                document.body.removeChild(clone);
            });
        }

        async function shareProfileResults(code) {
            const result = await fetchUserProfileFromSupabase(code);
            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Impossible de partager : le profil complet n‚Äôest pas encore disponible.');
                return;
            }
            const description = document.getElementById('ai-summary-content')?.innerText.trim() || '';
            shareProfile(result.user.mbti_type, `Type ${result.user.enneagram_type}`, description);
        }

        function shareProfile(mbti, enneagram, description) {
            const shareText = buildShareText(mbti, enneagram, description);
            const url = 'https://www.personnalitecomparee.com';
            if (navigator.share) {
                navigator.share({ title: 'Mon profil de personnalit√©', text: shareText, url });
            } else {
                showShareFallback(shareText, url);
            }
        }

        function buildShareText(mbti, enneagram, description) {
            return `Hey ! Je viens de passer l'√©valuation du site www.personnalitecomparee.com et voici mon profil !\nJe suis "${mbti} et ${enneagram}"\nVoici une petite description de ma personnalit√© : "${description}"\nDites-moi si vous me reconnaissez et n'h√©sitez pas √† aller passer aussi votre test ici : www.personnalitecomparee.com`;
        }

        function showShareFallback(text, url) {
            const existing = document.getElementById('share-fallback');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'share-fallback';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            const links = [
                { name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}` },
                { name: 'WhatsApp', url: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}` },
                { name: 'X/Twitter', url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}` },
                { name: 'LinkedIn', url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}` },
                { name: 'Telegram', url: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}` },
                { name: 'Email', url: `mailto:?subject=${encodeURIComponent('Mon profil de personnalit√©')}&body=${encodeURIComponent(text + ' ' + url)}` }
            ];
            overlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
                    <h3 class="text-lg font-medium mb-4">Partager</h3>
                    <div class="flex flex-col space-y-2">
                        ${links.map(l => `<a href="${l.url}" target="_blank" class="px-4 py-2 rounded hover:bg-gray-100">${l.name}</a>`).join('')}
                    </div>
                    <button class="mt-4 w-full px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" onclick="document.getElementById('share-fallback').remove()">Fermer</button>
                </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
        }


        // Fermer la modale en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const profileModal = document.getElementById('profile-modal');
            const resultsModal = document.getElementById('results-modal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === resultsModal) {
                closeResultsModal();
            }
        }

        // Permettre la saisie du code avec Entr√©e
        document.addEventListener('DOMContentLoaded', function() {
            const profileCodeInput = document.getElementById('profile-code');
            if (profileCodeInput) {
                profileCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkProfileCode();
                    }
                });
                
                // Forcer la saisie en majuscules
                profileCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
        });
    </script>

    <!-- Modales pour les descriptions d√©taill√©es -->
    <div id="modal-container"></div>

    <div id="profile-modal-container"></div>
            <div class="modal-body">
                <!-- √âtape 1: Saisie du code -->
                <div id="code-input-step" class="profile-step">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                            <i class="fas fa-key text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Acc√©dez √† votre profil</h3>
                        <p class="text-sm text-gray-500">Entrez votre code unique pour consulter vos r√©sultats</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="profile-code" class="block text-sm font-medium text-gray-700 mb-2">Code unique</label>
                            <input type="text" id="profile-code" placeholder="Entrez votre code (ex: ABC123)" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono tracking-wider uppercase">
                        </div>
                        <button onclick="checkProfileCode()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Acc√©der √† mon profil
                        </button>
                    </div>
                </div>

                <!-- √âtape 2: Statut des √©valuations -->
                <div id="profile-status-step" class="profile-step" style="display: none;">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                            <i class="fas fa-user-circle text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Profil de <span id="profile-name"></span></h3>
                        <p class="text-sm text-gray-500">Code: <span id="display-code" class="font-mono font-bold"></span></p>
                    </div>

                    <!-- Statut des √©valuations -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-gray-900 mb-3">Statut des √©valuations</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">Votre auto-√©valuation</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i> Termin√©e
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">√âvaluations des proches</span>
                                <span id="evaluations-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                    <!-- Sera rempli dynamiquement -->
                                </span>
                            </div>
                        </div>
                        
                        <!-- Barre de progression -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progression globale</span>
                                <span id="progress-text">0/4 termin√©</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Message selon le statut -->
                    <div id="status-message" class="rounded-lg p-4 mb-4">
                        <!-- Sera rempli dynamiquement -->
                    </div>

                    <!-- Actions -->
                    <div class="flex space-x-3">
                        <button onclick="shareCode()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <i class="fas fa-share mr-2"></i>
                            Partager mon code
                        </button>
                        <button id="seeResultsBtn" onclick="viewResults()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-chart-pie mr-2"></i>
                            Voir mes r√©sultats
                        </button>
                    </div>
                </div>

                <!-- Message d'erreur -->
                <div id="error-message" class="profile-step" style="display: none;">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Code introuvable</h3>
                        <p class="text-sm text-gray-500 mb-4">Le code que vous avez entr√© n'existe pas ou est incorrect.</p>
                        <button onclick="resetProfileModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            R√©essayer
                        </button>
                    </div>
                </div>
    </div>
        </div>
    </div>



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const homeLinks = document.querySelectorAll('.scroll-top-link');
      const brand = document.getElementById('brand-home');

      function handleScrollTop(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.body.classList.add('scroll-highlight');
        setTimeout(() => document.body.classList.remove('scroll-highlight'), 1000);
      }

      homeLinks.forEach(link => link.addEventListener('click', handleScrollTop));
      if (brand) brand.addEventListener('click', handleScrollTop);
    });
  </script>

  <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://swjnpvfkloubshksobau.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3am5wdmZrbG91YnNoa3NvYmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwOTUxMzEsImV4cCI6MjA2OTY3MTEzMX0.A6rnIJyfIIxDT0c2XW_zGeUXpdYCgBFd6MTzBGFZ-Cg";

  const supabase = createClient(supabaseUrl, supabaseKey);
  window.supabase = supabase;

  const externalForm = document.getElementById("external-form");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code")?.toUpperCase();
  const encodedCode = code ? encodeURIComponent(code) : null;

  if (encodedCode) {
    (async () => {
      if (externalForm) {
        externalForm.style.display = "none";
      }

      try {
        const { data: user, error } = await supabase
          .from("users")
          .select("id")
          .eq("code", encodedCode)
          .single();

        if (error || !user) {
          alert("Code invalide ou introuvable.");
          return;
        } else if (externalForm) {
          externalForm.style.display = "";
        }
      } catch (err) {
        console.error("Erreur lors de la v√©rification du code :", err);
        alert("Code invalide ou introuvable.");
        return;
      }
    })();
  }

  if (externalForm) {
    externalForm.addEventListener("submit", (e) => {
      e.preventDefault();
      alert("Merci pour votre participation. Les r√©sultats sont disponibles dans la section 'Mon profil'.");
      externalForm.reset();
      externalForm.style.display = "none";
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 600,
    easing: 'ease-out',
    once: true
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (function(){
  const wrap = (()=>{
    // Essaie plusieurs s√©lecteurs raisonnables
    return document.querySelector('section#hero, section.hero, .hero, .banner, [data-hero]') ||
           [...document.querySelectorAll('section')].find(s => /vraiment|analyse/i.test(s.textContent)) ||
           document.body;
  })();
  wrap.classList.add('pc-hero');

  // Si pas d√©j√† pr√©sent, injecte le canvas
  let canvas = document.getElementById('pc-constellation');
  if(!canvas){
    canvas = document.createElement('canvas');
    canvas.id = 'pc-constellation';
    wrap.prepend(canvas);
  }
  // Classe de position d√©j√† ajout√©e pour garantir la superposition correcte

  const ctx = canvas.getContext('2d', { alpha: true });
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  const N = 80;               // nombre de points
  let LINK_DIST = 100;        // distance de connexion
  let MAX_LINKS = N;          // connexions maximales par point
  let BASE_OPACITY = 0.25;    // opacit√© maximale des lignes
  const mouse = { x:0, y:0, inside:false };
  const DRIFT = 0.008;                  // amplitude du drift autonome
  const ALLOW_DRIFT = matchMedia('(pointer: coarse)').matches;
  let pts = [], W=0, H=0;

  function resize(){
    const { width, height } = wrap.getBoundingClientRect();
    W = canvas.width  = Math.floor(width * DPR);
    H = canvas.height = Math.floor(height * DPR);
    canvas.style.width  = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    if(!pts.length){
      pts = Array.from({length:N}, ()=>({
        x: Math.random()*width,
        y: Math.random()*height,
        vx: (Math.random()-.5)*.25,
        vy: (Math.random()-.5)*.25
      }));
    }
  }

  function updateConnectivity(){
    if (window.innerWidth <= 768) {
      LINK_DIST = 65;         // distance de connexion augment√©e
      MAX_LINKS = 3;          // un peu plus de liaisons par point
      BASE_OPACITY = 0.55;    // mobile
    } else {
      LINK_DIST = 120;        // distance de connexion augment√©e
      MAX_LINKS = N;          // inchang√© pour desktop
      BASE_OPACITY = 0.45;    // desktop
    }
  }

  resize();
  updateConnectivity();
  addEventListener('resize', () => { resize(); updateConnectivity(); });

  // Suivi souris uniquement dans la banni√®re
  wrap.addEventListener('mouseenter', ()=>mouse.inside = true);
  wrap.addEventListener('mouseleave', ()=>mouse.inside = false);
  wrap.addEventListener('mousemove', e=>{
    const r = canvas.getBoundingClientRect();
    mouse.x = e.clientX - r.left;
    mouse.y = e.clientY - r.top;
  });

  let stop = matchMedia('(prefers-reduced-motion: reduce)').matches;
  matchMedia('(prefers-reduced-motion: reduce)').addEventListener?.('change', e=>{ stop = e.matches; });

  function frame(){
    if(stop) return; // respect R.M.
    const r = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,r.width,r.height);

    // --- Move
    for(const p of pts){
      if(mouse.inside){
        const dx = mouse.x - p.x, dy = mouse.y - p.y;
        const d = Math.hypot(dx,dy) || 1;
        // Attraction "un cran au-dessus de mod√©r√©"
        const force = Math.min(0.035, 9/(d*d));
        p.vx += (dx/d)*force;
        p.vy += (dy/d)*force;
      } else if(ALLOW_DRIFT){
        // l√©ger mouvement autonome sur mobile
        p.vx += (Math.random()-.5)*DRIFT;
        p.vy += (Math.random()-.5)*DRIFT;
      }
      // friction + clamp
      p.vx *= 0.991; p.vy *= 0.991;
      const vmax = 0.9; // vitesse max
      const sp = Math.hypot(p.vx,p.vy);
      if(sp>vmax){ p.vx = p.vx/sp*vmax; p.vy = p.vy/sp*vmax; }

      p.x += p.vx; p.y += p.vy;
      if(p.x<0||p.x>r.width)  p.vx *= -1;
      if(p.y<0||p.y>r.height) p.vy *= -1;
    }

    // --- Lines
    ctx.lineWidth = 0.6;
    const linksCount = new Array(N).fill(0);
    for(let i=0;i<N;i++){
      for(let j=i+1;j<N;j++){
        const a=pts[i], b=pts[j];
        const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
        if(d<LINK_DIST && linksCount[i] < MAX_LINKS && linksCount[j] < MAX_LINKS){
          const o = 1 - d/LINK_DIST;
          ctx.strokeStyle = `rgba(59,130,246,${(o*BASE_OPACITY).toFixed(3)})`; // bleu #3B82F6
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          linksCount[i]++;
          linksCount[j]++;
        }
      }
    }
    ctx.fillStyle = 'rgba(10,15,26,.62)';
    for(const p of pts){
      ctx.beginPath();
      const r = (window.innerWidth <= 768) ? 1.3 : 1.6;
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  })();
});
</script>

<!-- Typed doit √™tre charg√© avant notre script pour l‚Äôeffet progressif -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>

<script>
  // Styles (arrondis + grille des suggestions)
  (function addChatStyles(){
    const s=document.createElement('style');
    s.textContent=`
      #chat-window{border-radius:32px!important;overflow:hidden!important;}
      #chat-input{border-radius:9999px 0 0 9999px!important;}
      #chat-send{border-radius:0 9999px 9999px 0!important;}
      #chat-box{display:flex;flex-direction:column;gap:8px;}
      .user-bubble{align-self:flex-end;background:#e8f0ff;padding:10px 12px;border-radius:14px;max-width:85%;}
      .assistant-bubble{align-self:flex-start;background:#f6f6f6;padding:10px 12px;border-radius:14px;max-width:85%;}
      /* Grille: 2 boutons sur la 1√®re ligne, 3e centr√© en dessous */
      #chat-suggestions{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;}
      #chat-suggestions .suggestion-bubble:nth-child(3){grid-column:1 / -1;justify-self:center;}
    `;
    document.head.appendChild(s);
  })();

  // ===== M√©moire locale + trim =====
  let messages = JSON.parse(localStorage.getItem("chatHistory")) || [];
  const MAX_CONTEXT_TOKENS_CLIENT = 1600;

  function estimateTokens(str){ return Math.ceil((str||"").length/4); }
  function trimHistoryClient(msgs,budgetTokens){
    const keep=[]; let total=0;
    for(let i=msgs.length-1;i>=0;i--){
      const m=msgs[i];
      const c=typeof m.content==="string"?m.content:JSON.stringify(m.content);
      const cost=estimateTokens(c)+8;
      if(total+cost>budgetTokens) break;
      keep.push(m); total+=cost;
    }
    return keep.reverse();
  }

  // ===== UI helpers =====
  function setTyping(on){ const el=document.getElementById("pc-typing-indicator"); if(el) el.hidden=!on; }
  function safeScrollToBottom(el){ el.scrollTo({top:el.scrollHeight,behavior:'smooth'}); }

  function toggleSuggestions(){
    const sugg=document.getElementById('chat-suggestions');
    if(!sugg) return;
    // si conversation existante -> cach√©es, sinon -> visibles en grille
    sugg.style.display = messages.length ? 'none' : 'grid';
  }

  function appendMessage(role,text,{typing=(role==='assistant'),skipPersist=false}={}){
    const chatBox=document.getElementById("chat-box"); if(!chatBox) return;
    const row=document.createElement('div'); row.className=`chat-row ${role==='user'?'user':'assistant'}`;
    const bubble=document.createElement('div'); bubble.className=`chat-bubble ${role==='user'?'user-bubble':'assistant-bubble'}`;
    row.appendChild(bubble); chatBox.appendChild(row);

    if(role==='assistant' && typing && window.Typed){
      const obs=new MutationObserver(()=>safeScrollToBottom(chatBox));
      obs.observe(bubble,{childList:true,subtree:true,characterData:true});
      new Typed(bubble,{strings:[text],typeSpeed:30,showCursor:false,loop:false,contentType:'html',onComplete:()=>{obs.disconnect();safeScrollToBottom(chatBox);}});
    }else{
      bubble.textContent=text;
    }
    safeScrollToBottom(chatBox);

    if(!skipPersist){
      messages.push({role,content:text});
      messages=trimHistoryClient(messages,MAX_CONTEXT_TOKENS_CLIENT);
      localStorage.setItem("chatHistory",JSON.stringify(messages));
      toggleSuggestions(); // cacher si un message vient d‚Äô√™tre ajout√©
    }
  }

  function afficherConversation(){
    const box=document.getElementById("chat-box"); if(!box) return;
    box.innerHTML="";
    messages.forEach(m=>appendMessage(m.role,m.content,{skipPersist:true,typing:false}));
    box.scrollTop=box.scrollHeight;
    toggleSuggestions(); // afficher/cacher selon l‚Äô√©tat au chargement
  }

  async function envoyerMessage(texte){
    if(!texte || !texte.trim()) return;
    const q=texte.trim();

    toggleSuggestions(); // les cacher si ce n‚Äôest pas d√©j√† le cas
    appendMessage('user',q);
    // Tracking : message utilisateur envoy√©
    trackEvent('chat_message_sent', { messageLength: q.length });
    setTyping(true);

    try{
      const res=await fetch("/api/text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
      const data=await res.json();
      const botMsg = data.message || "(pas de r√©ponse)";
      appendMessage('assistant', botMsg, {typing:true});
      // Tracking : r√©ponse du bot
      trackEvent('chat_message_received', { messageLength: botMsg.length });
    }catch(e){
      console.error(e);
      const errMsg = "Oups, probl√®me de connexion. R√©essaye dans quelques secondes.";
      appendMessage('assistant', errMsg,{typing:false});
      // Tracking m√™me en cas d'erreur r√©seau
      trackEvent('chat_message_received', { messageLength: errMsg.length });
    }finally{
      setTyping(false);
    }
  }

  // Bouton reset (appel√© par onclick sur le HTML)
  window.resetConversation=function(){
    messages=[];
    localStorage.removeItem("chatHistory");
    const box=document.getElementById("chat-box"); if(box) box.innerHTML="";
    toggleSuggestions(); // re-affiche en grille (2 + 1 centr√©)
  };

  // Brancher contr√¥les
  (function bindUI(){
    const sendBtn=document.getElementById("chat-send");
    const input=document.getElementById("chat-input");
    if(sendBtn && input){
      sendBtn.addEventListener("click",()=>{ envoyerMessage(input.value); input.value=""; input.focus(); });
      input.addEventListener("keypress",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }});
    }
    document.querySelectorAll('#chat-suggestions .suggestion-bubble').forEach(btn=>{
      const q=btn.dataset.question||btn.textContent.trim();
      btn.addEventListener('click',()=>envoyerMessage(q));
    });
  })();

  // Init
  afficherConversation();
</script>

<script>
function addChatStyles() {
  const style = document.createElement("style");
  style.textContent = `
    /* SCOP√â AU CHATBOT UNIQUEMENT */
    #home-ia #chat-suggestions .suggestion-bubble {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: rgba(255, 255, 255, 0.18) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border: 1px solid rgba(255, 255, 255, 0.28) !important;
      border-radius: 50px !important;
      padding: 10px 22px !important;
      margin: 6px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      color: rgba(0, 0, 0, 0.85) !important;
      cursor: pointer !important;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.3s ease !important;
      white-space: nowrap !important; /* desktop par d√©faut */
      text-align: center !important;
    }
    #home-ia #chat-suggestions .suggestion-bubble:hover {
      transform: translateY(-1px) scale(1.04) !important;
      background: rgba(255, 255, 255, 0.28) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08) !important;
    }
    @media (max-width: 768px) {
      #home-ia #chat-suggestions .suggestion-bubble {
        white-space: normal !important;
        max-width: calc(100% - 12px) !important;
      }
    }
  `;
  document.head.appendChild(style);
}
addChatStyles();
</script>
<style>
  #pc-constellation{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none;}
</style>

 <!-- Supabase UMD (expose window.supabase) -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<script>
/* ========================
   Analytics ‚Äì Personnalit√© Compar√©e
   ======================== */

// ====== CONFIG SUPABASE ======
// Utilise les constantes d√©clar√©es plus haut pour cr√©er le client Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ====== Utils ======
function generateSessionId() {
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxxyxxxxxxx'.replace(/[xy]/g, c => {
    const r = (Math.random() * 16) | 0;
    const v = c === 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

function parseUTM() {
  const params = new URLSearchParams(window.location.search);
  const utm = {};
  ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k=>{ const v=params.get(k); if(v) utm[k]=v; });
  return Object.keys(utm).length ? utm : null;
}

// ====== Session locale ======
let sessionId = localStorage.getItem('session_id');
const hasVisited = localStorage.getItem('hasVisited');
const isReturning = hasVisited === 'true';
if (!sessionId) {
  sessionId = generateSessionId();
  localStorage.setItem('session_id', sessionId);
}
if (!hasVisited) localStorage.setItem('hasVisited','true');

const firstRefKey = 'pc_first_referrer';
let firstReferrer = localStorage.getItem(firstRefKey);
if (!firstReferrer && document.referrer) {
  firstReferrer = document.referrer;
  localStorage.setItem(firstRefKey, firstReferrer);
}
const firstUtmKey = 'pc_first_utm';
let firstUtm = null;
try { firstUtm = JSON.parse(localStorage.getItem(firstUtmKey) || 'null'); } catch {}
const currentUtm = parseUTM();
if (!firstUtm && currentUtm) {
  firstUtm = currentUtm;
  localStorage.setItem(firstUtmKey, JSON.stringify(firstUtm));
}

// ====== Contexte navigateur ======
const userAgent = (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : 'unknown';
const isBot = /vercel-screenshot|bot|crawl|spider/i.test(userAgent);
const deviceType = userAgent !== 'unknown' && /Mobi|Android/i.test(userAgent) ? 'mobile' : 'desktop';
const language = (typeof navigator !== 'undefined' && (navigator.language || (navigator.languages && navigator.languages[0]))) || 'unknown';
const viewport = (typeof window !== 'undefined' && typeof window.innerWidth === 'number' && typeof window.innerHeight === 'number')
  ? { width: window.innerWidth, height: window.innerHeight }
  : { width: 0, height: 0 };
const screenSize = (typeof screen !== 'undefined' && typeof screen.width === 'number' && typeof screen.height === 'number')
  ? { width: screen.width, height: screen.height }
  : { width: 0, height: 0 };
let tzOffset = 0;
try { tzOffset = new Date().getTimezoneOffset(); } catch { tzOffset = 0; }

// ====== Geo sans cache ======
async function getGeoData() {
  try {
    const res = await fetch('https://get.geojs.io/v1/ip/geo.json', { cache: 'no-store' });
    const data = await res.json();
    console.log('üåç Geo brut:', data);
    const country = data.country_name || data.country || data.country_code || data.country_code3;
    const city = data.city || data.region;
    return {
      country: country && country.trim() ? country : 'Inconnu',
      city: city && city.trim() ? city : 'Inconnu',
      ip: data.ip || 'unknown'
    };
  } catch (err) {
    console.error('‚ùå Geo fetch error:', err);
    return { country: 'Inconnu', city: 'Inconnu', ip: 'unknown' };
  }
}

// ====== Cr√©ation / MAJ de la session ======
async function upsertSession(initialEventName = 'page_view') {
  if (!supabase) return false;
  if (isBot) return false;
  try {
    const geo = await getGeoData();
    const payload = {
      session_id: sessionId,
      first_referrer: firstReferrer ?? null,
      first_utm: firstUtm ?? null,
      user_agent: userAgent ?? 'unknown',
      device_type: deviceType ?? 'desktop',
      language: language ?? 'unknown',
      tz_offset: tzOffset ?? 0,
      viewport: viewport ?? { width: 0, height: 0 },
      screen: screenSize ?? { width: 0, height: 0 },
      engagement_ms: 0,
      is_returning: isReturning ?? false,
      last_page_url: location.href ?? '',
      last_event_name: initialEventName ?? '',
      last_activity_at: new Date().toISOString(),
      country: geo.country ?? 'Inconnu',
      city: geo.city ?? 'Inconnu',
      ip: geo.ip ?? 'unknown'
    };
    const required = ['session_id','user_agent','device_type','language','tz_offset','viewport','screen','country','city','ip'];
    const hasAll = required.every(k => payload[k] !== undefined && payload[k] !== null);
    if (!hasAll) {
      console.warn('‚ùó Missing keys in session payload', payload);
      return false;
    }
    console.log('‚û°Ô∏è Session upsert payload:', payload);
    const { error } = await supabase
      .from('sessions')
      .upsert(payload, { onConflict: ['session_id'] });
    if (error) {
      console.error('‚ùå Session upsert error:', error);
      return false;
    }
    return true;
  } catch (err) {
    console.error('‚ùå upsertSession exception:', err);
    return false;
  }
}

// ====== Envoi d‚Äô√©v√©nements ======
async function trackEvent(eventName, meta = {}) {
  if (!supabase || isBot) return;
  try {
    const event_category = eventName.includes('click') ? 'Interaction' : 'Navigation';
    const { error: e1 } = await supabase.from('events').insert({
      session_id: sessionId,
      event_name: eventName,
      event_category,
      page_url: location.href,
      referrer: document.referrer || null,
      utm: currentUtm,
      user_agent: userAgent,
      meta,
      element_selector: meta.element || null
    });
    if (e1) console.error('‚ùå Event insert error:', e1);
    const { error: e2 } = await supabase
      .from('sessions')
      .update({
        last_activity_at: new Date().toISOString(),
        last_event_name: eventName,
        last_page_url: location.href
      })
      .eq('session_id', sessionId);
    if (e2) console.error('‚ùå Session update error:', e2);
  } catch (err) {
    console.error('‚ùå trackEvent exception:', err);
  }
}

// ====== Init ======
(async () => {
  const ok = await upsertSession('page_view');
  if (!ok) return;
  await trackEvent('page_view');

  document.addEventListener('click', (e) => {
    let selector = '';
    if (e.target.id) selector = '#' + e.target.id;
    else if (e.target.className) {
      selector = e.target.tagName.toLowerCase() + '.' + e.target.className.toString().trim().replace(/\s+/g, '.');
    } else selector = e.target.tagName.toLowerCase();
  trackEvent('click', { element: selector });
  });
})();
</script>




<script>
  async function injectHTML(selector, file) {
    const target = document.querySelector(selector);
    if (target) {
      const res = await fetch(file);
      if (res.ok) {
        target.innerHTML = await res.text();
      }
    }
  }
  Promise.all([
    injectHTML("#header", "/includes/header.html"),
    injectHTML("#footer", "/includes/footer.html"),
    injectHTML("#profile-modal-container", "/includes/profile-modal.html")
  ]).then(() => {
    const s = document.createElement("script");
    s.src = "/js/common.js";
    s.onload = () => document.dispatchEvent(new Event('includesLoaded'));
    document.body.appendChild(s);
  });
</script>
</body>
</html>



      
