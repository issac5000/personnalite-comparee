<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="siteTitle">Personnalit√© Compar√©e | Test d√©riv√© MBTI & Enn√©agramme Gratuit</title>

  <!-- Supabase JS -->

  <!-- SEO Meta Tags -->
  <meta name="description" lang="fr" content="D√©couvrez votre personnalit√© avec un test d√©riv√© MBTI et Enn√©agramme gratuit. Analyse des 16 types et 9 profils, combinant auto-√©valuation et validation par vos proches.">
  <meta name="description" lang="en" content="Discover your personality with our free MBTI-inspired and Enneagram test. Explore the 16 personality types and 9 Enneagram profiles with self-assessment and peer validation.">
  <meta name="keywords" content="test personnalit√©, mod√®le d√©riv√© MBTI, enn√©agramme, psychologie, 16 types, auto-√©valuation, gratuit">
  <meta name="author" content="Personnalit√© Compar√©e">
  <meta name="robots" content="index, follow">

  <!-- Favicon --> 
    <link rel="icon" type="image/jpeg" href="/flavicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Supabase JS library -->
   
    <style>
        html, body {
            overflow-x: hidden;
        }
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        /* Make specific words visually thicker than font-weight allows */
        .pc-superbold { -webkit-text-stroke: 0.2px currentColor; }
        /* Subtle marker-like highlight effect for a single word */
        .pc-highlight {
          background-image: linear-gradient(180deg, transparent 58%, #fef08a 58%);
          background-repeat: no-repeat;
          border-radius: .15em;
          padding: 0 .08em; /* tiny side padding so the highlight peeks out */
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        button,
        [class*="card"] {
            transition: all 0.3s ease;
        }

        button:hover {
            transform: rotateX(3deg) rotateY(3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        /* Podcast visualizer */
        #home-podcast-visual {
          display: block;
          background: transparent;
          border: none;
          margin: -4px auto -2px auto; /* ultra rapproch√© et centr√© */
          width: clamp(220px, 40vw, 360px);
          aspect-ratio: 1 / 1; /* cercle toujours centr√© */
          height: auto;
        }
        #home-podcast h2 { margin-bottom: -4px !important; }
        #home-podcast-audio {
          display: block;
          width: clamp(220px, 40vw, 360px);
          margin: -4px auto 0 auto;
          border-radius: 9999px;
          background: rgba(255,255,255,0.9);
          box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        }
        /* Mobile: lecteur plus large (prend toute la largeur du conteneur) */
        @media (max-width: 640px) {
          #home-podcast-audio {
            width: 100%;
            max-width: 520px;
          }
          #home-podcast-visual {
            width: 100%;
            max-width: 520px;
          }
        }

        [class*="card"]:hover {
            transform: perspective(600px) rotateX(3deg) rotateY(-3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out, background 0.3s ease-in-out;
            border-radius: 9999px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
        }
        .question-card {
            min-height: 300px;
        }
        .floating-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .personality-badge {
            border-radius: 50px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Styles pour les modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .close {
            color: #9ca3af;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover,
        .close:focus {
            color: #374151;
        }

        /* Profile modal - enhanced look */
        #profile-modal .modal-content {
            border-radius: 22px;
            border: 1px solid #e7eefc;
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
            box-shadow: 0 28px 60px -12px rgba(16, 24, 40, 0.18), 0 16px 36px -18px rgba(16, 24, 40, 0.12);
        }
        #profile-modal .modal-header {
            border-top-left-radius: 22px;
            border-top-right-radius: 22px;
            border-bottom-color: #eaf0ff;
        }
        #profile-modal .modal-body { padding: 2rem; }
        /* Blue key badge with subtle relief */
        .pc-icon-badge {
            width: 64px; height: 64px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px;
            background: linear-gradient(145deg, #e8f1ff, #f5f9ff);
            border: 1px solid rgba(59, 130, 246, 0.18);
            box-shadow: 0 10px 28px rgba(37, 99, 235, 0.18), inset 0 -2px 6px rgba(255,255,255,0.9);
        }
        .pc-icon-badge i { color: #2563eb; font-size: 28px; text-shadow: 0 1px 0 rgba(255,255,255,0.85); }
        .pc-icon-lg { width: 72px; height: 72px; box-shadow: 0 12px 30px rgba(37,99,235,0.16), inset 0 -2px 6px rgba(255,255,255,0.95); }
        .pc-icon-lg i { font-size: 32px; }

        /* Soft card used in profile modal */
        #profile-modal .pc-soft-card {
          border-radius: 20px;
          background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
          border: 1px solid #e7eefc;
          box-shadow: 0 6px 16px rgba(16,24,40,0.06);
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @media (max-width: 1023px) {
            .desktop-nav {
                display: none;
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .question-container {
            display: none;
        }
        .question-container.active {
            display: block;
        }

        .section-clair {
            background-color: #ffffff;
        }

        .section-fonce {
            background-color: #fbfbfb;
        }
        #site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: inherit;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
            height: auto;
            min-height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        body {
            padding-top: 64px;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1100;
            display: none;
        }

        .mobile-menu.active {
            display: block;
        }

        @media (max-width: 1023px) {
            #site-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                background: inherit;
                box-shadow: 0 2px 10px rgba(0,0,0,0.06);
                height: auto;
                min-height: 56px;
            }
            body {
                padding-top: 56px;
            }
            [id],
            .section {
                scroll-margin-top: 64px;
            }
        }

        .scroll-highlight {
            animation: scrollHighlight 1s ease;
        }
        @keyframes scrollHighlight {
            from { background-color: #fef3c7; }
            to { background-color: #ffffff; }
        }

        /* Chat styles */
        .chat-row {
            display: flex;
            margin-bottom: 8px;
        }
        .chat-row.user {
            justify-content: flex-end;
        }
        .chat-row.assistant {
            justify-content: flex-start;
        }
        .chat-bubble {
            display: inline-block;
            padding: 10px 14px;
            font-size: 15px;
        }
        .assistant-bubble {
            background: #e0f0ff;
            color: #003b5c;
            border-radius: 16px 16px 16px 4px;
        }
        .user-bubble {
            background: #d1ffe0;
            color: #084d28;
            border-radius: 16px 16px 4px 16px;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .assistant-bubble.limit-error {
            background: #ffe5e5;
            border: 1px solid #ff0000;
            color: #b30000;
            font-weight: bold;
            animation: shake 0.4s;
        }
        .question-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 14px;
            margin-top: auto;
            padding: 12px;
        }
        .question-buttons button {
            padding: 6px 12px;
            border-radius: 8px;
            background-color: #e7f1fb;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .question-buttons button:hover {
            background-color: #d0e7f7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .pc-typing {
            position: sticky;
            bottom: 0;
            padding: 8px 12px;
            background: rgba(0,0,0,0.04);
            backdrop-filter: blur(2px);
            border-top: 1px solid rgba(0,0,0,0.06);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .pc-typing[hidden] { display: none; }
        .pc-dots span {
            animation: pc-blink 1.2s infinite;
            display: inline-block;
            padding-left: 2px;
        }
        .pc-dots span:nth-child(2) { animation-delay: .2s; }
        .pc-dots span:nth-child(3) { animation-delay: .4s; }
        @keyframes pc-blink {
            0% { opacity: 0.2; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-1px); }
            100% { opacity: 0.2; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: -2px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        :root{
          --pc-line: rgba(59,130,246,.30);  /* bleu doux (#3B82F6) */
          --pc-dot:  rgba(10,15,26,.62);
        }
        /* le conteneur de la banni√®re doit d√©j√† √™tre positionn√© ; sinon: */
        .pc-hero { position: relative; isolation: isolate; z-index: 0; margin-top: 2rem; }
        @media (min-width: 768px) {
          .pc-hero { margin-top: 3rem; }
        }

        #pc-constellation{
          position: absolute; inset: 0; width: 100%; height: 100%;
          pointer-events: none; z-index: -1; /* contenu texte reste au-dessus */
        }

        @media (prefers-reduced-motion: reduce){
          #pc-constellation{ display:none !important; }
        }

        .pc-info-banner{
          background:#eef2ff;
          color:#0f172a;
          border:1px solid rgba(59,130,246,.25);
          border-radius:12px;
          padding:14px 16px;
          margin:16px 0 12px;
          line-height:1.5;
          font-size:.95rem;
        }
        @media (max-width:768px){
          .pc-info-banner{ margin:12px 0; font-size:.93rem; }
        }

        #beta-banner {
          background-color: #F6D1D1;
          color: #B94E4E;
          height: 40px;
          display: flex;
          align-items: center;
          overflow: hidden;
          padding: 0 1rem;
          font-weight: 500;
          font-size: 0.875rem;
        }
        #beta-banner .banner-track {
          display: inline-block;
          white-space: nowrap;
          will-change: transform;
          animation: beta-scroll 25s linear infinite;
        }
        #beta-banner .banner-track span {
          display: inline-block;
          padding-right: 2rem;
        }
        @keyframes beta-scroll {
          from { transform: translateX(0); }
          to { transform: translateX(-50%); }
        }

       /* Styles sp√©cifiques au chatbot Psycho'Bot */
#chat-window {
  border-radius: 32px !important;
  overflow: hidden !important;
}

#chat-input {
  border-top-left-radius: 9999px !important;
  border-bottom-left-radius: 9999px !important;
  border: none !important;
}

#chat-send {
  border-top-right-radius: 9999px !important;
  border-bottom-right-radius: 9999px !important;
  border: none !important;
}

        #enneagramChart {
          min-height: 280px;
        }
        @media (max-width: 640px) {
          #enneagramChart {
            min-height: 350px;
          }
        }

        /* Animation: logo spins once every 5s (pulse) */
        @keyframes pc-spin-y {
          0%, 90% { transform: rotateY(0deg); }
          100%    { transform: rotateY(360deg); }
        }
        img[src$="logotitre.png"],
        img[src$="logo pc 3.png"] {
          display: inline-block;
          animation: pc-spin-y 5s ease-in-out infinite;
          transform-style: preserve-3d;
          backface-visibility: visible;
          will-change: transform;
          transform-origin: center center;
        }
        @media (prefers-reduced-motion: reduce) {
          img[src$="logotitre.png"],
          img[src$="logo pc 3.png"] { animation: none; }
        }

        /* Site-wide rounded buttons without changing colors */
        button,
        input[type="button"],
        input[type="submit"],
        .btn,
        a.btn {
          border-radius: 1rem !important; /* 16px approx */
        }

        /* Remove persistent tap highlight/focus ring on header controls after tap */
        #site-header button, #site-header a { -webkit-tap-highlight-color: transparent; }
        #site-header button:focus { outline: none; box-shadow: none; }

    </style>

    <!-- Open Graph -->
    <meta property="og:title" content="Personnalit√© Compar√©e | Test d√©riv√© MBTI & Enn√©agramme Gratuit" />
    <meta property="og:description" content="D√©couvrez votre vraie personnalit√© avec notre test d√©riv√© MBTI et Enn√©agramme gratuit. Analyse objective combinant votre auto-√©valuation et l'avis de vos proches." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.personnalitecomparee.com/" />

    <meta property="og:image" content="https://www.personnalitecomparee.com/logobanniere.jpeg" />
    <meta property="og:image:secure_url" content="https://www.personnalitecomparee.com/logobanniere.jpeg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Duplicate fallback for Facebook -->
    <meta property="og:image" content="https://www.personnalitecomparee.com/logobanniere.jpeg?fbrefresh=1" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Personnalit√© Compar√©e | Test d√©riv√© MBTI & Enn√©agramme Gratuit" />
    <meta name="twitter:description" content="D√©couvrez votre vraie personnalit√© avec notre test d√©riv√© MBTI et Enn√©agramme gratuit. Analyse objective combinant votre auto-√©valuation et l'avis de vos proches." />
    <meta name="twitter:image" content="https://www.personnalitecomparee.com/logobanniere.jpeg" />

</head>
<body id="top" class="font-sans bg-white text-gray-900">
    <div id="beta-banner"><div class="banner-track"><span data-i18n="beta.banner">üöß Phase de test en cours ! Vous pouvez d√®s maintenant essayer nos questionnaires et contribuer √† l‚Äôam√©lioration de l‚Äôalgorithme. Vos retours sont pr√©cieux pour rendre l‚Äôoutil encore plus fiable. üôå</span><span aria-hidden="true" data-i18n="beta.banner">üöß Phase de test en cours ! Vous pouvez d√®s maintenant essayer nos questionnaires et contribuer √† l‚Äôam√©lioration de l‚Äôalgorithme. Vos retours sont pr√©cieux pour rendre l‚Äôoutil encore plus fiable. üôå</span></div></div>
    <!-- Navigation -->
    <header id="site-header" class="sticky-header">
        <div class="flex items-center">
            <div class="flex items-center min-w-0">
                <img src="logo pc 3.png" alt="Personnalit√© Compar√©e logo" class="w-10 h-10 rounded-full object-cover"><span id="brand-home" class="ml-3 text-[1.05rem] sm:text-xl font-bold text-black truncate max-w-[65vw] sm:max-w-[60vw] md:max-w-none" data-i18n="brand.name">Personnalit√© Compar√©e</span>
            </div>
            <div class="relative ml-4 shrink-0">
                <button id="lang-toggle" class="p-2 focus:outline-none" aria-haspopup="true" aria-expanded="false">
                    <svg class="w-5 h-5 text-gray-800" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                        <circle cx="12" cy="12" r="9"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c3.5 3 3.5 15 0 18"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c-3.5 3-3.5 15 0 18"/>
                    </svg>
                </button>
                <div id="lang-menu" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg ring-1 ring-black/5 hidden z-50">
                    <button data-lang="en" class="flex items-center w-full px-4 py-2 text-sm hover:bg-gray-100"><span class="mr-2">üá¨üáß</span> English</button>
                    <button data-lang="fr" class="flex items-center w-full px-4 py-2 text-sm hover:bg-gray-100"><span class="mr-2">üá´üá∑</span> Fran√ßais</button>
                </div>
            </div>
        </div>
        <nav class="desktop-nav hidden lg:ml-6 lg:flex lg:items-center lg:space-x-8">
            <div id="home-menu-container" class="relative">
                <a id="home-menu-button" href="index.html" class="inline-flex items-center gap-2 text-gray-900 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.home">Accueil</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="home-menu" class="invisible opacity-0 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="index.html#home-how" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.how">Comment √ßa marche</a></li>
                        <li><a href="index.html#home-mbti" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.auto_eval">Auto-√©valuation</a></li>
                        <li><a href="index.html#home-enneagramme" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.eval_friend">√âvaluer un proche</a></li>
                        <li><a href="index.html#home-ia" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.chatbot">Parler avec Psycho'Bot</a></li>
                        <li><a href="index.html#retourver-profil" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.retrieve_profile">Retrouver un profil</a></li>
                        <li><a href="index.html#home-blog" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.latest_articles">Derniers articles</a></li>
                        <li><a href="index.html#home-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.faq">Questions fr√©quentes</a></li>
                        <li><a href="index.html#home-about" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.about">√Ä propos du projet</a></li>
                    </ul>
                </div>
            </div>
            <div id="mbti-menu-container" class="relative">
                <a id="mbti-menu-button" href="mbti.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.mbti">Mod√®le d√©riv√© MBTI</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="mbti-menu" class="invisible opacity-0 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="mbti.html#mbti-hero" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.understand">Comprendre le mod√®le d√©riv√© MBTI</a></li>
                        <li><a href="mbti.html#mbti-history" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.history">Un peu d'histoire</a></li>
                        <li><a href="mbti.html#mbti-types" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.types">Les 16 types</a></li>
                        <li><a href="mbti.html#mbti-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.faq">FAQ du mod√®le d√©riv√© MBTI</a></li>
                    </ul>
                </div>
            </div>
            <div id="ennea-menu-container" class="relative">
                <a id="ennea-menu-button" href="enneagramme.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.enneagram">Enn√©agramme</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="ennea-menu" class="invisible opacity-0 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="enneagramme.html#ennea-hero" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.understand">Comprendre l‚ÄôEnn√©agramme</a></li>
                        <li><a href="enneagramme.html#ennea-history" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.history">Un peu d'histoire</a></li>
                        <li><a href="enneagramme.html#ennea-types" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.types">Les 9 types</a></li>
                        <li><a href="enneagramme.html#ennea-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.faq">FAQ Enn√©agramme</a></li>
                    </ul>
                </div>
            </div>
            <a href="index.html#home-ia" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.ai">IA sp√©cialis√©e</a>
            <a href="blog.html" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.blog">Blog</a>
            <a href="index.html#home-faq" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.faq">FAQ</a>
            <button id="profile-btn-desktop" onclick="openProfileModal()" class="ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black" data-i18n="menu.profile">
                Mon profil
            </button>
        </nav>
        <div class="-mr-2 flex items-center lg:hidden">
            <button type="button" id="mobile-menu-button" class="shrink-0 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none lg:hidden" aria-controls="mobile-menu" aria-expanded="false">
                <span class="sr-only" data-i18n="nav.open_main">Ouvrir le menu principal</span>
                <i class="fas fa-bars" id="menu-icon"></i>
            </button>
        </div>
        <!-- Menu mobile -->
        <div class="mobile-menu lg:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t border-gray-200">
                <div>
                    <a id="mobile-home-button" href="index.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-900" aria-expanded="false">
                        <span data-i18n="menu.home">Accueil</span>
                        <svg id="mobile-home-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-home-menu" class="hidden pl-4 space-y-1">
                        <a href="index.html#home-how" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.how">Comment √ßa marche</a>
                        <a href="index.html#home-podcast" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.podcast">Podcast</a>
                        <a href="index.html#home-mbti" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.auto_eval">Auto-√©valuation</a>
                        <a href="index.html#home-enneagramme" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.eval_friend">√âvaluer un proche</a>
                        <a href="index.html#home-ia" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.chatbot">Parler avec Psycho'Bot</a>
                        <a href="index.html#retourver-profil" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.retrieve_profile">Retrouver un profil</a>
                        <a href="index.html#home-blog" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.latest_articles">Derniers articles</a>
                        <a href="index.html#home-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.faq">Questions fr√©quentes</a>
                        <a href="index.html#home-about" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.about">√Ä propos du projet</a>
                    </div>
                </div>
                <div>
                    <a id="mobile-mbti-button" href="mbti.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-500" aria-expanded="false">
                        <span data-i18n="menu.mbti">Mod√®le d√©riv√© MBTI</span>
                        <svg id="mobile-mbti-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-mbti-menu" class="hidden pl-4 space-y-1">
                        <a href="mbti.html#mbti-hero" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.understand">Comprendre le mod√®le d√©riv√© MBTI</a>
                        <a href="mbti.html#mbti-history" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.history">Un peu d'histoire</a>
                        <a href="mbti.html#mbti-types" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.types">Les 16 types</a>
                        <a href="mbti.html#mbti-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.faq">FAQ du mod√®le d√©riv√© MBTI</a>
                    </div>
                </div>
                <div>
                    <a id="mobile-ennea-button" href="enneagramme.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-500" aria-expanded="false">
                        <span data-i18n="menu.enneagram">Enn√©agramme</span>
                        <svg id="mobile-ennea-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-ennea-menu" class="hidden pl-4 space-y-1">
                        <a href="enneagramme.html#ennea-hero" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.understand">Comprendre l‚ÄôEnn√©agramme</a>
                        <a href="enneagramme.html#ennea-history" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.history">Un peu d'histoire</a>
                        <a href="enneagramme.html#ennea-types" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.types">Les 9 types</a>
                        <a href="enneagramme.html#ennea-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.faq">FAQ Enn√©agramme</a>
                    </div>
                </div>
                <a href="index.html#home-ia" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.ai">IA sp√©cialis√©e</a>
                <a href="blog.html" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.blog">Blog</a>
                <a href="index.html#home-faq" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.faq">FAQ</a>
                <button id="profile-btn-mobile" onclick="openProfileModal()" class="w-full mt-2 inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800" data-i18n="menu.profile">
                    Mon profil
                </button>
            </div>
        </div>
    </header>

  <!-- Hero Section Premium -->
    <section id="home-hero" data-aos="fade-up" class="section section-clair relative flex items-center justify-center overflow-hidden pc-hero mt-8 sm:mt-12" data-hero style="min-height: 80vh;">
        <canvas id="pc-constellation" aria-hidden="true"></canvas>
        <!-- Grille subtile en arri√®re-plan -->
        <div class="absolute inset-0 opacity-[0.02]">
            <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgb(15 23 42) 1px, transparent 0); background-size: 40px 40px;"></div>
        </div>

        <!-- √âl√©ments g√©om√©triques minimalistes -->
        <div class="absolute top-1/4 right-1/4 w-2 h-2 bg-blue-400/20 rounded-full"></div>
        <div class="absolute bottom-1/3 left-1/5 w-1 h-1 bg-slate-400/30 rounded-full"></div>
        <div class="absolute top-2/3 right-1/3 w-1.5 h-1.5 bg-blue-300/25 rounded-full"></div>

        <div class="relative max-w-5xl mx-auto px-6 pb-16 text-center">
<video autoplay loop muted playsinline class="mx-auto mb-4 w-36 sm:w-40 h-auto">
  <source src="logo.mp4" type="video/mp4">
  <img src="logobanniere.jpeg" alt="Nouveau logo">
</video>


            
            <!-- Titre principal avec hi√©rarchie claire -->
            <h1 data-i18n="heroTitle" class="text-4xl md:text-5xl lg:text-6xl font-semibold tracking-tight text-slate-900 mb-6 leading-tight">
                Et si vous vous connaissiez<br><span class="text-blue-600 font-black pc-superbold pc-highlight"><strong>vraiment</strong></span> ?
            </h1>
            
            <!-- Sous-titre √©pur√© -->
   <p data-i18n="heroSubtitle" class="max-w-2xl mx-auto text-lg md:text-xl text-slate-600 leading-relaxed mb-12 font-light">
    La premi√®re plateforme qui combine <span class="font-medium text-slate-800">test d√©riv√© MBTI</span> & <span class="font-medium text-slate-800">Enn√©agramme</span>, validation par l‚Äôentourage et <span class="font-medium text-slate-800">IA sp√©cialis√©e</span> pour r√©pondre √† toutes vos questions.
   </p>
            
            <!-- Boutons premium -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-12">
                <a href="#home-mbti" class="group relative inline-flex items-center gap-3 px-8 py-4 text-base font-medium text-white bg-slate-900 hover:bg-slate-800 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl">
                    <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span data-i18n="hero.autoEvalBtn">Auto-√©valuation</span>
                    <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>

                <a href="#home-enneagramme" class="group inline-flex items-center gap-3 px-8 py-4 text-base font-medium text-slate-700 bg-white hover:bg-slate-50 border border-slate-200 hover:border-slate-300 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span data-i18n="hero.evalFriendBtn">√âvaluer un proche</span>
                </a>
            </div>
            
            <!-- Indicateurs de confiance int√©gr√©s discr√®tement -->
            <div class="flex items-center justify-center gap-8 text-sm text-slate-500">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                    <span data-i18n="indicatorMBTI">16 profils inspir√©s du MBTI</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                    <span data-i18n="indicatorEnneagram">9 types Enn√©agramme</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                    <span data-i18n="indicatorValidation">Validation par les proches</span>
                </div>
            </div>
        </div>
  </section>

<!-- How it works -->
<div id="home-how" data-aos="fade-right" class="section section-fonce py-20 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    
    <!-- Title -->
    <div class="text-center">
      <h2 data-i18n="howTitle" class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
        Comment √ßa marche ?
      </h2>
      <p data-i18n="howSubtitle" class="mt-4 max-w-2xl text-xl text-gray-500 mx-auto">
        Une approche innovante pour une analyse plus objective de votre personnalit√©
      </p>
    </div>

    <!-- Steps -->
    <div class="mt-20 grid grid-cols-1 gap-12 md:grid-cols-3">
      
      <!-- Step 1 -->
      <div class="text-center p-6 rounded-[2rem] bg-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2">
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-[#B94E4E] shadow-md" style="background-color: #F6D1D1;">
          <i class="fas fa-user text-2xl"></i>
        </div>
      <div class="mt-6">
        <h3 class="text-lg font-semibold text-gray-900"><strong data-i18n="home.cards.autoEval.title">1. Auto-√©valuation</strong></h3>
        <p class="mt-3 text-base text-gray-500 leading-relaxed" data-i18n="home.cards.autoEval.desc">
          R√©ponds √† 20 questions simples pour exprimer ta propre vision de ta personnalit√©.
        </p>
      </div>
      </div>

      <!-- Step 2 -->
      <div class="text-center p-6 rounded-[2rem] bg-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2">
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-yellow-700 shadow-md" style="background-color: #FFF3B0;">
          <i class="fas fa-users text-2xl"></i>
        </div>
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-gray-900"><strong data-i18n="home.cards.externalEval.title">2. √âvaluation par 3 proches</strong></h3>
          <p class="mt-3 text-base text-gray-500 leading-relaxed" data-i18n="home.cards.externalEval.desc">
            Partage ton code unique avec 3 proches qui r√©pondront √† 20 questions sur toi.
          </p>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="text-center p-6 rounded-[2rem] bg-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2">
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-green-700 shadow-md" style="background-color: #B7E4C7;">
          <i class="fas fa-chart-pie text-2xl"></i>
        </div>
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-gray-900"><strong data-i18n="step3Title">3. Profil complet</strong></h3>
          <p class="mt-3 text-base text-gray-500 leading-relaxed" data-i18n="step3Desc">
            Recevez une analyse pond√©r√©e combinant votre auto-√©valuation et les √©valuations de vos proches.
          </p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Podcast Section -->
<section id="home-podcast" data-aos="fade-up" class="section section-clair py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-5xl mx-auto text-center">
    <h2 data-i18n="home.podcast.title" class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-0 leading-tight">
      Podcast pour comprendre en profondeur Personnalit√© Compar√©e
    </h2>
    <canvas id="home-podcast-visual"></canvas>
    <audio id="home-podcast-audio" controls controlsList="nodownload noplaybackrate" preload="metadata">
      <source src="podcastpc.mp3?v=1" type="audio/mpeg">
      Votre navigateur ne supporte pas la lecture audio.
    </audio>
  </div>
</section>


  <!-- Auto-evaluation Section -->
<div id="home-mbti" data-aos="zoom-in" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- Titre & Sous-titre -->
        <div class="text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="autoEvalSectionTitle">
                Auto-√©valuation
            </h2>
            <p class="mt-4 text-xl text-gray-500" data-i18n="autoEvalSectionSubtitle">
                R√©pondez √† ces 20 questions pour commencer votre analyse
            </p>
        </div>

        <!-- Encadr√© parent -->
        <div class="mt-12 mb-4 rounded-[2rem] shadow-sm border border-gray-200 px-6 py-8 bg-gray-50">
            <!-- Container questions -->
            <div id="questions-container" class="space-y-6">
                <!-- Les questions dynamiques viendront ici -->
                <!-- IMPORTANT : retirer 'shadow', 'border', 'rounded' sur chaque question individuelle -->
            </div>

            <!-- Navigation boutons -->
<div class="mt-8 flex justify-center gap-3">
                <button id="prev-question" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" style="display: none;">
                    <i class="fas fa-arrow-left mr-2"></i> <span data-i18n="prevQuestion">Question pr√©c√©dente</span>
                </button>
                <button id="next-question" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                    <span data-i18n="nextQuestion">Question suivante</span> <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="finish-test" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" style="display: none;">
                    <span data-i18n="finishTest">Terminer le test</span> <i class="fas fa-check ml-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="results-section"></div>

<!-- Evaluate a friend Section -->
<div id="home-enneagramme" data-aos="fade-left" class="section section-fonce py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <div class="text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="evalFriendTitle">
                √âvaluer un proche
            </h2>
            <p class="mt-4 text-xl text-gray-500" data-i18n="evalFriendSubtitle">
                Aidez un ami, un membre de votre famille ou un coll√®gue √† mieux comprendre sa personnalit√©
            </p>
        </div>

        <!-- Encadr√© arrondi harmonieux -->
        <div class="mt-12 mb-4 rounded-[2rem] shadow-sm border border-gray-200 px-6 py-8">
            <form id="evaluation-form">
                <div class="mb-6">
                    <label for="code" class="block text-sm font-medium text-gray-700" data-i18n="evalCodeLabel">Code unique de la personne</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input type="text" name="code" id="code" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-4 pr-12 py-3 sm:text-sm border-gray-300 rounded-md" placeholder="Ex: ABC123" data-i18n-placeholder="eval.codePlaceholder" required>
                        <div class="absolute inset-y-0 right-0 flex items-center">
                            <button type="button" id="search-code" class="h-full rounded-r-md border-transparent bg-gray-100 px-4 text-black hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-black">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500" data-i18n="evalCodeHint">Entrez le code que votre proche vous a communiqu√©</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="evalRelationLabel">Votre relation avec cette personne</label>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="family" name="relation" type="radio" value="family" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="family" class="font-medium text-gray-700" data-i18n="evalRelationFamily">Membre de la famille</label>
                                <p class="text-gray-500" data-i18n="evalRelationFamilyDesc">Parent, fr√®re, s≈ìur, enfant...</p>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="partner" name="relation" type="radio" value="partner" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="partner" class="font-medium text-gray-700" data-i18n="evalRelationPartner">Partenaire amoureux</label>
                                <p class="text-gray-500" data-i18n="evalRelationPartnerDesc">Conjoint, petit(e) ami(e)...</p>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="friend" name="relation" type="radio" value="friend" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="friend" class="font-medium text-gray-700" data-i18n="evalRelationFriend">Ami(e)</label>
                                <p class="text-gray-500" data-i18n="evalRelationFriendDesc">Ami proche, meilleur ami...</p>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="colleague" name="relation" type="radio" value="colleague" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="colleague" class="font-medium text-gray-700" data-i18n="evalRelationColleague">Coll√®gue de travail</label>
                                <p class="text-gray-500" data-i18n="evalRelationColleagueDesc">Coll√®gue, manager, collaborateur...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                        <span data-i18n="evalStartBtn">Commencer l'√©valuation</span> <i class="fas fa-play ml-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Section Chatbot -->
<section id="home-ia" data-aos="fade-up" class="section-clair py-16 px-4 sm:px-6 lg:px-8">
  <div class="max-w-3xl mx-auto">

    <!-- Titre centr√© -->
    <div class="text-center">
      <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="chatTitle">Parler avec Psycho'Bot</h2>
      <p class="mt-4 text-xl text-gray-500" data-i18n="chatSubtitle">
        Discutez avec notre assistant IA pour en savoir plus sur les profils inspir√©s du MBTI et Enn√©agramme.
      </p>
    </div>

    <!-- Bouton effacer, juste au-dessus du chat, align√© √† droite -->
    <div class="mt-4 flex justify-end">
      <button id="clear-chat"
              onclick="resetConversation()"
              class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium px-3 py-1 rounded-full shadow"
              data-i18n="chatReset">
        r√©initialiser
      </button>
    </div>

    <div class="mt-2">
      <!-- Fen√™tre de chat -->
      <div id="chat-window" class="h-[280px] sm:h-[320px] border border-gray-200 mb-4 bg-gray-50 flex flex-col">
        <div id="chat-box" class="flex-1 overflow-y-auto p-4" style="scroll-behavior: smooth;"></div>

        <!-- Suggestions: 2 c√¥te √† c√¥te, 3e centr√©e en dessous quand visible -->
        <div id="chat-suggestions" class="question-buttons p-3">
          <button class="suggestion-bubble" data-question="Explique-moi le mod√®le d√©riv√© MBTI" data-i18n="chatSugExplainMBTI">Explique-moi le mod√®le d√©riv√© MBTI</button>
          <button class="suggestion-bubble" data-question="Mon profil est-il inn√© ?" data-i18n="chatSugInnate">Mon profil est-il inn√© ?</button>
          <button class="suggestion-bubble" data-question="Pourquoi demander l‚Äôavis des proches ?" data-i18n="chatSugWhyRelatives">Pourquoi demander l‚Äôavis des proches ?</button>
        </div>

        <div id="pc-typing-indicator" class="pc-typing" aria-live="polite" role="status" hidden>
          <span class="pc-typing-text" data-i18n="chatTyping">Psycho'Bot est en train d'√©crire
            <span class="pc-dots"><span>.</span><span>.</span><span>.</span></span>
          </span>
        </div>
      </div>

      <!-- Zone de saisie -->
      <div class="flex w-full">
        <div class="flex w-full border border-gray-300 rounded-full overflow-hidden">
          <input id="chat-input" type="text" placeholder="Posez votre question √† Psycho'Bot..."
                 class="flex-grow px-4 py-2 text-gray-900 placeholder-gray-400 bg-white border-none focus:outline-none focus:ring-0" data-i18n-placeholder="chat.inputPlaceholder" />
          <button id="chat-send"
                  class="px-5 py-2 bg-black text-white font-medium hover:bg-gray-800 focus:outline-none">
            <span data-i18n="chatSend">Envoyer</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function scrollChatToBottom() {
    const box = document.getElementById('chat-box');
    if (box) box.scrollTop = box.scrollHeight;
  }
</script>


    <section id="retourver-profil" data-aos="zoom-in" class="section section-fonce py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto">
          <div class="text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl flex justify-center items-center gap-2">
              <i class="fas fa-search text-blue-500 animate-pulse"></i>
              <span data-i18n="retrieve.title">Retrouver un profil</span>
            </h2>
            <p class="mt-4 text-xl text-gray-500" data-i18n="retrieve.subtitle">
              Saisis le code unique que tu as re√ßu pour afficher un profil complet.
            </p>
          </div>
          <form onsubmit="event.preventDefault(); viewResults(document.getElementById('code-saisi').value);" autocomplete="off" class="mt-12 max-w-lg mx-auto">
            <div class="flex flex-col sm:flex-row items-center gap-4">
              <label for="code-saisi" class="sr-only" data-i18n="retrieve.codeLabel">Code re√ßu</label>
              <input type="text" id="code-saisi" class="flex-1 px-6 py-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 placeholder:text-gray-300 text-base text-center transition" placeholder="ABC123" maxlength="12" data-i18n-placeholder="retrieve.placeholder" required>
              <button type="submit" class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-lg font-semibold shadow hover:bg-gray-800 transition">
                <i class="fas fa-eye"></i> <span data-i18n="retrieve.viewButton">Voir le profil</span>
              </button>
            </div>
          </form>
        </div>
      </section>

<!-- Blog Preview Section -->
<section id="home-blog" data-aos="fade-up" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
  <div class="max-w-5xl mx-auto">
    <div class="text-center">
      <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="blogSection.title">Derniers articles</h2>
      <p class="mt-4 text-xl text-gray-500" data-i18n="blogSection.subtitle">Explorez notre blog pour approfondir le mod√®le inspir√© du MBTI et l‚ÄôEnn√©agramme</p>
    </div>
    <div class="mt-12 grid gap-6 md:grid-cols-2">
      <a href="blog-mbti-4-dimensions.html" class="block p-6 rounded-[2rem] bg-white shadow hover:shadow-md transition">
        <img src="blog1.jpeg" alt="Illustration du mod√®le inspir√© du MBTI" class="w-full h-auto max-h-40 object-contain rounded-[2rem] mb-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="blogPreview.mbti4.title">Les 4 dimensions du mod√®le inspir√© du MBTI</h3>
        <p class="text-gray-600 text-sm" data-i18n="blogPreview.mbti4.excerpt">Comprenez les axes fondamentaux qui structurent les 16 types de personnalit√©.</p>
      </a>
      <a href="blog-enneagramme-instincts.html" class="block p-6 rounded-[2rem] bg-white shadow hover:shadow-md transition">
        <img src="enneagramme.png" alt="Symbole de l'Enn√©agramme" class="w-full h-auto max-h-40 md:max-h-48 object-contain rounded-[2rem] mb-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="blogPreview.enneaInstincts.title">Comprendre les peurs profondes de l'Enn√©agramme</h3>
        <p class="text-gray-600 text-sm" data-i18n="blogPreview.enneaInstincts.excerpt">Explore les peurs fondamentales des neuf types et la mani√®re dont elles guident nos actions.</p>
      </a>
    </div>
  </div>
</section>

        <!-- FAQ Section -->
    <div id="home-faq" data-aos="fade-up" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto">
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="faq.title">
                    Questions fr√©quentes
                </h2>
                <p class="mt-4 text-xl text-gray-500" data-i18n="faq.subtitle">
                    Trouvez des r√©ponses aux questions les plus courantes
                </p>
            </div>
            
             <div class="mt-12 space-y-6">
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q1.question">Comment fonctionne le syst√®me de pond√©ration ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q1.answer">Avec le temps, nous avons constat√© que l‚Äôauto-√©valuation introduisait souvent des biais.<br>Le <strong>r√©sultat final repose donc uniquement sur l‚Äô√©valuation de trois proches</strong> de votre entourage.<br><br>Le syst√®me ne tient <strong>plus compte du lien</strong> (famille, ami, coll√®gue‚Ä¶), mais analyse la <strong>convergence de leurs r√©ponses</strong>.<br><br>‚û§ Si leurs r√©ponses sont <strong>fortement coh√©rentes</strong>, le <strong>score de certitude</strong> est √©lev√©.<br>‚û§ Si elles sont <strong>divergentes</strong>, le score sera plus faible, ce qui vous permet d‚Äôidentifier un profil encore flou ou nuanc√©.<br><br>Votre propre auto-√©valuation est toujours disponible, mais uniquement <strong>√† titre informatif</strong> ‚Äì elle <strong>n‚Äôinfluence plus le calcul</strong>.</p>
                        </div>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q2.question">Quelle intelligence artificielle se cache derri√®re Psycho'Bot ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q2.answer">Psycho'Bot fonctionne gr√¢ce au mod√®le gpt-4o-mini d‚ÄôOpenAI, une intelligence artificielle rapide et √©conomique, capable de fournir des r√©ponses pr√©cises et naturelles en temps r√©el.</p>
                        </div>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q3.question">Mes r√©ponses et celles de mes proches sont-elles anonymes ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q3.answer">Oui. Aucune identit√© n‚Äôest enregistr√©e avec les r√©ponses, et seules les donn√©es n√©cessaires au calcul du profil sont conserv√©es.</p>
                        </div>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q4.question">Mon code d‚Äôacc√®s est-il valable √† vie ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q4.answer">Oui. Votre code d‚Äôacc√®s reste valable ind√©finiment, ce qui vous permet de consulter vos r√©sultats √† tout moment, sans limite de dur√©e.</p>
                        </div>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q5.question">Puis-je voir les r√©ponses d√©taill√©es de chaque proche ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q5.answer">Non. Par souci de confidentialit√©, vous ne pouvez pas consulter le d√©tail des r√©ponses individuelles de vos proches. En revanche, dans votre page de r√©sultats, vous pouvez voir le profil inspir√© du MBTI et Enn√©agramme attribu√© √† chaque proche sur la base de ses r√©ponses.</p>
                        </div>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="faq.q6.question">Puis-je obtenir une interpr√©tation personnalis√©e de mes r√©sultats ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div class="faq-content mt-2 hidden">
                            <p class="text-gray-600" data-i18n="faq.q6.answer">Oui. Vous pouvez interroger Psycho‚ÄôBot dans la section "Parler avec Psycho‚ÄôBot" pour obtenir une interpr√©tation personnalis√©e de votre profil inspir√© du MBTI et Enn√©agramme. N‚Äôh√©sitez pas √† lui communiquer votre profil et √† lui poser toutes les questions que vous souhaitez.</p>
                        </div>
                    </button>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <p class="text-gray-600">
                    <span data-i18n="faq.moreQuestions">Vous avez d'autres questions ?</span> <a href="mailto:contact@personnalitecomparee.com" class="text-blue-600 hover:text-blue-500 font-medium" data-i18n="faq.contactUs">Contactez-nous</a>
                </p>
            </div>
        </div>
    </div>

    <!-- About Section -->
    <div id="home-about" class="section section-fonce py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="about.title">
                √Ä propos du projet
            </h2>
            <p class="mt-6 text-lg text-gray-600" data-i18n="about.description">
                "Personnalit√© Compar√©e" est n√© de la volont√© de cr√©er un outil plus objectif pour comprendre sa personnalit√©. Contrairement aux tests traditionnels qui reposent uniquement sur l'auto-√©valuation, notre approche combine votre perception avec celle de votre entourage pour un r√©sultat plus nuanc√© et fid√®le.
            </p>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-[#B94E4E]" style="background-color: #F6D1D1;">
                        <i class="fas fa-eye text-2xl drop-shadow-sm"></i>
                    </div>
                    <h3 class="mt-6 text-lg font-semibold text-gray-900" data-i18n="about.feature1.title">Vision objective</h3>
                    <p class="mt-3 text-sm text-gray-600" data-i18n="about.feature1.desc">
                        Combiner plusieurs perspectives pour une analyse plus compl√®te
                    </p>
                </div>
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-[#C9A227]" style="background-color: #FFF3B0;">
                        <i class="fas fa-shield-alt text-2xl drop-shadow-sm"></i>
                    </div>
                    <h3 class="mt-6 text-lg font-semibold text-gray-900" data-i18n="about.feature2.title">Confidentialit√©</h3>
                    <p class="mt-3 text-sm text-gray-600" data-i18n="about.feature2.desc">
                        Vos donn√©es sont prot√©g√©es et ne sont jamais partag√©es
                    </p>
                </div>
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full text-[#3C8F7C]" style="background-color: #B7E4C7;">
                        <i class="fas fa-graduation-cap text-2xl drop-shadow-sm"></i>
                    </div>
                    <h3 class="mt-6 text-lg font-semibold text-gray-900" data-i18n="about.feature3.title">Base scientifique</h3>
                    <p class="mt-3 text-sm text-gray-600" data-i18n="about.feature3.desc">
                        Fond√© sur les recherches en psychologie de la personnalit√©
                    </p>
                </div>
            </div>
            <div class="mt-8">
                <button onclick="showAboutProject()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                    <span data-i18n="about.button">En savoir plus sur le concept</span> <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <p class="text-xs text-gray-500 text-center mb-4">MBTI¬Æ est une marque d√©pos√©e de The Myers-Briggs Company. Ce site propose une approche inspir√©e et n‚Äôest ni affili√©, ni agr√©√©, ni soutenu par cette soci√©t√©.</p>
    <footer class="bg-gray-800">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.brand_title">Personnalit√© Compar√©e</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="index.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.home">Accueil</a></li>
        <li><a href="mbti.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.mbti">Mod√®le d√©riv√© MBTI</a></li>
        <li><a href="enneagramme.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.enneagram">Enn√©agramme</a></li>
        <li><a href="blog.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.blog">Blog</a></li>
        <li><a href="#home-ia" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.ai">IA sp√©cialis√©e</a></li>
        <li><a href="#home-faq" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.faq">FAQ</a></li>

                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.tests_title">Tests</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#home-mbti" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.auto_eval">Auto-√©valuation</a></li>
                        <li><a href="#home-enneagramme" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.evaluate_friend">√âvaluer un proche</a></li>
                        <li><a href="#retourver-profil" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.my_profile">Mon profil</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.legal_title">L√©gal</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" id="privacy-link" onclick="event.preventDefault(); showPrivacyPolicy();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.privacy">Confidentialit√©</a></li>
                        <li><a href="#" id="terms-link" onclick="event.preventDefault(); showTermsOfService();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.terms">Conditions d'utilisation</a></li>
                        <li><a href="#" id="legal-link" onclick="event.preventDefault(); showLegalNotices();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.legal">Mentions l√©gales</a></li>
                        <li><a href="#" id="cookies-link" onclick="event.preventDefault(); showCookies();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.cookies">Cookies</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.contact_title">Contact</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" id="support-link" onclick="event.preventDefault(); showSupport();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.support">Support</a></li>
                        <li class="flex space-x-6 pt-2">
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.facebook">Facebook</span>
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.instagram">Instagram</span>
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.tiktok">TikTok</span>
                                <i class="fab fa-tiktok"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-8">
                <p class="text-base text-gray-400 text-center" data-i18n="footer.copyright">
                    &copy; 2025 Personnalit√© Compar√©e. Tous droits r√©serv√©s.
                </p>
            </div>
        </div>
    </footer>
    <script src="questions-v2.js"></script>
      
   <script type="module">
import { supabase } from "./common.js";

        // Configuration et donn√©es
                // R√©cup√®re les questions externes depuis Supabase si l'utilisateur est un proche
let questions = AUTO_QUESTIONS;
// üîê G√©n√©re un code al√©atoire
function genererUniqueCode() {
  
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// üîÑ Envoie vers Supabase
async function enregistrerQuestionsPourProches(questionsAutoEvaluation, userCode) {
  // Mettre √† jour l'enregistrement existant avec les questions pour les proches
  const { data, error } = await supabase
    .from("users")
    .update({
      external_questions: questionsAutoEvaluation
    })
    .eq('code', userCode);

  if (error) {
    console.error("‚ùå Erreur lors de l'enregistrement Supabase :", error);
  } else {
    console.log("‚úÖ Questions pour proches enregistr√©es avec succ√®s :", data);
    alert((translations[document.documentElement.lang] || translations.fr).shareCodeAlert + userCode);
  }
}


if (window.location.href.includes("external")) {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");
  console.log("Code re√ßu dans l'URL :", code);

  if (code) {
    // Appelle Supabase pour r√©cup√©rer les questions li√©es √† ce code
    supabase
      .from("users")
      .select("external_questions")
      .eq("code", code)
      .then(({ data, error }) => {
        if (!error && data && data.length > 0 && data[0].external_questions) {
          questions = data[0].external_questions;
          console.log("Questions externes charg√©es :", questions);
          afficherQuestions(); // appel explicite
        } else {
          console.error("Aucune question externe trouv√©e ou erreur :", error);
        }
      });
  }
}

  // √âtat de l'application
        let currentQuestionIndex = 0;
        let answers = {};
        let testType = 'auto'; // 'auto' ou 'proche'
        let userCode = genererUniqueCode();
        let isSubmitting = false;
        let hasRendered = false;




        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupMobileMenu();
            setupDesktopDropdowns();
            setupFAQ();
            setupSmoothScrolling();
            setupProgressBars();
            setupEvaluationForm();
            loadFirstQuestion();
            initCountUp();
            updatePlaceholders();
        }

        function updatePlaceholders() {
            const lang = document.documentElement.lang;
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const translation = translations[lang] && translations[lang][key];
                if (translation !== undefined) {
                    el.placeholder = translation;
                }
            });
        }

        // Menu mobile
    function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.classList.contains('active');
                    
                    if (isOpen) {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.classList.add('active');
                        menuIcon.classList.remove('fa-bars');
                        menuIcon.classList.add('fa-times');
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                    // Remove persistent focus outline on mobile after tap
                    try { mobileMenuButton.blur(); } catch {}
                });

                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
        }
    }

    // Podcast audio visualizer (cercle avec barres radiales et halo)
    (function(){
      const audio = document.getElementById('home-podcast-audio');
      const canvas = document.getElementById('home-podcast-visual');
      if(!audio || !canvas) return;
      const ctx = canvas.getContext('2d');
      let ac = null, src = null, analyser = null, rafId = null;
      const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      const resize = ()=>{
        // Use actual rendered box to size the drawing buffer precisely
        const rect = canvas.getBoundingClientRect();
        const cssW = rect.width || 600;
        const cssH = rect.height || cssW; // aspect-ratio ensures square, but fallback to width
        canvas.width = Math.max(1, Math.round(cssW * dpr));
        canvas.height = Math.max(1, Math.round(cssH * dpr));
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels at (0,0)
      };
      resize();
      // Ensure layout is settled before sizing again
      requestAnimationFrame(resize);
      window.addEventListener('load', resize);
      let resizeTO; window.addEventListener('resize', ()=>{ clearTimeout(resizeTO); resizeTO=setTimeout(resize, 120); });
      const initAudio = ()=>{
        if (ac) return true;
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return false;
          ac = new AudioCtx();
          src = ac.createMediaElementSource(audio);
          analyser = ac.createAnalyser();
          analyser.fftSize = 128; // fen√™tre ultra courte => latence minimale
          analyser.smoothingTimeConstant = 0.12; // hyper r√©actif
          analyser.minDecibels = -90;
          analyser.maxDecibels = -10;
          src.connect(analyser);
          src.connect(ac.destination);
          return true;
        } catch(e) {
          return false;
        }
      };
      const draw = ()=>{
        if (!analyser) return;
        const rectDraw = canvas.getBoundingClientRect();
        const cssW = rectDraw.width || canvas.clientWidth || 600;
        const cssH = rectDraw.height || canvas.clientHeight || cssW;
        const cx = cssW/2, cy = cssH/2;
        const radius = Math.min(cssW, cssH) * 0.28; // rayon de base
        const barMax = Math.min(cssW, cssH) * 0.18;  // barres plus courtes (moins envahissantes)
        const freqBins = analyser.frequencyBinCount;
        const freqData = new Uint8Array(freqBins);
        const timeData = new Uint8Array(analyser.fftSize);
        const segments = 192; // cercle dense
        // Mapping lin√©aire avec wrap sur 360¬∞ pour √©viter les zones mortes
        const binMap = new Uint16Array(segments);
        for (let i=0;i<segments;i++){
          const t = i/segments; // 0..1
          const idx = Math.min(freqBins-1, Math.floor(t * freqBins));
          binMap[i] = idx;
        }
        const smooth = new Float32Array(segments);
        let t0 = performance.now();
        const render = ()=>{
          rafId = requestAnimationFrame(render);
          analyser.getByteFrequencyData(freqData);
          analyser.getByteTimeDomainData(timeData);
          // enveloppe instantan√©e (RMS) tr√®s l√©g√®re pour ancrer au tempo
          let sum=0; for(let k=0;k<timeData.length;k++){ const d=timeData[k]-128; sum+=d*d; }
          const envRms = Math.min(1, Math.sqrt(sum/timeData.length)/64);
          ctx.clearRect(0,0,cssW,cssH);
          ctx.save();
          // Centrer le rep√®re au milieu du canvas pour dessiner le cercle complet
          ctx.translate(cx, cy);
          // Anneau de pr√©‚Äëaffichage (visible avant lecture)
          ctx.lineWidth = 1.2;
          ctx.strokeStyle = 'rgba(148,163,184,0.30)';
          ctx.beginPath(); ctx.arc(0,0, radius-1, 0, Math.PI*2); ctx.stroke();

          // Barres radiales tout autour du cercle
          ctx.lineCap = 'round';
          ctx.globalCompositeOperation = 'lighter';
          const now = performance.now();
          const dt = Math.min(33, now - t0); t0 = now;
          for (let i=0;i<segments;i++){
            const bin = binMap[i];
            // moyenne locale de 3 bins pour √©viter des zones mortes
            const a0 = freqData[bin] || 0;
            const a1 = freqData[(bin+1)%freqBins] || 0;
            const a2 = freqData[(bin+2)%freqBins] || 0;
            let amp = (a0 + a1 + a2) / (3*255); // 0..1
            const floor = Math.min(0.15, 0.02 + envRms * 0.10);
            amp = Math.max(amp, floor);
            // cible hyper r√©active: spectre x enveloppe
            const target = Math.pow(amp, 1.0) * (0.58 + envRms * 1.12);
            // mont√©e/d√©croissance tr√®s rapides
            const prev = smooth[i] || 0;
            const up = prev + (target - prev) * 0.85;
            const down = prev * 0.62; // d√©croissance rapide
            const next = target > prev ? up : Math.max(target, down);
            // quantification l√©g√®re (saccad√©) mais fine pour la synchro
            const step = 0.03;
            const quant = Math.min(1, Math.max(0, Math.round(next/step) * step));
            smooth[i] = quant;
            const len = 4 + quant * barMax; // barres plus courtes

            const angle = (i / segments) * Math.PI * 2;
            const cos = Math.cos(angle), sin = Math.sin(angle);
            const x1 = cos * radius, y1 = sin * radius;
            const x2 = cos * (radius + len), y2 = sin * (radius + len);

            // couleur HSL bleu √©lectrique modul√©e par amplitude
            const l = Math.min(76, 56 + quant*24);
            ctx.strokeStyle = `hsl(210 100% ${l}%)`;
            ctx.shadowColor = 'rgba(59,130,246,0.65)';
            ctx.shadowBlur = 12 + quant*18;
            ctx.lineWidth = 1.2 + quant*1.6;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
          }
          ctx.globalCompositeOperation = 'source-over';
          ctx.restore();
        };
        render();
      };
      const start = async ()=>{
        if (!initAudio()) return;
        if (ac && ac.state === 'suspended') { try { await ac.resume(); } catch {} }
        if (!rafId) draw();
      };
      const stop = async ()=>{
        if (ac && ac.state === 'running') { try { await ac.suspend(); } catch {} }
        if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
        // keep last frame for a subtle paused look
      };
      audio.addEventListener('play', start);
      audio.addEventListener('pause', stop);
      audio.addEventListener('ended', stop);
      // Le contr√¥le de lecture est g√©r√© par la barre audio sous le cercle
      // Lancer imm√©diatement le rendu et initialiser l'audio pour afficher le cercle avant lecture
      initAudio();
      if (!rafId) draw();
    })();

        function setupDesktopDropdowns() {
            const dropdowns = [
                { containerId: 'home-menu-container', menuId: 'home-menu', buttonId: 'home-menu-button' },
                { containerId: 'mbti-menu-container', menuId: 'mbti-menu', buttonId: 'mbti-menu-button' },
                { containerId: 'ennea-menu-container', menuId: 'ennea-menu', buttonId: 'ennea-menu-button' }
            ];

            dropdowns.forEach(({ containerId, menuId, buttonId }) => {
                const container = document.getElementById(containerId);
                const menu = document.getElementById(menuId);
                const button = document.getElementById(buttonId);
                const caret = button ? button.querySelector('svg') : null;
                if (!container || !menu) return;

                let hideTimeout;

                const show = () => {
                    clearTimeout(hideTimeout);
                    menu.classList.remove('invisible', 'opacity-0');
                    menu.classList.add('visible', 'opacity-100');
                    if (caret) caret.classList.add('rotate-180');
                    if (button) button.setAttribute('aria-expanded', 'true');
                };

                const hide = () => {
                    hideTimeout = setTimeout(() => {
                        menu.classList.add('invisible', 'opacity-0');
                        menu.classList.remove('visible', 'opacity-100');
                        if (caret) caret.classList.remove('rotate-180');
                        if (button) button.setAttribute('aria-expanded', 'false');
                    }, 200);
                };

                container.addEventListener('mouseenter', show);
                container.addEventListener('mouseleave', hide);
                menu.addEventListener('mouseenter', show);
                menu.addEventListener('mouseleave', hide);
            });
        }

        // FAQ Accordion
        function setupFAQ() {
            const faqButtons = document.querySelectorAll('.faq-button');
            faqButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.querySelector('.faq-content');
                    const icon = this.querySelector('i');
                    const isOpen = !content.classList.contains('hidden');
                    
                    // Fermer toutes les autres FAQ
                    faqButtons.forEach(otherButton => {
                        if (otherButton !== this) {
                            const otherContent = otherButton.querySelector('.faq-content');
                            const otherIcon = otherButton.querySelector('i');
                            otherContent.classList.add('hidden');
                            otherIcon.classList.remove('rotate-180');
                        }
                    });
                    
                    // Toggle la FAQ actuelle
                    if (isOpen) {
                        content.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                    } else {
                        content.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                    }
                });
            });
        }

        // Smooth scrolling
        function setupSmoothScrolling() {
            const links = document.querySelectorAll('a[href^="#"]');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        const offsetTop = targetElement.offsetTop - 80; // Account for fixed nav
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        }

        // Animation des barres de progression
        function setupProgressBars() {
            const progressBars = document.querySelectorAll('.progress-bar');
            
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -100px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const targetWidth = bar.style.width;
                        bar.style.width = '0';
                        setTimeout(() => {
                            bar.style.width = targetWidth;
                        }, 100);
                    }
                });
            }, observerOptions);
            
            progressBars.forEach(bar => {
                observer.observe(bar);
            });
        }

        // Configuration du formulaire d'√©valuation
        function setupEvaluationForm() {
            const evaluationForm = document.getElementById('evaluation-form');
            if (evaluationForm) {
                evaluationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    startExternalEvaluation();
                });
            }
        }

        // Chargement de la premi√®re question
        function loadFirstQuestion() {
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                displayQuestion(0);
                setupQuestionNavigation();
            }
        }

       // Affichage d'une question
function displayQuestion(index) {
  const questionsContainer = document.getElementById('questions-container');
  const question = AUTO_QUESTIONS[index];

  if (!question || !questionsContainer) return;

  const progress = ((index + 1) / AUTO_QUESTIONS.length) * 100;

  const questionHTML = `
    <div class="question-container fade active bg-transparent overflow-hidden">
      <div class="px-6 py-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm font-medium text-black">
            <span data-i18n="question.label">Question</span> ${index + 1}/${AUTO_QUESTIONS.length}
          </span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
            <div class="progress-bar h-2.5 rounded-full transition-all duration-500"
                 style="width: ${progress}%; background: linear-gradient(90deg, hsl(${Math.round((progress/100)*120)} 90% 62%), hsl(${Math.round((progress/100)*120)} 90% 52%))"></div>
          </div>
        </div>

        <h3 class="text-xl font-medium text-gray-900 mb-6" data-i18n="questionnaire.auto.q${question.id}.title">${question.question}</h3>

        <div class="space-y-4">
          ${question.options.map((option, optionIndex) => {
            const dataI18n = option.text === "Je ne sais pas" ? 'question.option.dontknow' : `questionnaire.auto.q${question.id}.option${optionIndex + 1}`;
            return `
            <div class="flex items-start">
              <input id="q${question.id}-${optionIndex}"
                     name="question${question.id}"
                     type="radio"
                     value="${optionIndex}"
                     class="focus:ring-black h-4 w-4 text-black border-gray-300 mt-1"
                     ${answers[question.id] === optionIndex ? 'checked' : ''}>
              <label for="q${question.id}-${optionIndex}"
                     class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors"
                     data-i18n="${dataI18n}">
                ${option.text}
              </label>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
  `;

            questionsContainer.innerHTML = questionHTML;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // √âcouter les changements de r√©ponse
            const radioButtons = questionsContainer.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    answers[question.id] = parseInt(this.value);
                    saveProgress();
                    updateNavigationButtons();
                });
            });
            
            updateNavigationButtons();
        }

        // Configuration de la navigation entre questions
        function setupQuestionNavigation() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        displayQuestion(currentQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined) {
                        if (currentQuestionIndex < AUTO_QUESTIONS.length - 1) {
                            currentQuestionIndex++;
                            displayQuestion(currentQuestionIndex);
                        }
                    } else {
                        const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                        const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.selectAnswer) || 'Veuillez s√©lectionner une r√©ponse avant de continuer.';
                        alert(msg);
                    }
                });
            }
            
            if (finishButton) {
                finishButton.addEventListener('click', async function () {
                    if (isSubmitting) return;
                    if (hasRendered) {
                        displayResults(window.finalResults || {});
                        return;
                    }
                    if (Object.keys(answers).length !== AUTO_QUESTIONS.length) {
                        const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                        const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.completeAll) || 'Veuillez r√©pondre √† toutes les questions avant de terminer.';
                        alert(msg);
                        return;
                    }
                    isSubmitting = true;
                    finishButton.setAttribute('aria-disabled', 'true');
                    finishButton.style.pointerEvents = 'none';
                    await calculateResults();
                    finishButton.removeAttribute('aria-disabled');
                    finishButton.style.pointerEvents = '';
                    isSubmitting = false;
                    hasRendered = true;
                    const span = finishButton.querySelector('span[data-i18n]');
                    if (span) span.setAttribute('data-i18n', 'button.finishTest.saved');
                    const icon = finishButton.querySelector('i');
                    if (icon) icon.remove();
                    if (typeof applyTranslations === 'function') { applyTranslations(); }
                });
            }
        }

        function getScrollableAncestor(el) {
            let p = el.parentElement;
            while (p) {
                const style = getComputedStyle(p);
                const canScroll = /(auto|scroll)/.test(style.overflowY) || p.scrollHeight > p.clientHeight;
                if (canScroll) return p;
                p = p.parentElement;
            }
            return document.scrollingElement || document.documentElement; // fallback window
        }

        function waitForVisible(selector, timeout = 2000) {
            return new Promise((resolve, reject) => {
                const start = performance.now();
                const tick = () => {
                    const el = document.querySelector(selector);
                    if (el && el.offsetHeight > 0) return resolve(el);
                    if (performance.now() - start > timeout) return reject(new Error('timeout'));
                    requestAnimationFrame(tick);
                };
                tick();
            });
        }

        async function scrollToResults() {
            try {
                const el = await waitForVisible('#results-section', 2500);
                const header = document.querySelector('#site-header, header.sticky, .header.sticky');
                const headerH = header ? header.offsetHeight : 0;
                const scroller = getScrollableAncestor(el);
                const rect = el.getBoundingClientRect();
                const baseY = (scroller === document.scrollingElement || scroller === document.documentElement)
                    ? window.pageYOffset
                    : scroller.scrollTop;
                const targetY = baseY + rect.top - headerH - 8;
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        if (scroller === document.scrollingElement || scroller === document.documentElement) {
                            window.scrollTo({ top: Math.max(0, targetY), behavior: 'smooth' });
                        } else {
                            try { scroller.scrollTo({ top: Math.max(0, targetY), behavior: 'smooth' }); }
                            catch { scroller.scrollTop = Math.max(0, targetY); }
                        }
                        try { history.replaceState(null, '', '#results-section'); } catch {}
                    });
                });
            } catch (e) {
                const el = document.getElementById('results-section');
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Mise √† jour des boutons de navigation
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
            }
            
            const isLastQuestion = currentQuestionIndex === AUTO_QUESTIONS.length - 1;
            const hasAnswer = answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined;
            
            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        // Sauvegarde de la progression
        function saveProgress() {
            const progressData = {
                currentQuestionIndex,
                answers,
                testType,
                userCode,
                timestamp: Date.now()
            };
            localStorage.setItem('personalityTestProgress', JSON.stringify(progressData));

        }

        // Chargement de la progression sauvegard√©e
        function loadProgress() {
            const saved = localStorage.getItem('personalityTestProgress');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // V√©rifier si la sauvegarde n'est pas trop ancienne (24h)
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        currentQuestionIndex = data.currentQuestionIndex || 0;
                        answers = data.answers || {};
                        testType = data.testType || 'auto';
                        userCode = data.userCode || '';
                        return true;
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement de la progression:', e);
                }
            }
            return false;
        }

        /**
         * Enregistre le profil utilisateur (auto‚Äë√©valuation) dans Supabase.
         * Cette fonction ins√®re un enregistrement dans la table "users".
         * @param {Object} userProfile Contient le code unique, les types MBTI/Enn√©agramme,
         * les scores d√©taill√©s et le niveau de certitude.
         */
         async function saveUserProfileToSupabase(userProfile) {
  try {
    const { data, error } = await supabase
      .from('users')
      .insert({
        code: userProfile.code,
        mbti_scores: userProfile.mbtiScores,
        enneagram_scores: userProfile.enneagramScores,
        // Stocke les types auto pour r√©cup√©ration multi-appareils
        auto_mbti_type: userProfile.mbtiType,
        auto_enneagram_type: userProfile.enneagramType,
        // Les champs mbti_type/enneagram_type seront mis √† jour plus tard
        mbti_type: userProfile.mbtiType,
        enneagram_type: userProfile.enneagramType,
        certainty_score: 0
      })
      .select()
      .single();

    if (error) {
      console.error('Erreur lors de l\'enregistrement du profil utilisateur :', error);
    } else {
      console.log('Profil enregistr√© dans Supabase', data);

      if (testType === "auto") {
        enregistrerQuestionsPourProches(answers, userProfile.code);
      }
    }
  } catch (err) {
    console.error('Exception lors de l\'enregistrement du profil utilisateur :', err);
  }
}



        /**
         * Enregistre une √©valuation externe dans Supabase.
         * Cette fonction r√©cup√®re l'utilisateur par son code unique, puis ins√®re une √©valuation li√©e.
         * @param {String} code Code unique de l'utilisateur √©valu√©.
         * @param {String} relation Relation entre l'√©valuateur et l'utilisateur ("family", "partner", "friend", "colleague").
         * @param {Object} functionScores Scores des fonctions cognitives calcul√©s √† partir des r√©ponses.
         * @param {Object} enneagramScores Scores Enn√©agramme calcul√©s √† partir des r√©ponses.
         */
        async function saveExternalEvaluationToSupabase(code, relation, functionScores, enneagramScores) {
            try {
                // R√©cup√©rer l'utilisateur par code
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('code', code)
                    .single();
                if (userError || !user) {
                    console.error('Utilisateur introuvable pour ce code :', code, userError);
                    return;
                }
                const userId = user.id;
              // 1) Calcul des types √† partir des scores fournis
const { mbtiType: extMbtiType, enneagramType: extEnneagramTypeRaw } =
  getProfileFromScores(functionScores, enneagramScores);
const extEnneagramType = String(extEnneagramTypeRaw);

const { error: insertError } = await supabase
  .from('external_evaluations')
  .insert({
    user_id: userId,
    relation: relation,
    // ‚Üê ajoute cette ligne :
    function_scores: functionScores,
    mbti_scores: functionScores,
    enneagram_scores: enneagramScores,
    mbti_type: extMbtiType,
    enneagram_type: extEnneagramType
  });


                if (insertError) {
                    console.error('Erreur lors de l‚Äôenregistrement de l‚Äô√©valuation externe :', insertError);
                } else {
                    console.log('√âvaluation externe enregistr√©e dans Supabase');
                    await calculateFinalProfile(code);
                }
            } catch (err) {
                console.error('Exception lors de l‚Äôenregistrement de l‚Äô√©valuation externe :', err);
            }
        }

        /**
         * Calcule et enregistre le r√©sultat final si au moins trois √©valuations externes sont disponibles.
         * @param {String} userId Identifiant de l'utilisateur.
         */
        function getProfileFromScores(functionScores, enneagramScores) {
            const E = (functionScores.Fe || 0) + (functionScores.Te || 0) + (functionScores.Se || 0) + (functionScores.Ne || 0);
            const I = (functionScores.Fi || 0) + (functionScores.Ti || 0) + (functionScores.Si || 0) + (functionScores.Ni || 0);
            const S = (functionScores.Si || 0) + (functionScores.Se || 0);
            const N = (functionScores.Ni || 0) + (functionScores.Ne || 0);
            const T = (functionScores.Ti || 0) + (functionScores.Te || 0);
            const F = (functionScores.Fi || 0) + (functionScores.Fe || 0);
            const J = (functionScores.Te || 0) + (functionScores.Fe || 0);
            const P = (functionScores.Se || 0) + (functionScores.Ne || 0);
            const mbtiType =
                (E >= I ? 'E' : 'I') +
                (S >= N ? 'S' : 'N') +
                (T >= F ? 'T' : 'F') +
                (J >= P ? 'J' : 'P');
            let topEnnea = '1';
            Object.keys(enneagramScores).forEach(type => {
                if ((enneagramScores[type] || 0) > (enneagramScores[topEnnea] || 0)) {
                    topEnnea = type;
                }
            });
            return { mbtiType, enneagramType: topEnnea };
        }

        function getCoh√©renceMBTI(scores) {
            if (!scores) return "Inconnue";

            const E = (scores.Fe || 0) + (scores.Te || 0) + (scores.Se || 0) + (scores.Ne || 0);
            const I = (scores.Fi || 0) + (scores.Ti || 0) + (scores.Si || 0) + (scores.Ni || 0);
            const S = (scores.Si || 0) + (scores.Se || 0);
            const N = (scores.Ni || 0) + (scores.Ne || 0);
            const T = (scores.Ti || 0) + (scores.Te || 0);
            const F = (scores.Fi || 0) + (scores.Fe || 0);
            const J = (scores.Te || 0) + (scores.Fe || 0);
            const P = (scores.Se || 0) + (scores.Ne || 0);

            const pairs = [
                [I, E],
                [S, N],
                [T, F],
                [J, P]
            ];

            const √©carts = pairs.map(([a, b]) => Math.abs(a - b));

            const moyenne = √©carts.reduce((sum, val) => sum + val, 0) / pairs.length;

            if (moyenne >= 30) return "Forte";
            if (moyenne >= 15) return "Moyenne";
            return "Faible";
        }

        function getCoh√©renceEnn√©agramme(scores) {
            if (!scores) return "Inconnue";

            const types = Object.keys(scores);
            if (types.length === 0) return "Inconnue";

            let dominantType = types[0];
            types.forEach(type => {
                if ((scores[type] || 0) > (scores[dominantType] || 0)) {
                    dominantType = type;
                }
            });

            const dominantScore = scores[dominantType] || 0;
            const autres = types.filter(t => t !== dominantType).map(t => scores[t] || 0);
            const moyenneAutres = autres.reduce((sum, v) => sum + v, 0) / (autres.length || 1);

            const √©cart = dominantScore - moyenneAutres;

            if (√©cart > 20) return "Forte";
            if (√©cart >= 10) return "Moyenne";
            return "Faible";
        }

        function computeEnneagramWing(scores, coreType) {
            if (!scores || !coreType) return null;
            const left = coreType === '1' ? '9' : String(Number(coreType) - 1);
            const right = coreType === '9' ? '1' : String(Number(coreType) + 1);
            return (scores[left] || 0) >= (scores[right] || 0) ? left : right;
        }

       function computeWeightedResults(evaluations) {
    const functions = ['Fi','Fe','Ti','Te','Ni','Ne','Si','Se'];
    const types = ['1','2','3','4','5','6','7','8','9'];
    if (!Array.isArray(evaluations) || evaluations.length === 0) {
        return {
            mbtiType: null,
            enneagramType: null,
            enneagramWing: null,
            mbtiPercentages: {},
            mbtiStack: [],
            mbtiCertainty: 0,
            enneagramCertainty: 0,
            overallCertainty: 0
        };
    }

    // Pond√©ration par coh√©rence des √©valuateurs
    const COHERENCE_WEIGHTS = { Forte:1.0, Moyenne:0.7, Faible:0.4 };

    // Totaux pond√©r√©s et sommes de poids
    const funcTotals = Object.fromEntries(functions.map(k => [k, 0]));
    const enneaTotals = Object.fromEntries(types.map(k => [k, 0]));
    let funcWeightSum = 0;
    let enneaWeightSum = 0;

    evaluations.forEach(ev => {
        const fn = ev.mbti_scores || ev.function_scores || {};
        const en = ev.enneagram_scores || {};
        const cohMbti = getCoh√©renceMBTI(fn);
        const cohEnnea = getCoh√©renceEnn√©agramme(en);
        const wMbti = COHERENCE_WEIGHTS[cohMbti] || 0;
        const wEnnea = COHERENCE_WEIGHTS[cohEnnea] || 0;

        // Accumuler les fonctions
        functions.forEach(f => {
            funcTotals[f] += Number(fn[f] || 0) * wMbti;
        });
        funcWeightSum += wMbti;

        // Accumuler les scores Enn√©agramme
        types.forEach(t => {
            enneaTotals[t] += Number(en[t] || 0) * wEnnea;
        });
        enneaWeightSum += wEnnea;
    });

    const avgFunc = Object.fromEntries(functions.map(f => [f, funcWeightSum ? funcTotals[f] / funcWeightSum : 0]));
    const avgEnnea = Object.fromEntries(types.map(t => [t, enneaWeightSum ? enneaTotals[t] / enneaWeightSum : 0]));

    // D√©terminer le type √† partir des moyennes pond√©r√©es
    const E = (avgFunc.Fe || 0) + (avgFunc.Te || 0) + (avgFunc.Se || 0) + (avgFunc.Ne || 0);
    const I = (avgFunc.Fi || 0) + (avgFunc.Ti || 0) + (avgFunc.Si || 0) + (avgFunc.Ni || 0);
    const S = (avgFunc.Si || 0) + (avgFunc.Se || 0);
    const N = (avgFunc.Ni || 0) + (avgFunc.Ne || 0);
    const T = (avgFunc.Ti || 0) + (avgFunc.Te || 0);
    const F = (avgFunc.Fi || 0) + (avgFunc.Fe || 0);
    const J = (avgFunc.Te || 0) + (avgFunc.Fe || 0);
    const P = (avgFunc.Se || 0) + (avgFunc.Ne || 0);
    const mbtiType =
        (E >= I ? 'E' : 'I') +
        (S >= N ? 'S' : 'N') +
        (T >= F ? 'T' : 'F') +
        (J >= P ? 'J' : 'P');

    const mbtiStack = Object.entries(avgFunc)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,4)
        .map(([f])=>f);
    const totalFunc = Object.values(avgFunc).reduce((a,b)=>a+b,0);
    const mbtiPercentages = Object.fromEntries(functions.map(f=>[f, totalFunc?Math.round((avgFunc[f]/totalFunc)*100):0]));

    let enneagramType = null; let max = -Infinity;
    Object.entries(avgEnnea).forEach(([t,v])=>{ if(v>max){max=v; enneagramType=t;} });
    const left = enneagramType==='1'?'9':String(Number(enneagramType)-1);
    const right = enneagramType==='9'?'1':String(Number(enneagramType)+1);
    const enneagramWing = (avgEnnea[left] || 0) >= (avgEnnea[right] || 0) ? left : right;

    // Certitudes: conserver ta logique de pond√©ration par coh√©rence au niveau des types
    const mbtiWeightTotals = {};
    const enneagramWeightTotals = {};
    evaluations.forEach(ev => {
        const { mbtiType: tMbti, enneagramType: tEnnea } = getProfileFromScores(ev.mbti_scores || ev.function_scores || {}, ev.enneagram_scores || {});
        const cohMbti = getCoh√©renceMBTI(ev.mbti_scores || ev.function_scores || {});
        const cohEnnea = getCoh√©renceEnn√©agramme(ev.enneagram_scores || {});
        const wMbti = COHERENCE_WEIGHTS[cohMbti] || 0;
        const wEnnea = COHERENCE_WEIGHTS[cohEnnea] || 0;
        mbtiWeightTotals[tMbti] = (mbtiWeightTotals[tMbti] || 0) + wMbti;
        enneagramWeightTotals[tEnnea] = (enneagramWeightTotals[tEnnea] || 0) + wEnnea;
    });
    const totalEvals = evaluations.length;
    const mbtiTop = Math.max(...Object.values(mbtiWeightTotals), 0);
    const enneaTop = Math.max(...Object.values(enneagramWeightTotals), 0);
    const mbtiCertainty = Math.round((mbtiTop / totalEvals) * 100);
    const enneagramCertainty = Math.round((enneaTop / totalEvals) * 100);
    const overallCertainty = Math.round((mbtiCertainty + enneagramCertainty)/2);

    return {
        mbtiType,
        enneagramType,
        enneagramWing,
        mbtiPercentages,
        mbtiStack,
        mbtiCertainty,
        enneagramCertainty,
        overallCertainty,
        functionAverages: avgFunc,
        enneagramAverages: avgEnnea
    };
}

async function calculateFinalProfile(code) {
    try {
        const { data: user, error: userError } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score, auto_mbti_type, auto_enneagram_type')
            .eq('code', code)
            .single();
        if (userError || !user) {
            console.error('Utilisateur introuvable pour ce code :', code, userError);
            return null;
        }
        // Conserver un instantan√© de l'auto-√©valuation avant la mise √† jour
        const autoMbti = user.auto_mbti_type || user.mbti_type || null;
        const autoEnneagram = user.auto_enneagram_type || user.enneagram_type || null;
        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);
        if (evalError) {
            console.error('Erreur lors de la r√©cup√©ration des √©valuations externes :', evalError);
            return null;
        }
        if (!evaluations || evaluations.length === 0) {
            return { user, evaluations: [] };
        }

        const weighted = computeWeightedResults(evaluations);
        const overallCertainty = weighted.overallCertainty;

        await supabase
            .from('users')
            .update({
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                certainty_score: overallCertainty,
                mbti_scores: weighted.functionAverages,
                enneagram_scores: weighted.enneagramAverages
            })
            .eq('code', code);

        return {
            user: {
                id: user.id,
                code,
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                mbti_scores: weighted.functionAverages,
                enneagram_scores: weighted.enneagramAverages,
                certainty_score: overallCertainty
            },
            evaluations,
            mbtiCertainty: weighted.mbtiCertainty,
            enneagramCertainty: weighted.enneagramCertainty,
            overallCertainty,
            // Renvoyer l'auto-√©valuation pour comparaison c√¥t√© client (sans changer le sch√©ma)
            autoMbti,
            autoEnneagram
        };
    } catch (err) {
        console.error('Erreur lors du calcul du profil final :', err);
        return null;
    }
}

async function fetchUserProfileFromSupabase(code) {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score, auto_mbti_type, auto_enneagram_type')
            .eq('code', code);

        if (error) {
            console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur :', error);
            return null;
        }

        if (!data || data.length === 0) {
            return null;
        }

        const user = data[0];

        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);

        if (evalError) {
            console.error('Erreur lors de la r√©cup√©ration des √©valuations externes :', evalError);
        }

        return { user, evaluations: evaluations || [] };
    } catch (err) {
        console.error('Exception lors de la r√©cup√©ration du profil :', err);
        return null;
    }
}

async function calculateResults() {
    console.log("Bouton Terminer cliqu√©");
    const functionScores = { Fi: 0, Fe: 0, Ti: 0, Te: 0, Ni: 0, Ne: 0, Si: 0, Se: 0 };
    const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

    Object.keys(answers).forEach(questionId => {
        const questionIndex = parseInt(questionId) - 1;
        const answerIndex = answers[questionId];
        const question = AUTO_QUESTIONS[questionIndex];
        const selectedOption = question.options[answerIndex];

        Object.keys(selectedOption.functions).forEach(func => {
            functionScores[func] += selectedOption.functions[func];
        });

        Object.keys(selectedOption.enneagram).forEach(type => {
            enneagramScores[type] += selectedOption.enneagram[type];
        });
    });

    const E = functionScores.Fe + functionScores.Te + functionScores.Se + functionScores.Ne;
    const I = functionScores.Fi + functionScores.Ti + functionScores.Si + functionScores.Ni;
    const S = functionScores.Si + functionScores.Se;
    const N = functionScores.Ni + functionScores.Ne;
    const T = functionScores.Ti + functionScores.Te;
    const F = functionScores.Fi + functionScores.Fe;
    const J = functionScores.Te + functionScores.Fe;
    const P = functionScores.Se + functionScores.Ne;

    const mbtiType =
        (E >= I ? 'E' : 'I') +
        (S >= N ? 'S' : 'N') +
        (T >= F ? 'T' : 'F') +
        (J >= P ? 'J' : 'P');

    const enneagramType = Object.keys(enneagramScores).reduce((a, b) =>
        enneagramScores[a] > enneagramScores[b] ? a : b
    );
    const enneagramWing = computeEnneagramWing(enneagramScores, enneagramType);

    const traitPairs = [
        [E, I],
        [S, N],
        [T, F],
        [J, P]
    ];
    const mbtiCertainty = Math.min(95, Math.round(
        traitPairs.reduce((sum, [a, b]) => {
            const total = a + b;
            return total ? sum + Math.abs(a - b) / total : sum;
        }, 0) / traitPairs.length * 100
    ));

    const totalEnneagramScore = Object.values(enneagramScores).reduce((a, b) => a + b, 0);
    const enneagramCertainty = totalEnneagramScore
        ? Math.min(95, Math.round((enneagramScores[enneagramType] / totalEnneagramScore) * 100))
        : 0;

    const certaintyScore = Math.round((mbtiCertainty + enneagramCertainty) / 2);

const uniqueCode = genererUniqueCode();
  
    const userProfile = {
        code: uniqueCode,
        mbtiType,
        enneagramType,
        enneagramWing,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores: functionScores,
        enneagramScores,
        timestamp: Date.now()
    };

    await saveUserProfileToSupabase(userProfile);
    localStorage.setItem('userProfile_' + uniqueCode, JSON.stringify(userProfile));

    displayResults({
        code: uniqueCode,
        mbtiType,
        enneagramType,
        enneagramWing,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores: functionScores,
        enneagramScores
    });
}

function displayResults(results) {
    window.finalResults = results;
    const resultsHTML = generateResultsHTML(window.finalResults || {});

    const existing = document.getElementById('results-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'results-modal';
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900" data-i18n="results.summary.title">Vos r√©sultats</h2>
                <span class="close" onclick="closeResultsModal()">&times;</span>
            </div>
            <div class="modal-body">${resultsHTML}</div>
        </div>`;
    document.body.appendChild(modal);
    initCountUp(modal);

    if (typeof applyTranslations === 'function') {
        applyTranslations();
        const finalResults = window.finalResults || {};
        const lang = document.documentElement.lang || 'fr';
        const mbti = (finalResults.mbtiType || "").toUpperCase();
        const ennea = String(finalResults.enneagramType || "");

        let careerText =
            (translations[lang].results.career.mbti &&
                translations[lang].results.career.mbti[mbti]) ||
            (translations[lang].results.career.ennea &&
                translations[lang].results.career.ennea[ennea]) ||
            translations[lang].results.career.fallback;
        const careerEl = document.getElementById("careerProfileText");
        if (careerEl) { careerEl.innerText = careerText; }
    }

    localStorage.setItem('personalityTestResults', JSON.stringify(results));
    localStorage.removeItem('personalityTestProgress');
}

        // G√©n√©ration du HTML des r√©sultats
        function generateResultsHTML(results) {
            const lang = localStorage.getItem('lang') || 'fr';
            const mbtiDescKey = `mbti.types.${results.mbtiType}.desc`;
            const mbtiDesc = translations[lang][mbtiDescKey] || '';

            const enneaNameKey = `enneagramme.types.${results.enneagramType}.name`;
            const enneaName = translations[lang][enneaNameKey] || '';
            const enneaDescKey = `enneagramme.types.${results.enneagramType}.desc`;
            const enneaDesc = translations[lang][enneaDescKey] || '';
            const wingDisplay = results.enneagramWing ? `w${results.enneagramWing}` : '';

            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="results.summary.title">Vos r√©sultats</h2>
                        <p class="mt-4 text-xl text-gray-600" data-i18n="results.summary.subtitle">Voici votre profil de personnalit√© bas√© sur vos r√©ponses</p>
                    </div>
                    
                    <div class="mt-12 bg-white shadow-xl rounded-lg overflow-hidden">
                        <div class="px-6 py-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900" data-i18n="results.profile.title">Votre profil</h3>
                                    <p class="mt-1 text-gray-500"><span data-i18n="results.profile.completedOn">Analyse compl√©t√©e le</span> ${new Date().toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div class="mt-4 md:mt-0">
                                    <span class="personality-badge bg-green-100 text-green-800">${results.mbtiType}</span>
                                    <span class="personality-badge bg-blue-100 text-blue-800 ml-2">Type ${results.enneagramType}${wingDisplay}</span>
                                </div>
                            </div>
                            
                           <!-- Code unique pour partage -->
<div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between text-center md:text-left">
    <div>
      <h4 class="text-lg font-medium text-blue-900" data-i18n="results.code.title">Votre code unique</h4>
      <p class="text-sm text-blue-700 mt-1" data-i18n="results.code.share">Partagez ce code avec vos proches pour qu'ils puissent vous √©valuer</p>
    </div>
    <div class="mt-4 md:mt-0 flex flex-col gap-2 md:flex-row md:items-center md:space-x-3 items-center">
      <div class="bg-white border-2 border-blue-300 rounded-lg px-4 py-2">
        <span class="text-2xl font-bold text-blue-900 tracking-wider" id="unique-code">${results.code}</span>
      </div>
      <button onclick="copyCode('${results.code}')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
        <i class="fas fa-copy mr-1"></i> <span data-i18n="results.code.copy">Copier</span>
      </button>
    </div>
  </div>
</div>

                            
                         <div class="pc-info-banner" role="note" aria-live="polite" style="text-align: center;" data-i18n="results.banner.info">
  Voici les profils avec lesquels vous vous identifiez. Partagez votre code unique √† 3 proches, puis consultez vos r√©sultats d√©taill√©s dans la section 
  <strong>¬´ Mon profil ¬ª</strong> ou <strong>¬´ Retrouver un profil ¬ª</strong>.
</div>


                            <div class="mt-8 grid grid-cols-1 gap-8 md:grid-cols-2">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900" data-i18n="results.mbti.title">Profil MBTI</h4>
                                    <div class="mt-4 bg-green-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">${results.mbtiType}</p>
                                        <p class="text-gray-600 text-sm mt-1" data-i18n="${mbtiDescKey}">${mbtiDesc}</p>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-lg font-medium text-gray-900" data-i18n="results.enneagram.title">Profil Enn√©agramme</h4>
                                    <div class="mt-4 bg-blue-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">Type ${results.enneagramType}${wingDisplay} - <span data-i18n="${enneaNameKey}">${enneaName}</span></p>
                                        <p class="text-gray-600 text-sm mt-1" data-i18n="${enneaDescKey}">${enneaDesc}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 flex flex-wrap justify-center gap-4">
                                <button onclick="shareCode()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                    <i class="fas fa-share mr-2"></i> <span data-i18n="results.buttons.share">Partager</span>
                                </button>
                                <button onclick="restartTest()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-redo mr-2"></i> <span data-i18n="results.buttons.restart">Refaire le test</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fonctions utilitaires
        function initCountUp(root = document) {
            const elements = root.querySelectorAll('.countup');
            if (!elements.length) return;
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const endVal = parseFloat(el.dataset.value) || 0;
                        const suffix = el.dataset.suffix || '';
                        const counter = new CountUp(el, endVal, { duration: 1.5, suffix });
                        if (!counter.error) {
                            counter.start();
                        } else {
                            console.error(counter.error);
                        }
                        obs.unobserve(el);
                    }
                });
            }, { threshold: 0.5 });

            elements.forEach(el => {
                const suffix = el.dataset.suffix || '';
                el.textContent = '0' + suffix;
                observer.observe(el);
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                // Changer temporairement le texte du bouton
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i> Copi√© !';
                button.classList.remove('bg-black', 'hover:bg-gray-800');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-black', 'hover:bg-gray-800');
                }, 2000);
            }).catch(() => {
                alert('Code copi√© : ' + code);
            });
        }

        function restartTest() {
            if (confirm('√ätes-vous s√ªr de vouloir recommencer le test ? Vos r√©ponses actuelles seront perdues.')) {
                localStorage.removeItem('personalityTestProgress');
                localStorage.removeItem('personalityTestResults');
                currentQuestionIndex = 0;
                answers = {};
                hasRendered = false;

                // R√©initialiser la section des r√©sultats si elle existe
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    resultsSection.innerHTML = '';
                    resultsSection.className = '';
                }

                displayQuestion(0);
            }
        }
        // Gestion des modales
        function showModal(title, content) {
            const modalContainer = document.getElementById('modal-container');
            const modalHTML = `
                <div class="modal show" id="current-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="text-xl font-bold text-gray-900">${title}</h2>
                            <span class="close" onclick="closeModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // Fermer avec ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
            
            // Fermer en cliquant √† l'ext√©rieur
            document.getElementById('current-modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        function closeModal() {
            const modal = document.getElementById('current-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }

        // Descriptions d√©taill√©es MBTI
        const mbtiDetailedDescriptions = {
            'INTJ': {
                title: 'INTJ - L\'Architecte',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTJ sont des visionnaires strat√©giques avec un plan pour tout. Ils sont ind√©pendants, d√©termin√©s et ont une forte capacit√© √† voir les possibilit√©s futures.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Penseurs strat√©giques et visionnaires</li>
                            <li>Ind√©pendants et autonomes</li>
                            <li>Orient√©s vers les objectifs √† long terme</li>
                            <li>Excellents planificateurs</li>
                            <li>Pr√©f√®rent travailler seuls ou en petits groupes</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Architecte, ing√©nieur, scientifique, consultant en strat√©gie, d√©veloppeur de logiciels, chercheur.</p>
                    </div>
                `
            },
            'INTP': {
                title: 'INTP - Le Penseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTP sont des penseurs logiques et cr√©atifs, toujours √† la recherche de nouvelles id√©es et possibilit√©s th√©oriques.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Analystes logiques et objectifs</li>
                            <li>Curieux et ouverts aux nouvelles id√©es</li>
                            <li>Ind√©pendants et flexibles</li>
                            <li>Excellents r√©solveurs de probl√®mes</li>
                            <li>Pr√©f√®rent la th√©orie √† la pratique</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Chercheur, philosophe, math√©maticien, programmeur, analyste, professeur d'universit√©.</p>
                    </div>
                `
            }
            ,
            'ISTJ': {
                title: 'ISTJ - Le Logisticien',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTJ sont s√©rieux et fiables. Ils respectent les r√®gles et traditions, travaillent m√©thodiquement et prennent leurs responsabilit√©s au s√©rieux. Leur approche est pragmatique et organis√©e.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Responsables, pratiques et factuels</li>
                            <li>Respectent les traditions et les structures √©tablies</li>
                            <li>Mettent l'accent sur la pr√©cision et la loyaut√©</li>
                            <li>Pr√©f√©rent la stabilit√© et la planification</li>
                            <li>Peuvent √™tre r√©serv√©s et rigides face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Comptable, auditeur, administrateur, officier militaire, juge, gestionnaire de projet.</p>
                    </div>
                `
            },
            'ISTP': {
                title: 'ISTP - Le Virtuose',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTP sont pragmatiques et analytiques. Ils aiment comprendre comment fonctionnent les choses et s'attaquer √† des probl√®mes concrets. Flexibles et observateurs, ils pr√©f√®rent apprendre par l'exp√©rience.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Calmes et r√©alistes</li>
                            <li>Analytiques et logiques</li>
                            <li>Aiment d√©monter et r√©parer des objets</li>
                            <li>S'adaptent rapidement aux situations de crise</li>
                            <li>Peuvent para√Ætre distants √©motionnellement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">M√©canicien, ing√©nieur, pilote, technicien, enqu√™teur.</p>
                    </div>
                `
            },
            'ISFJ': {
                title: 'ISFJ - Le Protecteur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFJ sont chaleureux et consciencieux. Ils veillent √† pr√©server l'harmonie et la s√©curit√© de leur entourage. Ils respectent les traditions et sont attentifs aux besoins des autres.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Bienveillants, loyaux et responsables</li>
                            <li>Organis√©s et m√©thodiques</li>
                            <li>Souvent modestes et discrets</li>
                            <li>Se soucient des besoins des autres avant les leurs</li>
                            <li>Peuvent √™tre r√©ticents face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, biblioth√©caire, assistant social, gestionnaire administratif.</p>
                    </div>
                `
            },
            'ISFP': {
                title: 'ISFP - L\'Aventurier',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFP sont sensibles, discrets et artistiques. Ils appr√©cient l'harmonie, la beaut√© et la libert√© de s'exprimer. Ils vivent l‚Äôinstant pr√©sent et recherchent l'√©quilibre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Cr√©atifs et artistiques</li>
                            <li>Empathiques et chaleureux</li>
                            <li>Discrets et r√©serv√©s</li>
                            <li>Appr√©cient la libert√© et l‚Äôind√©pendance</li>
                            <li>Peuvent √©viter les conflits et les planifications rigides</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Artiste, designer, photographe, chef cuisinier, travailleur social.</p>
                    </div>
                `
            },
            'INFJ': {
                title: 'INFJ - L\'Avocat',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFJ sont perspicaces et id√©alistes. Ils sont guid√©s par leurs valeurs et cherchent √† comprendre les motivations profondes des autres. Ils sont cr√©atifs et se consacrent √† aider autrui.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Visionnaires et orient√©s vers un sens profond</li>
                            <li>Empathiques et compatissants</li>
                            <li>Cr√©atifs et originaux</li>
                            <li>Organis√©s et d√©termin√©s</li>
                            <li>Peuvent se sentir incompris ou retir√©s</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Conseiller, psychologue, √©crivain, enseignant, humanitaire.</p>
                    </div>
                `
            },
            'INFP': {
                title: 'INFP - Le M√©diateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFP sont id√©alistes et empathiques. Guid√©s par leurs valeurs, ils cherchent un sens profond √† la vie et s‚Äôefforcent de rendre le monde meilleur. Ils sont cr√©atifs et sensibles.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Id√©alistes et guid√©s par leurs valeurs</li>
                            <li>Empathiques et compatissants</li>
                            <li>Cr√©atifs et expressifs</li>
                            <li>Aiment l'authenticit√© et l'individualit√©</li>
                            <li>Peuvent √™tre r√©serv√©s et √©viter les conflits</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">√âcrivain, psychologue, conseiller, artiste, musicien.</p>
                    </div>
                `
            },
            'ENTJ': {
                title: 'ENTJ - Le Commandant',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTJ sont des leaders n√©s, charismatiques et logiques. Ils aiment structurer des organisations, planifier l'avenir et relever des d√©fis. Ils sont d√©termin√©s et ax√©s sur l‚Äôefficacit√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Leaders strat√©giques et assertifs</li>
                            <li>D√©cisifs et organis√©s</li>
                            <li>Adeptes de la planification et de l'ex√©cution</li>
                            <li>Orient√©s vers les objectifs et la r√©ussite</li>
                            <li>Peuvent para√Ætre autoritaires ou impatients</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Directeur g√©n√©ral, avocat, chef de projet, politicien, entrepreneur.</p>
                    </div>
                `
            },
            'ENTP': {
                title: 'ENTP - L\'Innovateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTP sont cr√©atifs et curieux. Ils aiment explorer de nouvelles id√©es, d√©battre et remettre en question le statu quo. Flexibles, ils pr√©f√®rent les possibilit√©s ouvertes aux routines strictes.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Inventifs et plein d'esprit</li>
                            <li>Aiment d√©battre et argumenter</li>
                            <li>S'adaptent rapidement √† de nouveaux concepts</li>
                            <li>Aiment les d√©fis intellectuels</li>
                            <li>Peuvent s'ennuyer avec la routine et la gestion des d√©tails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Avocat, consultant, entrepreneur, inventeur, journaliste.</p>
                    </div>
                `
            },
            'ENFJ': {
                title: 'ENFJ - Le Donateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFJ sont charismatiques et attentifs aux autres. Ils comprennent intuitivement les besoins des gens et aiment motiver et inspirer. Ils recherchent l‚Äôharmonie et le d√©veloppement personnel et collectif.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux, empathiques et organis√©s</li>
                            <li>Communicateurs naturels</li>
                            <li>Aident les autres √† r√©aliser leur potentiel</li>
                            <li>Orient√©s vers les valeurs et l'harmonie</li>
                            <li>Peuvent s'oublier au profit des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Professeur, coach, psychologue, coordinateur d‚Äô√©v√©nements, diplomate.</p>
                    </div>
                `
            },
            'ENFP': {
                title: 'ENFP - L\'Inspirateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFP sont enthousiastes et cr√©atifs. Ils s‚Äô√©panouissent dans l'exploration de nouvelles id√©es et inspirent les autres gr√¢ce √† leur vision optimiste. Ils cherchent l‚Äôauthenticit√© et la libert√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>√ânerg√©tiques et imaginatifs</li>
                            <li>Empathiques et communicatifs</li>
                            <li>S'√©panouissent dans les relations</li>
                            <li>Aiment l'innovation et la diversit√©</li>
                            <li>Peuvent se disperser et n√©gliger les d√©tails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Inf√©rieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Journaliste, conseiller, animateur, auteur, professionnel des relations publiques.</p>
                    </div>
                `
            },
            'ESTP': {
                title: 'ESTP - L\'Entrepreneur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTP sont √©nergiques et orient√©s vers l'action. Ils aiment vivre l'instant pr√©sent et r√©soudre des situations concr√®tes. Adaptables et sociables, ils prennent des d√©cisions rapides.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Dynamiques et aventuriers</li>
                            <li>Pragmatiques et r√©alistes</li>
                            <li>Orient√©s vers les r√©sultats imm√©diats</li>
                            <li>Bons communicateurs et n√©gociateurs</li>
                            <li>Peuvent se montrer impatients et risquer l'impulsivit√©</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Pens√©e Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Entrepreneur, d√©tective, pilote, vendeur, pompier.</p>
                    </div>
                `
            },
            'ESTJ': {
                title: 'ESTJ - L\'Ex√©cutif',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTJ sont organis√©s et directs. Ils se fient aux faits et aiment structurer les activit√©s pour obtenir des r√©sultats efficaces. Ils valorisent la tradition et l‚Äôordre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Pragmatiques et responsables</li>
                            <li>Directs et orient√©s vers l'action</li>
                            <li>Logiques et objectifs</li>
                            <li>Aiment organiser et diriger</li>
                            <li>Peuvent √™tre inflexibles ou autoritaires</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inf√©rieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Gestionnaire, officier militaire, policier, juge, chef de projet.</p>
                    </div>
                `
            },
            'ESFP': {
                title: 'ESFP - L\'Amuseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFP sont spontan√©s et sociables. Ils aiment profiter de la vie et attirer l'attention. Pratiques et chaleureux, ils encouragent les autres √† vivre pleinement chaque moment.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Sociables et enthousiastes</li>
                            <li>Spontan√©s et √©nergiques</li>
                            <li>Aiment le divertissement et la vari√©t√©</li>
                            <li>Observateurs et pratiques</li>
                            <li>Peuvent √™tre sensibles aux critiques et √©viter la planification</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pens√©e Extravertie (Te)</p>
                            <p><strong>Inf√©rieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Acteur, animateur, h√¥te, vendeur, infirmier p√©diatrique.</p>
                    </div>
                `
            },
            'ESFJ': {
                title: 'ESFJ - Le Consul',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFJ sont aimables et sociables. Ils prennent soin des autres et veillent √† maintenir l'harmonie. Organis√©s et consciencieux, ils travaillent pour soutenir leur communaut√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux et serviables</li>
                            <li>Organis√©s et responsables</li>
                            <li>Centr√©s sur la communaut√© et la tradition</li>
                            <li>Communicateurs empathiques</li>
                            <li>Peuvent √™tre sensibles √† la critique et rechercher l'approbation</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inf√©rieure :</strong> Pens√©e Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carri√®res typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, gestionnaire d'√©v√©nements, conseiller, travailleur social.</p>
                    </div>
                `
            }
        };

        // Descriptions d√©taill√©es Enn√©agramme
        const enneagramDetailedDescriptions = {
            '1': {
                title: 'Type 1 - Le Perfectionniste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type 1 sont motiv√©s par le besoin de vivre correctement, d'am√©liorer le monde et d'√©viter la col√®re.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre corrompu, d√©fectueux ou mauvais</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre bon, vertueux et parfait</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Id√©alistes et responsables</li>
                            <li>Fort sens moral et √©thique</li>
                            <li>Perfectionnistes et critiques</li>
                            <li>Organis√©s et m√©thodiques</li>
                            <li>Peuvent √™tre rigides et col√©riques</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Sages, discernants, r√©alistes et nobles. Peuvent √™tre moralement h√©ro√Øques.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Deviennent critiques, perfectionnistes et peuvent exploser de col√®re.</p>
                    </div>
                `
            },
            '2': {
                title: 'Type 2 - L\'Altruiste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†2 sont motiv√©s par le besoin d'√™tre aim√©s et n√©cessaires. Ils sont empathiques, chaleureux et g√©n√©reux, mais peuvent devenir possessifs et trop ax√©s sur la reconnaissance.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas √™tre aim√©s ou √™tre inutiles</p>
                            <p><strong>D√©sir fondamental :</strong> Se sentir appr√©ci√©s, aim√©s et n√©cessaires</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Empathiques et chaleureux</li>
                            <li>Serviables et g√©n√©reux</li>
                            <li>Adapt√©s aux besoins des autres</li>
                            <li>Peuvent √™tre d√©pendants de la reconnaissance</li>
                            <li>Parfois possessifs ou envahissants</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont altruistes, aimants et d√©sint√©ress√©s. Ils soutiennent les autres de mani√®re authentique sans attendre de retour.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir envahissants, ressentir de la jalousie et s'√©puiser en donnant trop.</p>
                    </div>
                `
            },
            '3': {
                title: 'Type 3 - Le B√¢tisseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†3 sont motiv√©s par le besoin de r√©ussir et d'√™tre admir√©s. Ambitieux et √©nergiques, ils sont adaptables et conscients de leur image, mais peuvent devenir pr√©occup√©s par leur statut.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas avoir de valeur personnelle</p>
                            <p><strong>D√©sir fondamental :</strong> Se sentir pr√©cieux et admir√© pour leurs r√©alisations</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Ambitieux et charismatiques</li>
                            <li>Efficaces et comp√©titifs</li>
                            <li>Flexibles et orient√©s vers les objectifs</li>
                            <li>Tr√®s conscients de leur image</li>
                            <li>Peuvent n√©gliger leurs √©motions ou celles des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont authentiques, inspirants et encouragent les autres √† r√©ussir. Ils assument leurs valeurs personnelles plut√¥t que de rechercher uniquement la reconnaissance.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir obs√©d√©s par leur image, ignorer leurs besoins √©motionnels et craindre l'√©chec.</p>
                    </div>
                `
            },
            '4': {
                title: 'Type 4 - L\'Artiste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†4 recherchent l'authenticit√© et un sens personnel. Sensibles et cr√©atifs, ils veulent √™tre compris et exprimer leur individualit√©. Ils peuvent √™tre introspectifs et parfois m√©lancoliques.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Ne pas avoir d'identit√© ou de valeur personnelle</p>
                            <p><strong>D√©sir fondamental :</strong> Trouver leur v√©ritable identit√© et s'exprimer de mani√®re authentique</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Sensibles et introspectifs</li>
                            <li>Cr√©atifs et expressifs</li>
                            <li>Appr√©cient la profondeur et l'authenticit√©</li>
                            <li>Peuvent √™tre m√©lancoliques et se sentir diff√©rents</li>
                            <li>Recherchent souvent un sens et une connexion profonde</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont hautement cr√©atifs, inspir√©s et capables de transformer leur exp√©rience personnelle en quelque chose d'universel.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent se sentir incompris, se retirer et devenir auto‚Äëindulgents ou envieux des autres.</p>
                    </div>
                `
            },
            '5': {
                title: 'Type 5 - L\'Investigateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†5 veulent comprendre le monde. Ils sont observateurs, innovants et autonomes. Ils peuvent se retirer pour pr√©server leur √©nergie et d√©velopper leurs connaissances.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre impuissant, inutile ou incapable</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre comp√©tent et comprendre l'environnement</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Observateurs et analytiques</li>
                            <li>Innovants et cr√©atifs</li>
                            <li>Ind√©pendants et r√©serv√©s</li>
                            <li>Recherchent la ma√Ætrise de leurs domaines d'int√©r√™t</li>
                            <li>Peuvent se couper de leurs √©motions ou des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont visionnaires, pionniers et apportent des id√©es novatrices qui am√©liorent la soci√©t√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir d√©tach√©s, trop rationnels et √©viter la participation sociale.</p>
                    </div>
                `
            },
            '6': {
                title: 'Type 6 - Le Loyaliste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†6 recherchent la s√©curit√© et la confiance. Loyaux et fiables, ils anticipent les probl√®mes et recherchent le soutien. Ils peuvent osciller entre la prudence et l'audace.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre sans soutien ou sans direction</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre en s√©curit√© et soutenu</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Fiables et d√©vou√©s</li>
                            <li>Consciencieux et travailleurs</li>
                            <li>Tendance √† anticiper les probl√®mes</li>
                            <li>Peuvent osciller entre doute et confiance</li>
                            <li>Parfois anxieux ou sceptiques</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils sont courageux, engag√©s et se mettent au service d'une cause plus grande qu'eux.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir m√©fiants, autoritaires ou excessivement anxieux.</p>
                    </div>
                `
            },
            '7': {
                title: 'Type 7 - L\'Enthousiaste',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†7 sont optimistes et aventuriers. Ils recherchent des exp√©riences stimulantes et veulent √©viter la douleur et l'ennui. Souvent joyeux, ils peuvent se disperser.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre priv√©s ou coinc√©s dans la souffrance</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre heureux, satisfaits et libres</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Extravertis et optimistes</li>
                            <li>Polyvalents et spontan√©s</li>
                            <li>Curieux et enthousiastes</li>
                            <li>Aiment planifier des projets et des voyages</li>
                            <li>Peuvent √™tre dispers√©s ou √©viter la douleur √† tout prix</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils canaliseront leur √©nergie dans des objectifs significatifs et appr√©cieront la simplicit√© et la gratitude.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent fuir les responsabilit√©s, se disperser ou chercher des distractions excessives.</p>
                    </div>
                `
            },
            '8': {
                title: 'Type 8 - Le Challenger',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†8 valorisent l'ind√©pendance et la protection. Ils sont confiants, forts et veulent se prot√©ger et prot√©ger les autres. Ils peuvent devenir dominants s'ils se sentent menac√©s.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> √ätre bless√©s ou contr√¥l√©s par autrui</p>
                            <p><strong>D√©sir fondamental :</strong> √ätre ma√Ætres de leur vie et prot√©ger les faibles</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Assertifs et d√©cisifs</li>
                            <li>Confiants et protecteurs</li>
                            <li>Dirigeants naturels</li>
                            <li>D√©fendent leurs convictions</li>
                            <li>Peuvent √™tre contr√¥lants ou impulsifs</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils utilisent leur force pour am√©liorer le monde et prot√©ger les vuln√©rables. Ils sont magnanimes et courageux.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent devenir dominateurs, se m√©fier des autres et r√©agir avec col√®re.</p>
                    </div>
                `
            },
            '9': {
                title: 'Type 9 - Le M√©diateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les Type¬†9 recherchent la paix int√©rieure et ext√©rieure. Ils sont r√©ceptifs, conciliants et stables. Ils fuient les conflits et peuvent devenir complaisants pour pr√©server l'harmonie.</p>

                        <h3 class="text-lg font-semibold text-gray-900">Motivations profondes :</h3>
                        <div class="bg-teal-50 p-4 rounded-lg">
                            <p><strong>Peur fondamentale :</strong> Perdre la connexion ou √™tre s√©par√© des autres</p>
                            <p><strong>D√©sir fondamental :</strong> Maintenir la paix et l'harmonie</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caract√©ristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>R√©ceptifs et rassurants</li>
                            <li>Stables et accommodants</li>
                            <li>M√©diateurs naturels</li>
                            <li>√âvitent les conflits et la prise de d√©cision</li>
                            <li>Peuvent devenir complaisants ou inertes</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En sant√© :</h3>
                        <p class="text-gray-700">Ils apportent la paix et la coh√©sion, aident les autres √† coop√©rer et deviennent des sources d'unit√©.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">En stress :</h3>
                        <p class="text-gray-700">Ils peuvent ignorer leurs propres besoins, √©viter les conflits et se dissocier √©motionnellement.</p>
                    </div>
                `
            }
        };

        // Fonctions pour afficher les d√©tails
        function showMBTIDetails(type) {
            const details = mbtiDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`${type} - Description`, `<p>Description d√©taill√©e du type ${type} en cours de d√©veloppement.</p>`);
            }
        }

        function showEnneagramDetails(type) {
            const details = enneagramDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`Type ${type} - Description`, `<p>Description d√©taill√©e du type ${type} en cours de d√©veloppement.</p>`);
            }
        }

        function showAboutProject() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-700" data-i18n="home.modal.paragraph1">"Personnalit√© Compar√©e" est n√© de la volont√© de cr√©er un outil plus objectif pour comprendre sa personnalit√©.</p>

                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="home.modal.subtitle1">Notre approche unique :</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-eye text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold" data-i18n="home.modal.card1.title">Vision objective</h4>
                            <p class="text-sm text-gray-600" data-i18n="home.modal.card1.text">Combiner plusieurs perspectives pour une analyse plus compl√®te</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-shield-alt text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold" data-i18n="home.modal.card2.title">Confidentialit√©</h4>
                            <p class="text-sm text-gray-600" data-i18n="home.modal.card2.text">Vos donn√©es sont prot√©g√©es et ne sont jamais partag√©es</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <i class="fas fa-graduation-cap text-green-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold" data-i18n="home.modal.card3.title">Base scientifique</h4>
                            <p class="text-sm text-gray-600" data-i18n="home.modal.card3.text">Fond√© sur les recherches en psychologie de la personnalit√©</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="home.modal.subtitle2">Pourquoi cette approche ?</h3>
                    <p class="text-gray-700" data-i18n="home.modal.paragraph2">Contrairement aux tests traditionnels qui reposent uniquement sur l'auto-√©valuation, notre approche combine votre perception avec celle de votre entourage pour un r√©sultat plus nuanc√© et fid√®le.</p>

                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="home.modal.subtitle3">Comment √ßa marche ?</h3>
                    <ol class="list-decimal list-inside text-gray-700 space-y-1">
                        <li data-i18n="home.modal.list.item1">Vous r√©pondez √† 20 questions d'auto-√©valuation</li>
                        <li data-i18n="home.modal.list.item2">Vous partagez votre code unique avec vos proches</li>
                        <li data-i18n="home.modal.list.item3">Ils r√©pondent √† 20 questions sur votre personnalit√©</li>
                        <li data-i18n="home.modal.list.item4">Notre algorithme combine toutes les r√©ponses avec une pond√©ration scientifique</li>
                        <li data-i18n="home.modal.list.item5">Vous obtenez votre profil MBTI et Enn√©agramme avec un score de certitude</li>
                    </ol>
                </div>
            `;
            showModal('<span data-i18n="home.modal.title">√Ä propos du projet</span>', content);
        }

        // Fonctions pour les pages l√©gales et contact
function showPrivacyPolicy() {
  const lang = localStorage.getItem('lang') || 'fr';
  const date = new Date().toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US');
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.privacy.title">Politique de Confidentialit√©</h3>
      <p class="text-gray-700"><span data-i18n="footer.legal.privacy.update">Derni√®re mise √† jour :</span> ${date}</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.collected.title">1. Donn√©es collect√©es</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.collected.desc">Nous collectons uniquement les r√©ponses fournies lors&nbsp;:</p>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.collected.item1">de vos auto-√©valuations ;</li>
        <li data-i18n="footer.legal.privacy.collected.item2">des √©valuations r√©alis√©es par vos proches.</li>
      </ul>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.collected.note">Aucune autre donn√©e personnelle (nom, e-mail, localisation, etc.) n‚Äôest demand√©e ni enregistr√©e.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.purpose.title">2. Finalit√© de la collecte</h4>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.purpose.item1">Calculer et afficher votre profil de personnalit√© ;</li>
        <li data-i18n="footer.legal.privacy.purpose.item2">G√©n√©rer les r√©sultats finaux √† partir des √©valuations re√ßues.</li>
      </ul>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.storage.title">3. Stockage des donn√©es</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.storage.text">Vos r√©ponses sont stock√©es de mani√®re s√©curis√©e dans notre base de donn√©es <strong>Supabase</strong>. Elles ne sont pas enregistr√©es ailleurs.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.sharing.title">4. Partage des donn√©es</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.sharing.text">Nous ne vendons, n‚Äô√©changeons et ne partageons <strong>aucune</strong> donn√©e avec des tiers. Seules les personnes disposant de votre code unique peuvent consulter vos r√©sultats.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.security.title">5. S√©curit√©</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.security.text">Supabase applique des mesures de s√©curit√© standards (chiffrement en transit, contr√¥les d‚Äôacc√®s). Nous limitons l‚Äôacc√®s aux donn√©es aux seules finalit√©s d√©crites ci-dessus.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.retention.title">6. Dur√©e de conservation</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.retention.text">Les r√©ponses sont conserv√©es tant que votre code unique reste valide dans notre base. Vous pouvez demander leur suppression √† tout moment.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.rights.title">7. Vos droits</h4>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.rights.item1">Demander une copie de vos donn√©es ;</li>
        <li data-i18n="footer.legal.privacy.rights.item2">Demander la suppression d√©finitive de vos donn√©es.</li>
      </ul>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.rights.contact">Pour exercer ces droits, contactez-nous via la section <strong>Support</strong> du site.</p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.privacy.title">Politique de Confidentialit√©</span>', content);
}

function showTermsOfService() {
  const lang = localStorage.getItem('lang') || 'fr';
  const date = new Date().toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US');
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.terms.title">Conditions d'Utilisation</h3>
      <p class="text-gray-700"><span data-i18n="footer.legal.terms.update">Derni√®re mise √† jour :</span> ${date}</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.use.title">Utilisation du service</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.use.text">Ce service est fourni gratuitement √† des fins √©ducatives et de d√©veloppement personnel. Il ne remplace pas un conseil professionnel en psychologie.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.accuracy.title">Pr√©cision des r√©sultats</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.accuracy.text">Les r√©sultats sont bas√©s sur des mod√®les psychologiques reconnus mais ne constituent pas un diagnostic m√©dical ou psychologique.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.liability.title">Responsabilit√©</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.liability.text">L'utilisation de ce service se fait sous votre propre responsabilit√©. Nous ne sommes pas responsables des d√©cisions prises sur la base des r√©sultats.</p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.terms.title">Conditions d\'Utilisation</span>', content);
}
function showLegalNotices() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.mentions.title">Mentions L√©gales</h3>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.editor.title">√âditeur du site</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.editor.text">
        <strong>Personnalit√© Compar√©e</strong><br>
        Site web √©ducatif et informatif sur les tests de personnalit√© (MBTI et Enn√©agramme)<br>
        Contact : <a href="mailto:contact@personnalitecomparee.com" class="text-blue-600 hover:underline">contact@personnalitecomparee.com</a>
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.hosting.title">H√©bergement</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.hosting.text">
        Ce site est h√©berg√© par <strong>Vercel Inc.</strong><br>
        340 S Lemon Ave #4133<br>
        Walnut, CA 91789, √âtats-Unis<br>
        <a href="https://vercel.com" target="_blank" rel="noopener" class="text-blue-600 hover:underline">https://vercel.com</a>
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.ip.title">Propri√©t√© intellectuelle</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.ip.text">
        L‚Äôensemble du contenu de ce site (textes, √©l√©ments graphiques, code source) est prot√©g√© par les lois en vigueur sur la propri√©t√© intellectuelle.<br>
        Les mod√®les MBTI et Enn√©agramme sont des syst√®mes conceptuels utilis√©s ici uniquement √† des fins p√©dagogiques et informatives.
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.liability.title">Responsabilit√©</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.liability.text">
        Les informations fournies sur ce site le sont √† titre indicatif et ne constituent en aucun cas un conseil professionnel, m√©dical ou psychologique. L‚Äôutilisateur reste seul responsable de l‚Äôusage qu‚Äôil fait des informations et r√©sultats propos√©s.
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.trademarks.title">Marques et mentions l√©gales sp√©cifiques</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.trademarks.mbti">
        MBTI est une marque d√©pos√©e appartenant √† The Myers-Briggs Company. Le pr√©sent site utilise ce terme √† des fins p√©dagogiques et informatives uniquement. Nous ne sommes ni affili√©s, ni agr√©√©s, ni soutenus par The Myers-Briggs Company.
      </p>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.trademarks.enneagram">
        L‚Äôutilisation du mot "Enn√©agramme" fait r√©f√©rence au syst√®me de typologie de la personnalit√© bien connu, dont l‚Äôusage est libre. Aucun lien n‚Äôest revendiqu√© avec des organismes officiels comme The Enneagram Institute.
      </p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.mentions.title">Mentions L√©gales</span>', content);
}
function showCookies() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.cookies.title">Cookies et stockage local</h3>
      <p class="text-gray-700" data-i18n="footer.legal.cookies.text">
        Ce site n‚Äôutilise pas de cookies de suivi.<br>
        Seules certaines donn√©es n√©cessaires au fonctionnement (comme la progression dans le test ou le code d‚Äôacc√®s aux r√©sultats) sont stock√©es localement dans le navigateur ou dans notre base de donn√©es Supabase.
      </p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.cookies.title">Cookies et stockage local</span>', content);
}

function showSupport() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.contact.support.title">Support</h3>

      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-900" data-i18n="footer.contact.support.email.title">Email</h4>
        <p class="text-blue-700" data-i18n="footer.contact.support.email.text"></p>
      </div>

      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-900" data-i18n="footer.contact.support.tech.title">Support technique</h4>
        <p class="text-blue-700" data-i18n="footer.contact.support.tech.text">Pour toute question technique ou probl√®me avec le test, n'h√©sitez pas √† nous √©crire en d√©taillant votre probl√®me.</p>
      </div>

      <div class="bg-green-50 p-4 rounded-lg">
        <h4 class="font-semibold text-green-900" data-i18n="footer.contact.support.suggestions.title">Suggestions</h4>
        <p class="text-green-700" data-i18n="footer.contact.support.suggestions.text">Vos suggestions d'am√©lioration sont les bienvenues ! Aidez-nous √† am√©liorer l'exp√©rience utilisateur.</p>
      </div>

      <div class="bg-yellow-50 p-4 rounded-lg">
        <h4 class="font-semibold text-yellow-900" data-i18n="footer.contact.support.time.title">Temps de r√©ponse</h4>
        <p class="text-yellow-700" data-i18n="footer.contact.support.time.text">Nous nous effor√ßons de r√©pondre √† tous les messages dans les 48 heures.</p>
      </div>
    </div>
  `;
  showModal('<span data-i18n="footer.contact.support.title">Support</span>', content);
}

window.showPrivacyPolicy = showPrivacyPolicy;
window.showTermsOfService = showTermsOfService;
window.showLegalNotices = showLegalNotices;
window.showCookies = showCookies;
window.showSupport = showSupport;
window.openProfileModal = openProfileModal;
window.closeProfileModal = closeProfileModal;
window.resetProfileModal = resetProfileModal;
window.checkProfileCode = checkProfileCode;
window.viewResults = viewResults;
window.shareCode = shareCode;
window.copyCode = copyCode;
window.restartTest = restartTest;
window.closeResultsModal = closeResultsModal;
window.showAboutProject = showAboutProject;
window.closeModal = closeModal;
window.shareProfileResults = shareProfileResults;

        // Fonction pour d√©marrer l'√©valuation externe
        function startExternalEvaluation() {
            const codeInput = document.getElementById('code');
            const relationInputs = document.querySelectorAll('input[name="relation"]');
            
            if (!codeInput || !codeInput.value.trim()) {
                alert('Veuillez entrer le code unique de la personne √† √©valuer.');
                return;
            }
            
            let selectedRelation = null;
            relationInputs.forEach(input => {
                if (input.checked) {
                    selectedRelation = input.value;
                }
            });
            
            if (!selectedRelation) {
                alert('Veuillez s√©lectionner votre relation avec cette personne.');
                return;
            }
            
            // Sauvegarder les informations de l'√©valuation externe
            localStorage.setItem('externalEvaluationCode', codeInput.value.trim().toUpperCase());
            localStorage.setItem('externalEvaluationRelation', selectedRelation);
            
            // Ouvrir les questions d'√©valuation externe dans une fen√™tre modale
            showExternalEvaluationQuestions();
        }

        // Fonction pour afficher les questions d'√©valuation externe
        function showExternalEvaluationQuestions() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');
            
            const relationLabels = {
                'family': '<span data-i18n="evalRelationFamily">Membre de la famille</span>',
                'partner': '<span data-i18n="evalRelationPartner">Partenaire amoureux</span>',
                'friend': '<span data-i18n="evalRelationFriend">Ami(e)</span>',
                'colleague': '<span data-i18n="evalRelationColleague">Coll√®gue de travail</span>'
            };
            
            const content = `
                <div class="max-w-4xl mx-auto">
<div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="bg-black px-6 py-4 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-white" data-i18n="home.modal.externalEval.title">√âvaluation externe</h2>
                                <p class="text-gray-200 mt-1"><span data-i18n="home.modal.externalEval.codeLabel">Code:</span> ${code} | <span data-i18n="home.modal.externalEval.relationLabel">Relation:</span> ${relationLabels[relation]}</p>
                            </div>
                            <span class="close" onclick="closeModal()" style="color: white;">&times;</span>
                        </div>
                        <div class="p-6">
                            <form id="eval-form">
                                <div id="external-questions-content">
                                    <!-- Les questions seront ajout√©es ici -->
                                </div>
                                <div class="mt-6 flex justify-between">
                                    <button type="button" id="prev-external-question" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" style="display: none;">
                                        <i class="fas fa-arrow-left mr-2"></i> <span data-i18n="home.modal.externalEval.prev">Question pr√©c√©dente</span>
                                    </button>
                                    <button type="button" id="next-external-question" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                        <span data-i18n="home.modal.externalEval.next">Question suivante</span> <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                    <button type="submit" id="submit-eval" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" style="display: none;">
                                        <i class="fas fa-check mr-2"></i> <span data-i18n="home.modal.externalEval.submit">Terminer l'√©valuation</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            showModal('', content);
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // Masquer l'en-t√™te par d√©faut de la modale et ajuster la taille
            const defaultHeader = document.querySelector('#current-modal .modal-header');
            if (defaultHeader) defaultHeader.style.display = 'none';

            const modalContent = document.querySelector('#current-modal .modal-content');
            if (modalContent) {
                modalContent.style.maxWidth = '900px';
                modalContent.style.width = '90%';
                modalContent.style.padding = '0';
            }

            // Initialiser les questions externes
            currentExternalQuestionIndex = 0;
            externalAnswers = {};
            displayExternalQuestion(0);
            setupExternalQuestionNavigation();
            setupEvalFormSubmit();
        }
        
        // Variables pour l'√©valuation externe
        let currentExternalQuestionIndex = 0;
        let externalAnswers = {};
        
        // Questions pour l'√©valuation externe (20 questions)
        // Ajout de l'option "Je ne sais pas" √† chaque question d'√©valuation externe
        EXTERNAL_QUESTIONS.forEach(q => {
            q.options.push({ text: "Je ne sais pas", functions: {}, enneagram: {} });
        });

        // Fonction pour afficher une question externe
        function displayExternalQuestion(index) {
            const question = EXTERNAL_QUESTIONS[index];
            if (!question) return;
            
            const progress = ((index + 1) / EXTERNAL_QUESTIONS.length) * 100;
            const questionsContent = document.getElementById('external-questions-content');

            questionsContent.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-medium text-black"><span data-i18n="question.label">Question</span> ${index + 1}/${EXTERNAL_QUESTIONS.length}</span>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
                            <div class="progress-bar h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%; background: linear-gradient(90deg, hsl(${Math.round((progress/100)*120)} 90% 62%), hsl(${Math.round((progress/100)*120)} 90% 52%))"></div>
                        </div>
                    </div>
<h3 class="text-xl font-medium text-gray-900 mb-6" data-i18n="questionnaire.ext.q${question.id}.title">${question.question}</h3>
                    
                 <div class="space-y-4">
  ${question.options.map((option, optionIndex) => {
    const value = optionIndex === question.options.length - 1 ? 0 : optionIndex + 1;
    const extraClass = optionIndex === question.options.length - 1 ? ' mt-1' : '';
    const dataChoice = value === 0 ? ' data-choice="unknown"' : '';
    const dataI18n = value === 0 ? 'question.option.dontknow' : `questionnaire.ext.q${question.id}.option${optionIndex + 1}`;
    return `
      <div class="flex items-start${extraClass}">
        <input id="eq${question.id}-${optionIndex}" name="external_question${question.id}" type="radio" value="${value}"${dataChoice} class="focus:ring-black h-4 w-4 text-black border-gray-300 mt-1" ${externalAnswers[question.id] === value ? 'checked' : ''}>
        <label for="eq${question.id}-${optionIndex}" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors">
          <span data-i18n="${dataI18n}">${option.text}</span>
        </label>
      </div>`;
  }).join('')}
</div>

                </div>
            `;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // √âcouter les changements de r√©ponse
            const radioButtons = questionsContent.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    externalAnswers[question.id] = parseInt(this.value);
                    updateExternalNavigationButtons();
                });
            });
            
            updateExternalNavigationButtons();
        }
        
        // Configuration de la navigation pour les questions externes
        function setupExternalQuestionNavigation() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentExternalQuestionIndex > 0) {
                        currentExternalQuestionIndex--;
                        displayExternalQuestion(currentExternalQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined) {
                        if (currentExternalQuestionIndex < EXTERNAL_QUESTIONS.length - 1) {
                            currentExternalQuestionIndex++;
                            displayExternalQuestion(currentExternalQuestionIndex);
                        }
                    } else {
                        const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                        const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.selectAnswer) || 'Veuillez s√©lectionner une r√©ponse avant de continuer.';
                        alert(msg);
                    }
                });
            }
        }
        
        // Mise √† jour des boutons de navigation externes
        function updateExternalNavigationButtons() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            const finishButton = document.getElementById('submit-eval');

            if (prevButton) {
                prevButton.style.display = currentExternalQuestionIndex > 0 ? 'inline-flex' : 'none';
            }

            const isLastQuestion = currentExternalQuestionIndex === EXTERNAL_QUESTIONS.length - 1;
            const hasAnswer = externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined;

            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        function setupEvalFormSubmit() {
            const form = document.getElementById('eval-form');
            const btn = document.getElementById('submit-eval');
            if (!form || !btn) return;

            const statusEl = document.createElement('span');
            statusEl.className = 'sr-only';
            statusEl.setAttribute('aria-live', 'polite');
            btn.after(statusEl);

            function setLoadingState() {
                btn.disabled = true;
                btn.classList.remove('bg-green-500', 'bg-red-500');
                btn.innerHTML = '<span class="spinner"></span> Veuillez patienter, nous enregistrons vos r√©ponses...';
                statusEl.textContent = 'Enregistrement en cours...';
            }

            function setSuccessState() {
                btn.disabled = true;
                btn.classList.remove('bg-red-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-green-500', 'text-white');
                btn.innerHTML = 'Succ√®s ‚úÖ';
                statusEl.textContent = 'Enregistrement r√©ussi';
            }

            function setRetryState() {
                btn.disabled = false;
                btn.classList.remove('bg-green-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-500', 'text-white');
                btn.innerHTML = 'R√©essayer';
                statusEl.textContent = '√âchec, r√©essayez';
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (btn.disabled) return;
            if (Object.keys(externalAnswers).length !== EXTERNAL_QUESTIONS.length) {
                const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.completeAll) || 'Veuillez r√©pondre √† toutes les questions avant de terminer.';
                alert(msg);
                return;
            }
                setLoadingState();
                await new Promise(r => setTimeout(r, 0));

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);
                try {
                    await Promise.race([
                        submitExternalEvaluation(),
                        new Promise((_, reject) => {
                            controller.signal.addEventListener('abort', () => reject(new DOMException('Timeout', 'AbortError')));
                        })
                    ]);
                    setSuccessState();
                } catch (err) {
                    if (err.name === 'AbortError') {
                        alert('La requ√™te a expir√©. Veuillez r√©essayer.');
                    } else {
                        console.error(err);
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                    setRetryState();
                } finally {
                    clearTimeout(timeoutId);
                }
            }, { once: false });
        }

        // Fonction pour soumettre l'√©valuation externe
        async function submitExternalEvaluation() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');

            // Calculer les scores de fonctions cognitives et Enn√©agramme
            const functionScores = { Fi: 0, Fe: 0, Ti: 0, Te: 0, Ni: 0, Ne: 0, Si: 0, Se: 0 };
            const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
            Object.keys(externalAnswers).forEach(questionId => {
                const question = EXTERNAL_QUESTIONS.find(q => q.id === parseInt(questionId));
                const value = externalAnswers[questionId];
                if (value === 0) {
                    return;
                }
                const selectedOption = question.options[value - 1];
                // Ajouter les scores de fonctions cognitives
                Object.keys(selectedOption.functions).forEach(func => {
                    functionScores[func] += selectedOption.functions[func];
                });
                // Ajouter les scores Enn√©agramme
                Object.keys(selectedOption.enneagram).forEach(type => {
                    enneagramScores[type] += selectedOption.enneagram[type];
                });
            });
            // Enregistrer dans Supabase
            await saveExternalEvaluationToSupabase(code, relation, functionScores, enneagramScores);
            // Nettoyer le stockage local temporaire
            localStorage.removeItem('externalEvaluationCode');
            localStorage.removeItem('externalEvaluationRelation');
            // Afficher un message de confirmation
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                questionsContainer.innerHTML = '';
            }
            const modalHTML = `
                <div id="evaluation-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div id="evaluation-modal" class="bg-white rounded-lg shadow-lg p-8 max-w-md w-11/12 transform opacity-0 scale-95 transition-all duration-300">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <i class="fas fa-check text-green-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4" data-i18n="evaluation.done.title">√âvaluation termin√©e !</h2>
                        <p class="text-gray-600 mb-6" data-i18n="evaluation.done.text"></p>
                        <button id="close-evaluation-modal" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-home mr-2"></i> <span data-i18n="evaluation.done.button">Retour √† l'accueil</span>
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            applyTranslations();
            setEvaluationDoneText(code);
            const modal = document.getElementById('evaluation-modal');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            });
            document.getElementById('close-evaluation-modal').addEventListener('click', () => {
                const overlay = document.getElementById('evaluation-modal-overlay');
                if (overlay) {
                    overlay.remove();
                }
                window.location.href = 'index.html';
            });
        }

        // Chargement de la progression au d√©marrage
        if (loadProgress()) {
            displayQuestion(currentQuestionIndex);
        }
        
        // Gestion du menu mobile
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.style.display === 'block';
                    
                    if (isOpen) {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.style.display = 'block';
                        menuIcon.className = 'fas fa-times';
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                    // Remove persistent focus outline on mobile after tap
                    try { mobileMenuButton.blur(); } catch {}
                });
                
                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
            }
        });
        
        // ===== ESPACE PERSONNEL =====
        
        // Base de donn√©es simul√©e des profils (non utilis√©e, conserv√©e pour r√©f√©rence)
        /* const profilesDatabase = {
            'ABC123': {
                name: 'Jean Dupont',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-15' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-16' },
                    { relation: 'Coll√®gue de travail', completed: false, completedAt: null }
                ],
                results: {
                    mbti: 'ENFJ',
                    enneagram: 'Type 2',
                    certainty: 91
                }
            },
            'XYZ789': {
                name: 'Marie Martin',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Partenaire amoureux', completed: true, completedAt: '2024-01-10' },
                    { relation: 'Ami(e)', completed: false, completedAt: null },
                    { relation: 'Membre de la famille', completed: false, completedAt: null }
                ],
                results: null
            },
            'DEF456': {
                name: 'Pierre Durand',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-12' },
                    { relation: 'Coll√®gue de travail', completed: true, completedAt: '2024-01-13' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-14' }
                ],
                results: {
                    mbti: 'INTJ',
                    enneagram: 'Type 5',
                    certainty: 87
                }
            }
        }; */

        // Fonctions de gestion de la modale
        function openProfileModal(prefillCode) {
            document.getElementById('profile-modal').classList.add('show');
            resetProfileModal();
            if (prefillCode) {
                const input = document.getElementById('profile-code');
                input.value = prefillCode.trim().toUpperCase();
                checkProfileCode();
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('show');
        }

        function resetProfileModal() {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'√©tape de saisie du code
            document.getElementById('code-input-step').style.display = 'block';
            
            // R√©initialiser le champ de saisie
            document.getElementById('profile-code').value = '';
        }

        async function checkProfileCode() {
            const code = document.getElementById('profile-code').value.trim().toUpperCase();

            if (!code) {
                alert('Veuillez entrer un code');
                return;
            }

            // R√©cup√©ration du profil via Supabase
            let result = await fetchUserProfileFromSupabase(code);
            console.log("üß† R√©sultat brut depuis Supabase :", result);
            console.log("üìò MBTI :", result.user?.mbti_type);
            console.log("üìó Enn√©agramme :", result.user?.enneagram_type);

            if (!result || !result.user) {
                // Afficher le message d'erreur
                document.querySelectorAll('.profile-step').forEach(step => {
                    step.style.display = 'none';
                });
                document.getElementById('error-message').style.display = 'block';
                return;
            }
            if (result.evaluations.length > 0) {
                const updated = await calculateFinalProfile(code);
                if (updated) {
                    result = updated;
                }
            }

            const { user, evaluations } = result;
            const overallCertainty = result.overallCertainty ?? user.certainty_score ?? null;
            // Construire un objet de profil simplifi√© compatible avec displayProfile
            const simplifiedProfile = {
                name: user.mbti_type && user.enneagram_type
                    ? `${user.mbti_type} ‚Äî type ${user.enneagram_type}`
                    : user.mbti_type || 'Profil',
                selfEvaluationCompleted: true,
                externalEvaluations: evaluations.map(ev => ({
                    relation: ev.relation,
                    completed: true,
                    completedAt: ev.created_at
                })),
                results: user.mbti_type && user.enneagram_type
                    ? {
                        mbti: user.mbti_type,
                        enneagram: user.enneagram_type,
                        certainty: overallCertainty,
                        // Ajouter les champs d'auto-√©valuation pour comparaison IA (si disponibles)
                        autoMbti: result.autoMbti || user.auto_mbti_type || null,
                        autoEnneagram: result.autoEnneagram || user.auto_enneagram_type || null,
                        // Rappeler explicitement que le profil affich√© est bas√© sur l'externe
                        externalMbti: user.mbti_type,
                        externalEnneagram: user.enneagram_type
                    }
                    : null
            };
            displayProfile(code, simplifiedProfile);
        }

        function displayProfile(code, profile) {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'√©tape du statut
            document.getElementById('profile-status-step').style.display = 'block';
            
            // Remplir les informations du profil
            document.getElementById('profile-name').textContent = profile.name;
            document.getElementById('display-code').textContent = code;
            
            // Calculer le statut des √©valuations
            const completedEvaluations = Array.isArray(profile.externalEvaluations)
                ? profile.externalEvaluations.filter(ev => ev.completed).length
                : 0;
            // Dans notre syst√®me, un minimum de trois √©valuations externes est requis
            const totalEvaluationsRequired = 3;
            const totalProgress = completedEvaluations + (profile.selfEvaluationCompleted ? 1 : 0);
            const maxProgress = totalEvaluationsRequired + 1; // +1 pour l'auto-√©valuation
            
            // Mettre √† jour le statut des √©valuations
            const evaluationsStatus = document.getElementById('evaluations-status');
            // Si toutes les √©valuations requises sont termin√©es, afficher le statut vert, sinon statut orange.
            if (completedEvaluations >= totalEvaluationsRequired) {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                const langStatus = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const allDoneLabel = (window.translations && window.translations[langStatus] && window.translations[langStatus].profileModal && window.translations[langStatus].profileModal.step2 && window.translations[langStatus].profileModal.step2.allCompleted) || 'Toutes termin√©es';
                evaluationsStatus.innerHTML = `<i class="fas fa-check mr-1"></i> ${allDoneLabel}`;
            } else {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                const langStatus = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const completedSuffix = (window.translations && window.translations[langStatus] && window.translations[langStatus].profileModal && window.translations[langStatus].profileModal.step2 && window.translations[langStatus].profileModal.step2.completedSuffix) || 'termin√©es';
                evaluationsStatus.innerHTML = `<i class="fas fa-clock mr-1"></i> ${completedEvaluations}/${totalEvaluationsRequired} ${completedSuffix}`;
            }
            
            // Mettre √† jour la barre de progression
            const progressPercent = (totalProgress / maxProgress) * 100;
            const pb = document.getElementById('progress-bar');
            pb.style.width = progressPercent + '%';
            const hue2 = Math.round((progressPercent/100)*120);
            pb.style.background = `linear-gradient(90deg, hsl(${hue2} 90% 62%), hsl(${hue2} 90% 52%))`;
            const lang = localStorage.getItem('lang') || 'fr';
            const suffix = translations[lang]['profileModal.step2.progressSuffix'] || '';
            document.getElementById('progress-text').textContent = `${totalProgress}/${maxProgress} ${suffix}`;
            
            // Afficher le message selon le statut (3 √©valuations requises)
            displayStatusMessage(profile, completedEvaluations, 3);
        }

        function displayStatusMessage(profile, completedEvaluations, totalEvaluations) {
            const statusMessage = document.getElementById('status-message');
            const totalRequired = 3;
            const remaining = totalRequired - completedEvaluations;

            if (completedEvaluations >= totalRequired) {
                statusMessage.className = 'rounded-lg p-4 mb-4 bg-green-50 border border-green-200';
                statusMessage.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-400 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800" data-i18n="profile.complete.title">Analyse compl√®te !</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p data-i18n="profile.complete.text">F√©licitations !</p>
                                <p data-i18n="profile.complete.explanation">Toutes les √©valuations ont √©t√© compl√©t√©es. Vous pouvez maintenant consulter votre profil de personnalit√© complet.</p>
                            </div>
                        </div>
                    </div>
                `;
                applyTranslations();
                updateResultsButtonState(0);
            } else {
                statusMessage.className = 'rounded-lg p-4 mb-4 bg-yellow-50 border border-yellow-200';
                statusMessage.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-400 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800" data-i18n="profile.pending.title">√âvaluations en cours</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p data-i18n="profile.incomplete.text"></p>
                                <p class="mt-1" data-i18n="profile.pending.share">Partagez votre code unique avec vos proches pour qu‚Äôils puissent vous √©valuer et vous donner acc√®s √† cette page.</p>
                            </div>
                        </div>
                    </div>
                `;
                applyTranslations();
                setIncompleteMessage(remaining);
                updateResultsButtonState(remaining);
            }
        }

        function setIncompleteMessage(remaining) {
            const lang = localStorage.getItem('lang') || 'fr';
            const template = translations[lang]['profile.incomplete.text'];
            const person = remaining === 1 ? (lang === 'fr' ? 'personne' : 'person') : (lang === 'fr' ? 'personnes' : 'people');
            const verb = remaining === 1 ? (lang === 'fr' ? 'doit' : 'needs') : (lang === 'fr' ? 'doivent' : 'need');
            const el = document.querySelector('[data-i18n="profile.incomplete.text"]');
            if (el && template) {
                el.innerHTML = template.replace('{count}', remaining).replace('{person}', person).replace('{verb}', verb);
            }
        }

        function setEvaluationDoneText(code) {
            const lang = localStorage.getItem('lang') || 'fr';
            const template = translations[lang]['evaluation.done.text'];
            const el = document.querySelector('[data-i18n="evaluation.done.text"]');
            if (el && template) {
                el.innerHTML = template.replace('{code}', code);
            }
        }

        function updateResultsButtonState(remaining) {
            const btn = document.getElementById('seeResultsBtn');
            if (!btn) return;
            if (remaining > 0) {
                if (!btn.dataset.onclick && btn.getAttribute('onclick')) {
                    btn.dataset.onclick = btn.getAttribute('onclick');
                }
                btn.removeAttribute('onclick');
                btn.setAttribute('disabled', 'disabled');
                btn.setAttribute('aria-disabled', 'true');
                btn.classList.add('opacity-60', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.remove('bg-black', 'hover:bg-gray-800');
                btn.setAttribute('title', 'Compl√©tez d‚Äôabord 3 √©valuations externes pour acc√©der √† vos r√©sultats d√©taill√©s.');
            } else {
                if (btn.dataset.onclick) {
                    btn.setAttribute('onclick', btn.dataset.onclick);
                }
                btn.removeAttribute('disabled');
                btn.removeAttribute('aria-disabled');
                btn.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.add('bg-black', 'hover:bg-gray-800');
                btn.removeAttribute('title');
            }
        }

        function shareCode() {
            const code = document.getElementById('display-code')?.textContent ||
                         document.getElementById('unique-code')?.textContent ||
                         (typeof userCode !== 'undefined' ? userCode : '');

            if (!code) {
                alert('Aucun code √† partager');
                return;
            }

            const shareText = `Salut ! Peux-tu m'aider √† mieux comprendre ma personnalit√© ? Utilise ce code ${code} sur https://personnalitecomparee.com pour m'√©valuer. Merci ! üòä`;

            if (navigator.share) {
                navigator.share({
                    title: '√âvaluation de personnalit√©',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Message copi√© dans le presse-papiers ! Vous pouvez le partager avec vos proches.');
                }).catch(() => {
                    prompt('Copiez ce message pour le partager:', shareText);
                });
            }
        }

        async function viewResults(codeParam) {
            const userCode = (codeParam || document.getElementById('display-code').textContent)
                .trim()
                .toUpperCase();

            if (!userCode) {
                alert('Veuillez entrer un code');
                return;
            }

            const initial = await fetchUserProfileFromSupabase(userCode);

            if (!initial) {
                alert('Code introuvable');
                return;
            }

            const selfCompleted =
                initial.user &&
                initial.user.mbti_scores && Object.keys(initial.user.mbti_scores).length > 0 &&
                initial.user.enneagram_scores && Object.keys(initial.user.enneagram_scores).length > 0;

            if (!selfCompleted || initial.evaluations.length < 3) {
                alert(i18n.t('alerts.missingEvaluations'));
                return;
            }


            const selfProfile = getProfileFromScores(initial.user.mbti_scores || {}, initial.user.enneagram_scores || {});
            // Backfill DB auto_* si manquants (anciens profils)
            try {
                if ((!initial.user.auto_mbti_type || !initial.user.auto_enneagram_type) && selfProfile.mbtiType && selfProfile.enneagramType) {
                    await supabase
                      .from('users')
                      .update({ auto_mbti_type: selfProfile.mbtiType, auto_enneagram_type: selfProfile.enneagramType })
                      .eq('id', initial.user.id);
                }
            } catch (e) { console.warn('Backfill auto_* failed:', e); }

            const result = await calculateFinalProfile(userCode);

            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Le r√©sultat final n‚Äôest pas encore pr√™t.');
                return;
            }

            const externalProfiles = result.evaluations.map(ev => {
                const { mbtiType, enneagramType } = getProfileFromScores(ev.mbti_scores, ev.enneagram_scores);
                const coherenceMBTI = getCoh√©renceMBTI(ev.mbti_scores);
                const coherenceEnneagramme = getCoh√©renceEnn√©agramme(ev.enneagram_scores);
                return {
                    relation: ev.relation,
                    mbti: mbtiType,
                    enneagram: enneagramType,
                    coherenceMBTI,
                    coherenceEnneagramme,
                    completed: true,
                    completedAt: ev.created_at
                };
            });
            const certaintyScore = result.overallCertainty ??
                (result.user.certainty_score != null ? Number(result.user.certainty_score) : null);
            const enneaWing = computeEnneagramWing(result.user.enneagram_scores, result.user.enneagram_type);
            const finalProfile = {
                uniqueCode: userCode,
                name: `${result.user.mbti_type} ‚Äî Type ${result.user.enneagram_type}${enneaWing ? 'w' + enneaWing : ''}`,
                self: { mbti: selfProfile.mbtiType, enneagram: selfProfile.enneagramType },
                results: {
                    mbti: result.user.mbti_type,
                    mbtiCertainty: result.mbtiCertainty ?? certaintyScore,
                    enneagram: result.user.enneagram_type,
                    enneagramWing: enneaWing,
                    enneagramCertainty: result.enneagramCertainty ?? certaintyScore,
                    overallCertainty: certaintyScore,
                    // Expose auto-√©valuation au rendu/IA
                    autoMbti: selfProfile.mbtiType,
                    autoEnneagram: selfProfile.enneagramType,
                    // Rappeler explicitement l‚Äôexterne
                    externalMbti: result.user.mbti_type,
                    externalEnneagram: result.user.enneagram_type
                },
                externalEvaluations: externalProfiles,
                mbtiScores: result.user.mbti_scores,
                enneagramScores: result.user.enneagram_scores,
                externalCount: result.evaluations.length
            };
            closeProfileModal();
            displayDetailedResults(finalProfile, userCode);
        }

        const OPPOSITE_TYPES = {
            ISTJ: "ENFP", ISFJ: "ENTP", INFJ: "ESTP", INTJ: "ESFP",
            ISTP: "ENFJ", ISFP: "ENTJ", INFP: "ESTJ", INTP: "ESFJ",
            ESTP: "INFJ", ESFP: "INTJ", ENFP: "ISTJ", ENTP: "ISFJ",
            ESTJ: "INFP", ESFJ: "INTP", ENFJ: "ISTP", ENTJ: "ISFP"
        };

        function displayDetailedResults(profile, code) {
            const lang = localStorage.getItem('lang') || 'fr';
            const coherenceLabel = translations[lang]['results.details.coherence.label'];
            const wing = profile.results.enneagramWing || computeEnneagramWing(profile.enneagramScores, profile.results.enneagram);
            // Fallback pour certitude globale si absente
            const overall = (profile.results && profile.results.overallCertainty != null)
              ? Number(profile.results.overallCertainty)
              : Math.round(((Number(profile.results?.mbtiCertainty ?? 0) + Number(profile.results?.enneagramCertainty ?? 0)) || 0) / 2);
            const enneaDisplay = `Type ${profile.results.enneagram}${wing ? 'w' + wing : ''}`;
            // Cr√©er une nouvelle modale pour les r√©sultats
            const resultsModal = document.createElement('div');
            resultsModal.id = 'results-modal';
            resultsModal.className = 'modal show';
            resultsModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="text-xl font-bold text-gray-900" data-i18n="results.details.title"></h2>
                        <span class="close" onclick="closeResultsModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-6">
                            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                                <i class="fas fa-chart-pie text-green-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="results.details.analysis">Analyse Compl√®te</h3>
                            <p class="text-sm text-gray-500"><span data-i18n="results.details.code">Code:</span> <span class="font-mono font-bold">${code}</span></p>
                        </div>

                       <!-- R√©sultats MBTI et Enn√©agramme -->
<div class="grid md:grid-cols-2 gap-6 mb-6">
  <!-- MBTI -->
  <div class="bg-blue-50 rounded-2xl p-6 shadow-sm">
    <h4 class="font-semibold text-blue-900 mb-2" data-i18n="results.details.mbtiTitle">Type MBTI</h4>
    <div class="text-2xl font-bold text-blue-600 mb-2">${profile.results.mbti}</div>
    <div class="mt-2">
      ${
        profile.results.mbtiCertainty != null
          ? `<p class="mb-1" data-i18n="results.details.certainty">Certitude</p>
             <div class="relative w-full bg-gray-200 h-6 rounded-full overflow-hidden" data-aos="fade-right">
               <div class="certainty-bar absolute left-0 top-0 h-full rounded-full bg-gradient-to-r from-blue-300 via-blue-400 to-blue-500 transition-all duration-1000" data-width="${profile.results.mbtiCertainty}" style="width:0"></div>
               <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.mbtiCertainty}%</span>
             </div>`
          : `<p data-i18n="results.details.pending">Certitude : Donn√©es en cours...</p>`
      }
    </div>
  </div>

  <!-- Enn√©agramme -->
  <div class="bg-purple-50 rounded-2xl p-6 shadow-sm">
    <h4 class="font-semibold text-purple-900 mb-2" data-i18n="results.details.enneagramTitle">Enn√©agramme</h4>
    <div class="text-2xl font-bold text-purple-600 mb-2">${enneaDisplay}</div>
    <div class="mt-2">
      ${
        profile.results.enneagramCertainty != null
          ? `<p class="mb-1" data-i18n="results.details.certainty">Certitude</p>
             <div class="relative w-full bg-gray-200 h-6 rounded-full overflow-hidden" data-aos="fade-right">
               <div class="certainty-bar absolute left-0 top-0 h-full rounded-full bg-gradient-to-r from-purple-300 via-purple-400 to-purple-500 transition-all duration-1000" data-width="${profile.results.enneagramCertainty}" style="width:0"></div>
               <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.enneagramCertainty}%</span>
             </div>`
          : `<p data-i18n="results.details.pending">Certitude : Donn√©es en cours...</p>`
      }
    </div>
  </div>
</div>

<!-- Certitude globale -->
<div class="bg-gray-50 rounded-2xl p-6 shadow-sm mb-6">
  <p class="mb-1" data-i18n="results.details.overallCertainty">Certitude globale</p>
  <div class="relative w-full bg-gray-200 h-6 rounded-full overflow-hidden" data-aos="fade-right">
    <div class="certainty-bar absolute left-0 top-0 h-full rounded-full bg-gradient-to-r from-green-300 via-green-400 to-green-500 transition-all duration-1000" data-width="${overall}" style="width:0"></div>
    <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${overall}%</span>
  </div>
  <p class="text-sm text-gray-600 mt-2" data-i18n="results.details.basedOnRelatives">Bas√© sur les √©valuations de vos proches</p>
  ${profile.externalCount < 3 ? `<p class="text-sm text-yellow-700 mt-2" data-i18n="results.details.increaseCertainty">üîé Augmentez votre niveau de certitude en compl√©tant les 3 √©valuations externes (famille, partenaire, ami ou coll√®gue).</p>` : ''}
</div>


     <!-- Graphiques MBTI & Enn√©agramme -->
<div class="grid md:grid-cols-2 gap-6 mb-6 w-full">
  <!-- MBTI -->
  <div class="bg-blue-50 rounded-2xl p-4 sm:p-6 shadow-sm border border-blue-100 w-full overflow-hidden">
    <h4 class="font-semibold text-blue-900 mb-4 flex items-center gap-2">
      <span class="material-icons text-blue-500">bar_chart</span>
      <span data-i18n="results.details.mbtiDichotomies">Dichotomies MBTI</span>
    </h4>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl p-3 sm:p-4 shadow-inner w-full overflow-hidden">
        <div class="text-xs text-gray-600 mb-2">Brut (pond√©r√© par coh√©rence)</div>
        <canvas id="mbtiChartRaw" height="260" class="w-full h-auto" style="max-width: 100%;"></canvas>
      </div>
      <div class="bg-white rounded-xl p-3 sm:p-4 shadow-inner w-full overflow-hidden">
        <div class="text-xs text-gray-600 mb-2">Ajust√© stack (80% donn√©es / 20% stack)</div>
        <canvas id="mbtiChartAdj" height="260" class="w-full h-auto" style="max-width: 100%;"></canvas>
      </div>
    </div>
    <p class="text-[11px] sm:text-xs text-gray-500 mt-2">
      Note: brut = contributions positives normalis√©es; ajust√© = brut m√©lang√© √† la hi√©rarchie de la stack du type final.
    </p>
  </div>

  <!-- Enn√©agramme -->
  <div class="bg-purple-50 rounded-2xl p-4 sm:p-6 shadow-sm border border-purple-100 w-full overflow-hidden">
    <h4 class="font-semibold text-purple-900 mb-4 flex items-center gap-2">
      <span class="material-icons text-purple-500">pie_chart</span>
      <span data-i18n="results.details.enneagramTypes">Types Enn√©agramme</span>
    </h4>
    <div class="bg-white rounded-xl p-3 sm:p-4 shadow-inner w-full overflow-hidden">
      <canvas id="enneagramChart" height="300" class="w-full h-auto" style="max-width: 100%;"></canvas>
    </div>
    <p class="text-[11px] sm:text-xs text-gray-500 mt-2">
      Note: barres = scores Enn√©agramme pond√©r√©s par la coh√©rence des √©valuations.
    </p>
  </div>
</div>


<!-- R√©sum√© IA -->
<div id="ai-profile-summary" class="mt-6 mb-8 bg-white rounded-2xl p-6 shadow-lg border border-gray-200">
  <h4 class="font-semibold text-gray-900 text-lg mb-4 flex items-center gap-2">
    <span class="material-icons text-green-500">psychology</span>
    <span data-i18n="results.details.aiSummaryTitle">
      Description succincte du profil par <span class="font-bold text-green-600">Psycho'Bot</span>
    </span>
  </h4>
  <div id="ai-summary-content" class="text-base leading-relaxed text-gray-700 space-y-4">
    <span data-i18n="results.details.generating" class="italic text-gray-500">G√©n√©ration en cours‚Ä¶</span>
  </div>
</div>





                            <!-- D√©tail des √©valuations -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3" data-i18n="results.details.detailTitle">D√©tail des √©valuations</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700" data-i18n="results.details.selfEvaluation">Auto-√©valuation</span>
                                        <div class="text-xs text-gray-500">${profile.self.mbti} ‚Äî type ${profile.self.enneagram}</div>
                                    </div>
                                    <span class="text-sm text-green-600 font-medium" data-i18n="results.details.completed">‚úì Compl√©t√©e</span>
                                </div>
                                ${profile.externalEvaluations.map(evaluation => `
                                    <div class="flex items-center justify-between p-3 ${evaluation.completed ? 'bg-green-50' : 'bg-gray-50'} rounded-lg">
                                        <div>
                                            <span class="text-sm font-medium text-gray-700">${evaluation.relation}</span>
                                            <div class="text-xs text-gray-500">${evaluation.mbti} ‚Äî type ${evaluation.enneagram} ‚Äî MBTI : <strong>${coherenceLabel} ${evaluation.coherenceMBTI}</strong> ‚Äî Enn√©agramme : <strong>${coherenceLabel} ${evaluation.coherenceEnneagramme}</strong></div>
                                        </div>
                                          <span class="text-sm ${evaluation.completed ? 'text-green-600' : 'text-gray-500'} font-medium">
                                              ${evaluation.completed ? `<span data-i18n="results.details.completedOn">‚úì Compl√©t√©e le</span> ${new Date(evaluation.completedAt).toLocaleDateString('fr-FR')}` : `<span data-i18n="results.details.pendingShort">‚è≥ En attente</span>`}
                                          </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mt-8 mb-6 p-4 rounded-lg bg-gray-100 border border-gray-300 text-xs text-gray-700 leading-relaxed">
  <p class="mb-2"><strong data-i18n="results.details.coherence.title"> Coh√©rence</strong> : <span data-i18n="results.details.coherence.desc">d√©termine dans quelle mesure les r√©ponses d‚Äôun proche sont logiquement stables.</span></p>
  <ul class="list-disc list-inside space-y-1">
    <li data-i18n="results.details.coherence.strong"><strong>Forte</strong> ‚Üí peu voire pas de contradictions, r√©ponses align√©es</li>
    <li data-i18n="results.details.coherence.medium"><strong>Moyenne</strong> ‚Üí quelques h√©sitations ou contradictions</li>
    <li data-i18n="results.details.coherence.weak"><strong>Faible</strong> ‚Üí r√©ponses peu coh√©rentes entre elles</li>
  </ul>
</div>

<div class="mt-10 bg-white shadow-lg rounded-3xl border border-gray-200 overflow-hidden">
  <!-- En-t√™te -->
  <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-100 to-purple-100">
    <div class="text-xl font-bold text-gray-800 flex items-center justify-center w-full">
      <span class="material-icons text-blue-400">insights</span>
      <span class="block text-center" data-i18n="results.detailed.title">
        R√©sultats compl√©mentaires
      </span>
    </div>
  </div>

  <!-- Contenu -->
  <div class="p-6 space-y-10">

    <!-- Carri√®re & Passions -->
    <div>
      <div class="text-lg font-semibold text-gray-800 text-center">
        <span class="block" data-i18n="results.career.title">
          Carri√®re & Passions probables
        </span>
      </div>
<p id="careerProfileText" class="mt-3 text-center text-gray-700 leading-relaxed bg-blue-100/40 border border-blue-200 rounded-2xl p-4 shadow-sm"></p>
    </div>

    <!-- Profil miroir -->
    <div>
      <div class="text-lg font-semibold text-gray-800 text-center">
        <span class="block" data-i18n="results.mirror.title">
          Profil miroir (oppos√©)
        </span>
      </div>
      <div class="mt-3 p-5 rounded-2xl border border-purple-200 bg-purple-100/40 shadow-sm text-center">
        <p id="mirrorProfileText" class="text-gray-700 leading-relaxed font-medium" data-i18n="results.mirror.text"></p>
      </div>
    </div>

  </div>
</div>


<div class="mt-6 mb-6 flex justify-center">
  <img src="logobanniere.jpeg" alt="Logo Personnalit√© Compar√©e" class="h-24 object-contain opacity-90" />
</div>




                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="shareProfileResults('${code}')" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                <i class="fas fa-share mr-2"></i>
                                <span data-i18n="results.details.share">Partager</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
    document.body.appendChild(resultsModal);
    initCountUp(resultsModal);
    applyTranslations();
    const titleEl = resultsModal.querySelector('[data-i18n="results.details.title"]');
    if (titleEl) { titleEl.innerHTML = titleEl.innerHTML.replace('{name}', `${profile.results.mbti} ‚Äî ${enneaDisplay}`); }

    // Texte carri√®re : MBTI > Enn√©agramme > fallback
    const careerEl = document.getElementById("careerProfileText");
    if (careerEl && translations[lang] && translations[lang].results && translations[lang].results.career) {
        const mbti = (profile.results.mbti || "").toUpperCase();
        const ennea = String(profile.results.enneagram || "");
        const careerText =
            (translations[lang].results.career.mbti &&
             translations[lang].results.career.mbti[mbti]) ||
            (translations[lang].results.career.ennea &&
             translations[lang].results.career.ennea[ennea]) ||
            translations[lang].results.career.fallback;
        careerEl.innerText = careerText;
    }

    const resultType = profile.results.mbti;
    const mirrorType = OPPOSITE_TYPES[resultType] || "‚Äî";
    const mirrorEl = document.getElementById("mirrorProfileText");
    if (mirrorEl) {
        mirrorEl.innerHTML = (translations[lang]["results.mirror.text"] || "")
            .replace("{mirror}", `<strong>${mirrorType}</strong>`);
    }

            // Animer les barres de certitude
            resultsModal.querySelectorAll('.certainty-bar').forEach(bar => {
                const width = bar.dataset.width;
                requestAnimationFrame(() => {
                    bar.style.width = width + '%';
                });
            });
            if (window.AOS) {
                AOS.refresh();
            }
            renderCharts(profile, resultsModal);
            initAiProfileSummary(profile, code);
        }

        function renderCharts(profile, container) {
            const mbtiCanvasRaw = container.querySelector('#mbtiChartRaw');
            const mbtiCanvasAdj = container.querySelector('#mbtiChartAdj');
            const enneaCanvas = container.querySelector('#enneagramChart');
            const enoughEvaluations = profile.externalCount >= 3;
            const hasMbtiScores = profile.mbtiScores && Object.values(profile.mbtiScores).some(v => v > 0);
            const hasEnneaScores = profile.enneagramScores && Object.values(profile.enneagramScores).some(v => v > 0);

            if (!enoughEvaluations || !hasMbtiScores || !hasEnneaScores) {
                const message = document.createElement('p');
                message.className = 'text-sm text-gray-500 text-center';
                message.textContent = 'Donn√©es en attente (minimum 3 √©valuations externes requises).';
                if (mbtiCanvasRaw) {
                    mbtiCanvasRaw.remove();
                    mbtiCanvasRaw.parentElement.appendChild(message.cloneNode(true));
                }
                if (mbtiCanvasAdj) {
                    mbtiCanvasAdj.remove();
                    mbtiCanvasAdj.parentElement.appendChild(message.cloneNode(true));
                }
                if (enneaCanvas) {
                    enneaCanvas.remove();
                    enneaCanvas.parentElement.appendChild(message);
                }
                return;
            }
            // 1) MBTI RAW (data only, positive contributions normalized)
            const rawMBTICtx = mbtiCanvasRaw.getContext('2d');
            const raw = profile.mbtiScores || {};
            const rawPos = {
                Fi: Math.max(0, raw.Fi || 0),
                Fe: Math.max(0, raw.Fe || 0),
                Ti: Math.max(0, raw.Ti || 0),
                Te: Math.max(0, raw.Te || 0),
                Si: Math.max(0, raw.Si || 0),
                Se: Math.max(0, raw.Se || 0),
                Ni: Math.max(0, raw.Ni || 0),
                Ne: Math.max(0, raw.Ne || 0)
            };
            const rawSum = Object.values(rawPos).reduce((a,b)=>a+b,0);
            const rawPct = k => rawSum ? Math.round((rawPos[k] / rawSum) * 100) : 0;
            const mbtiRawData = [
                { label: 'Fi', value: rawPct('Fi') },
                { label: 'Fe', value: rawPct('Fe') },
                { label: 'Ti', value: rawPct('Ti') },
                { label: 'Te', value: rawPct('Te') },
                { label: 'Si', value: rawPct('Si') },
                { label: 'Se', value: rawPct('Se') },
                { label: 'Ni', value: rawPct('Ni') },
                { label: 'Ne', value: rawPct('Ne') }
            ];

            // 2) MBTI ADJUSTED (stack-guided display: 80% data, 20% stack baseline)
            const type = String(profile.results.mbti || '').toUpperCase();
            const STACKS = {
              INTJ:['Ni','Te','Fi','Se'], ENTJ:['Te','Ni','Se','Fi'],
              INTP:['Ti','Ne','Si','Fe'], ENTP:['Ne','Ti','Fe','Si'],
              INFJ:['Ni','Fe','Ti','Se'], ENFJ:['Fe','Ni','Se','Ti'],
              INFP:['Fi','Ne','Si','Te'], ENFP:['Ne','Fi','Te','Si'],
              ISTJ:['Si','Te','Fi','Ne'], ESTJ:['Te','Si','Ne','Fi'],
              ISFJ:['Si','Fe','Ti','Ne'], ESFJ:['Fe','Si','Ne','Ti'],
              ISTP:['Ti','Se','Ni','Fe'], ESTP:['Se','Ti','Fe','Ni'],
              ISFP:['Fi','Se','Ni','Te'], ESFP:['Se','Fi','Te','Ni']
            };
            const level = { dom:1.0, aux:0.8, tert:0.5, inf:0.3, shadow:0.2 };
            const stack = STACKS[type] || [];
            const weight = {
              Fi: level.shadow, Fe: level.shadow, Ti: level.shadow, Te: level.shadow,
              Si: level.shadow, Se: level.shadow, Ni: level.shadow, Ne: level.shadow
            };
            if (stack.length === 4) {
              weight[stack[0]] = level.dom;
              weight[stack[1]] = level.aux;
              weight[stack[2]] = level.tert;
              weight[stack[3]] = level.inf;
            }
            // Pond√©ration data + baseline stack (affichage hybride pour √©viter 0% incoh√©rents)
            const weighted = Object.fromEntries(Object.entries(rawPos).map(([k,v])=>[k, v * (weight[k] || level.shadow)]));
            const sumWeighted = Object.values(weighted).reduce((a,b)=>a+b,0);
            const dataNorm = Object.fromEntries(Object.entries(weighted).map(([k,v])=>[k, sumWeighted? v/sumWeighted : 0]));

            // Baseline: normaliser les poids de stack sur 8 fonctions (shadow √† 0.2)
            const baseWeights = {
                Fi: weight.Fi, Fe: weight.Fe, Ti: weight.Ti, Te: weight.Te,
                Si: weight.Si, Se: weight.Se, Ni: weight.Ni, Ne: weight.Ne
            };
            const baseSum = Object.values(baseWeights).reduce((a,b)=>a+b,0) || 1;
            const stackNorm = Object.fromEntries(Object.entries(baseWeights).map(([k,v])=>[k, v/baseSum]));

            const ALPHA = 0.8; // 80% donn√©es, 20% baseline stack
            const blend = k => ALPHA*(dataNorm[k]||0) + (1-ALPHA)*(stackNorm[k]||0);
            const mbtiAdjData = [
                { label: 'Fi', value: Math.round(blend('Fi')*100) },
                { label: 'Fe', value: Math.round(blend('Fe')*100) },
                { label: 'Ti', value: Math.round(blend('Ti')*100) },
                { label: 'Te', value: Math.round(blend('Te')*100) },
                { label: 'Si', value: Math.round(blend('Si')*100) },
                { label: 'Se', value: Math.round(blend('Se')*100) },
                { label: 'Ni', value: Math.round(blend('Ni')*100) },
                { label: 'Ne', value: Math.round(blend('Ne')*100) }
            ];
            const mbtiDescriptions = {
                Fi: 'Sentiment Introverti',
                Fe: 'Sentiment Extraverti',
                Ti: 'Pens√©e Introvertie',
                Te: 'Pens√©e Extravertie',
                Si: 'Sensation Introvertie',
                Se: 'Sensation Extravertie',
                Ni: 'Intuition Introvertie',
                Ne: 'Intuition Extravertie'
            };
            Chart.register(ChartDataLabels);
            new Chart(rawMBTICtx, {
                type: 'bar',
                data: {
                    labels: mbtiRawData.map(d => d.label),
                    datasets: [{
                        data: mbtiRawData.map(d => d.value),
                        backgroundColor: '#93C5FD',
                        borderRadius: 8,
                        barThickness: 20,
                        categoryPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 },
                        y: { ticks: { autoSkip: false } }
                    },
                    layout: {
                        padding: { top: 10, bottom: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${mbtiDescriptions[mbtiRawData[ctx.dataIndex].label]}: ${Math.round(ctx.parsed.x)}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${Math.round(value)}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });

            const adjMBTICtx = mbtiCanvasAdj.getContext('2d');
            new Chart(adjMBTICtx, {
                type: 'bar',
                data: {
                    labels: mbtiAdjData.map(d => d.label),
                    datasets: [{
                        data: mbtiAdjData.map(d => d.value),
                        backgroundColor: '#60A5FA',
                        borderRadius: 8,
                        barThickness: 20,
                        categoryPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 },
                        y: { ticks: { autoSkip: false } }
                    },
                    layout: {
                        padding: { top: 10, bottom: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${mbtiDescriptions[mbtiAdjData[ctx.dataIndex].label]}: ${Math.round(ctx.parsed.x)}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${Math.round(value)}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });

            const enneaCtx = enneaCanvas.getContext('2d');
            const enneaLabels = Object.keys(profile.enneagramScores).sort();
            const enneaPos = Object.fromEntries(enneaLabels.map(k => [k, Math.max(0, profile.enneagramScores[k] || 0)]));
            const sumPosEnnea = Object.values(enneaPos).reduce((a,b)=>a+b,0);
            const enneaValues = enneaLabels.map(k => sumPosEnnea ? Math.round((enneaPos[k] / sumPosEnnea) * 100) : 0);
            const maxIndex = enneaValues.indexOf(Math.max(...enneaValues));
            const enneaColors = enneaValues.map((v, i) => i === maxIndex ? '#A855F7' : '#D8B4FE');
            const enneagramDescriptions = {
                1: 'Le R√©formateur',
                2: "L'Altruiste",
                3: 'Le Performeur',
                4: "L'Individualiste",
                5: "L'Investigateur",
                6: 'Le Loyaliste',
                7: "L'√âpicurien",
                8: 'Le Chef',
                9: 'Le M√©diateur'
            };
            new Chart(enneaCtx, {
                type: 'bar',
                data: {
                    labels: enneaLabels.map(t => `Type ${t}`),
                    datasets: [{
                        data: enneaValues,
                        backgroundColor: enneaColors,
                        borderColor: enneaValues.map((v, i) => i === maxIndex ? '#7C3AED' : 'transparent'),
                        borderWidth: enneaValues.map((v, i) => i === maxIndex ? 2 : 0),
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: true,
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${Math.round(ctx.parsed.x)}% - ${enneagramDescriptions[enneaLabels[ctx.dataIndex]]}`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${Math.round(value)}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }

        function setupScrollIndicator(container) {
            if (!container || container.__scrollIndicatorInitialized) return;
            const indicator = container.querySelector('#scroll-indicator');
            if (!indicator) return;

            const update = () => {
                const needsScroll = container.scrollHeight > container.clientHeight + 1;
                const scrolled = container.scrollTop > 8;
                const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 4;
                if (needsScroll && !scrolled && !atBottom) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            };

            container.addEventListener('scroll', update);
            window.addEventListener('resize', update);
            const observer = new MutationObserver(() => requestAnimationFrame(update));
            observer.observe(container, { childList: true, characterData: true, subtree: true });

            container.__scrollIndicatorInitialized = true;
            requestAnimationFrame(update);
        }

       async function initAiProfileSummary(profile, code) {
    const container = document.querySelector('#results-modal #ai-summary-content');
    if (!container || container.dataset.loading === '1') return;

    // 0) Pr√©f√©rence: valeurs d√©j√† fournies par le profil (si disponibles)
    let autoMbti = (profile && profile.results && profile.results.autoMbti) || null;
    let autoEnneagram = (profile && profile.results && profile.results.autoEnneagram) || null;
    let externalMbti = (profile && profile.results && (profile.results.externalMbti || profile.results.mbti)) || null;
    let externalEnneagram = (profile && profile.results && (profile.results.externalEnneagram || profile.results.enneagram)) || null;

    // 1) R√©cup√©rer l'auto depuis profile.self si pr√©sent (fallback robuste multi‚Äëappareils)
    try {
        if ((!autoMbti || !autoEnneagram) && profile && profile.self) {
            autoMbti = autoMbti || profile.self.mbti || profile.self.mbtiType || null;
            autoEnneagram = autoEnneagram || profile.self.enneagram || profile.self.enneagramType || null;
        }
    } catch (_) {}

    // 1b) R√©cup√©rer l'auto-√©valuation depuis le localStorage (fallback)
    try {
        if (!autoMbti || !autoEnneagram) {
            const raw = localStorage.getItem('userProfile_' + code);
            if (raw) {
                const up = JSON.parse(raw);
                autoMbti = autoMbti || up.mbtiType || null;
                autoEnneagram = autoEnneagram || up.enneagramType || null;
            }
        }
    } catch (_) {}

    // 2) R√©cup√©rer/Calculer les √©valuations externes depuis Supabase pour calculer un profil agr√©g√© (si non fourni)
    try {
        if ((!externalMbti || !externalEnneagram) && typeof fetchUserProfileFromSupabase === 'function' && typeof computeWeightedResults === 'function') {
            const r = await fetchUserProfileFromSupabase(code);
            const evaluations = (r && Array.isArray(r.evaluations)) ? r.evaluations : [];
            if (evaluations.length > 0) {
                const weighted = computeWeightedResults(evaluations);
                externalMbti = weighted.mbtiType || null;
                externalEnneagram = weighted.enneagramType || null;
            }
            // 2b) Compl√©ter l'auto depuis la DB si encore manquant
            if ((!autoMbti || !autoEnneagram) && r && r.user) {
                autoMbti = autoMbti || r.user.auto_mbti_type || null;
                autoEnneagram = autoEnneagram || r.user.auto_enneagram_type || null;
            }
        }
    } catch (e) {
        console.warn('Impossible de calculer le profil externe agr√©g√©:', e);
    }

    // 3) Fallbacks si on n'a pas pu distinguer
    // - Si aucune auto trouv√©e mais le profil affich√© n'a pas d'√©valuations externes, on prend le profil courant comme auto
    if (!autoMbti || !autoEnneagram) {
        if (!externalMbti && !externalEnneagram && profile && profile.results) {
            autoMbti = autoMbti || profile.results.mbti || null;
            autoEnneagram = autoEnneagram || profile.results.enneagram || null;
        }
    }

    // Construire la cl√© de cache en fonction des infos disponibles
    const cacheKey = `ai-summary:v3:${code}:${autoMbti || ''}:${autoEnneagram || ''}:${externalMbti || ''}:${externalEnneagram || ''}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
        console.info('[AI Summary]', 'cache hit', cacheKey);
        container.textContent = cached;
        setupScrollIndicator(container);
        return;
    }

    console.info('[AI Summary]', 'cache miss', cacheKey);
    container.setAttribute('data-loading', '1');

    // Toujours g√©n√©rer un COMPARATIF, m√™me si certaines infos manquent.
    const mbtiAuto = autoMbti || 'indisponible';
    const enneaAuto = autoEnneagram || 'indisponible';
    const mbtiExt = externalMbti || 'indisponible';
    const enneaExt = externalEnneagram || 'indisponible';

    const messages = [
        {
            role: 'system',
            content: "Tu es Psycho'Bot, un psychologue p√©dagogique. √âcris en fran√ßais clair et nuanc√©, sans jargon. Adresse-toi directement √† la personne (tutoiement), ton amical, empathique, bienveillant et concret."
        },
        {
            role: 'user',
            content: `Comparatif entre auto-√©valuation et √©valuations externes pour la m√™me personne.\n\n1) Auto-√©valuation (vision subjective)\nMBTI=${mbtiAuto}, Enn√©agramme=${enneaAuto}\n\n2) √âvaluations externes (vision des proches)\nMBTI=${mbtiExt}, Enn√©agramme=${enneaExt}\n\nTa t√¢che (respecte imp√©rativement cette structure) :\n- Convergences (o√π √ßa se rejoint).\n- Divergences (o√π √ßa diff√®re).\n- Lecture psychologique : biais possibles, angles morts, coh√©rences/contradictions.\n- Synth√®se positive : comment cette comparaison aide √† mieux te conna√Ætre.\n\nR√®gles : 350 mots max, phrases courtes, tutoiement, ton positif et p√©dagogique. Si une info est manquante, indique en quoi cette absence peut biaiser l'analyse et compare tout de m√™me ce qui est disponible. N'inclus pas de diagnostic m√©dical/clinique.`
        }
    ];

    let totalText = '';
    let attempts = 0;

    while (true) {
        try {
            const response = await fetch('/api/psy-results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages })
            });

            if (!response.ok) throw new Error('bad response');
            const data = await response.json();
            totalText += data.content || '';

            if (data.finish_reason && data.finish_reason !== 'stop') {
                messages.push({ role: 'assistant', content: data.content || '' });
                messages.push({ role: 'user', content: 'continue' });
                continue;
            }

            const finalText = totalText.trim();
            container.textContent = finalText || "Description indisponible pour le moment.";
            if (finalText) localStorage.setItem(cacheKey, finalText);
            break;
        } catch (e) {
            console.error('Erreur IA:', e);
            attempts++;
            if (attempts < 2) {
                container.textContent = "√âchec de la g√©n√©ration, nouvelle tentative‚Ä¶";
                continue;
            }
            container.textContent = "Impossible de terminer la description";
            break;
        }
    }

    container.removeAttribute('data-loading');
    setupScrollIndicator(container);
}


        function closeResultsModal() {
            const modal = document.getElementById('results-modal');
            if (modal) {
                modal.remove();
            }
        }


        async function shareProfileResults(code) {
            const result = await fetchUserProfileFromSupabase(code);
            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Impossible de partager : le profil complet n‚Äôest pas encore disponible.');
                return;
            }
            const description = document.getElementById('ai-summary-content')?.innerText.trim() || '';
            shareProfile(result.user.mbti_type, `Type ${result.user.enneagram_type}`, description);
        }

        function shareProfile(mbti, enneagram, description) {
            const shareText = buildShareText(mbti, enneagram, description);
            const url = 'https://www.personnalitecomparee.com';
            if (navigator.share) {
                navigator.share({ title: 'Mon profil de personnalit√©', text: shareText, url });
            } else {
                showShareFallback(shareText, url);
            }
        }

        function buildShareText(mbti, enneagram, description) {
            return `Hey ! Je viens de passer l'√©valuation du site www.personnalitecomparee.com et voici mon profil !\nJe suis "${mbti} et ${enneagram}"\nVoici une petite description de ma personnalit√© : "${description}"\nDites-moi si vous me reconnaissez et n'h√©sitez pas √† aller passer aussi votre test ici : www.personnalitecomparee.com`;
        }

        function showShareFallback(text, url) {
            const existing = document.getElementById('share-fallback');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'share-fallback';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            const links = [
                { name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}` },
                { name: 'WhatsApp', url: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}` },
                { name: 'X/Twitter', url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}` },
                { name: 'LinkedIn', url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}` },
                { name: 'Telegram', url: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}` },
                { name: 'Email', url: `mailto:?subject=${encodeURIComponent('Mon profil de personnalit√©')}&body=${encodeURIComponent(text + ' ' + url)}` }
            ];
            overlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
                    <h3 class="text-lg font-medium mb-4" data-i18n="shareFallback.title">Partager</h3>
                    <div class="flex flex-col space-y-2">
                        ${links.map(l => `<a href="${l.url}" target="_blank" class="px-4 py-2 rounded hover:bg-gray-100">${l.name}</a>`).join('')}
                    </div>
                    <button class="mt-4 w-full px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" onclick="document.getElementById('share-fallback').remove()"><span data-i18n="shareFallback.close">Fermer</span></button>
                </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
        }


        // Fermer la modale en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const profileModal = document.getElementById('profile-modal');
            const resultsModal = document.getElementById('results-modal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === resultsModal) {
                closeResultsModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            const profileModal = document.getElementById('profile-modal');
            const resultsModal = document.getElementById('results-modal');
            if (event.key === 'Escape') {
                if (resultsModal) { closeResultsModal(); }
                if (profileModal) { closeProfileModal(); }
            }
        });

        // Permettre la saisie du code avec Entr√©e
        document.addEventListener('DOMContentLoaded', function() {
            const profileCodeInput = document.getElementById('profile-code');
            if (profileCodeInput) {
                profileCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkProfileCode();
                    }
                });
                
                // Forcer la saisie en majuscules
                profileCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
        });
    </script>

   <!-- Modales pour les descriptions d√©taill√©es -->
    <div id="modal-container"></div>

 <!-- Modale Espace Personnel -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900" data-i18n="profileModal.title">Mon Espace Personnel</h2>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- √âtape 1: Saisie du code -->
                <div id="code-input-step" class="profile-step">
                    <div class="text-center mb-6">
                        <div class="mx-auto pc-icon-badge mb-5">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="profileModal.step1.title">Acc√©dez √† votre profil</h3>
                        <p class="text-sm text-gray-500" data-i18n="profileModal.step1.desc">Entrez votre code unique pour consulter vos r√©sultats</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="profile-code" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="profileModal.codeLabel">Code unique</label>
                            <input type="text" id="profile-code" placeholder="Entrez votre code (ex: ABC123)"
                                   class="w-full px-4 py-3 border border-gray-200 rounded-2xl shadow-md focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-center text-lg font-mono tracking-wider uppercase transition-all" data-i18n-placeholder="profileModal.codePlaceholder">
                        </div>
                        <button onclick="checkProfileCode()" class="w-full inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-2xl text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black shadow-md">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            <span data-i18n="profileModal.accessButton">Acc√©der √† mon profil</span>
                        </button>
                    </div>
                </div>


                <!-- √âtape 2: Statut des √©valuations -->
                <div id="profile-status-step" class="profile-step" style="display: none;">
                    <div class="text-center mb-6">
                        <div class="mx-auto pc-icon-badge pc-icon-lg mb-5">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2"><span data-i18n="profileModal.step2.title">Profil de</span> <span id="profile-name"></span></h3>
                        <p class="text-sm text-gray-500"><span data-i18n="profileModal.step2.codeLabel">Code:</span> <span id="display-code" class="font-mono font-bold"></span></p>
                    </div>

                    <!-- Statut des √©valuations -->
                    <div class="pc-soft-card p-5 mb-6">
                        <h4 class="font-medium text-gray-900 mb-3" data-i18n="profileModal.step2.statusTitle">Statut des √©valuations</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600" data-i18n="profileModal.step2.selfEval">Votre auto-√©valuation</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i> <span data-i18n="profileModal.step2.completed">Termin√©e</span>
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600" data-i18n="profileModal.step2.relativesEval">√âvaluations des proches</span>
                                <span id="evaluations-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                    <!-- Sera rempli dynamiquement -->
                                </span>
                            </div>
                        </div>
                        
                        <!-- Barre de progression -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span data-i18n="profileModal.step2.progress">Progression globale</span>
                                <span id="progress-text">0/4</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="progress-bar h-2 rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(90deg, hsl(0 90% 62%), hsl(0 90% 52%))"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Message selon le statut -->
                    <div id="status-message" class="pc-soft-card p-4 mb-4">
                        <!-- Sera rempli dynamiquement -->
                    </div>

                    <!-- Actions -->
                    <div class="flex space-x-3">
                        <button onclick="shareCode()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <i class="fas fa-share mr-2"></i>
                            <span data-i18n="profile.complete.button.share">Partager mon code</span>
                        </button>
                        <button id="seeResultsBtn" onclick="viewResults()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-chart-pie mr-2"></i>
                            <span data-i18n="profile.complete.button.results">Voir mes r√©sultats</span>
                        </button>
                    </div>
                </div>

                <!-- Message d'erreur -->
                <div id="error-message" class="profile-step" style="display: none;">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="profileModal.error.title">Code introuvable</h3>
                        <p class="text-sm text-gray-500 mb-4" data-i18n="profileModal.error.desc">Le code que vous avez entr√© n'existe pas ou est incorrect.</p>
                        <button onclick="resetProfileModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <span data-i18n="profileModal.error.retry">R√©essayer</span>
                        </button>
                    </div>
                </div>
    </div>
        </div>
    </div>




  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const homeLinks = document.querySelectorAll('.scroll-top-link');
      const brand = document.getElementById('brand-home');

      function handleScrollTop(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.body.classList.add('scroll-highlight');
        setTimeout(() => document.body.classList.remove('scroll-highlight'), 1000);
      }

      homeLinks.forEach(link => link.addEventListener('click', handleScrollTop));
      if (brand) brand.addEventListener('click', handleScrollTop);
    });
  </script>

  <script type="module">
import { supabase } from "./common.js";

  const externalForm = document.getElementById("external-form");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code")?.toUpperCase();
  const encodedCode = code ? encodeURIComponent(code) : null;

  if (encodedCode) {
    (async () => {
      if (externalForm) {
        externalForm.style.display = "none";
      }

      try {
        const { data: user, error } = await supabase
          .from("users")
          .select("id")
          .eq("code", encodedCode)
          .single();

        if (error || !user) {
          alert("Code invalide ou introuvable.");
          return;
        } else if (externalForm) {
          externalForm.style.display = "";
        }
      } catch (err) {
        console.error("Erreur lors de la v√©rification du code :", err);
        alert("Code invalide ou introuvable.");
        return;
      }
    })();
  }

  if (externalForm) {
    externalForm.addEventListener("submit", (e) => {
      e.preventDefault();
      alert("Merci pour votre participation. Les r√©sultats sont disponibles dans la section 'Mon profil'.");
      externalForm.reset();
      externalForm.style.display = "none";
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 600,
    easing: 'ease-out',
    once: true
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (function(){
  const wrap = (()=>{
    // Essaie plusieurs s√©lecteurs raisonnables
    return document.querySelector('section#hero, section.hero, .hero, .banner, [data-hero]') ||
           [...document.querySelectorAll('section')].find(s => /vraiment|analyse/i.test(s.textContent)) ||
           document.body;
  })();
  wrap.classList.add('pc-hero');

  // Si pas d√©j√† pr√©sent, injecte le canvas
  let canvas = document.getElementById('pc-constellation');
  if(!canvas){
    canvas = document.createElement('canvas');
    canvas.id = 'pc-constellation';
    wrap.prepend(canvas);
  }
  // Classe de position d√©j√† ajout√©e pour garantir la superposition correcte

  const ctx = canvas.getContext('2d', { alpha: true });
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  const N = 80;               // nombre de points
  let LINK_DIST = 100;        // distance de connexion
  let MAX_LINKS = N;          // connexions maximales par point
  let BASE_OPACITY = 0.25;    // opacit√© maximale des lignes
  const mouse = { x:0, y:0, inside:false };
  const DRIFT = 0.008;                  // amplitude du drift autonome
  const ALLOW_DRIFT = matchMedia('(pointer: coarse)').matches;
  let pts = [], W=0, H=0;

  function resize(){
    const { width, height } = wrap.getBoundingClientRect();
    W = canvas.width  = Math.floor(width * DPR);
    H = canvas.height = Math.floor(height * DPR);
    canvas.style.width  = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    if(!pts.length){
      pts = Array.from({length:N}, ()=>({
        x: Math.random()*width,
        y: Math.random()*height,
        vx: (Math.random()-.5)*.25,
        vy: (Math.random()-.5)*.25
      }));
    }
  }

  function updateConnectivity(){
    if (window.innerWidth <= 768) {
      LINK_DIST = 65;         // distance de connexion augment√©e
      MAX_LINKS = 3;          // un peu plus de liaisons par point
      BASE_OPACITY = 0.55;    // mobile
    } else {
      LINK_DIST = 120;        // distance de connexion augment√©e
      MAX_LINKS = N;          // inchang√© pour desktop
      BASE_OPACITY = 0.45;    // desktop
    }
  }

  resize();
  updateConnectivity();
  addEventListener('resize', () => { resize(); updateConnectivity(); });

  // Suivi souris uniquement dans la banni√®re
  wrap.addEventListener('mouseenter', ()=>mouse.inside = true);
  wrap.addEventListener('mouseleave', ()=>mouse.inside = false);
  wrap.addEventListener('mousemove', e=>{
    const r = canvas.getBoundingClientRect();
    mouse.x = e.clientX - r.left;
    mouse.y = e.clientY - r.top;
  });

  let stop = matchMedia('(prefers-reduced-motion: reduce)').matches;
  matchMedia('(prefers-reduced-motion: reduce)').addEventListener?.('change', e=>{ stop = e.matches; });

  function frame(){
    if(stop) return; // respect R.M.
    const r = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,r.width,r.height);

    // --- Move
    for(const p of pts){
      if(mouse.inside){
        const dx = mouse.x - p.x, dy = mouse.y - p.y;
        const d = Math.hypot(dx,dy) || 1;
        // Attraction "un cran au-dessus de mod√©r√©"
        const force = Math.min(0.035, 9/(d*d));
        p.vx += (dx/d)*force;
        p.vy += (dy/d)*force;
      } else if(ALLOW_DRIFT){
        // l√©ger mouvement autonome sur mobile
        p.vx += (Math.random()-.5)*DRIFT;
        p.vy += (Math.random()-.5)*DRIFT;
      }
      // friction + clamp
      p.vx *= 0.991; p.vy *= 0.991;
      const vmax = 0.9; // vitesse max
      const sp = Math.hypot(p.vx,p.vy);
      if(sp>vmax){ p.vx = p.vx/sp*vmax; p.vy = p.vy/sp*vmax; }

      p.x += p.vx; p.y += p.vy;
      if(p.x<0||p.x>r.width)  p.vx *= -1;
      if(p.y<0||p.y>r.height) p.vy *= -1;
    }

    // --- Lines
    ctx.lineWidth = 0.6;
    const linksCount = new Array(N).fill(0);
    for(let i=0;i<N;i++){
      for(let j=i+1;j<N;j++){
        const a=pts[i], b=pts[j];
        const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
        if(d<LINK_DIST && linksCount[i] < MAX_LINKS && linksCount[j] < MAX_LINKS){
          const o = 1 - d/LINK_DIST;
          ctx.strokeStyle = `rgba(59,130,246,${(o*BASE_OPACITY).toFixed(3)})`; // bleu #3B82F6
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          linksCount[i]++;
          linksCount[j]++;
        }
      }
    }
    ctx.fillStyle = 'rgba(10,15,26,.62)';
    for(const p of pts){
      ctx.beginPath();
      const r = (window.innerWidth <= 768) ? 1.3 : 1.6;
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  })();
});
</script>

<!-- Typed doit √™tre charg√© avant notre script pour l‚Äôeffet progressif -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>

<script>
  // Styles (arrondis + grille des suggestions)
  (function addChatStyles(){
    const s=document.createElement('style');
    s.textContent=`
      #chat-window{border-radius:32px!important;overflow:hidden!important;}
      #chat-input{border-radius:9999px 0 0 9999px!important;}
      #chat-send{border-radius:0 9999px 9999px 0!important;}
      #chat-box{display:flex;flex-direction:column;gap:8px;}
      .user-bubble{align-self:flex-end;background:#e8f0ff;padding:10px 12px;border-radius:14px;max-width:85%;}
      .assistant-bubble{align-self:flex-start;background:#f6f6f6;padding:10px 12px;border-radius:14px;max-width:85%;}
      /* Grille: 2 boutons sur la 1√®re ligne, 3e centr√© en dessous */
      #chat-suggestions{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;}
      #chat-suggestions .suggestion-bubble:nth-child(3){grid-column:1 / -1;justify-self:center;}
    `;
    document.head.appendChild(s);
  })();

  // ===== M√©moire locale + trim =====
  let messages = JSON.parse(localStorage.getItem("chatHistory")) || [];
  const MAX_CONTEXT_TOKENS_CLIENT = 1600;

  function estimateTokens(str){ return Math.ceil((str||"").length/4); }
  function trimHistoryClient(msgs,budgetTokens){
    const keep=[]; let total=0;
    for(let i=msgs.length-1;i>=0;i--){
      const m=msgs[i];
      const c=typeof m.content==="string"?m.content:JSON.stringify(m.content);
      const cost=estimateTokens(c)+8;
      if(total+cost>budgetTokens) break;
      keep.push(m); total+=cost;
    }
    return keep.reverse();
  }

  // ===== UI helpers =====
  function setTyping(on){ const el=document.getElementById("pc-typing-indicator"); if(el) el.hidden=!on; }
  function safeScrollToBottom(el){ el.scrollTo({top:el.scrollHeight,behavior:'smooth'}); }

  function toggleSuggestions(){
    const sugg=document.getElementById('chat-suggestions');
    if(!sugg) return;
    // si conversation existante -> cach√©es, sinon -> visibles en grille
    sugg.style.display = messages.length ? 'none' : 'grid';
  }

  function appendMessage(role,text,{typing=(role==='assistant'),skipPersist=false}={}){
    const chatBox=document.getElementById("chat-box"); if(!chatBox) return;
    const row=document.createElement('div'); row.className=`chat-row ${role==='user'?'user':'assistant'}`;
    const bubble=document.createElement('div'); bubble.className=`chat-bubble ${role==='user'?'user-bubble':'assistant-bubble'}`;
    row.appendChild(bubble); chatBox.appendChild(row);

    if(role==='assistant' && typing && window.Typed){
      const obs=new MutationObserver(()=>safeScrollToBottom(chatBox));
      obs.observe(bubble,{childList:true,subtree:true,characterData:true});
      new Typed(bubble,{strings:[text],typeSpeed:30,showCursor:false,loop:false,contentType:'html',onComplete:()=>{obs.disconnect();safeScrollToBottom(chatBox);}});
    }else{
      bubble.textContent=text;
    }
    safeScrollToBottom(chatBox);

    if(!skipPersist){
      messages.push({role,content:text});
      messages=trimHistoryClient(messages,MAX_CONTEXT_TOKENS_CLIENT);
      localStorage.setItem("chatHistory",JSON.stringify(messages));
      toggleSuggestions(); // cacher si un message vient d‚Äô√™tre ajout√©
    }
  }

  function afficherConversation(){
    const box=document.getElementById("chat-box"); if(!box) return;
    box.innerHTML="";
    messages.forEach(m=>appendMessage(m.role,m.content,{skipPersist:true,typing:false}));
    box.scrollTop=box.scrollHeight;
    toggleSuggestions(); // afficher/cacher selon l‚Äô√©tat au chargement
  }

  async function envoyerMessage(texte){
    if(!texte || !texte.trim()) return;
    const q=texte.trim();

    toggleSuggestions(); // les cacher si ce n‚Äôest pas d√©j√† le cas
    appendMessage('user',q);
    // Tracking : message utilisateur envoy√©
    saveEvent('chat_message_sent', null, null, { messageLength: q.length });
    setTyping(true);

    try{
      const res=await fetch("/api/text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
      const data=await res.json();
      const botMsg = data.message || "(pas de r√©ponse)";
      appendMessage('assistant', botMsg, {typing:true});
      // Tracking : r√©ponse du bot
      saveEvent('chat_message_received', null, null, { messageLength: botMsg.length });
    }catch(e){
      console.error(e);
      const errMsg = "Oups, probl√®me de connexion. R√©essaye dans quelques secondes.";
      appendMessage('assistant', errMsg,{typing:false});
      // Tracking m√™me en cas d'erreur r√©seau
      saveEvent('chat_message_received', null, null, { messageLength: errMsg.length });
    }finally{
      setTyping(false);
    }
  }

  // Bouton reset (appel√© par onclick sur le HTML)
  window.resetConversation=function(){
    messages=[];
    localStorage.removeItem("chatHistory");
    const box=document.getElementById("chat-box"); if(box) box.innerHTML="";
    toggleSuggestions(); // re-affiche en grille (2 + 1 centr√©)
  };

  // Brancher contr√¥les
  (function bindUI(){
    const sendBtn=document.getElementById("chat-send");
    const input=document.getElementById("chat-input");
    if(sendBtn && input){
      sendBtn.addEventListener("click",()=>{ envoyerMessage(input.value); input.value=""; input.focus(); });
      input.addEventListener("keypress",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }});
    }
    document.querySelectorAll('#chat-suggestions .suggestion-bubble').forEach(btn=>{
      const q=btn.dataset.question||btn.textContent.trim();
      btn.addEventListener('click',()=>envoyerMessage(q));
    });
  })();

  // Init
  afficherConversation();
</script>

<script>
function addChatStyles() {
  const style = document.createElement("style");
  style.textContent = `
    /* SCOP√â AU CHATBOT UNIQUEMENT */
    #home-ia #chat-suggestions .suggestion-bubble {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: rgba(255, 255, 255, 0.18) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border: 1px solid rgba(255, 255, 255, 0.28) !important;
      border-radius: 50px !important;
      padding: 10px 22px !important;
      margin: 6px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      color: rgba(0, 0, 0, 0.85) !important;
      cursor: pointer !important;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.3s ease !important;
      white-space: nowrap !important; /* desktop par d√©faut */
      text-align: center !important;
    }
    #home-ia #chat-suggestions .suggestion-bubble:hover {
      transform: translateY(-1px) scale(1.04) !important;
      background: rgba(255, 255, 255, 0.28) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08) !important;
    }
    @media (max-width: 768px) {
      #home-ia #chat-suggestions .suggestion-bubble {
        white-space: normal !important;
        max-width: calc(100% - 12px) !important;
      }
    }
  `;
  document.head.appendChild(style);
}
addChatStyles();
</script>
<style>
  #pc-constellation{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none;}
</style>

<script src="nav.js"></script>
<script src="lang.js"></script>
<script src="i18n.js"></script>

<script>
window.addEventListener('scroll', () => {
    const banner = document.getElementById('beta-banner');
    if (banner) banner.remove();
}, { once: true });
</script>

 <script type="module">
import { supabase } from "./common.js";

  // -------- Utils --------
  const nowIso = () => new Date().toISOString();
  const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile'
    : /Tablet|iPad/i.test(navigator.userAgent) ? 'tablet' : 'desktop';
  const language = (navigator.language || 'en').slice(0,2);
  const tz_offset = -new Date().getTimezoneOffset(); // en minutes (ex: +120 pour CET)
  const viewport = { width: window.innerWidth, height: window.innerHeight };
  const screenInfo = { width: window.screen?.width || 0, height: window.screen?.height || 0 };
  const parseUTM = () => {
    const p = new URLSearchParams(location.search);
    const keys = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term"];
    const obj = {};
    keys.forEach(k => { if (p.get(k)) obj[k] = p.get(k); });
    return Object.keys(obj).length ? obj : null;
  };

  // -------- D√©claration du session_id --------
  let sessionId;
  let seconds = 0; // pour engagement_ms

  // -------- Insertion/Mise √† jour sessions --------
  async function upsertSession(firstLoad=false, lastEventName=null) {
    const payload = {
      session_id: sessionId,
      last_activity_at: nowIso(),
      last_page_url: window.location.href,
      user_agent: navigator.userAgent,
      device_type: deviceType,
      language,
      tz_offset,
      viewport,
      screen: screenInfo
    };
    if (firstLoad) {
      payload.first_seen_at = nowIso();
      payload.first_referrer = document.referrer || null;
      payload.first_utm = parseUTM();
      // calcul simple is_returning via localStorage
      const hasVisited = !!localStorage.getItem("pc_has_visited");
      payload.is_returning = hasVisited;
    }
    if (lastEventName) payload.last_event_name = lastEventName;
    // on envoie engagement_ms en ms (overwrite avec la valeur actuelle)
    payload.engagement_ms = seconds * 1000;

    // upsert sur session_id
    try {
      await supabase.from("sessions")
        .upsert([payload], { onConflict: "session_id" });
    } catch (e) {
      console.error("Erreur upsert sessions:", e);
    }
  }

  // -------- Event tracking (√©crit events + rafra√Æchit sessions.last_activity_at) --------
  async function trackEvent(eventName, extraData = {}) {
    try {
      const { error } = await supabase.from("events").insert([{
        session_id: sessionId,
        event_name: eventName,
        event_category: eventName,   // ‚úÖ ajout pour √©viter event_category null
        element_selector: extraData.element_selector || null,
        value: extraData.value || null,
        meta: extraData.meta || {},
        page_url: window.location.href,
        referrer: document.referrer,
        user_agent: navigator.userAgent
      }]);
      if (error) console.error("Erreur enregistrement event:", error);
    } catch (err) {
      console.error("Erreur trackEvent:", err);
    } finally {
      upsertSession(false, eventName);
    }
  }

  // -------- Helper pour sauver un event --------
  async function saveEvent(eventCategory, elementSelector = null, value = null, meta = {}) {
    try {
      await supabase.from("events").insert([{
        session_id: sessionId,
        event_name: eventCategory,          // ‚ö†Ô∏è obligatoire en base
        event_category: eventCategory,
        element_selector: elementSelector,
        value,
        meta,
        page_url: window.location.href,
        referrer: document.referrer,
        user_agent: navigator.userAgent
      }]);
    } catch (err) {
      console.error("Erreur enregistrement event:", err);
    } finally {
      upsertSession(false, eventCategory);
    }
  }
  window.saveEvent = saveEvent;

  // ====== Init ======
  (async () => {
    sessionId = localStorage.getItem("session_id") || crypto.randomUUID();
    localStorage.setItem("session_id", sessionId);

    // upsert initial (cr√©e si nouveau, met √† jour sinon)
    await upsertSession(true, "page_view");

    // flag visiteur (pour is_returning sur les prochaines visites)
    localStorage.setItem("pc_has_visited", "1");

    // premier event
    trackEvent("page_view");

    // Clicks
    document.addEventListener('click', (e) => {
      let selector = '';
      if (e.target.id) selector = '#' + e.target.id;
      else if (e.target.className) {
        selector = e.target.tagName.toLowerCase() + '.' +
          e.target.className.toString().trim().replace(/\s+/g, '.');
      } else selector = e.target.tagName.toLowerCase();
      saveEvent('Click', selector, null, { element: selector });
    });
  })();

  // -------- Scroll tracking (25%, 50%, 75%, 100%) --------
  let scrollTracked = {25: false, 50: false, 75: false, 100: false};
  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrolled = Math.round((scrollTop / docHeight) * 100);

    [25,50,75,100].forEach(p => {
      if (scrolled >= p && !scrollTracked[p]) {
        scrollTracked[p] = true;
        saveEvent("Scroll", null, p, { percent: p });
      }
    });
  });

  // -------- Temps pass√© sur la page (heartbeat toutes les 15s) --------
  setInterval(() => {
    seconds += 15;
    // event "Time" + MAJ sessions (last_activity_at + engagement_ms)
    saveEvent("Time", null, seconds, { url: window.location.href });
  }, 15000);

  // -------- Form Submits --------
  document.addEventListener("submit", (e) => {
    let selector = e.target.id ? `#${e.target.id}` : e.target.tagName.toLowerCase();
    saveEvent("FormSubmit", selector, null, { formAction: e.target.action || null });
  });

  // -------- Stats Form Submits --------
  async function loadFormStats() {
    const { data, error } = await supabase
      .from("events")
      .select("occurred_at")
      .eq("event_category", "FormSubmit");

    if (error) {
      console.error("Erreur r√©cup√©ration stats:", error);
      return;
    }

    // Regroupe par jour
    const stats = {};
    data.forEach(ev => {
      const day = new Date(ev.occurred_at).toISOString().split("T")[0];
      stats[day] = (stats[day] || 0) + 1;
    });

    // Affichage dans ton HTML
    const container = document.getElementById("form-stats");
    if (!container) return;

    container.innerHTML = "";
    let total = 0;
    Object.entries(stats)
      .sort((a, b) => b[0].localeCompare(a[0]))
      .forEach(([day, count]) => {
        total += count;
        const p = document.createElement("p");
        p.textContent = `${day} : ${count} formulaire(s)`;
        container.appendChild(p);
      });

    // Ajoute un total en haut
    const totalDiv = document.createElement("div");
    totalDiv.innerHTML = `<strong>Total formulaires soumis : ${total}</strong>`;
    container.prepend(totalDiv);
  }

  // Charge les stats √† l'ouverture
  loadFormStats();
</script>




</body>
</html>



      
