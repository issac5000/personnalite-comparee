<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="enneagramme.page.title">Ennéagramme — Personnalité Comparée</title>

  <!-- Supabase JS -->

  <!-- SEO Meta Tags -->
  <meta name="description" lang="fr" content="Découvrez votre personnalité avec un test dérivé MBTI et Ennéagramme gratuit. Analyse des 16 types et 9 profils, combinant auto-évaluation et validation par vos proches.">
  <meta name="description" lang="en" content="Discover your personality with our free MBTI-inspired and Enneagram test. Explore the 16 personality types and 9 Enneagram profiles with self-assessment and peer validation.">
  <meta name="keywords" content="test personnalité, MBTI, ennéagramme, psychologie, 16 types, auto-évaluation, gratuit">
  <meta name="author" content="Personnalité Comparée">
  <meta name="robots" content="index, follow">


  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="Personnalité Comparée | Test MBTI & Ennéagramme Gratuit">
  <meta property="og:description" content="Découvrez votre vraie personnalité avec notre test MBTI et Ennéagramme gratuit. Analyse objective combinant votre auto-évaluation et l'avis de vos proches.">
    <meta property="og:image" content="logo.jpg">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="Personnalité Comparée | Test MBTI & Ennéagramme Gratuit">
    <meta property="twitter:description" content="Découvrez votre vraie personnalité avec notre test MBTI et Ennéagramme gratuit. Analyse objective combinant votre auto-évaluation et l'avis de vos proches.">
      <meta property="twitter:image" content="logo.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="/flavicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Supabase JS library -->
   
    <style>
        html, body {
            overflow-x: hidden;
        }
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        /* Highlight styles reused from home banner */
        .pc-superbold { -webkit-text-stroke: 0.2px currentColor; }
        .pc-highlight {
          background-image: linear-gradient(180deg, transparent 58%, #fef08a 58%);
          background-repeat: no-repeat;
          border-radius: .15em;
          padding: 0 .08em;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        button,
        [class*="card"] {
            transition: all 0.3s ease;
        }

        /* Animation: logo spins once every 5s (pulse) */
        @keyframes pc-spin-y {
          0%, 90% { transform: rotateY(0deg); }
          100%    { transform: rotateY(360deg); }
        }
        img[src$="logotitre.png"],
        img[src$="logo pc 3.png"] {
          display: inline-block;
          animation: pc-spin-y 5s ease-in-out infinite;
          transform-style: preserve-3d;
          backface-visibility: visible;
          will-change: transform;
          transform-origin: center center;
        }
        @media (prefers-reduced-motion: reduce) {
          img[src$="logotitre.png"],
          img[src$="logo pc 3.png"] { animation: none; }
        }

        /* Site-wide rounded buttons without changing colors */
        button,
        input[type="button"],
        input[type="submit"],
        .btn,
        a.btn {
          border-radius: 1rem !important; /* 16px approx */
        }

        button:hover {
            transform: rotateX(3deg) rotateY(3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        [class*="card"]:hover {
            transform: perspective(600px) rotateX(3deg) rotateY(-3deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .question-card {
            min-height: 300px;
        }
        .floating-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .personality-badge {
            border-radius: 50px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Styles pour les modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalZoomIn 0.3s ease-out;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .close {
            color: #9ca3af;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover,
        .close:focus {
            color: #374151;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalZoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @media (max-width: 1023px) {
            .desktop-nav {
                display: none;
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .question-container {
            display: none;
        }
        .question-container.active {
            display: block;
        }

        .section-clair {
            background-color: #ffffff;
        }

        .section-fonce {
            background-color: #fbfbfb;
        }
        #site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: inherit;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
            height: auto;
            min-height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        body {
            padding-top: 64px;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1100;
            display: none;
        }

        .mobile-menu.active {
            display: block;
        }

        @media (max-width: 1023px) {
            #site-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                background: inherit;
                box-shadow: 0 2px 10px rgba(0,0,0,0.06);
                height: auto;
                min-height: 56px;
            }
            body {
                padding-top: 56px;
            }
            [id],
            .section {
                scroll-margin-top: 64px;
            }
        }

        .scroll-highlight {
            animation: scrollHighlight 1s ease;
        }
        @keyframes scrollHighlight {
            from { background-color: #fef3c7; }
            to { background-color: #ffffff; }
        }

        /* Chat styles */
        .chat-row {
            display: flex;
            margin-bottom: 8px;
        }
        .chat-row.user {
            justify-content: flex-end;
        }
        .chat-row.assistant {
            justify-content: flex-start;
        }
        .chat-bubble {
            display: inline-block;
            padding: 10px 14px;
            font-size: 15px;
        }
        .assistant-bubble {
            background: #e0f0ff;
            color: #003b5c;
            border-radius: 16px 16px 16px 4px;
        }
        .user-bubble {
            background: #d1ffe0;
            color: #084d28;
            border-radius: 16px 16px 4px 16px;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .assistant-bubble.limit-error {
            background: #ffe5e5;
            border: 1px solid #ff0000;
            color: #b30000;
            font-weight: bold;
            animation: shake 0.4s;
        }
        .question-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 14px;
            margin-top: auto;
            padding: 12px;
        }
        .question-buttons button {
            padding: 6px 12px;
            border-radius: 8px;
            background-color: #e7f1fb;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .question-buttons button:hover {
            background-color: #d0e7f7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .pc-typing {
            position: sticky;
            bottom: 0;
            padding: 8px 12px;
            background: rgba(0,0,0,0.04);
            backdrop-filter: blur(2px);
            border-top: 1px solid rgba(0,0,0,0.06);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .pc-typing[hidden] { display: none; }
        .pc-dots span {
            animation: pc-blink 1.2s infinite;
            display: inline-block;
            padding-left: 2px;
        }
        .pc-dots span:nth-child(2) { animation-delay: .2s; }
        .pc-dots span:nth-child(3) { animation-delay: .4s; }
        @keyframes pc-blink {
            0% { opacity: 0.2; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-1px); }
            100% { opacity: 0.2; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: -2px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        :root{
          --pc-line: rgba(59,130,246,.30);  /* bleu doux (#3B82F6) */
          --pc-dot:  rgba(10,15,26,.62);
        }
        /* le conteneur de la bannière doit déjà être positionné ; sinon: */
        .pc-hero { position: relative; isolation: isolate; z-index: 0; margin-top: 2rem; }
        @media (min-width: 768px) {
          .pc-hero { margin-top: 3rem; }
        }

        #pc-constellation{
          position: absolute; inset: 0; width: 100%; height: 100%;
          pointer-events: none; z-index: -1; /* contenu texte reste au-dessus */
        }

        @media (prefers-reduced-motion: reduce){
          #pc-constellation{ display:none !important; }
        }

        .pc-info-banner{
          background:#eef2ff;
          color:#0f172a;
          border:1px solid rgba(59,130,246,.25);
          border-radius:12px;
          padding:14px 16px;
          margin:16px 0 12px;
          line-height:1.5;
          font-size:.95rem;
        }
        @media (max-width:768px){
          .pc-info-banner{ margin:12px 0; font-size:.93rem; }
        }

       /* Styles spécifiques au chatbot Psycho'Bot */
#chat-window {
  border-radius: 32px !important;
  overflow: hidden !important;
}

#chat-input {
  border-top-left-radius: 9999px !important;
  border-bottom-left-radius: 9999px !important;
  border: none !important;
}

#chat-send {
  border-top-right-radius: 9999px !important;
  border-bottom-right-radius: 9999px !important;
  border: none !important;
}

    </style>

</head>
<body id="top" class="font-sans bg-white text-gray-900">
<!-- Navigation -->
<header id="site-header" class="sticky-header">
        <div class="flex items-center">
            <div class="flex items-center min-w-0">
                <img src="logo pc 3.png" alt="Personnalité Comparée logo" class="w-10 h-10 rounded-full object-cover"><span id="brand-home" class="ml-3 text-[1.05rem] sm:text-xl font-bold text-black truncate max-w-[65vw] sm:max-w-[60vw] md:max-w-none" data-i18n="brand.name">Personnalité Comparée</span>
            </div>
            <div class="relative ml-4 shrink-0">
                <button id="lang-toggle" class="p-2 focus:outline-none" aria-haspopup="true" aria-expanded="false">
                    <svg class="w-5 h-5 text-gray-800" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                        <circle cx="12" cy="12" r="9"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c3.5 3 3.5 15 0 18"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c-3.5 3-3.5 15 0 18"/>
                    </svg>
                </button>
                <div id="lang-menu" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg ring-1 ring-black/5 hidden z-50">
                    <button data-lang="en" class="flex items-center w-full px-4 py-2 text-sm hover:bg-gray-100"><span class="mr-2">🇬🇧</span> English</button>
                    <button data-lang="fr" class="flex items-center w-full px-4 py-2 text-sm hover:bg-gray-100"><span class="mr-2">🇫🇷</span> Français</button>
                </div>
            </div>
        </div>
        <nav class="desktop-nav hidden lg:ml-6 lg:flex lg:items-center lg:space-x-8">
            <div id="home-menu-container" class="relative group">
                <a id="home-menu-button" href="index.html" class="inline-flex items-center gap-2 text-gray-900 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.home">Accueil</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="home-menu" class="invisible opacity-0 group-hover:visible group-hover:opacity-100 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="index.html#home-how" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.how">Comment ça marche</a></li>
                        <li><a href="index.html#home-mbti" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.auto_eval">Auto-évaluation</a></li>
                        <li><a href="index.html#home-enneagramme" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.eval_friend">Évaluer un proche</a></li>
                        <li><a href="index.html#home-ia" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.chatbot">Parler avec Psycho'Bot</a></li>
                        <li><a href="index.html#retourver-profil" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.retrieve_profile">Retrouver un profil</a></li>
                        <li><a href="index.html#home-blog" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.latest_articles">Derniers articles</a></li>
                        <li><a href="index.html#home-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.faq">Questions fréquentes</a></li>
                        <li><a href="index.html#home-about" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.home.about">À propos du projet</a></li>
                    </ul>
                </div>
            </div>
            <div id="mbti-menu-container" class="relative group">
                <a id="mbti-menu-button" href="mbti.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.mbti">MBTI</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="mbti-menu" class="invisible opacity-0 group-hover:visible group-hover:opacity-100 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="mbti.html#mbti-hero" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.understand">Comprendre le MBTI</a></li>
                        <li><a href="mbti.html#mbti-history" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.history">Un peu d'histoire</a></li>
                        <li><a href="mbti.html#mbti-types" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.types">Les 16 types</a></li>
                        <li><a href="mbti.html#mbti-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.mbti.faq">FAQ MBTI</a></li>
                    </ul>
                </div>
            </div>
            <div id="ennea-menu-container" class="relative group">
                <a id="ennea-menu-button" href="enneagramme.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium" aria-haspopup="true" aria-expanded="false">
                    <span data-i18n="menu.enneagram">Ennéagramme</span>
                    <svg class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </a>
                <div id="ennea-menu" class="invisible opacity-0 group-hover:visible group-hover:opacity-100 transition absolute left-0 mt-2 w-64 rounded-xl shadow-lg bg-white ring-1 ring-black/5 z-50">
                    <ul class="py-2 text-sm">
                        <li><a href="enneagramme.html#ennea-hero" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.understand">Comprendre l’Ennéagramme</a></li>
                        <li><a href="enneagramme.html#ennea-history" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.history">Un peu d'histoire</a></li>
                        <li><a href="enneagramme.html#ennea-types" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.types">Les 9 types</a></li>
                        <li><a href="enneagramme.html#ennea-faq" class="dropdown-item block px-4 py-2 text-gray-700 hover:bg-gray-100" data-i18n="menu.enneagram.faq">FAQ Ennéagramme</a></li>
                    </ul>
                </div>
            </div>
            <a href="index.html#home-ia" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.ai">IA spécialisée</a>
            <a href="blog.html" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.blog">Blog</a>
            <a href="index.html#home-faq" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium" data-i18n="menu.faq">FAQ</a>
        </nav>
        <div class="-mr-2 flex items-center lg:hidden">
            <button type="button" id="mobile-menu-button" class="shrink-0 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none lg:hidden" aria-controls="mobile-menu" aria-expanded="false">
                <span class="sr-only" data-i18n="nav.open_main">Ouvrir le menu principal</span>
                <i class="fas fa-bars" id="menu-icon"></i>
            </button>
        </div>
        <!-- Menu mobile -->
        <div class="mobile-menu lg:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t border-gray-200">
                <div>
                    <a id="mobile-home-button" href="index.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-900" aria-expanded="false">
                        <span data-i18n="menu.home">Accueil</span>
                        <svg id="mobile-home-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-home-menu" class="hidden pl-4 space-y-1">
                        <a href="index.html#home-how" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.how">Comment ça marche</a>
                        <a href="index.html#home-podcast" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.podcast">Podcast</a>
                        <a href="index.html#home-mbti" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.auto_eval">Auto-évaluation</a>
                        <a href="index.html#home-enneagramme" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.eval_friend">Évaluer un proche</a>
                        <a href="index.html#home-ia" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.chatbot">Parler avec Psycho'Bot</a>
                        <a href="index.html#retourver-profil" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.retrieve_profile">Retrouver un profil</a>
                        <a href="index.html#home-blog" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.latest_articles">Derniers articles</a>
                        <a href="index.html#home-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.faq">Questions fréquentes</a>
                        <a href="index.html#home-about" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.home.about">À propos du projet</a>
                    </div>
                </div>
                <div>
                    <a id="mobile-mbti-button" href="mbti.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-500" aria-expanded="false">
                        <span data-i18n="menu.mbti">MBTI</span>
                        <svg id="mobile-mbti-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-mbti-menu" class="hidden pl-4 space-y-1">
                        <a href="mbti.html#mbti-hero" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.understand">Comprendre le MBTI</a>
                        <a href="mbti.html#mbti-history" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.history">Un peu d'histoire</a>
                        <a href="mbti.html#mbti-types" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.types">Les 16 types</a>
                        <a href="mbti.html#mbti-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.mbti.faq">FAQ MBTI</a>
                    </div>
                </div>
                <div>
                    <a id="mobile-ennea-button" href="enneagramme.html" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-base font-medium text-gray-500" aria-expanded="false">
                        <span data-i18n="menu.enneagram">Ennéagramme</span>
                        <svg id="mobile-ennea-caret" class="h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </a>
                    <div id="mobile-ennea-menu" class="hidden pl-4 space-y-1">
                        <a href="enneagramme.html#ennea-hero" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.understand">Comprendre l’Ennéagramme</a>
                        <a href="enneagramme.html#ennea-history" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.history">Un peu d'histoire</a>
                        <a href="enneagramme.html#ennea-types" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.types">Les 9 types</a>
                        <a href="enneagramme.html#ennea-faq" class="block px-3 py-2 rounded-md text-sm text-gray-700" data-i18n="menu.enneagram.faq">FAQ Ennéagramme</a>
                    </div>
                </div>
                <a href="index.html#home-ia" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.ai">IA spécialisée</a>
                <a href="blog.html" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.blog">Blog</a>
                <a href="index.html#home-faq" class="text-gray-500 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium" data-i18n="menu.faq">FAQ</a>
            </div>
        </div>
    </header>

    <main>
<section id="ennea-hero" data-aos="fade-up" class="px-4 sm:px-6 lg:px-8 relative overflow-hidden pc-hero mt-8 sm:mt-12" data-hero>
  <canvas id="pc-constellation" aria-hidden="true"></canvas>
  <div class="absolute inset-0 opacity-[0.02]">
    <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgb(15 23 42) 1px, transparent 0); background-size: 40px 40px;"></div>
  </div>
  <div class="absolute top-1/4 right-1/4 w-2 h-2 bg-blue-400/20 rounded-full"></div>
  <div class="absolute bottom-1/3 left-1/5 w-1 h-1 bg-slate-400/30 rounded-full"></div>
  <div class="absolute top-2/3 right-1/3 w-1.5 h-1.5 bg-blue-300/25 rounded-full"></div>
  <div class="relative max-w-3xl mx-auto px-6 pb-16 text-center">
    <img src="logobanniere.jpeg" alt="Nouveau logo" class="mx-auto mb-8 w-36 sm:w-40 h-auto">
    <h1 data-i18n="enneagramme.hero.title" class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-6">Découvrir l'ennéagramme</h1>
    <p data-i18n="enneagramme.hero.text" class="text-lg text-gray-700">L'ennéagramme est un modèle de personnalité fondé sur 9 types, centré sur nos motivations profondes et nos blessures originelles.</p>
  </div>
</section>

<section id="ennea-history" data-aos="fade-up" class="py-16 px-4 sm:px-6 lg:px-8 bg-gray-50">
  <div class="max-w-3xl mx-auto">
    <div class="text-center">
      <h2 data-i18n="enneagramme.history.title" class="text-3xl font-extrabold text-gray-900 sm:text-4xl">Un peu d'histoire</h2>
    </div>
    <div class="mt-12 text-gray-700 space-y-6 leading-relaxed">
      
      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="enneagramme.history.origins.title">1. Étymologie & origines anciennes</h3>
        <p data-i18n="enneagramme.history.origins.text">Le mot <em>Ennéagramme</em> vient des mots grecs <em>ennea</em> (« neuf ») et <em>gramma</em> (« ce qui est dessiné ou écrit »). Son symbolisme puise dans des traditions spirituelles et philosophiques anciennes, telles que la mystique chrétienne, soufie, bouddhiste, hindoue ou kabbalistique, ainsi que dans les enseignements de Pythagore.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="enneagramme.history.gurdjieff.title">2. Gurdjieff & premiers usages modernes</h3>
        <p data-i18n="enneagramme.history.gurdjieff.text">Au début du XXᵉ siècle, le philosophe mystique <strong>Georges Gurdjieff</strong> introduit en Occident la figure de l’Ennéagramme, vers 1916, comme symbole cosmique et outil pour comprendre le mouvement et les lois universelles — sans l’appliquer à la typologie de la personnalité.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="enneagramme.history.ichazo.title">3. Ichazo & Naranjo : naissance de la typologie</h3>
        <p data-i18n="enneagramme.history.ichazo.text1"><strong>Oscar Ichazo</strong> (Bolivie, années 1950) formalise les neuf fixations d’ego, passions et vertus de chaque point de l’Ennéagramme, dans un système nommé <em>Protoanalysis</em>, avec une base philosophique et psychologique.</p>
        <p data-i18n="enneagramme.history.ichazo.text2">Dans les années 1970, le psychiatre <strong>Claudio Naranjo</strong> reprend ce travail et l’adapte en une véritable typologie de personnalité. Il le diffuse aux États-Unis via l’Institut Esalen à Berkeley.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="enneagramme.history.diffusion.title">4. Diffusion académique et populaire</h3>
        <p data-i18n="enneagramme.history.diffusion.text1">Dans les années 1980–1990, des auteurs comme <strong>Don Richard Riso</strong>, <strong>Russ Hudson</strong>, <strong>Helen Palmer</strong>, <strong>Eli Jaxon-Bear</strong> ou <strong>Richard Rohr</strong> publient des ouvrages populaires rendant le système accessible au grand public.</p>
        <p data-i18n="enneagramme.history.diffusion.text2">En 1993, Riso et Hudson créent le <em>Riso–Hudson Enneagram Type Indicator (RHETI)</em> et fondent l’Enneagram Institute, qui structure la diffusion, la recherche et la formation.</p>
      </div>

      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="enneagramme.history.popularity.title">5. Popularité, usages & critiques</h3>
        <p data-i18n="enneagramme.history.popularity.text">Aujourd’hui, l’Ennéagramme est utilisé en développement personnel, spiritualité, coaching et travail en équipe. Mais il est aussi critiqué pour :</p>
        <ul class="list-disc list-inside">
          <li data-i18n="enneagramme.history.popularity.list1">Un manque de validation psychométrique solide</li>
          <li data-i18n="enneagramme.history.popularity.list2">Une base scientifique limitée</li>
          <li data-i18n="enneagramme.history.popularity.list3">Une forte influence de traditions spirituelles, ce qui le rend plus subjectif</li>
        </ul>
      </div>

    </div>
  </div>
</section>


    <div id="ennea-types" data-aos="fade-left" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="enneagramme.types.title">
                    Les 9 types de l'Ennéagramme
                </h2>
                <p class="mt-4 max-w-2xl text-xl text-gray-500 mx-auto" data-i18n="enneagramme.types.subtitle">
                    Découvrez les motivations profondes qui influencent votre personnalité
                </p>
            </div>
            
            <div class="mt-12 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Type 1 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-red-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">1</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.1.name">Le Perfectionniste</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.1.nickname">Le Réformateur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.1.desc">
                                Motivés par le besoin de vivre correctement, d'améliorer le monde et d'éviter la colère. Ils sont idéalistes, responsables et ont un fort sens moral.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.1.detail">
                                <strong>Peur fondamentale :</strong> Être corrompu, défectueux ou mauvais<br>
                                <strong>Désir fondamental :</strong> Être bon, vertueux et parfait
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('1')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 2 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">2</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.2.name">L'Altruiste</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.2.nickname">L'Aidant</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.2.desc">
                                Motivés par le besoin d'être aimés et appréciés, et d'exprimer leurs sentiments positifs envers les autres. Ils sont empathiques, sincères et chaleureux.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.2.detail">
                                <strong>Peur fondamentale :</strong> Être indigne d'amour<br>
                                <strong>Désir fondamental :</strong> Se sentir aimé et apprécié
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('2')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 3 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-yellow-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">3</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.3.name">Le Bâtisseur</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.3.nickname">Le Performeur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.3.desc">
                                Motivés par le besoin d'être productifs, d'atteindre le succès et d'éviter l'échec. Ils sont adaptables, ambitieux et orientés vers les objectifs.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.3.detail">
                                <strong>Peur fondamentale :</strong> Être sans valeur en dehors de leurs réalisations<br>
                                <strong>Désir fondamental :</strong> Se sentir valorisé et digne d'amour
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('3')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 4 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">4</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.4.name">L'Artiste</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.4.nickname">L'Individualiste</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.4.desc">
                                Motivés par le besoin de s'exprimer et d'être compris pour qui ils sont vraiment. Ils sont créatifs, émotionnellement honnêtes et personnels.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.4.detail">
                                <strong>Peur fondamentale :</strong> N'avoir ni identité ni importance personnelle<br>
                                <strong>Désir fondamental :</strong> Trouver leur vrai moi et leur importance
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('4')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 5 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">5</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.5.name">L'Investigateur</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.5.nickname">Le Penseur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.5.desc">
                                Motivés par le besoin de comprendre le monde qui les entoure. Ils sont intenses, cérébraux, perceptifs et indépendants.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.5.detail">
                                <strong>Peur fondamentale :</strong> Être inutile, incapable ou envahi<br>
                                <strong>Désir fondamental :</strong> Être compétent et comprendre l'environnement
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('5')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 6 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">6</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.6.name">Le Loyaliste</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.6.nickname">Le Sceptique</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.6.desc">
                                Motivés par le besoin de sécurité et de soutien. Ils sont engagés, responsables, anxieux et soupçonneux.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.6.detail">
                                <strong>Peur fondamentale :</strong> Être sans soutien ou sans guidance<br>
                                <strong>Désir fondamental :</strong> Avoir sécurité et soutien
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('6')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 7 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-orange-500 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">7</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.7.name">L'Enthousiaste</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.7.nickname">L'Épicurien</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.7.desc">
                                Motivés par le besoin de maintenir leur bonheur et leur enthousiasme. Ils sont spontanés, polyvalents, distractibles et dispersés.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.7.detail">
                                <strong>Peur fondamentale :</strong> Être piégé dans la douleur ou la privation<br>
                                <strong>Désir fondamental :</strong> Maintenir leur bonheur et leur satisfaction
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('7')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 8 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-red-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">8</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.8.name">Le Challenger</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.8.nickname">Le Protecteur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.8.desc">
                                Motivés par le besoin d'être autonomes et de contrôler leur propre vie. Ils sont puissants, dominants, confiants et confrontants.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.8.detail">
                                <strong>Peur fondamentale :</strong> Être contrôlé ou vulnérable aux autres<br>
                                <strong>Désir fondamental :</strong> Être autonome et contrôler leur propre vie
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('8')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Type 9 -->
                <div class="type-card bg-white overflow-hidden shadow rounded-[32px] transform transition duration-300 ease-in-out hover:-translate-y-1 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-teal-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <span class="text-white font-bold text-lg">9</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.types.9.name">Le Médiateur</h3>
                                <p class="text-sm text-gray-500" data-i18n="enneagramme.types.9.nickname">Le Pacificateur</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600" data-i18n="enneagramme.types.9.desc">
                                Motivés par le besoin de maintenir leur paix intérieure et extérieure. Ils sont réceptifs, rassurants, agréables et complaisants.
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="text-xs text-gray-500" data-i18n="enneagramme.types.9.detail">
                                <strong>Peur fondamentale :</strong> Perte de connexion et fragmentation<br>
                                <strong>Désir fondamental :</strong> Maintenir leur paix intérieure et extérieure
                            </div>
                        </div>
                        <div class="mt-5">
                            <button onclick="showEnneagramDetails('9')" class="text-sm font-medium text-black hover:text-gray-800">
                                <span data-i18n='learnMore'>En savoir plus</span> <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="max-w-xl mx-auto px-6" data-aos="fade-up">
  <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl text-center mb-8" data-i18n="moreArticlesTitle">En savoir plus</h2>
  <a href="blog-enneagramme-instincts.html" class="block p-6 rounded-[32px] overflow-hidden bg-white border border-gray-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition text-center" data-aos="fade-up" data-aos-delay="100">
    <img src="enneagramme.png" alt="Symbole de l'Ennéagramme" class="mx-auto h-32 w-auto object-contain mb-4 rounded-[32px]">
    <h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="blogPreview.enneaInstincts.title">Comprendre les peurs profondes de l'Ennéagramme</h3>
    <p class="text-gray-600 text-sm" data-i18n="blogPreview.enneaInstincts.excerpt">Explore les peurs fondamentales des neuf types et la manière dont elles guident nos actions.</p>
  </a>
</div>




    </main>
        <div id="ennea-faq" data-aos="fade-up" class="section section-clair py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto">
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl" data-i18n="enneagramme.faq.title">
                    Questions fréquentes
                </h2>
                <p class="mt-4 text-xl text-gray-500" data-i18n="enneagramme.faq.subtitle">
                    Trouvez des réponses aux questions les plus courantes
                </p>
            </div>

            <div class="mt-12 space-y-6">
                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-1" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-1-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q1.question">En quoi l’Ennéagramme diffère-t-il du MBTI ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-1-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-1" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q1.answer">
                                Le MBTI décrit des préférences cognitives ; l’Ennéagramme décrit surtout des motivations profondes, peurs de base et mécanismes de défense. Ils sont complémentaires : l’un parle de “comment tu fonctionnes”, l’autre de “pourquoi tu fonctionnes comme ça”.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-2" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-2-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q2.question">C’est spirituel ou psychologique ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-2-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-2" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q2.answer">
                                Historiquement, l’Ennéagramme a des racines spirituelles ; aujourd’hui il est utilisé dans un cadre de développement personnel et de coaching. Ce n’est pas un outil clinique, son socle scientifique est limité.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-3" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-3-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q3.question">Que sont les “ailes” et les “sous-types” ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-3-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-3" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q3.answer">
                                Les ailes sont les types adjacents qui colorent ton type principal (ex. 4w3, 4w5). Les sous-types (instincts : conservation, social, sexuel) modulent l’expression du type et expliquent des variations fortes au sein d’un même type.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-4" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-4-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q4.question">Peut-on “changer” de type ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-4-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-4" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q4.answer">
                                Le type de base reste généralement stable ; ce qui change, c’est ton niveau de santé/ressources et la manière dont tu gères ta peur centrale. On parle d’intégration/désintégration plutôt que de changement de type.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-5" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-5-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q5.question">Pourquoi je me reconnais dans plusieurs types ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-5-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-5" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q5.answer">
                                Les comportements se recoupent. La clé, c’est la motivation profonde et la peur de base. Les tests peuvent aider, mais l’auto-enquête (exemples concrets, réactions sous stress, désirs non négociables) est déterminante.
                            </p>
                        </div>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-[2rem] overflow-hidden">
                    <button id="faq-ennea-6" class="faq-button w-full px-6 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500" aria-expanded="false" aria-controls="faq-ennea-6-content">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900" data-i18n="enneagramme.faq.q6.question">Comment utiliser l’Ennéagramme sans tomber dans les étiquettes ?</h3>
                            <i class="fas fa-chevron-down text-blue-500 transform transition-transform duration-300"></i>
                        </div>
                        <div id="faq-ennea-6-content" class="faq-content mt-2 hidden" aria-labelledby="faq-ennea-6" aria-hidden="true">
                            <p class="text-gray-600" data-i18n="enneagramme.faq.q6.answer">
                                Comme une carte : un repère pour le langage et la compréhension de soi/autrui, pas une prison. Évite les jugements rapides, privilégie la curiosité, l’empathie et le travail sur les schémas récurrents.
                            </p>
                        </div>
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <p class="text-gray-600" data-i18n="enneagramme.faq.outro">
                    Vous avez d'autres questions ? <a href="mailto:contact@personnalitecomparee.com" class="text-blue-600 hover:text-blue-500 font-medium">Contactez-nous</a>
                </p>
            </div>
        </div>
    </div>
<div id="results-section"></div>

   <!-- Footer -->
    <p class="text-xs text-gray-500 text-center mb-4">MBTI® est une marque déposée de The Myers-Briggs Company. Ce site propose une approche inspirée et n’est ni affilié, ni agréé, ni soutenu par cette société.</p>
    <footer class="bg-gray-800">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.brand_title">Personnalité Comparée</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="index.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.home">Accueil</a></li>
        <li><a href="mbti.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.mbti">MBTI</a></li>
        <li><a href="enneagramme.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.enneagram">Ennéagramme</a></li>
        <li><a href="blog.html" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.blog">Blog</a></li>
        <li><a href="#home-ia" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.ai">IA spécialisée</a></li>
        <li><a href="#home-faq" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.faq">FAQ</a></li>

                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.tests_title">Tests</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#home-mbti" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.auto_eval">Auto-évaluation</a></li>
                        <li><a href="#home-enneagramme" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.evaluate_friend">Évaluer un proche</a></li>
                        <li><a href="#retourver-profil" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.my_profile">Mon profil</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.legal_title">Légal</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" id="privacy-link" onclick="event.preventDefault(); showPrivacyPolicy();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.privacy">Confidentialité</a></li>
                        <li><a href="#" id="terms-link" onclick="event.preventDefault(); showTermsOfService();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.terms">Conditions d'utilisation</a></li>
                        <li><a href="#" id="legal-link" onclick="event.preventDefault(); showLegalNotices();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.legal">Mentions légales</a></li>
                        <li><a href="#" id="cookies-link" onclick="event.preventDefault(); showCookies();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.cookies">Cookies</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 tracking-wider uppercase" data-i18n="footer.contact_title">Contact</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="#" id="support-link" onclick="event.preventDefault(); showSupport();" class="text-base text-gray-300 hover:text-white transition-colors" data-i18n="footer.support">Support</a></li>
                        <li class="flex space-x-6 pt-2">
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.facebook">Facebook</span>
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.instagram">Instagram</span>
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors">
                                <span class="sr-only" data-i18n="social.tiktok">TikTok</span>
                                <i class="fab fa-tiktok"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-8">
                <p class="text-base text-gray-400 text-center" data-i18n="footer.copyright">
                    &copy; 2025 Personnalité Comparée. Tous droits réservés.
                </p>
            </div>
        </div>
    </footer>
    <script src="questions-v2.js"></script>

   
      
    <script>
        // Configuration et données
                // Récupère les questions externes depuis Supabase si l'utilisateur est un proche
let questions = AUTO_QUESTIONS;
// 🔐 Génére un code aléatoire
function genererUniqueCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// 🔄 Envoie vers Supabase
async function enregistrerQuestionsPourProches(questionsAutoEvaluation, userCode) {
  // Mettre à jour l'enregistrement existant avec les questions pour les proches
  const { data, error } = await supabase
    .from("users")
    .update({
      external_questions: questionsAutoEvaluation
    })
    .eq('code', userCode);

  if (error) {
    console.error("❌ Erreur lors de l'enregistrement Supabase :", error);
  } else {
    console.log("✅ Questions pour proches enregistrées avec succès :", data);
    alert("Voici ton code à donner à 3 proches : " + userCode);
  }
}


if (window.location.href.includes("external")) {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");
  console.log("Code reçu dans l'URL :", code);

  if (code) {
    // Appelle Supabase pour récupérer les questions liées à ce code
    supabase
      .from("users")
      .select("external_questions")
      .eq("code", code)
      .then(({ data, error }) => {
        if (!error && data && data.length > 0 && data[0].external_questions) {
          questions = data[0].external_questions;
          console.log("Questions externes chargées :", questions);
          afficherQuestions(); // appel explicite
        } else {
          console.error("Aucune question externe trouvée ou erreur :", error);
        }
      });
  }
}


        // État de l'application
        let currentQuestionIndex = 0;
        let answers = {};
        let testType = 'auto'; // 'auto' ou 'proche'
        let userCode = genererUniqueCode();



        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupMobileMenu();
            setupFAQ();
            setupSmoothScrolling();
            setupProgressBars();
            setupEvaluationForm();
            loadFirstQuestion();
            initCountUp();
        }

        // Menu mobile
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.classList.contains('active');
                    
                    if (isOpen) {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.classList.add('active');
                        menuIcon.classList.remove('fa-bars');
                        menuIcon.classList.add('fa-times');
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                });

                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
            }
        }

        // FAQ Accordion
        function setupFAQ() {
            const faqButtons = document.querySelectorAll('.faq-button');
            faqButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.querySelector('.faq-content');
                    const icon = this.querySelector('i');
                    const isOpen = this.getAttribute('aria-expanded') === 'true';

                    // Fermer toutes les autres FAQ
                    faqButtons.forEach(otherButton => {
                        if (otherButton !== this) {
                            const otherContent = otherButton.querySelector('.faq-content');
                            const otherIcon = otherButton.querySelector('i');
                            otherContent.classList.add('hidden');
                            otherIcon.classList.remove('rotate-180');
                            otherButton.setAttribute('aria-expanded', 'false');
                            otherContent.setAttribute('aria-hidden', 'true');
                        }
                    });

                    // Toggle la FAQ actuelle
                    if (isOpen) {
                        content.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                        this.setAttribute('aria-expanded', 'false');
                        content.setAttribute('aria-hidden', 'true');
                    } else {
                        content.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                        this.setAttribute('aria-expanded', 'true');
                        content.setAttribute('aria-hidden', 'false');
                    }
                });
            });
        }

        // Smooth scrolling
        function setupSmoothScrolling() {
            const links = document.querySelectorAll('a[href^="#"]');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        const offsetTop = targetElement.offsetTop - 80; // Account for fixed nav
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        }

        // Animation des barres de progression
        function setupProgressBars() {
            const progressBars = document.querySelectorAll('.progress-bar');
            
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -100px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const targetWidth = bar.style.width;
                        bar.style.width = '0';
                        setTimeout(() => {
                            bar.style.width = targetWidth;
                        }, 100);
                    }
                });
            }, observerOptions);
            
            progressBars.forEach(bar => {
                observer.observe(bar);
            });
        }

        // Configuration du formulaire d'évaluation
        function setupEvaluationForm() {
            const evaluationForm = document.getElementById('evaluation-form');
            if (evaluationForm) {
                evaluationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const code = formData.get('code');
                    const relation = formData.get('relation');
                    
                    if (code && relation) {
                        userCode = code;
                        testType = 'proche';
                        startEvaluationTest(relation);
                    } else {
                        alert('Veuillez remplir tous les champs requis.');
                    }
                });
            }
        }

        // Chargement de la première question
        function loadFirstQuestion() {
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                displayQuestion(0);
                setupQuestionNavigation();
            }
        }

       // Affichage d'une question
function displayQuestion(index) {
  const questionsContainer = document.getElementById('questions-container');
  const question = AUTO_QUESTIONS[index];

  if (!question || !questionsContainer) return;

  const progress = ((index + 1) / AUTO_QUESTIONS.length) * 100;

  const questionHTML = `
    <div class="question-container fade active bg-transparent overflow-hidden">
      <div class="px-6 py-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm font-medium text-blue-600">
            Question ${index + 1}/${AUTO_QUESTIONS.length}
          </span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
            <div class="progress-bar bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                 style="width: ${progress}%"></div>
          </div>
        </div>

<h3 class="text-xl font-medium text-gray-900 mb-6" data-i18n="questionnaire.ext.q${question.id}.title">${question.question}</h3>

        <div class="space-y-4">
          ${question.options.map((option, optionIndex) => {
            const dataI18n = option.text === "Je ne sais pas" ? 'question.option.dontknow' : `questionnaire.auto.q${question.id}.option${optionIndex + 1}`;
            return `
            <div class="flex items-start">
              <input id="q${question.id}-${optionIndex}"
                     name="question${question.id}"
                     type="radio"
                     value="${optionIndex}"
                     class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 mt-1"
                     ${answers[question.id] === optionIndex ? 'checked' : ''}>
              <label for="q${question.id}-${optionIndex}"
                     class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors"
                     data-i18n="${dataI18n}">
                ${option.text}
              </label>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
  `;

            questionsContainer.innerHTML = questionHTML;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // Écouter les changements de réponse
            const radioButtons = questionsContainer.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    answers[question.id] = parseInt(this.value);
                    saveProgress();
                    updateNavigationButtons();
                });
            });
            
            updateNavigationButtons();
        }

        // Configuration de la navigation entre questions
        function setupQuestionNavigation() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        displayQuestion(currentQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined) {
                        if (currentQuestionIndex < AUTO_QUESTIONS.length - 1) {
                            currentQuestionIndex++;
                            displayQuestion(currentQuestionIndex);
                        }
                    } else {
                        alert('Veuillez sélectionner une réponse avant de continuer.');
                    }
                });
            }
            
            if (finishButton) {
                finishButton.addEventListener('click', async function() {
                    if (Object.keys(answers).length === AUTO_QUESTIONS.length) {
                        await calculateResults();
                        const span = finishButton.querySelector('span[data-i18n]');
                        if (span) span.setAttribute('data-i18n', 'button.finishTest.saved');
                        const icon = finishButton.querySelector('i');
                        if (icon) icon.remove();
                        if (typeof applyTranslations === 'function') { applyTranslations(); }
                    } else {
                        const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                        const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.completeAll) || 'Veuillez répondre à toutes les questions avant de terminer.';
                        alert(msg);
                    }
                });
            }
        }

        function getScrollableAncestor(el) {
            let p = el.parentElement;
            while (p) {
                const style = getComputedStyle(p);
                const canScroll = /(auto|scroll)/.test(style.overflowY) || p.scrollHeight > p.clientHeight;
                if (canScroll) return p;
                p = p.parentElement;
            }
            return document.scrollingElement || document.documentElement; // fallback window
        }

        function waitForVisible(selector, timeout = 2000) {
            return new Promise((resolve, reject) => {
                const start = performance.now();
                const tick = () => {
                    const el = document.querySelector(selector);
                    if (el && el.offsetHeight > 0) return resolve(el);
                    if (performance.now() - start > timeout) return reject(new Error('timeout'));
                    requestAnimationFrame(tick);
                };
                tick();
            });
        }

        async function scrollToResults() {
            try {
                const el = await waitForVisible('#results-section', 2500);
                const header = document.querySelector('#site-header, header.sticky, .header.sticky');
                const headerH = header ? header.offsetHeight : 0;
                const scroller = getScrollableAncestor(el);
                const rect = el.getBoundingClientRect();
                const baseY = (scroller === document.scrollingElement || scroller === document.documentElement)
                    ? window.pageYOffset
                    : scroller.scrollTop;
                const targetY = baseY + rect.top - headerH - 8;
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        if (scroller === document.scrollingElement || scroller === document.documentElement) {
                            window.scrollTo({ top: Math.max(0, targetY), behavior: 'smooth' });
                        } else {
                            try { scroller.scrollTo({ top: Math.max(0, targetY), behavior: 'smooth' }); }
                            catch { scroller.scrollTop = Math.max(0, targetY); }
                        }
                        try { history.replaceState(null, '', '#results-section'); } catch {}
                    });
                });
            } catch (e) {
                const el = document.getElementById('results-section');
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Mise à jour des boutons de navigation
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            const finishButton = document.getElementById('finish-test');
            
            if (prevButton) {
                prevButton.style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
            }
            
            const isLastQuestion = currentQuestionIndex === AUTO_QUESTIONS.length - 1;
            const hasAnswer = answers[AUTO_QUESTIONS[currentQuestionIndex].id] !== undefined;
            
            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        // Sauvegarde de la progression
        function saveProgress() {
            const progressData = {
                currentQuestionIndex,
                answers,
                testType,
                userCode,
                timestamp: Date.now()
            };
            localStorage.setItem('personalityTestProgress', JSON.stringify(progressData));

        }

        // Chargement de la progression sauvegardée
        function loadProgress() {
            const saved = localStorage.getItem('personalityTestProgress');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Vérifier si la sauvegarde n'est pas trop ancienne (24h)
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        currentQuestionIndex = data.currentQuestionIndex || 0;
                        answers = data.answers || {};
                        testType = data.testType || 'auto';
                        userCode = data.userCode || '';
                        return true;
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement de la progression:', e);
                }
            }
            return false;
        }


        /**
         * Enregistre le profil utilisateur (auto‑évaluation) dans Supabase.
         * Cette fonction insère un enregistrement dans la table "users".
         * @param {Object} userProfile Contient le code unique, les types MBTI/Ennéagramme,
         * les scores détaillés et le niveau de certitude.
         */
         async function saveUserProfileToSupabase(userProfile) {
  try {
    const { data, error } = await supabase
      .from('users')
      .insert({
        code: userProfile.code,
        mbti_scores: userProfile.mbtiScores,
        enneagram_scores: userProfile.enneagramScores,
        auto_mbti_type: userProfile.mbtiType,
        auto_enneagram_type: userProfile.enneagramType,
        mbti_type: userProfile.mbtiType,
        enneagram_type: userProfile.enneagramType,
        certainty_score: 0
      })
      .select()
      .single();

    if (error) {
      console.error('Erreur lors de l\'enregistrement du profil utilisateur :', error);
    } else {
      console.log('Profil enregistré dans Supabase', data);

      if (testType === "auto") {
        enregistrerQuestionsPourProches(answers, userProfile.code);
      }
    }
  } catch (err) {
    console.error('Exception lors de l\'enregistrement du profil utilisateur :', err);
  }
}



        /**
         * Enregistre une évaluation externe dans Supabase.
         * Cette fonction récupère l'utilisateur par son code unique, puis insère une évaluation liée.
         * @param {String} code Code unique de l'utilisateur évalué.
         * @param {String} relation Relation entre l'évaluateur et l'utilisateur ("family", "partner", "friend", "colleague").
         * @param {Object} mbtiScores Scores MBTI calculés à partir des réponses de l'évaluation externe.
         * @param {Object} enneagramScores Scores Ennéagramme calculés à partir des réponses.
         */
        async function saveExternalEvaluationToSupabase(code, relation, mbtiScores, enneagramScores) {
            try {
                // Récupérer l'utilisateur par code
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('code', code)
                    .single();
                if (userError || !user) {
                    console.error('Utilisateur introuvable pour ce code :', code, userError);
                    return;
                }
                const userId = user.id;
                // Insérer l'évaluation
                const { error: insertError } = await supabase
                    .from('external_evaluations')
                    .insert({
                        user_id: userId,
                        relation: relation,
                        mbti_scores: mbtiScores,
                        enneagram_scores: enneagramScores
                    });
                if (insertError) {
                    console.error('Erreur lors de l’enregistrement de l’évaluation externe :', insertError);
                } else {
                    console.log('Évaluation externe enregistrée dans Supabase');
                    await calculateFinalProfile(code);
                }
            } catch (err) {
                console.error('Exception lors de l’enregistrement de l’évaluation externe :', err);
            }
        }

        /**
         * Calcule et enregistre le résultat final si au moins trois évaluations externes sont disponibles.
         * @param {String} userId Identifiant de l'utilisateur.
         */
        function getProfileFromScores(mbtiScores, enneagramScores) {
            const mbtiType =
                (mbtiScores.E > mbtiScores.I ? 'E' : 'I') +
                (mbtiScores.S > mbtiScores.N ? 'S' : 'N') +
                (mbtiScores.T > mbtiScores.F ? 'T' : 'F') +
                (mbtiScores.J > mbtiScores.P ? 'J' : 'P');
            let topEnnea = '1';
            Object.keys(enneagramScores).forEach(type => {
                if (enneagramScores[type] > enneagramScores[topEnnea]) {
                    topEnnea = type;
                }
            });
            return { mbtiType, enneagramType: topEnnea };
        }

        function getCohérenceMBTI(scores) {
            if (!scores) return "Inconnue";

            const pairs = [
                ["I", "E"],
                ["S", "N"],
                ["T", "F"],
                ["J", "P"]
            ];

            const écarts = pairs.map(([a, b]) => {
                if (scores[a] == null || scores[b] == null) return 0;
                return Math.abs(scores[a] - scores[b]);
            });

            const moyenne = écarts.reduce((sum, val) => sum + val, 0) / écarts.length;

            if (moyenne >= 30) return "Forte";
            if (moyenne >= 15) return "Moyenne";
            return "Faible";
        }

        function getCohérenceEnnéagramme(scores) {
            if (!scores) return "Inconnue";

            const types = Object.keys(scores);
            if (types.length === 0) return "Inconnue";

            let dominantType = types[0];
            types.forEach(type => {
                if ((scores[type] || 0) > (scores[dominantType] || 0)) {
                    dominantType = type;
                }
            });

            const dominantScore = scores[dominantType] || 0;
            const autres = types.filter(t => t !== dominantType).map(t => scores[t] || 0);
            const moyenneAutres = autres.reduce((sum, v) => sum + v, 0) / (autres.length || 1);

            const écart = dominantScore - moyenneAutres;

            if (écart > 20) return "Forte";
            if (écart >= 10) return "Moyenne";
            return "Faible";
        }

        function computeEnneagramWing(scores, coreType) {
            if (!scores || !coreType) return null;
            const left = coreType === '1' ? '9' : String(Number(coreType) - 1);
            const right = coreType === '9' ? '1' : String(Number(coreType) + 1);
            return (scores[left] || 0) >= (scores[right] || 0) ? left : right;
        }

       function computeWeightedResults(evaluations) {
    const baseWeights = {
        family: 30,
        partner: 25,
        friend: 25,
        colleague: 15
    };

    const combinedMbti = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
    const combinedEnneagram = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

    const availableRelations = {};
    let totalBaseWeight = 0;

    evaluations.forEach(ev => {
        if (baseWeights[ev.relation]) {
            if (!availableRelations[ev.relation]) {
                availableRelations[ev.relation] = [];
                totalBaseWeight += baseWeights[ev.relation];
            }
            availableRelations[ev.relation].push(ev);
        }
    });

    if (totalBaseWeight === 0) {
        return {
            mbtiType: null,
            enneagramType: null,
            mbtiCertainty: 0,
            enneagramCertainty: 0,
            overallCertainty: 0,
            combinedMbti,
            combinedEnneagram
        };
    }

    const normalizedWeights = {};
    Object.keys(availableRelations).forEach(relation => {
        normalizedWeights[relation] = (baseWeights[relation] / totalBaseWeight) * 100;
    });

    Object.keys(availableRelations).forEach(relation => {
        const weight = normalizedWeights[relation];
        const relEvaluations = availableRelations[relation];
        const avgMbti = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        const avgEnneagram = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

        relEvaluations.forEach(ev => {
            Object.keys(ev.mbti_scores).forEach(trait => {
                avgMbti[trait] += ev.mbti_scores[trait];
            });
            Object.keys(ev.enneagram_scores).forEach(type => {
                avgEnneagram[type] += ev.enneagram_scores[type];
            });
        });

        Object.keys(avgMbti).forEach(trait => {
            avgMbti[trait] = avgMbti[trait] / relEvaluations.length;
            combinedMbti[trait] += avgMbti[trait] * (weight / 100);
        });
        Object.keys(avgEnneagram).forEach(type => {
            avgEnneagram[type] = avgEnneagram[type] / relEvaluations.length;
            combinedEnneagram[type] += avgEnneagram[type] * (weight / 100);
        });
    });

    const mbtiType =
        (combinedMbti.E > combinedMbti.I ? 'E' : 'I') +
        (combinedMbti.S > combinedMbti.N ? 'S' : 'N') +
        (combinedMbti.T > combinedMbti.F ? 'T' : 'F') +
        (combinedMbti.J > combinedMbti.P ? 'J' : 'P');

    let topEnnea = '1';
    Object.keys(combinedEnneagram).forEach(type => {
        if (combinedEnneagram[type] > combinedEnneagram[topEnnea]) {
            topEnnea = type;
        }
    });

    const COHERENCE_WEIGHTS = { Forte:1.0, Moyenne:0.7, Faible:0.4 };
    const mbtiWeights = {};
    const enneagramWeights = {};
    evaluations.forEach(ev => {
        const { mbtiType: evMbti, enneagramType: evEnnea } = getProfileFromScores(ev.mbti_scores, ev.enneagram_scores);
        const cohMbti = getCohérenceMBTI(ev.mbti_scores);
        const cohEnnea = getCohérenceEnnéagramme(ev.enneagram_scores);
        const wMbti = COHERENCE_WEIGHTS[cohMbti] || 0;
        const wEnnea = COHERENCE_WEIGHTS[cohEnnea] || 0;
        mbtiWeights[evMbti] = (mbtiWeights[evMbti] || 0) + wMbti;
        enneagramWeights[evEnnea] = (enneagramWeights[evEnnea] || 0) + wEnnea;
    });
    const totalEvals = evaluations.length;
    const mbtiTop = Math.max(...Object.values(mbtiWeights), 0);
    const enneaTop = Math.max(...Object.values(enneagramWeights), 0);
    const mbtiCertainty = Math.round((mbtiTop / totalEvals) * 100);
    const enneagramCertainty = Math.round((enneaTop / totalEvals) * 100);
    const overallCertainty = Math.round((mbtiCertainty + enneagramCertainty) / 2);

    return {
        mbtiType,
        enneagramType: topEnnea,
        mbtiCertainty,
        enneagramCertainty,
        overallCertainty,
        combinedMbti,
        combinedEnneagram
    };
}

async function calculateFinalProfile(code) {
    try {
        const { data: user, error: userError } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score, auto_mbti_type, auto_enneagram_type')
            .eq('code', code)
            .single();
        if (userError || !user) {
            console.error('Utilisateur introuvable pour ce code :', code, userError);
            return null;
        }
        const autoMbti = user.auto_mbti_type || user.mbti_type || null;
        const autoEnneagram = user.auto_enneagram_type || user.enneagram_type || null;
        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);
        if (evalError) {
            console.error('Erreur lors de la récupération des évaluations externes :', evalError);
            return null;
        }
        if (!evaluations || evaluations.length === 0) {
            return { user, evaluations: [] };
        }

        const weighted = computeWeightedResults(evaluations);
        const overallCertainty = weighted.overallCertainty;

        await supabase
            .from('users')
            .update({
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                certainty_score: overallCertainty,
                mbti_scores: weighted.combinedMbti,
                enneagram_scores: weighted.combinedEnneagram
            })
            .eq('code', code);

        return {
            user: {
                id: user.id,
                code,
                mbti_type: weighted.mbtiType,
                enneagram_type: weighted.enneagramType,
                mbti_scores: weighted.combinedMbti,
                enneagram_scores: weighted.combinedEnneagram,
                certainty_score: overallCertainty
            },
            evaluations,
            mbtiCertainty: weighted.mbtiCertainty,
            enneagramCertainty: weighted.enneagramCertainty,
            overallCertainty,
            autoMbti,
            autoEnneagram
        };
    } catch (err) {
        console.error('Erreur lors du calcul du profil final :', err);
        return null;
    }
}

async function fetchUserProfileFromSupabase(code) {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('id, code, mbti_scores, enneagram_scores, mbti_type, enneagram_type, certainty_score, auto_mbti_type, auto_enneagram_type')
            .eq('code', code);

        if (error) {
            console.error('Erreur lors de la récupération de l\'utilisateur :', error);
            return null;
        }

        if (!data || data.length === 0) {
            return null;
        }

        const user = data[0];

        const { data: evaluations, error: evalError } = await supabase
            .from('external_evaluations')
            .select('relation, mbti_scores, enneagram_scores, created_at')
            .eq('user_id', user.id);

        if (evalError) {
            console.error('Erreur lors de la récupération des évaluations externes :', evalError);
        }

        return { user, evaluations: evaluations || [] };
    } catch (err) {
        console.error('Exception lors de la récupération du profil :', err);
        return null;
    }
}

async function calculateResults() {
    console.log("Bouton Terminer cliqué");
    const mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
    const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
    
    Object.keys(answers).forEach(questionId => {
        const questionIndex = parseInt(questionId) - 1;
        const answerIndex = answers[questionId];
        const question = AUTO_QUESTIONS[questionIndex];
        const selectedOption = question.options[answerIndex];
        
        Object.keys(selectedOption.mbti).forEach(trait => {
            mbtiScores[trait] += selectedOption.mbti[trait];
        });
        
        Object.keys(selectedOption.enneagram).forEach(type => {
            enneagramScores[type] += selectedOption.enneagram[type];
        });
    });
    
    const mbtiType = 
        (mbtiScores.E > mbtiScores.I ? 'E' : 'I') +
        (mbtiScores.S > mbtiScores.N ? 'S' : 'N') +
        (mbtiScores.T > mbtiScores.F ? 'T' : 'F') +
        (mbtiScores.J > mbtiScores.P ? 'J' : 'P');
    
    const enneagramType = Object.keys(enneagramScores).reduce((a, b) => 
        enneagramScores[a] > enneagramScores[b] ? a : b
    );
    
    const mbtiPairs = [
        ['E', 'I'],
        ['S', 'N'],
        ['T', 'F'],
        ['J', 'P']
    ];
    let mbtiCertaintySum = 0;
    mbtiPairs.forEach(([a, b]) => {
        const pairTotal = mbtiScores[a] + mbtiScores[b];
        if (pairTotal > 0) {
            mbtiCertaintySum += Math.abs(mbtiScores[a] - mbtiScores[b]) / pairTotal;
        }
    });
    const mbtiCertainty = Math.min(95, Math.round((mbtiCertaintySum / mbtiPairs.length) * 100));

    const totalEnneagramScore = Object.values(enneagramScores).reduce((a, b) => a + b, 0);
    const enneagramCertainty = totalEnneagramScore
        ? Math.min(95, Math.round((enneagramScores[enneagramType] / totalEnneagramScore) * 100))
        : 0;

    const certaintyScore = Math.round((mbtiCertainty + enneagramCertainty) / 2);
    
    const uniqueCode = genererUniqueCode();
    
    const userProfile = {
        code: uniqueCode,
        mbtiType,
        enneagramType,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores,
        enneagramScores,
        timestamp: Date.now()
    };

    await saveUserProfileToSupabase(userProfile);
    localStorage.setItem('userProfile_' + uniqueCode, JSON.stringify(userProfile));
    
    displayResults({
        code: uniqueCode,
        mbtiType,
        enneagramType,
        mbtiCertainty,
        enneagramCertainty,
        certaintyScore,
        mbtiScores,
        enneagramScores
    });
}

function displayResults(results) {
    const resultsHTML = generateResultsHTML(results);

    const existing = document.getElementById('results-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'results-modal';
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Vos résultats</h2>
                <span class="close" onclick="closeResultsModal()">&times;</span>
            </div>
            <div class="modal-body">${resultsHTML}</div>
        </div>`;
    document.body.appendChild(modal);
    initCountUp(modal);

    localStorage.setItem('personalityTestResults', JSON.stringify(results));
    localStorage.removeItem('personalityTestProgress');
}

        // Génération du HTML des résultats
        function generateResultsHTML(results) {
            const mbtiDescriptions = {
                'INTJ': 'L\'Architecte - Visionnaires stratégiques avec un plan pour tout.',
                'INTP': 'Le Penseur - Penseurs logiques et créatifs, toujours à la recherche de nouvelles idées.',
                'ENTJ': 'Le Commandant - Leaders naturels, charismatiques et déterminés.',
                'ENTP': 'L\'Innovateur - Inventifs et curieux, excellents pour trouver des solutions originales.',
                'INFJ': 'L\'Avocat - Idéalistes créatifs et perspicaces, motivés par leurs valeurs profondes.',
                'INFP': 'Le Médiateur - Poétiques, gentils et altruistes, toujours désireux d\'aider.',
                'ENFJ': 'Le Donateur - Charismatiques et empathiques, motivés par le désir d\'aider les autres.',
                'ENFP': 'L\'Inspirateur - Enthousiastes, créatifs et sociables, toujours à la recherche de nouvelles expériences.',
                'ISTJ': 'Le Logisticien - Pratiques et factuels, fiables et responsables.',
                'ISFJ': 'Le Protecteur - Chaleureux et consciencieux, toujours prêts à protéger leurs proches.',
                'ESTJ': 'L\'Exécutif - Excellents administrateurs, incomparables pour gérer avec efficacité.',
                'ESFJ': 'Le Consul - Extraordinairement attentionnés, sociables et populaires.',
                'ISTP': 'Le Virtuose - Mécaniciens audacieux et pratiques, maîtres de tous les types d\'outils.',
                'ISFP': 'L\'Aventurier - Artistes flexibles et charmants, toujours prêts à explorer.',
                'ESTP': 'L\'Entrepreneur - Intelligents, énergiques et très perceptifs.',
                'ESFP': 'L\'Amuseur - Spontanés, énergiques et enthousiastes.'
            };
            
            const enneagramDescriptions = {
                '1': 'Le Perfectionniste - Motivé par le besoin de vivre correctement et d\'améliorer le monde.',
                '2': 'L\'Altruiste - Motivé par le besoin d\'être aimé et d\'aider les autres.',
                '3': 'Le Bâtisseur - Motivé par le besoin de réussir et d\'être reconnu.',
                '4': 'L\'Artiste - Motivé par le besoin d\'exprimer son authenticité unique.',
                '5': 'L\'Investigateur - Motivé par le besoin de comprendre le monde.',
                '6': 'Le Loyaliste - Motivé par le besoin de sécurité et de soutien.',
                '7': 'L\'Enthousiaste - Motivé par le besoin de maintenir le bonheur et l\'enthousiasme.',
                '8': 'Le Challenger - Motivé par le besoin d\'être autonome et de contrôler sa vie.',
                '9': 'Le Médiateur - Motivé par le besoin de maintenir la paix intérieure et extérieure.'
            };
            
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                            Vos résultats
                        </h2>
                        <p class="mt-4 text-xl text-gray-600">
                            Voici votre profil de personnalité basé sur vos réponses
                        </p>
                    </div>
                    
                    <div class="mt-12 bg-white shadow-xl rounded-lg overflow-hidden">
                        <div class="px-6 py-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900">Votre profil</h3>
                                    <p class="mt-1 text-gray-500">Analyse complétée le ${new Date().toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div class="mt-4 md:mt-0">
                                    <span class="personality-badge bg-green-100 text-green-800">${results.mbtiType}</span>
                                    <span class="personality-badge bg-blue-100 text-blue-800 ml-2">Type ${results.enneagramType}</span>
                                </div>
                            </div>
                            
                            <!-- Code unique pour partage -->
                            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-medium text-blue-900">Votre code unique</h4>
                                        <p class="text-sm text-blue-700 mt-1">Partagez ce code avec vos proches pour qu'ils puissent vous évaluer</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="bg-white border-2 border-blue-300 rounded-lg px-4 py-2">
                                            <span class="text-2xl font-bold text-blue-900 tracking-wider" id="unique-code">${results.code}</span>
                                        </div>
                                        <button onclick="copyCode('${results.code}')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                            <i class="fas fa-copy mr-1"></i> Copier
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                         <div class="pc-info-banner" role="note" aria-live="polite" style="text-align: center;">
  Voici les profils avec lesquels vous vous identifiez. Partagez votre code unique à 3 proches, puis consultez vos résultats détaillés dans la section 
  <strong>« Mon profil »</strong> ou <strong>« Retrouver un profil »</strong>.
</div>


                            <div class="mt-8 grid grid-cols-1 gap-8 md:grid-cols-2">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900">Profil MBTI</h4>
                                    <div class="mt-4 bg-green-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">${results.mbtiType}</p>
                                        <p class="text-gray-600 text-sm mt-1">${mbtiDescriptions[results.mbtiType]}</p>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-lg font-medium text-gray-900">Profil Ennéagramme</h4>
                                    <div class="mt-4 bg-blue-50 rounded-lg p-4">
                                        <p class="text-gray-700 font-medium">Type ${results.enneagramType}</p>
                                        <p class="text-gray-600 text-sm mt-1">${enneagramDescriptions[results.enneagramType]}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 flex flex-wrap justify-center gap-4">
                                <button onclick="shareCode()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                    <i class="fas fa-share mr-2"></i> Partager
                                </button>
                                <button onclick="restartTest()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-redo mr-2"></i> Refaire le test
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fonctions utilitaires
        function initCountUp(root = document) {
            const elements = root.querySelectorAll('.countup');
            if (!elements.length) return;
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const endVal = parseFloat(el.dataset.value) || 0;
                        const suffix = el.dataset.suffix || '';
                        const counter = new CountUp(el, endVal, { duration: 1.5, suffix });
                        if (!counter.error) {
                            counter.start();
                        } else {
                            console.error(counter.error);
                        }
                        obs.unobserve(el);
                    }
                });
            }, { threshold: 0.5 });

            elements.forEach(el => {
                const suffix = el.dataset.suffix || '';
                el.textContent = '0' + suffix;
                observer.observe(el);
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                // Changer temporairement le texte du bouton
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i> Copié !';
                button.classList.remove('bg-black', 'hover:bg-gray-800');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-black', 'hover:bg-gray-800');
                }, 2000);
            }).catch(() => {
                alert('Code copié : ' + code);
            });
        }

        function restartTest() {
            if (confirm('Êtes-vous sûr de vouloir recommencer le test ? Vos réponses actuelles seront perdues.')) {
                localStorage.removeItem('personalityTestProgress');
                localStorage.removeItem('personalityTestResults');
                currentQuestionIndex = 0;
                answers = {};
                
                // Réinitialiser la section des résultats si elle existe
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    resultsSection.innerHTML = '';
                    resultsSection.className = '';
                }
                
                displayQuestion(0);
            }
        }

        function startEvaluationTest(relation) {
            alert(`Évaluation pour un ${relation} - Fonctionnalité en cours de développement`);
        }

        // Gestion des modales
        function showModal(title, content) {
            const modalContainer = document.getElementById('modal-container');
            const modalHTML = `
                <div class="modal show" id="current-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="text-xl font-bold text-gray-900">${title}</h2>
                            <span class="close" onclick="closeModal()">✕</span>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }
            
            // Fermer avec ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
            
            // Fermer en cliquant à l'extérieur
            document.getElementById('current-modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        function closeModal() {
            const modal = document.getElementById('current-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }

        // Descriptions détaillées MBTI
        const mbtiDetailedDescriptions = {
            'INTJ': {
                title: 'INTJ - L\'Architecte',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTJ sont des visionnaires stratégiques avec un plan pour tout. Ils sont indépendants, déterminés et ont une forte capacité à voir les possibilités futures.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Penseurs stratégiques et visionnaires</li>
                            <li>Indépendants et autonomes</li>
                            <li>Orientés vers les objectifs à long terme</li>
                            <li>Excellents planificateurs</li>
                            <li>Préfèrent travailler seuls ou en petits groupes</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inférieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Architecte, ingénieur, scientifique, consultant en stratégie, développeur de logiciels, chercheur.</p>
                    </div>
                `
            },
            'INTP': {
                title: 'INTP - Le Penseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INTP sont des penseurs logiques et créatifs, toujours à la recherche de nouvelles idées et possibilités théoriques.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Analystes logiques et objectifs</li>
                            <li>Curieux et ouverts aux nouvelles idées</li>
                            <li>Indépendants et flexibles</li>
                            <li>Excellents résolveurs de problèmes</li>
                            <li>Préfèrent la théorie à la pratique</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inférieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Chercheur, philosophe, mathématicien, programmeur, analyste, professeur d'université.</p>
                    </div>
                `
            }
            ,
            'ISTJ': {
                title: 'ISTJ - Le Logisticien',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTJ sont sérieux et fiables. Ils respectent les règles et traditions, travaillent méthodiquement et prennent leurs responsabilités au sérieux. Leur approche est pragmatique et organisée.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Responsables, pratiques et factuels</li>
                            <li>Respectent les traditions et les structures établies</li>
                            <li>Mettent l'accent sur la précision et la loyauté</li>
                            <li>Préférent la stabilité et la planification</li>
                            <li>Peuvent être réservés et rigides face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Inférieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Comptable, auditeur, administrateur, officier militaire, juge, gestionnaire de projet.</p>
                    </div>
                `
            },
            'ISTP': {
                title: 'ISTP - Le Virtuose',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISTP sont pragmatiques et analytiques. Ils aiment comprendre comment fonctionnent les choses et s'attaquer à des problèmes concrets. Flexibles et observateurs, ils préfèrent apprendre par l'expérience.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Calmes et réalistes</li>
                            <li>Analytiques et logiques</li>
                            <li>Aiment démonter et réparer des objets</li>
                            <li>S'adaptent rapidement aux situations de crise</li>
                            <li>Peuvent paraître distants émotionnellement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inférieure :</strong> Sentiment Extraverti (Fe)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Mécanicien, ingénieur, pilote, technicien, enquêteur.</p>
                    </div>
                `
            },
            'ISFJ': {
                title: 'ISFJ - Le Protecteur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFJ sont chaleureux et consciencieux. Ils veillent à préserver l'harmonie et la sécurité de leur entourage. Ils respectent les traditions et sont attentifs aux besoins des autres.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Bienveillants, loyaux et responsables</li>
                            <li>Organisés et méthodiques</li>
                            <li>Souvent modestes et discrets</li>
                            <li>Se soucient des besoins des autres avant les leurs</li>
                            <li>Peuvent être réticents face au changement</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Inférieure :</strong> Intuition Extravertie (Ne)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, bibliothécaire, assistant social, gestionnaire administratif.</p>
                    </div>
                `
            },
            'ISFP': {
                title: 'ISFP - L\'Aventurier',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ISFP sont sensibles, discrets et artistiques. Ils apprécient l'harmonie, la beauté et la liberté de s'exprimer. Ils vivent l’instant présent et recherchent l'équilibre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Créatifs et artistiques</li>
                            <li>Empathiques et chaleureux</li>
                            <li>Discrets et réservés</li>
                            <li>Apprécient la liberté et l’indépendance</li>
                            <li>Peuvent éviter les conflits et les planifications rigides</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Tertiaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Inférieure :</strong> Pensée Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Artiste, designer, photographe, chef cuisinier, travailleur social.</p>
                    </div>
                `
            },
            'INFJ': {
                title: 'INFJ - L\'Avocat',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFJ sont perspicaces et idéalistes. Ils sont guidés par leurs valeurs et cherchent à comprendre les motivations profondes des autres. Ils sont créatifs et se consacrent à aider autrui.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Visionnaires et orientés vers un sens profond</li>
                            <li>Empathiques et compatissants</li>
                            <li>Créatifs et originaux</li>
                            <li>Organisés et déterminés</li>
                            <li>Peuvent se sentir incompris ou retirés</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Tertiaire :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Inférieure :</strong> Sensation Extravertie (Se)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Conseiller, psychologue, écrivain, enseignant, humanitaire.</p>
                    </div>
                `
            },
            'INFP': {
                title: 'INFP - Le Médiateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les INFP sont idéalistes et empathiques. Guidés par leurs valeurs, ils cherchent un sens profond à la vie et s’efforcent de rendre le monde meilleur. Ils sont créatifs et sensibles.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Idéalistes et guidés par leurs valeurs</li>
                            <li>Empathiques et compatissants</li>
                            <li>Créatifs et expressifs</li>
                            <li>Aiment l'authenticité et l'individualité</li>
                            <li>Peuvent être réservés et éviter les conflits</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Tertiaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Inférieure :</strong> Pensée Extravertie (Te)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Écrivain, psychologue, conseiller, artiste, musicien.</p>
                    </div>
                `
            },
            'ENTJ': {
                title: 'ENTJ - Le Commandant',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTJ sont des leaders nés, charismatiques et logiques. Ils aiment structurer des organisations, planifier l'avenir et relever des défis. Ils sont déterminés et axés sur l’efficacité.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Leaders stratégiques et assertifs</li>
                            <li>Décisifs et organisés</li>
                            <li>Adeptes de la planification et de l'exécution</li>
                            <li>Orientés vers les objectifs et la réussite</li>
                            <li>Peuvent paraître autoritaires ou impatients</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inférieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Directeur général, avocat, chef de projet, politicien, entrepreneur.</p>
                    </div>
                `
            },
            'ENTP': {
                title: 'ENTP - L\'Innovateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENTP sont créatifs et curieux. Ils aiment explorer de nouvelles idées, débattre et remettre en question le statu quo. Flexibles, ils préfèrent les possibilités ouvertes aux routines strictes.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Inventifs et plein d'esprit</li>
                            <li>Aiment débattre et argumenter</li>
                            <li>S'adaptent rapidement à de nouveaux concepts</li>
                            <li>Aiment les défis intellectuels</li>
                            <li>Peuvent s'ennuyer avec la routine et la gestion des détails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inférieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Avocat, consultant, entrepreneur, inventeur, journaliste.</p>
                    </div>
                `
            },
            'ENFJ': {
                title: 'ENFJ - Le Donateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFJ sont charismatiques et attentifs aux autres. Ils comprennent intuitivement les besoins des gens et aiment motiver et inspirer. Ils recherchent l’harmonie et le développement personnel et collectif.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux, empathiques et organisés</li>
                            <li>Communicateurs naturels</li>
                            <li>Aident les autres à réaliser leur potentiel</li>
                            <li>Orientés vers les valeurs et l'harmonie</li>
                            <li>Peuvent s'oublier au profit des autres</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Intuition Introvertie (Ni)</p>
                            <p><strong>Tertiaire :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Inférieure :</strong> Pensée Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Professeur, coach, psychologue, coordinateur d’événements, diplomate.</p>
                    </div>
                `
            },
            'ENFP': {
                title: 'ENFP - L\'Inspirateur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ENFP sont enthousiastes et créatifs. Ils s’épanouissent dans l'exploration de nouvelles idées et inspirent les autres grâce à leur vision optimiste. Ils cherchent l’authenticité et la liberté.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Énergétiques et imaginatifs</li>
                            <li>Empathiques et communicatifs</li>
                            <li>S'épanouissent dans les relations</li>
                            <li>Aiment l'innovation et la diversité</li>
                            <li>Peuvent se disperser et négliger les détails</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Inférieure :</strong> Sensation Introvertie (Si)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Journaliste, conseiller, animateur, auteur, professionnel des relations publiques.</p>
                    </div>
                `
            },
            'ESTP': {
                title: 'ESTP - L\'Entrepreneur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTP sont énergiques et orientés vers l'action. Ils aiment vivre l'instant présent et résoudre des situations concrètes. Adaptables et sociables, ils prennent des décisions rapides.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Dynamiques et aventuriers</li>
                            <li>Pragmatiques et réalistes</li>
                            <li>Orientés vers les résultats immédiats</li>
                            <li>Bons communicateurs et négociateurs</li>
                            <li>Peuvent se montrer impatients et risquer l'impulsivité</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Pensée Introvertie (Ti)</p>
                            <p><strong>Tertiaire :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Inférieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Entrepreneur, détective, pilote, vendeur, pompier.</p>
                    </div>
                `
            },
            'ESTJ': {
                title: 'ESTJ - L\'Exécutif',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESTJ sont organisés et directs. Ils se fient aux faits et aiment structurer les activités pour obtenir des résultats efficaces. Ils valorisent la tradition et l’ordre.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Pragmatiques et responsables</li>
                            <li>Directs et orientés vers l'action</li>
                            <li>Logiques et objectifs</li>
                            <li>Aiment organiser et diriger</li>
                            <li>Peuvent être inflexibles ou autoritaires</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inférieure :</strong> Sentiment Introverti (Fi)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Gestionnaire, officier militaire, policier, juge, chef de projet.</p>
                    </div>
                `
            },
            'ESFP': {
                title: 'ESFP - L\'Amuseur',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFP sont spontanés et sociables. Ils aiment profiter de la vie et attirer l'attention. Pratiques et chaleureux, ils encouragent les autres à vivre pleinement chaque moment.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Sociables et enthousiastes</li>
                            <li>Spontanés et énergiques</li>
                            <li>Aiment le divertissement et la variété</li>
                            <li>Observateurs et pratiques</li>
                            <li>Peuvent être sensibles aux critiques et éviter la planification</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sensation Extravertie (Se)</p>
                            <p><strong>Auxiliaire :</strong> Sentiment Introverti (Fi)</p>
                            <p><strong>Tertiaire :</strong> Pensée Extravertie (Te)</p>
                            <p><strong>Inférieure :</strong> Intuition Introvertie (Ni)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Acteur, animateur, hôte, vendeur, infirmier pédiatrique.</p>
                    </div>
                `
            },
            'ESFJ': {
                title: 'ESFJ - Le Consul',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700">Les ESFJ sont aimables et sociables. Ils prennent soin des autres et veillent à maintenir l'harmonie. Organisés et consciencieux, ils travaillent pour soutenir leur communauté.</p>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Caractéristiques principales :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li>Chaleureux et serviables</li>
                            <li>Organisés et responsables</li>
                            <li>Centrés sur la communauté et la tradition</li>
                            <li>Communicateurs empathiques</li>
                            <li>Peuvent être sensibles à la critique et rechercher l'approbation</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Fonctions cognitives :</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p><strong>Dominante :</strong> Sentiment Extraverti (Fe)</p>
                            <p><strong>Auxiliaire :</strong> Sensation Introvertie (Si)</p>
                            <p><strong>Tertiaire :</strong> Intuition Extravertie (Ne)</p>
                            <p><strong>Inférieure :</strong> Pensée Introvertie (Ti)</p>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900">Carrières typiques :</h3>
                        <p class="text-gray-700">Infirmier, enseignant, gestionnaire d'événements, conseiller, travailleur social.</p>
                    </div>
                `
            }
        };

        // Descriptions détaillées Ennéagramme
        const enneagramDetailedDescriptions = {
            '1': {
                title: '<span data-i18n="enneagramme.modals.1.title">Type 1 - Le Perfectionniste</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.1.intro">Les Type 1 sont motivés par le besoin de vivre correctement, d'améliorer le monde et d'éviter la colère.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.1.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.1.coreFear"><strong>Peur fondamentale :</strong> Être corrompu, défectueux ou mauvais</p>
                            <p data-i18n="enneagramme.modals.1.coreDesire"><strong>Désir fondamental :</strong> Être bon, vertueux et parfait</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.1.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.1.traits1">Idéalistes et responsables</li>
                            <li data-i18n="enneagramme.modals.1.traits2">Fort sens moral et éthique</li>
                            <li data-i18n="enneagramme.modals.1.traits3">Perfectionnistes et critiques</li>
                            <li data-i18n="enneagramme.modals.1.traits4">Organisés et méthodiques</li>
                            <li data-i18n="enneagramme.modals.1.traits5">Peuvent être rigides et colériques</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.1.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.1.healthy">Sages, discernants, réalistes et nobles. Peuvent être moralement héroïques.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.1.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.1.stress">Deviennent critiques, perfectionnistes et peuvent exploser de colère.</p>
                    </div>
                `
            },
            '2': {
                title: '<span data-i18n="enneagramme.modals.2.title">Type 2 - L\'Altruiste</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.2.intro">Les Type 2 sont motivés par le besoin d'être aimés et nécessaires. Ils sont empathiques, chaleureux et généreux, mais peuvent devenir possessifs et trop axés sur la reconnaissance.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.2.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.2.coreFear"><strong>Peur fondamentale :</strong> Ne pas être aimés ou être inutiles</p>
                            <p data-i18n="enneagramme.modals.2.coreDesire"><strong>Désir fondamental :</strong> Se sentir appréciés, aimés et nécessaires</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.2.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.2.traits1">Empathiques et chaleureux</li>
                            <li data-i18n="enneagramme.modals.2.traits2">Serviables et généreux</li>
                            <li data-i18n="enneagramme.modals.2.traits3">Adaptés aux besoins des autres</li>
                            <li data-i18n="enneagramme.modals.2.traits4">Peuvent être dépendants de la reconnaissance</li>
                            <li data-i18n="enneagramme.modals.2.traits5">Parfois possessifs ou envahissants</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.2.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.2.healthy">Ils sont altruistes, aimants et désintéressés. Ils soutiennent les autres de manière authentique sans attendre de retour.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.2.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.2.stress">Ils peuvent devenir envahissants, ressentir de la jalousie et s'épuiser en donnant trop.</p>
                    </div>
                `
            },
            '3': {
                title: '<span data-i18n="enneagramme.modals.3.title">Type 3 - Le Bâtisseur</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.3.intro">Les Type 3 sont motivés par le besoin de réussir et d'être admirés. Ambitieux et énergiques, ils sont adaptables et conscients de leur image, mais peuvent devenir préoccupés par leur statut.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.3.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.3.coreFear"><strong>Peur fondamentale :</strong> Ne pas avoir de valeur personnelle</p>
                            <p data-i18n="enneagramme.modals.3.coreDesire"><strong>Désir fondamental :</strong> Se sentir précieux et admiré pour leurs réalisations</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.3.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.3.traits1">Ambitieux et charismatiques</li>
                            <li data-i18n="enneagramme.modals.3.traits2">Efficaces et compétitifs</li>
                            <li data-i18n="enneagramme.modals.3.traits3">Flexibles et orientés vers les objectifs</li>
                            <li data-i18n="enneagramme.modals.3.traits4">Très conscients de leur image</li>
                            <li data-i18n="enneagramme.modals.3.traits5">Peuvent négliger leurs émotions ou celles des autres</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.3.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.3.healthy">Ils sont authentiques, inspirants et encouragent les autres à réussir. Ils assument leurs valeurs personnelles plutôt que de rechercher uniquement la reconnaissance.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.3.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.3.stress">Ils peuvent devenir obsédés par leur image, ignorer leurs besoins émotionnels et craindre l'échec.</p>
                    </div>
                `
            },
            '4': {
                title: '<span data-i18n="enneagramme.modals.4.title">Type 4 - L\'Artiste</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.4.intro">Les Type 4 recherchent l'authenticité et un sens personnel. Sensibles et créatifs, ils veulent être compris et exprimer leur individualité. Ils peuvent être introspectifs et parfois mélancoliques.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.4.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.4.coreFear"><strong>Peur fondamentale :</strong> Ne pas avoir d'identité ou de valeur personnelle</p>
                            <p data-i18n="enneagramme.modals.4.coreDesire"><strong>Désir fondamental :</strong> Trouver leur véritable identité et s'exprimer de manière authentique</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.4.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.4.traits1">Sensibles et introspectifs</li>
                            <li data-i18n="enneagramme.modals.4.traits2">Créatifs et expressifs</li>
                            <li data-i18n="enneagramme.modals.4.traits3">Apprécient la profondeur et l'authenticité</li>
                            <li data-i18n="enneagramme.modals.4.traits4">Peuvent être mélancoliques et se sentir différents</li>
                            <li data-i18n="enneagramme.modals.4.traits5">Recherchent souvent un sens et une connexion profonde</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.4.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.4.healthy">Ils sont hautement créatifs, inspirés et capables de transformer leur expérience personnelle en quelque chose d'universel.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.4.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.4.stress">Ils peuvent se sentir incompris, se retirer et devenir auto‑indulgents ou envieux des autres.</p>
                    </div>
                `
            },
            '5': {
                title: '<span data-i18n="enneagramme.modals.5.title">Type 5 - L\'Investigateur</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.5.intro">Les Type 5 veulent comprendre le monde. Ils sont observateurs, innovants et autonomes. Ils peuvent se retirer pour préserver leur énergie et développer leurs connaissances.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.5.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.5.coreFear"><strong>Peur fondamentale :</strong> Être impuissant, inutile ou incapable</p>
                            <p data-i18n="enneagramme.modals.5.coreDesire"><strong>Désir fondamental :</strong> Être compétent et comprendre l'environnement</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.5.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.5.traits1">Observateurs et analytiques</li>
                            <li data-i18n="enneagramme.modals.5.traits2">Innovants et créatifs</li>
                            <li data-i18n="enneagramme.modals.5.traits3">Indépendants et réservés</li>
                            <li data-i18n="enneagramme.modals.5.traits4">Recherchent la maîtrise de leurs domaines d'intérêt</li>
                            <li data-i18n="enneagramme.modals.5.traits5">Peuvent se couper de leurs émotions ou des autres</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.5.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.5.healthy">Ils sont visionnaires, pionniers et apportent des idées novatrices qui améliorent la société.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.5.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.5.stress">Ils peuvent devenir détachés, trop rationnels et éviter la participation sociale.</p>
                    </div>
                `
            },
            '6': {
                title: '<span data-i18n="enneagramme.modals.6.title">Type 6 - Le Loyaliste</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.6.intro">Les Type 6 recherchent la sécurité et la confiance. Loyaux et fiables, ils anticipent les problèmes et recherchent le soutien. Ils peuvent osciller entre la prudence et l'audace.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.6.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.6.coreFear"><strong>Peur fondamentale :</strong> Être sans soutien ou sans direction</p>
                            <p data-i18n="enneagramme.modals.6.coreDesire"><strong>Désir fondamental :</strong> Être en sécurité et soutenu</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.6.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.6.traits1">Fiables et dévoués</li>
                            <li data-i18n="enneagramme.modals.6.traits2">Consciencieux et travailleurs</li>
                            <li data-i18n="enneagramme.modals.6.traits3">Tendance à anticiper les problèmes</li>
                            <li data-i18n="enneagramme.modals.6.traits4">Peuvent osciller entre doute et confiance</li>
                            <li data-i18n="enneagramme.modals.6.traits5">Parfois anxieux ou sceptiques</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.6.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.6.healthy">Ils sont courageux, engagés et se mettent au service d'une cause plus grande qu'eux.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.6.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.6.stress">Ils peuvent devenir méfiants, autoritaires ou excessivement anxieux.</p>
                    </div>
                `
            },
            '7': {
                title: '<span data-i18n="enneagramme.modals.7.title">Type 7 - L\'Enthousiaste</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.7.intro">Les Type 7 sont optimistes et aventuriers. Ils recherchent des expériences stimulantes et veulent éviter la douleur et l'ennui. Souvent joyeux, ils peuvent se disperser.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.7.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.7.coreFear"><strong>Peur fondamentale :</strong> Être privés ou coincés dans la souffrance</p>
                            <p data-i18n="enneagramme.modals.7.coreDesire"><strong>Désir fondamental :</strong> Être heureux, satisfaits et libres</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.7.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.7.traits1">Extravertis et optimistes</li>
                            <li data-i18n="enneagramme.modals.7.traits2">Polyvalents et spontanés</li>
                            <li data-i18n="enneagramme.modals.7.traits3">Curieux et enthousiastes</li>
                            <li data-i18n="enneagramme.modals.7.traits4">Aiment planifier des projets et des voyages</li>
                            <li data-i18n="enneagramme.modals.7.traits5">Peuvent être dispersés ou éviter la douleur à tout prix</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.7.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.7.healthy">Ils canaliseront leur énergie dans des objectifs significatifs et apprécieront la simplicité et la gratitude.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.7.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.7.stress">Ils peuvent fuir les responsabilités, se disperser ou chercher des distractions excessives.</p>
                    </div>
                `
            },
            '8': {
                title: '<span data-i18n="enneagramme.modals.8.title">Type 8 - Le Challenger</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.8.intro">Les Type 8 valorisent l'indépendance et la protection. Ils sont confiants, forts et veulent se protéger et protéger les autres. Ils peuvent devenir dominants s'ils se sentent menacés.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.8.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.8.coreFear"><strong>Peur fondamentale :</strong> Être blessés ou contrôlés par autrui</p>
                            <p data-i18n="enneagramme.modals.8.coreDesire"><strong>Désir fondamental :</strong> Être maîtres de leur vie et protéger les faibles</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.8.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.8.traits1">Assertifs et décisifs</li>
                            <li data-i18n="enneagramme.modals.8.traits2">Confiants et protecteurs</li>
                            <li data-i18n="enneagramme.modals.8.traits3">Dirigeants naturels</li>
                            <li data-i18n="enneagramme.modals.8.traits4">Défendent leurs convictions</li>
                            <li data-i18n="enneagramme.modals.8.traits5">Peuvent être contrôlants ou impulsifs</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.8.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.8.healthy">Ils utilisent leur force pour améliorer le monde et protéger les vulnérables. Ils sont magnanimes et courageux.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.8.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.8.stress">Ils peuvent devenir dominateurs, se méfier des autres et réagir avec colère.</p>
                    </div>
                `
            },
            '9': {
                title: '<span data-i18n="enneagramme.modals.9.title">Type 9 - Le Médiateur</span>',
                content: `
                    <div class="space-y-4">
                        <p class="text-gray-700" data-i18n="enneagramme.modals.9.intro">Les Type 9 recherchent la paix intérieure et extérieure. Ils sont réceptifs, conciliants et stables. Ils fuient les conflits et peuvent devenir complaisants pour préserver l'harmonie.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.9.motivationsTitle">Motivations profondes :</h3>
                        <div class="bg-teal-50 p-4 rounded-lg">
                            <p data-i18n="enneagramme.modals.9.coreFear"><strong>Peur fondamentale :</strong> Perdre la connexion ou être séparé des autres</p>
                            <p data-i18n="enneagramme.modals.9.coreDesire"><strong>Désir fondamental :</strong> Maintenir la paix et l'harmonie</p>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.9.traitsTitle">Caractéristiques :</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li data-i18n="enneagramme.modals.9.traits1">Réceptifs et rassurants</li>
                            <li data-i18n="enneagramme.modals.9.traits2">Stables et accommodants</li>
                            <li data-i18n="enneagramme.modals.9.traits3">Médiateurs naturels</li>
                            <li data-i18n="enneagramme.modals.9.traits4">Évitent les conflits et la prise de décision</li>
                            <li data-i18n="enneagramme.modals.9.traits5">Peuvent devenir complaisants ou inertes</li>
                        </ul>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.9.healthyTitle">En santé :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.9.healthy">Ils apportent la paix et la cohésion, aident les autres à coopérer et deviennent des sources d'unité.</p>

                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="enneagramme.modals.9.stressTitle">En stress :</h3>
                        <p class="text-gray-700" data-i18n="enneagramme.modals.9.stress">Ils peuvent ignorer leurs propres besoins, éviter les conflits et se dissocier émotionnellement.</p>
                    </div>
                `
            }
        };

        // Fonctions pour afficher les détails
        function showMBTIDetails(type) {
            const details = mbtiDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`${type} - Description`, `<p>Description détaillée du type ${type} en cours de développement.</p>`);
            }
        }

        function showEnneagramDetails(type) {
            const details = enneagramDetailedDescriptions[type];
            if (details) {
                showModal(details.title, details.content);
            } else {
                showModal(`Type ${type} - Description`, `<p>Description détaillée du type ${type} en cours de développement.</p>`);
            }
        }

        function showAboutProject() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-700">"Personnalité Comparée" est né de la volonté de créer un outil plus objectif pour comprendre sa personnalité.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Notre approche unique :</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-eye text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Vision objective</h4>
                            <p class="text-sm text-gray-600">Combiner plusieurs perspectives pour une analyse plus complète</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <i class="fas fa-shield-alt text-blue-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Confidentialité</h4>
                            <p class="text-sm text-gray-600">Vos données sont protégées et ne sont jamais partagées</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <i class="fas fa-graduation-cap text-green-600 text-2xl mb-2"></i>
                            <h4 class="font-semibold">Base scientifique</h4>
                            <p class="text-sm text-gray-600">Fondé sur les recherches en psychologie de la personnalité</p>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Pourquoi cette approche ?</h3>
                    <p class="text-gray-700">Contrairement aux tests traditionnels qui reposent uniquement sur l'auto-évaluation, notre approche combine votre perception avec celle de votre entourage pour un résultat plus nuancé et fidèle.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-900">Comment ça marche ?</h3>
                    <ol class="list-decimal list-inside text-gray-700 space-y-1">
                        <li>Vous répondez à 20 questions d'auto-évaluation</li>
                        <li>Vous partagez votre code unique avec vos proches</li>
                        <li>Ils répondent à 20 questions sur votre personnalité</li>
                        <li>Notre algorithme combine toutes les réponses avec une pondération scientifique</li>
                        <li>Vous obtenez votre profil MBTI et Ennéagramme avec un score de certitude</li>
                    </ol>
                </div>
            `;
            showModal('À propos du projet', content);
        }

        // Fonctions pour les pages légales et contact
function showPrivacyPolicy() {
  const lang = localStorage.getItem('lang') || 'fr';
  const date = new Date().toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US');
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.privacy.title">Politique de Confidentialité</h3>
      <p class="text-gray-700"><span data-i18n="footer.legal.privacy.update">Dernière mise à jour :</span> ${date}</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.collected.title">1. Données collectées</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.collected.desc">Nous collectons uniquement les réponses fournies lors&nbsp;:</p>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.collected.item1">de vos auto-évaluations ;</li>
        <li data-i18n="footer.legal.privacy.collected.item2">des évaluations réalisées par vos proches.</li>
      </ul>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.collected.note">Aucune autre donnée personnelle (nom, e-mail, localisation, etc.) n’est demandée ni enregistrée.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.purpose.title">2. Finalité de la collecte</h4>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.purpose.item1">Calculer et afficher votre profil de personnalité ;</li>
        <li data-i18n="footer.legal.privacy.purpose.item2">Générer les résultats finaux à partir des évaluations reçues.</li>
      </ul>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.storage.title">3. Stockage des données</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.storage.text">Vos réponses sont stockées de manière sécurisée dans notre base de données <strong>Supabase</strong>. Elles ne sont pas enregistrées ailleurs.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.sharing.title">4. Partage des données</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.sharing.text">Nous ne vendons, n’échangeons et ne partageons <strong>aucune</strong> donnée avec des tiers. Seules les personnes disposant de votre code unique peuvent consulter vos résultats.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.security.title">5. Sécurité</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.security.text">Supabase applique des mesures de sécurité standards (chiffrement en transit, contrôles d’accès). Nous limitons l’accès aux données aux seules finalités décrites ci-dessus.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.retention.title">6. Durée de conservation</h4>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.retention.text">Les réponses sont conservées tant que votre code unique reste valide dans notre base. Vous pouvez demander leur suppression à tout moment.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.privacy.rights.title">7. Vos droits</h4>
      <ul class="list-disc pl-6 text-gray-700">
        <li data-i18n="footer.legal.privacy.rights.item1">Demander une copie de vos données ;</li>
        <li data-i18n="footer.legal.privacy.rights.item2">Demander la suppression définitive de vos données.</li>
      </ul>
      <p class="text-gray-700" data-i18n="footer.legal.privacy.rights.contact">Pour exercer ces droits, contactez-nous via la section <strong>Support</strong> du site.</p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.privacy.title">Politique de Confidentialité</span>', content);
}

function showTermsOfService() {
  const lang = localStorage.getItem('lang') || 'fr';
  const date = new Date().toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US');
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.terms.title">Conditions d'Utilisation</h3>
      <p class="text-gray-700"><span data-i18n="footer.legal.terms.update">Dernière mise à jour :</span> ${date}</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.use.title">Utilisation du service</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.use.text">Ce service est fourni gratuitement à des fins éducatives et de développement personnel. Il ne remplace pas un conseil professionnel en psychologie.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.accuracy.title">Précision des résultats</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.accuracy.text">Les résultats sont basés sur des modèles psychologiques reconnus mais ne constituent pas un diagnostic médical ou psychologique.</p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.terms.liability.title">Responsabilité</h4>
      <p class="text-gray-700" data-i18n="footer.legal.terms.liability.text">L'utilisation de ce service se fait sous votre propre responsabilité. Nous ne sommes pas responsables des décisions prises sur la base des résultats.</p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.terms.title">Conditions d\'Utilisation</span>', content);
}
function showLegalNotices() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.mentions.title">Mentions Légales</h3>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.editor.title">Éditeur du site</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.editor.text">
        <strong>Personnalité Comparée</strong><br>
        Site web éducatif et informatif sur les tests de personnalité (MBTI et Ennéagramme)<br>
        Contact : <a href="mailto:contact@personnalitecomparee.com" class="text-blue-600 hover:underline">contact@personnalitecomparee.com</a>
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.hosting.title">Hébergement</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.hosting.text">
        Ce site est hébergé par <strong>Vercel Inc.</strong><br>
        340 S Lemon Ave #4133<br>
        Walnut, CA 91789, États-Unis<br>
        <a href="https://vercel.com" target="_blank" rel="noopener" class="text-blue-600 hover:underline">https://vercel.com</a>
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.ip.title">Propriété intellectuelle</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.ip.text">
        L’ensemble du contenu de ce site (textes, éléments graphiques, code source) est protégé par les lois en vigueur sur la propriété intellectuelle.<br>
        Les modèles MBTI et Ennéagramme sont des systèmes conceptuels utilisés ici uniquement à des fins pédagogiques et informatives.
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.liability.title">Responsabilité</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.liability.text">
        Les informations fournies sur ce site le sont à titre indicatif et ne constituent en aucun cas un conseil professionnel, médical ou psychologique. L’utilisateur reste seul responsable de l’usage qu’il fait des informations et résultats proposés.
      </p>

      <h4 class="font-semibold text-gray-900" data-i18n="footer.legal.mentions.trademarks.title">Marques et mentions légales spécifiques</h4>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.trademarks.mbti">
        MBTI est une marque déposée appartenant à The Myers-Briggs Company. Le présent site utilise ce terme à des fins pédagogiques et informatives uniquement. Nous ne sommes ni affiliés, ni agréés, ni soutenus par The Myers-Briggs Company.
      </p>
      <p class="text-gray-700" data-i18n="footer.legal.mentions.trademarks.enneagram">
        L’utilisation du mot "Ennéagramme" fait référence au système de typologie de la personnalité bien connu, dont l’usage est libre. Aucun lien n’est revendiqué avec des organismes officiels comme The Enneagram Institute.
      </p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.mentions.title">Mentions Légales</span>', content);
}
function showCookies() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.cookies.title">Cookies et stockage local</h3>
      <p class="text-gray-700" data-i18n="footer.legal.cookies.text">
        Ce site n’utilise pas de cookies de suivi.<br>
        Seules certaines données nécessaires au fonctionnement (comme la progression dans le test ou le code d’accès aux résultats) sont stockées localement dans le navigateur ou dans notre base de données Supabase.
      </p>
    </div>
  `;
  showModal('<span data-i18n="footer.legal.cookies.title">Cookies et stockage local</span>', content);
}

function showSupport() {
  const content = `
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.contact.support.title">Support</h3>

      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-900" data-i18n="footer.contact.support.email.title">Email</h4>
        <p class="text-blue-700" data-i18n="footer.contact.support.email.text"></p>
      </div>

      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-900" data-i18n="footer.contact.support.tech.title">Support technique</h4>
        <p class="text-blue-700" data-i18n="footer.contact.support.tech.text">Pour toute question technique ou problème avec le test, n'hésitez pas à nous écrire en détaillant votre problème.</p>
      </div>

      <div class="bg-green-50 p-4 rounded-lg">
        <h4 class="font-semibold text-green-900" data-i18n="footer.contact.support.suggestions.title">Suggestions</h4>
        <p class="text-green-700" data-i18n="footer.contact.support.suggestions.text">Vos suggestions d'amélioration sont les bienvenues ! Aidez-nous à améliorer l'expérience utilisateur.</p>
      </div>

      <div class="bg-yellow-50 p-4 rounded-lg">
        <h4 class="font-semibold text-yellow-900" data-i18n="footer.contact.support.time.title">Temps de réponse</h4>
        <p class="text-yellow-700" data-i18n="footer.contact.support.time.text">Nous nous efforçons de répondre à tous les messages dans les 48 heures.</p>
      </div>
    </div>
  `;
  showModal('<span data-i18n="footer.contact.support.title">Support</span>', content);
}


        // Fonction pour démarrer l'évaluation externe
        function startExternalEvaluation() {
            const codeInput = document.querySelector('input[placeholder="Ex: ABC123"]');
            const relationInputs = document.querySelectorAll('input[name="relation"]');
            
            if (!codeInput || !codeInput.value.trim()) {
                alert('Veuillez entrer le code unique de la personne à évaluer.');
                return;
            }
            
            let selectedRelation = null;
            relationInputs.forEach(input => {
                if (input.checked) {
                    selectedRelation = input.value;
                }
            });
            
            if (!selectedRelation) {
                alert('Veuillez sélectionner votre relation avec cette personne.');
                return;
            }
            
            // Sauvegarder les informations de l'évaluation externe
            localStorage.setItem('externalEvaluationCode', codeInput.value.trim().toUpperCase());
            localStorage.setItem('externalEvaluationRelation', selectedRelation);
            
            // Ouvrir les questions d'évaluation externe dans une fenêtre modale
            showExternalEvaluationQuestions();
        }

        // Fonction pour afficher les questions d'évaluation externe
        function showExternalEvaluationQuestions() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');
            
            const relationLabels = {
                'family': 'Membre de la famille',
                'partner': 'Partenaire amoureux',
                'friend': 'Ami(e)',
                'colleague': 'Collègue de travail'
            };
            
            const content = `
                <div class="max-w-4xl mx-auto">
<div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-white" data-i18n="home.modal.externalEval.title">Évaluation externe</h2>
                                <p class="text-blue-100 mt-1">Code: ${code} | Relation: ${relationLabels[relation]}</p>
                            </div>
                            <span class="close" onclick="closeModal()" style="color: white;">&times;</span>
                        </div>
                        <div class="p-6">
                            <form id="eval-form">
                                <div id="external-questions-content">
                                    <!-- Les questions seront ajoutées ici -->
                                </div>
                                <div class="mt-6 flex justify-between">
                                    <button type="button" id="prev-external-question" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" style="display: none;">
                                        <i class="fas fa-arrow-left mr-2"></i> Question précédente
                                    </button>
                                    <button type="button" id="next-external-question" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                        Question suivante <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                    <button type="submit" id="submit-eval" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" style="display: none;">
                                        <i class="fas fa-check mr-2"></i> Terminer l'évaluation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            showModal('', content);

            // Masquer l'en-tête par défaut de la modale et ajuster la taille
            const defaultHeader = document.querySelector('#current-modal .modal-header');
            if (defaultHeader) defaultHeader.style.display = 'none';

            const modalContent = document.querySelector('#current-modal .modal-content');
            if (modalContent) {
                modalContent.style.maxWidth = '900px';
                modalContent.style.width = '90%';
                modalContent.style.padding = '0';
            }

            // Initialiser les questions externes
            currentExternalQuestionIndex = 0;
            externalAnswers = {};
            displayExternalQuestion(0);
            setupExternalQuestionNavigation();
            setupEvalFormSubmit();
        }
        
        // Variables pour l'évaluation externe
        let currentExternalQuestionIndex = 0;
        let externalAnswers = {};
        
        // Questions pour l'évaluation externe (20 questions)
        // Ajout de l'option "Je ne sais pas" à chaque question d'évaluation externe
        EXTERNAL_QUESTIONS.forEach(q => {
            q.options.push({ text: "Je ne sais pas", functions: {}, enneagram: {} });
        });

        // Fonction pour afficher une question externe
        function displayExternalQuestion(index) {
            const question = EXTERNAL_QUESTIONS[index];
            if (!question) return;
            
            const progress = ((index + 1) / EXTERNAL_QUESTIONS.length) * 100;
            const questionsContent = document.getElementById('external-questions-content');
            
            questionsContent.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-medium text-blue-600">Question ${index + 1}/${EXTERNAL_QUESTIONS.length}</span>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 ml-4">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <h3 class="text-xl font-medium text-gray-900 mb-6" data-i18n="questionnaire.external.q${question.id}.title">${question.question}</h3>
                    
                    <div class="space-y-4">
  ${question.options.map((option, optionIndex) => {
    const value = optionIndex === question.options.length - 1 ? 0 : optionIndex + 1;
    const extraClass = optionIndex === question.options.length - 1 ? ' mt-1' : '';
    const dataChoice = value === 0 ? ' data-choice="unknown"' : '';
    const dataI18n = value === 0 ? 'question.option.dontknow' : `questionnaire.ext.q${question.id}.option${optionIndex + 1}`;
    return `
      <div class="flex items-start${extraClass}">
        <input id="eq${question.id}-${optionIndex}" name="external_question${question.id}" type="radio" value="${value}"${dataChoice} class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 mt-1" ${externalAnswers[question.id] === value ? 'checked' : ''}>
        <label for="eq${question.id}-${optionIndex}" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors">
          <span data-i18n="${dataI18n}">${option.text}</span>
        </label>
      </div>`;
  }).join('')}
</div>

                </div>
            `;
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            // Écouter les changements de réponse
            const radioButtons = questionsContent.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    externalAnswers[question.id] = parseInt(this.value);
                    updateExternalNavigationButtons();
                });
            });
            
            updateExternalNavigationButtons();
        }
        
        // Configuration de la navigation pour les questions externes
        function setupExternalQuestionNavigation() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentExternalQuestionIndex > 0) {
                        currentExternalQuestionIndex--;
                        displayExternalQuestion(currentExternalQuestionIndex);
                    }
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined) {
                        if (currentExternalQuestionIndex < EXTERNAL_QUESTIONS.length - 1) {
                            currentExternalQuestionIndex++;
                            displayExternalQuestion(currentExternalQuestionIndex);
                        }
                    } else {
                        const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                        const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.selectAnswer) || 'Veuillez sélectionner une réponse avant de continuer.';
                        alert(msg);
                    }
                });
            }
        }
        
        // Mise à jour des boutons de navigation externes
        function updateExternalNavigationButtons() {
            const prevButton = document.getElementById('prev-external-question');
            const nextButton = document.getElementById('next-external-question');
            const finishButton = document.getElementById('submit-eval');

            if (prevButton) {
                prevButton.style.display = currentExternalQuestionIndex > 0 ? 'inline-flex' : 'none';
            }

            const isLastQuestion = currentExternalQuestionIndex === EXTERNAL_QUESTIONS.length - 1;
            const hasAnswer = externalAnswers[EXTERNAL_QUESTIONS[currentExternalQuestionIndex].id] !== undefined;

            if (nextButton && finishButton) {
                if (isLastQuestion) {
                    nextButton.style.display = 'none';
                    finishButton.style.display = hasAnswer ? 'inline-flex' : 'none';
                } else {
                    nextButton.style.display = 'inline-flex';
                    finishButton.style.display = 'none';
                }
            }
        }

        function setupEvalFormSubmit() {
            const form = document.getElementById('eval-form');
            const btn = document.getElementById('submit-eval');
            if (!form || !btn) return;

            const statusEl = document.createElement('span');
            statusEl.className = 'sr-only';
            statusEl.setAttribute('aria-live', 'polite');
            btn.after(statusEl);

            function setLoadingState() {
                btn.disabled = true;
                btn.classList.remove('bg-green-500', 'bg-red-500');
                btn.innerHTML = '<span class="spinner"></span> Veuillez patienter, nous enregistrons vos réponses...';
                statusEl.textContent = 'Enregistrement en cours...';
            }

            function setSuccessState() {
                btn.disabled = true;
                btn.classList.remove('bg-red-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-green-500', 'text-white');
                btn.innerHTML = 'Succès ✅';
                statusEl.textContent = 'Enregistrement réussi';
            }

            function setRetryState() {
                btn.disabled = false;
                btn.classList.remove('bg-green-500', 'bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-500', 'text-white');
                btn.innerHTML = 'Réessayer';
                statusEl.textContent = 'Échec, réessayez';
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (btn.disabled) return;
            if (Object.keys(externalAnswers).length !== EXTERNAL_QUESTIONS.length) {
                const lang = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const msg = (window.translations && window.translations[lang] && window.translations[lang].alerts && window.translations[lang].alerts.completeAll) || 'Veuillez répondre à toutes les questions avant de terminer.';
                alert(msg);
                return;
            }
                setLoadingState();
                await new Promise(r => setTimeout(r, 0));

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);
                try {
                    await Promise.race([
                        submitExternalEvaluation(),
                        new Promise((_, reject) => {
                            controller.signal.addEventListener('abort', () => reject(new DOMException('Timeout', 'AbortError')));
                        })
                    ]);
                    setSuccessState();
                } catch (err) {
                    if (err.name === 'AbortError') {
                        alert('La requête a expiré. Veuillez réessayer.');
                    } else {
                        console.error(err);
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                    setRetryState();
                } finally {
                    clearTimeout(timeoutId);
                }
            }, { once: false });
        }

        // Fonction pour soumettre l'évaluation externe
        async function submitExternalEvaluation() {
            const code = localStorage.getItem('externalEvaluationCode');
            const relation = localStorage.getItem('externalEvaluationRelation');
            
            // Calculer les scores MBTI et Ennéagramme pour cette évaluation
            const mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            const enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
            Object.keys(externalAnswers).forEach(questionId => {
                const question = EXTERNAL_QUESTIONS.find(q => q.id === parseInt(questionId));
                const value = externalAnswers[questionId];
                if (value === 0) {
                    return;
                }
                const selectedOption = question.options[value - 1];
                // Ajouter les scores MBTI
                Object.keys(selectedOption.mbti).forEach(trait => {
                    mbtiScores[trait] += selectedOption.mbti[trait];
                });
                // Ajouter les scores Ennéagramme
                Object.keys(selectedOption.enneagram).forEach(type => {
                    enneagramScores[type] += selectedOption.enneagram[type];
                });
            });
            // Enregistrer dans Supabase
            await saveExternalEvaluationToSupabase(code, relation, mbtiScores, enneagramScores);
            // Nettoyer le stockage local temporaire
            localStorage.removeItem('externalEvaluationCode');
            localStorage.removeItem('externalEvaluationRelation');
            // Afficher un message de confirmation
            const questionsContainer = document.getElementById('questions-container');
            if (questionsContainer) {
                questionsContainer.innerHTML = '';
            }
            const modalHTML = `
                <div id="evaluation-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div id="evaluation-modal" class="bg-white rounded-lg shadow-lg p-8 max-w-md w-11/12 transform opacity-0 scale-95 transition-all duration-300">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <i class="fas fa-check text-green-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Évaluation terminée !</h2>
                        <p class="text-gray-600 mb-6">
                            Merci d'avoir pris le temps d'évaluer cette personne. Votre évaluation a été enregistrée avec le code <strong>${code}</strong>.
                        </p>
                        <p class="text-sm text-gray-500 mb-6">
                            La personne recevra ses résultats complets une fois que toutes les évaluations seront terminées.
                        </p>
                        <button id="close-evaluation-modal" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-home mr-2"></i> Retour à l'accueil
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('evaluation-modal');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            });
            document.getElementById('close-evaluation-modal').addEventListener('click', () => {
                const overlay = document.getElementById('evaluation-modal-overlay');
                if (overlay) {
                    overlay.remove();
                }
                window.location.href = 'index.html';
            });
        }

        // Chargement de la progression au démarrage
        if (loadProgress()) {
            displayQuestion(currentQuestionIndex);
        }
        
        // Gestion du menu mobile
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    const isOpen = mobileMenu.style.display === 'block';
                    
                    if (isOpen) {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    } else {
                        mobileMenu.style.display = 'block';
                        menuIcon.className = 'fas fa-times';
                        mobileMenuButton.setAttribute('aria-expanded', 'true');
                    }
                    // Remove persistent focus outline on mobile after tap
                    try { mobileMenuButton.blur(); } catch {}
                });
                
                // Fermer le menu quand on clique sur un lien
                const mobileLinks = mobileMenu.querySelectorAll('a');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        mobileMenu.style.display = 'none';
                        menuIcon.className = 'fas fa-bars';
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    });
                });
            }
        });
        
        // ===== ESPACE PERSONNEL =====
        
        // Base de données simulée des profils (non utilisée, conservée pour référence)
        /* const profilesDatabase = {
            'ABC123': {
                name: 'Jean Dupont',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-15' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-16' },
                    { relation: 'Collègue de travail', completed: false, completedAt: null }
                ],
                results: {
                    mbti: 'ENFJ',
                    enneagram: 'Type 2',
                    certainty: 91
                }
            },
            'XYZ789': {
                name: 'Marie Martin',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Partenaire amoureux', completed: true, completedAt: '2024-01-10' },
                    { relation: 'Ami(e)', completed: false, completedAt: null },
                    { relation: 'Membre de la famille', completed: false, completedAt: null }
                ],
                results: null
            },
            'DEF456': {
                name: 'Pierre Durand',
                selfEvaluationCompleted: true,
                externalEvaluations: [
                    { relation: 'Ami(e)', completed: true, completedAt: '2024-01-12' },
                    { relation: 'Collègue de travail', completed: true, completedAt: '2024-01-13' },
                    { relation: 'Membre de la famille', completed: true, completedAt: '2024-01-14' }
                ],
                results: {
                    mbti: 'INTJ',
                    enneagram: 'Type 5',
                    certainty: 87
                }
            }
        }; */

        // Fonctions de gestion de la modale
        function openProfileModal(prefillCode) {
            document.getElementById('profile-modal').classList.add('show');
            resetProfileModal();
            if (prefillCode) {
                const input = document.getElementById('profile-code');
                input.value = prefillCode.trim().toUpperCase();
                checkProfileCode();
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('show');
        }

        function resetProfileModal() {
            // Cacher toutes les étapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'étape de saisie du code
            document.getElementById('code-input-step').style.display = 'block';
            
            // Réinitialiser le champ de saisie
            document.getElementById('profile-code').value = '';
        }

        async function checkProfileCode() {
            const code = document.getElementById('profile-code').value.trim().toUpperCase();

            if (!code) {
                alert('Veuillez entrer un code');
                return;
            }

            // Récupération du profil via Supabase
            let result = await fetchUserProfileFromSupabase(code);
            console.log("🧠 Résultat brut depuis Supabase :", result);
            console.log("📘 MBTI :", result.user?.mbti_type);
            console.log("📗 Ennéagramme :", result.user?.enneagram_type);

            if (!result || !result.user) {
                // Afficher le message d'erreur
                document.querySelectorAll('.profile-step').forEach(step => {
                    step.style.display = 'none';
                });
                document.getElementById('error-message').style.display = 'block';
                return;
            }
            if (result.evaluations.length > 0) {
                const updated = await calculateFinalProfile(code);
                if (updated) {
                    result = updated;
                }
            }

            const { user, evaluations } = result;
            const overallCertainty = result.overallCertainty ?? user.certainty_score ?? null;
            // Construire un objet de profil simplifié compatible avec displayProfile
            const simplifiedProfile = {
                name: user.mbti_type && user.enneagram_type
                    ? `${user.mbti_type} — type ${user.enneagram_type}`
                    : user.mbti_type || 'Profil',
                selfEvaluationCompleted: true,
                externalEvaluations: evaluations.map(ev => ({
                    relation: ev.relation,
                    completed: true,
                    completedAt: ev.created_at
                })),
                results: user.mbti_type && user.enneagram_type
                    ? {
                        mbti: user.mbti_type,
                        enneagram: user.enneagram_type,
                        certainty: overallCertainty,
                        autoMbti: result.autoMbti || user.auto_mbti_type || null,
                        autoEnneagram: result.autoEnneagram || user.auto_enneagram_type || null,
                        externalMbti: user.mbti_type,
                        externalEnneagram: user.enneagram_type
                    }
                    : null
            };
            displayProfile(code, simplifiedProfile);
        }

        function displayProfile(code, profile) {
            // Cacher toutes les étapes
            document.querySelectorAll('.profile-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Afficher l'étape du statut
            document.getElementById('profile-status-step').style.display = 'block';
            
            // Remplir les informations du profil
            document.getElementById('profile-name').textContent = profile.name;
            document.getElementById('display-code').textContent = code;
            
            // Calculer le statut des évaluations
            const completedEvaluations = Array.isArray(profile.externalEvaluations)
                ? profile.externalEvaluations.filter(ev => ev.completed).length
                : 0;
            // Dans notre système, un minimum de trois évaluations externes est requis
            const totalEvaluationsRequired = 3;
            const totalProgress = completedEvaluations + (profile.selfEvaluationCompleted ? 1 : 0);
            const maxProgress = totalEvaluationsRequired + 1; // +1 pour l'auto-évaluation
            
            // Mettre à jour le statut des évaluations
            const evaluationsStatus = document.getElementById('evaluations-status');
            // Si toutes les évaluations requises sont terminées, afficher le statut vert, sinon statut orange.
            if (completedEvaluations >= totalEvaluationsRequired) {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                const langStatus = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const allDoneLabel = (window.translations && window.translations[langStatus] && window.translations[langStatus].profileModal && window.translations[langStatus].profileModal.step2 && window.translations[langStatus].profileModal.step2.allCompleted) || 'Toutes terminées';
                evaluationsStatus.innerHTML = `<i class="fas fa-check mr-1"></i> ${allDoneLabel}`;
            } else {
                evaluationsStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                const langStatus = document.documentElement.lang || localStorage.getItem('lang') || 'fr';
                const completedSuffix = (window.translations && window.translations[langStatus] && window.translations[langStatus].profileModal && window.translations[langStatus].profileModal.step2 && window.translations[langStatus].profileModal.step2.completedSuffix) || 'terminées';
                evaluationsStatus.innerHTML = `<i class="fas fa-clock mr-1"></i> ${completedEvaluations}/${totalEvaluationsRequired} ${completedSuffix}`;
            }
            
            // Mettre à jour la barre de progression
            const progressPercent = (totalProgress / maxProgress) * 100;
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            const lang = localStorage.getItem('lang') || 'fr';
            const suffix = translations[lang]['profileModal.step2.progressSuffix'] || '';
            document.getElementById('progress-text').textContent = `${totalProgress}/${maxProgress} ${suffix}`;
            
            // Afficher le message selon le statut (3 évaluations requises)
            displayStatusMessage(profile, completedEvaluations, 3);
        }

        function displayStatusMessage(profile, completedEvaluations, totalEvaluations) {
            const statusMessage = document.getElementById('status-message');
            const totalRequired = 3;
            const remaining = totalRequired - completedEvaluations;

            if (completedEvaluations >= totalRequired) {
                statusMessage.className = 'rounded-lg p-4 mb-4 bg-green-50 border border-green-200';
                statusMessage.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-400 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Analyse complète !</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p>Félicitations ! Toutes les évaluations ont été complétées. Vous pouvez maintenant consulter votre profil de personnalité complet.</p>
                            </div>
                        </div>
                    </div>
                `;
                updateResultsButtonState(0);
            } else {
                statusMessage.className = 'rounded-lg p-4 mb-4 bg-yellow-50 border border-yellow-200';
                const personText = remaining === 1 ? 'personne' : 'personnes';
                statusMessage.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-400 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Évaluations en cours</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>Il reste <strong>${remaining} ${personText}</strong> qui ${remaining === 1 ? 'doit' : 'doivent'} compléter l’évaluation pour améliorer le niveau de certitude de votre profil et accéder à votre page de résultats détaillés. Cette page présente votre profil MBTI et votre profil Ennéagramme, leur niveau de certitude respectif, des graphiques pour y voir plus clair, une description personnalisée de votre profil par Psycho’Bot, ainsi que les résultats de chaque évaluateur et leur cohérence interne.</p>
                                <p class="mt-1">Partagez votre code unique avec vos proches pour qu’ils puissent vous évaluer et vous donner accès à cette page.</p>
                            </div>
                        </div>
                    </div>
                `;
                updateResultsButtonState(remaining);
            }
        }

        function updateResultsButtonState(remaining) {
            const btn = document.getElementById('seeResultsBtn');
            if (!btn) return;
            if (remaining > 0) {
                if (!btn.dataset.onclick && btn.getAttribute('onclick')) {
                    btn.dataset.onclick = btn.getAttribute('onclick');
                }
                btn.removeAttribute('onclick');
                btn.setAttribute('disabled', 'disabled');
                btn.setAttribute('aria-disabled', 'true');
                btn.classList.add('opacity-60', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.remove('bg-black', 'hover:bg-gray-800');
                btn.setAttribute('title', 'Complétez d’abord 3 évaluations externes pour accéder à vos résultats détaillés.');
            } else {
                if (btn.dataset.onclick) {
                    btn.setAttribute('onclick', btn.dataset.onclick);
                }
                btn.removeAttribute('disabled');
                btn.removeAttribute('aria-disabled');
                btn.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-gray-300');
                btn.classList.add('bg-black', 'hover:bg-gray-800');
                btn.removeAttribute('title');
            }
        }

        function shareCode() {
            const code = document.getElementById('display-code')?.textContent ||
                         document.getElementById('unique-code')?.textContent ||
                         (typeof userCode !== 'undefined' ? userCode : '');

            if (!code) {
                alert('Aucun code à partager');
                return;
            }

            const shareText = `Salut ! Peux-tu m'aider à mieux comprendre ma personnalité ? Utilise ce code ${code} sur https://personnalitecomparee.com pour m'évaluer. Merci ! 😊`;

            if (navigator.share) {
                navigator.share({
                    title: 'Évaluation de personnalité',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Message copié dans le presse-papiers ! Vous pouvez le partager avec vos proches.');
                }).catch(() => {
                    prompt('Copiez ce message pour le partager:', shareText);
                });
            }
        }

        async function viewResults(codeParam) {
            const userCode = (codeParam || document.getElementById('display-code').textContent)
                .trim()
                .toUpperCase();

            if (!userCode) {
                alert('Veuillez entrer un code');
                return;
            }

            const initial = await fetchUserProfileFromSupabase(userCode);

            if (!initial) {
                alert('Code introuvable');
                return;
            }

            if (initial.evaluations.length === 0) {
                alert('Au moins une évaluation externe est nécessaire pour afficher le résultat final.');
                return;
            }

            const selfProfile = getProfileFromScores(initial.user.mbti_scores || {}, initial.user.enneagram_scores || {});
            // Backfill DB auto_* si manquants
            try {
                if ((!initial.user.auto_mbti_type || !initial.user.auto_enneagram_type) && selfProfile.mbtiType && selfProfile.enneagramType) {
                    await supabase
                      .from('users')
                      .update({ auto_mbti_type: selfProfile.mbtiType, auto_enneagram_type: selfProfile.enneagramType })
                      .eq('id', initial.user.id);
                }
            } catch (e) { console.warn('Backfill auto_* failed:', e); }

            const result = await calculateFinalProfile(userCode);

            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Le résultat final n’est pas encore prêt.');
                return;
            }

            const externalProfiles = result.evaluations.map(ev => {
                const { mbtiType, enneagramType } = getProfileFromScores(ev.mbti_scores, ev.enneagram_scores);
                const coherenceMBTI = getCohérenceMBTI(ev.mbti_scores);
                const coherenceEnneagramme = getCohérenceEnnéagramme(ev.enneagram_scores);
                return {
                    relation: ev.relation,
                    mbti: mbtiType,
                    enneagram: enneagramType,
                    coherenceMBTI,
                    coherenceEnneagramme,
                    completed: true,
                    completedAt: ev.created_at
                };
            });
            const certaintyScore = result.overallCertainty ??
                (result.user.certainty_score != null ? Number(result.user.certainty_score) : null);
            const enneaWing = computeEnneagramWing(result.user.enneagram_scores, result.user.enneagram_type);
            const finalProfile = {
                uniqueCode: userCode,
                name: `${result.user.mbti_type} — Type ${result.user.enneagram_type}${enneaWing ? 'w' + enneaWing : ''}`,
                self: { mbti: selfProfile.mbtiType, enneagram: selfProfile.enneagramType },
                results: {
                    mbti: result.user.mbti_type,
                    mbtiCertainty: result.mbtiCertainty ?? certaintyScore,
                    enneagram: result.user.enneagram_type,
                    enneagramWing: enneaWing,
                    enneagramCertainty: result.enneagramCertainty ?? certaintyScore,
                    overallCertainty: certaintyScore,
                    autoMbti: selfProfile.mbtiType,
                    autoEnneagram: selfProfile.enneagramType,
                    externalMbti: result.user.mbti_type,
                    externalEnneagram: result.user.enneagram_type
                },
                externalEvaluations: externalProfiles,
                mbtiScores: result.user.mbti_scores,
                enneagramScores: result.user.enneagram_scores,
                externalCount: result.evaluations.length
            };
            closeProfileModal();
            displayDetailedResults(finalProfile, userCode);
        }

        function displayDetailedResults(profile, code) {
            // Créer une nouvelle modale pour les résultats
            const overall = (profile.results && profile.results.overallCertainty != null)
              ? Number(profile.results.overallCertainty)
              : Math.round(((Number(profile.results?.mbtiCertainty ?? 0) + Number(profile.results?.enneagramCertainty ?? 0)) || 0) / 2);
            const resultsModal = document.createElement('div');
            resultsModal.id = 'results-modal';
            resultsModal.className = 'modal show';
            resultsModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="text-xl font-bold text-gray-900">Résultats Détaillés - ${profile.name}</h2>
                        <span class="close" onclick="closeResultsModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-6">
                            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                                <i class="fas fa-chart-pie text-green-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Analyse Complète</h3>
                            <p class="text-sm text-gray-500">Code: <span class="font-mono font-bold">${code}</span></p>
                        </div>

                        <!-- Résultats MBTI et Ennéagramme -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-semibold text-blue-900 mb-2">Type MBTI</h4>
            <div class="text-2xl font-bold text-blue-600 mb-2">${profile.results.mbti}</div>
            <div class="mt-2">
              ${
                profile.results.mbtiCertainty != null
                  ? `<p class="mb-1">Certitude</p>
                     <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
                       <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-blue-500 transition-all duration-1000" data-width="${profile.results.mbtiCertainty}" style="width:0"></div>
                       <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.mbtiCertainty}%</span>
                     </div>`
                  : `<p>Certitude : Données en cours...</p>`
              }
            </div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <h4 class="font-semibold text-purple-900 mb-2">Ennéagramme</h4>
            <div class="text-2xl font-bold text-purple-600 mb-2">Type ${profile.results.enneagram}${profile.results.enneagramWing ? 'w' + profile.results.enneagramWing : ''}</div>
            <div class="mt-2">
              ${
                profile.results.enneagramCertainty != null
                  ? `<p class="mb-1">Certitude</p>
                     <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
                       <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-purple-500 transition-all duration-1000" data-width="${profile.results.enneagramCertainty}" style="width:0"></div>
                       <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${profile.results.enneagramCertainty}%</span>
                     </div>`
                  : `<p>Certitude : Données en cours...</p>`
              }
            </div>
          </div>
        </div>

        <!-- Certitude globale -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="mb-1">Certitude globale</p>
          <div class="relative w-full bg-gray-200 h-6 rounded overflow-hidden" data-aos="fade-right">
            <div class="certainty-bar absolute left-0 top-0 h-full rounded bg-green-500 transition-all duration-1000" data-width="${overall}" style="width:0"></div>
            <span class="absolute w-full text-center text-white font-bold text-sm leading-6">${overall}%</span>
          </div>
          <p class="text-sm text-gray-600 mt-2">Basé sur les évaluations de vos proches</p>
          ${profile.externalCount < 3 ? `<p class="text-sm text-yellow-700 mt-2">🔎 Augmentez votre niveau de certitude en complétant les 3 évaluations externes (famille, partenaire, ami ou collègue).</p>` : ''}
        </div>


        <!-- Graphiques MBTI & Ennéagramme -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Dichotomies MBTI</h4>
            <canvas id="mbtiChart" height="300"></canvas>
          </div>
          <div class="bg-white rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Types Ennéagramme</h4>
            <canvas id="enneagramChart" height="220"></canvas>
          </div>
        </div>

        <div id="ai-profile-summary" class="mt-6 bg-gray-50 rounded-lg p-5 shadow-sm mb-6">
            <h4 class="font-semibold text-gray-900 text-lg mb-3">Description succincte du profil par Psycho'Bot</h4>
            <div id="ai-summary-content" class="relative text-sm leading-relaxed text-gray-700 max-h-80 overflow-y-auto">
                Génération en cours…
                <div id="scroll-indicator" aria-hidden="true" class="pointer-events-none hidden absolute inset-x-0 bottom-0 h-10 bg-gradient-to-b from-transparent to-white flex items-end justify-center pb-1 text-gray-500">
                    <span class="text-xl animate-bounce">⌄</span>
                </div>
            </div>
        </div>

                            <!-- Détail des évaluations -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">Détail des évaluations</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700" data-i18n="results.details.selfEvaluation">Auto-évaluation</span>
                                        <div class="text-xs text-gray-500">${profile.self.mbti} — type ${profile.self.enneagram}</div>
                                    </div>
                                    <span class="text-sm text-green-600 font-medium">✓ Complétée</span>
                                </div>
                                ${profile.externalEvaluations.map(evaluation => `
                                    <div class="flex items-center justify-between p-3 ${evaluation.completed ? 'bg-green-50' : 'bg-gray-50'} rounded-lg">
                                        <div>
                                            <span class="text-sm font-medium text-gray-700">${evaluation.relation}</span>
                                            <div class="text-xs text-gray-500">${evaluation.mbti} — type ${evaluation.enneagram} — MBTI : <strong>Cohérence ${evaluation.coherenceMBTI}</strong> — Ennéagramme : <strong>Cohérence ${evaluation.coherenceEnneagramme}</strong></div>
                                        </div>
                                        <span class="text-sm ${evaluation.completed ? 'text-green-600' : 'text-gray-500'} font-medium">
                                            ${evaluation.completed ? '✓ Complétée le ' + new Date(evaluation.completedAt).toLocaleDateString('fr-FR') : '⏳ En attente'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

<div class="mt-8 mb-6 p-4 rounded-lg bg-gray-100 border border-gray-300 text-xs text-gray-700 leading-relaxed">
  <p class="mb-2"><strong> Cohérence</strong> : détermine dans quelle mesure les réponses d’un proche sont logiquement stables.</p>
  <ul class="list-disc list-inside space-y-1">
    <li><strong>Forte</strong> → peu voire pas de contradictions, réponses alignées</li>
    <li><strong>Moyenne</strong> → quelques hésitations ou contradictions</li>
    <li><strong>Faible</strong> → réponses peu cohérentes entre elles</li>
  </ul>
</div>

<div class="mt-6 mb-6 flex justify-center">
  <img src="logobanniere.jpeg" alt="Logo Personnalité Comparée" class="h-24 object-contain opacity-90" />
</div>




                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="shareProfileResults('${code}')" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                                <i class="fas fa-share mr-2"></i>
                                Partager
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
    document.body.appendChild(resultsModal);
    initCountUp(resultsModal);

            // Animer les barres de certitude
            resultsModal.querySelectorAll('.certainty-bar').forEach(bar => {
                const width = bar.dataset.width;
                requestAnimationFrame(() => {
                    bar.style.width = width + '%';
                });
            });
            if (window.AOS) {
                AOS.refresh();
            }
            renderCharts(profile, resultsModal);
            initAiProfileSummary(profile, code);
        }

        function renderCharts(profile, container) {
            const mbtiCanvas = container.querySelector('#mbtiChart');
            const enneaCanvas = container.querySelector('#enneagramChart');
            const enoughEvaluations = profile.externalCount >= 3;
            const hasMbtiScores = profile.mbtiScores && Object.values(profile.mbtiScores).some(v => v > 0);
            const hasEnneaScores = profile.enneagramScores && Object.values(profile.enneagramScores).some(v => v > 0);

            if (!enoughEvaluations || !hasMbtiScores || !hasEnneaScores) {
                const message = document.createElement('p');
                message.className = 'text-sm text-gray-500 text-center';
                message.textContent = 'Données en attente (minimum 3 évaluations externes requises).';
                if (mbtiCanvas) {
                    mbtiCanvas.remove();
                    mbtiCanvas.parentElement.appendChild(message.cloneNode(true));
                }
                if (enneaCanvas) {
                    enneaCanvas.remove();
                    enneaCanvas.parentElement.appendChild(message);
                }
                return;
            }

            const mbtiCtx = mbtiCanvas.getContext('2d');
            const clamp = (val) => Math.min(100, Math.max(0, val));
            const mbtiData = [
                { label: 'Fi', value: clamp(profile.mbtiScores.Fi || 0) },
                { label: 'Fe', value: clamp(profile.mbtiScores.Fe || 0) },
                { label: 'Ti', value: clamp(profile.mbtiScores.Ti || 0) },
                { label: 'Te', value: clamp(profile.mbtiScores.Te || 0) },
                { label: 'Si', value: clamp(profile.mbtiScores.Si || 0) },
                { label: 'Se', value: clamp(profile.mbtiScores.Se || 0) },
                { label: 'Ni', value: clamp(profile.mbtiScores.Ni || 0) },
                { label: 'Ne', value: clamp(profile.mbtiScores.Ne || 0) }
            ];
            const mbtiDescriptions = {
                Fi: 'Sentiment Introverti',
                Fe: 'Sentiment Extraverti',
                Ti: 'Pensée Introvertie',
                Te: 'Pensée Extravertie',
                Si: 'Sensation Introvertie',
                Se: 'Sensation Extravertie',
                Ni: 'Intuition Introvertie',
                Ne: 'Intuition Extravertie'
            };
            Chart.register(ChartDataLabels);
            new Chart(mbtiCtx, {
                type: 'bar',
                data: {
                    labels: mbtiData.map(d => d.label),
                    datasets: [{
                        data: mbtiData.map(d => d.value),
                        backgroundColor: '#93C5FD',
                        borderRadius: 8,
                        barThickness: 20,
                        categoryPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 },
                        y: { ticks: { autoSkip: false } }
                    },
                    layout: {
                        padding: { top: 10, bottom: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${mbtiDescriptions[mbtiData[ctx.dataIndex].label]}: ${ctx.parsed.x}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${value}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });

            const enneaCtx = enneaCanvas.getContext('2d');
            const enneaLabels = Object.keys(profile.enneagramScores).sort();
            const enneaValues = enneaLabels.map(k => Math.round(profile.enneagramScores[k]));
            const maxIndex = enneaValues.indexOf(Math.max(...enneaValues));
            const enneaColors = enneaValues.map((v, i) => i === maxIndex ? '#A855F7' : '#D8B4FE');
            const enneagramDescriptions = {
                1: 'Le Réformateur',
                2: "L'Altruiste",
                3: 'Le Performeur',
                4: "L'Individualiste",
                5: "L'Investigateur",
                6: 'Le Loyaliste',
                7: "L'Épicurien",
                8: 'Le Chef',
                9: 'Le Médiateur'
            };
            new Chart(enneaCtx, {
                type: 'bar',
                data: {
                    labels: enneaLabels.map(t => `Type ${t}`),
                    datasets: [{
                        data: enneaValues,
                        backgroundColor: enneaColors,
                        borderColor: enneaValues.map((v, i) => i === maxIndex ? '#7C3AED' : 'transparent'),
                        borderWidth: enneaValues.map((v, i) => i === maxIndex ? 2 : 0),
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.parsed.x}% - ${enneagramDescriptions[enneaLabels[ctx.dataIndex]]}`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: value => `${value}%`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }

        function setupScrollIndicator(container) {
            if (!container || container.__scrollIndicatorInitialized) return;
            const indicator = container.querySelector('#scroll-indicator');
            if (!indicator) return;

            const update = () => {
                const needsScroll = container.scrollHeight > container.clientHeight + 1;
                const scrolled = container.scrollTop > 8;
                const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 4;
                if (needsScroll && !scrolled && !atBottom) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            };

            container.addEventListener('scroll', update);
            window.addEventListener('resize', update);
            const observer = new MutationObserver(() => requestAnimationFrame(update));
            observer.observe(container, { childList: true, characterData: true, subtree: true });

            container.__scrollIndicatorInitialized = true;
            requestAnimationFrame(update);
        }

        async function initAiProfileSummary(profile, code) {
            const container = document.querySelector('#results-modal #ai-summary-content');
            if (!container || container.dataset.loading === '1') return;

            // 0) Préférence: récupérer depuis profile.results si disponibles
            let autoMbti = (profile && profile.results && profile.results.autoMbti) || null;
            let autoEnneagram = (profile && profile.results && profile.results.autoEnneagram) || null;
            let externalMbti = (profile && profile.results && (profile.results.externalMbti || profile.results.mbti)) || null;
            let externalEnneagram = (profile && profile.results && (profile.results.externalEnneagram || profile.results.enneagram)) || null;

            // 1) Auto-éval depuis profile.self si présent (fallback robuste)
            try {
                if ((!autoMbti || !autoEnneagram) && profile && profile.self) {
                    autoMbti = autoMbti || profile.self.mbti || profile.self.mbtiType || null;
                    autoEnneagram = autoEnneagram || profile.self.enneagram || profile.self.enneagramType || null;
                }
            } catch (_) {}

            // 1b) Auto-évaluation depuis localStorage (fallback)
            try {
                if (!autoMbti || !autoEnneagram) {
                    const raw = localStorage.getItem('userProfile_' + code);
                    if (raw) {
                        const up = JSON.parse(raw);
                        autoMbti = autoMbti || up.mbtiType || null;
                        autoEnneagram = autoEnneagram || up.enneagramType || null;
                    }
                }
            } catch (_) {}

            // 2) Évaluations externes via Supabase (agrégation locale) si nécessaire
            try {
                if ((!externalMbti || !externalEnneagram) && typeof fetchUserProfileFromSupabase === 'function' && typeof computeWeightedResults === 'function') {
                    const r = await fetchUserProfileFromSupabase(code);
                    const evaluations = (r && Array.isArray(r.evaluations)) ? r.evaluations : [];
                    if (evaluations.length > 0) {
                        const weighted = computeWeightedResults(evaluations);
                        externalMbti = weighted.mbtiType || null;
                        externalEnneagram = weighted.enneagramType || null;
                    }
                    // 2b) Compléter l'auto depuis la DB si encore manquant
                    if ((!autoMbti || !autoEnneagram) && r && r.user) {
                        autoMbti = autoMbti || r.user.auto_mbti_type || null;
                        autoEnneagram = autoEnneagram || r.user.auto_enneagram_type || null;
                    }
                }
            } catch (e) {
                console.warn('Impossible de calculer le profil externe agrégé:', e);
            }

            // 3) Fallback si pas d'auto détectée et pas d'évaluations externes: utiliser le profil courant
            if (!autoMbti || !autoEnneagram) {
                if (!externalMbti && !externalEnneagram && profile && profile.results) {
                    autoMbti = autoMbti || profile.results.mbti || null;
                    autoEnneagram = autoEnneagram || profile.results.enneagram || null;
                }
            }

            const cacheKey = `ai-summary:v3:${code}:${autoMbti || ''}:${autoEnneagram || ''}:${externalMbti || ''}:${externalEnneagram || ''}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                console.info('[AI Summary]', 'cache hit', cacheKey);
                container.textContent = cached;
                setupScrollIndicator(container);
                return;
            }

            console.info('[AI Summary]', 'cache miss', cacheKey);
            container.setAttribute('data-loading', '1');

            // Toujours générer un COMPARATIF, même si certaines infos manquent.
            const mbtiAuto = autoMbti || 'indisponible';
            const enneaAuto = autoEnneagram || 'indisponible';
            const mbtiExt = externalMbti || 'indisponible';
            const enneaExt = externalEnneagram || 'indisponible';

            const messages = [
                { role: 'system', content: "Tu es Psycho'Bot, un psychologue pédagogique. Écris en français clair et nuancé, sans jargon. Adresse-toi directement à la personne (tutoiement), ton amical, empathique, bienveillant et concret." },
                { role: 'user', content: `Comparatif entre auto-évaluation et évaluations externes pour la même personne.\n\n1) Auto-évaluation (vision subjective)\nMBTI=${mbtiAuto}, Ennéagramme=${enneaAuto}\n\n2) Évaluations externes (vision des proches)\nMBTI=${mbtiExt}, Ennéagramme=${enneaExt}\n\nTa tâche (respecte impérativement cette structure) :\n- Convergences (où ça se rejoint).\n- Divergences (où ça diffère).\n- Lecture psychologique : biais possibles, angles morts, cohérences/contradictions.\n- Synthèse positive : comment cette comparaison aide à mieux te connaître.\n\nRègles : 350 mots max, phrases courtes, tutoiement, ton positif et pédagogique. Si une info est manquante, indique en quoi cette absence peut biaiser l'analyse et compare tout de même ce qui est disponible. N'inclus pas de diagnostic médical/clinique.` }
            ];

            let totalText = '';
            let attempts = 0;

            while (true) {
                try {
                    const response = await fetch('/api/psy-results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages })
                    });

                    if (!response.ok) throw new Error('bad response');
                    const data = await response.json();
                    totalText += data.content || '';

                    if (data.finish_reason && data.finish_reason !== 'stop') {
                        messages.push({ role: 'assistant', content: data.content || '' });
                        messages.push({ role: 'user', content: 'continue' });
                        continue;
                    }

                    const finalText = totalText.trim();
                    container.textContent = finalText || "Description indisponible pour le moment.";
                    if (finalText) localStorage.setItem(cacheKey, finalText);
                    break;
                } catch (e) {
                    console.error('Erreur IA:', e);
                    attempts++;
                    if (attempts < 2) {
                        container.textContent = "Échec de la génération, nouvelle tentative…";
                        continue;
                    }
                    container.textContent = "Impossible de terminer la description";
                    break;
                }
            }

            container.removeAttribute('data-loading');
            setupScrollIndicator(container);
        }

        function closeResultsModal() {
            const modal = document.getElementById('results-modal');
            if (modal) {
                modal.remove();
            }
        }


        async function shareProfileResults(code) {
            const result = await fetchUserProfileFromSupabase(code);
            if (!result || !result.user.mbti_type || !result.user.enneagram_type) {
                alert('Impossible de partager : le profil complet n’est pas encore disponible.');
                return;
            }
            const description = document.getElementById('ai-summary-content')?.innerText.trim() || '';
            shareProfile(result.user.mbti_type, `Type ${result.user.enneagram_type}`, description);
        }

        function shareProfile(mbti, enneagram, description) {
            const shareText = buildShareText(mbti, enneagram, description);
            const url = 'https://www.personnalitecomparee.com';
            if (navigator.share) {
                navigator.share({ title: 'Mon profil de personnalité', text: shareText, url });
            } else {
                showShareFallback(shareText, url);
            }
        }

        function buildShareText(mbti, enneagram, description) {
            return `Hey ! Je viens de passer l'évaluation du site www.personnalitecomparee.com et voici mon profil !\nJe suis "${mbti} et ${enneagram}"\nVoici une petite description de ma personnalité : "${description}"\nDites-moi si vous me reconnaissez et n'hésitez pas à aller passer aussi votre test ici : www.personnalitecomparee.com`;
        }

        function showShareFallback(text, url) {
            const existing = document.getElementById('share-fallback');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'share-fallback';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            const links = [
                { name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}` },
                { name: 'WhatsApp', url: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}` },
                { name: 'X/Twitter', url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}` },
                { name: 'LinkedIn', url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}` },
                { name: 'Telegram', url: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}` },
                { name: 'Email', url: `mailto:?subject=${encodeURIComponent('Mon profil de personnalité')}&body=${encodeURIComponent(text + ' ' + url)}` }
            ];
            overlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
                    <h3 class="text-lg font-medium mb-4">Partager</h3>
                    <div class="flex flex-col space-y-2">
                        ${links.map(l => `<a href="${l.url}" target="_blank" class="px-4 py-2 rounded hover:bg-gray-100">${l.name}</a>`).join('')}
                    </div>
                    <button class="mt-4 w-full px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" onclick="document.getElementById('share-fallback').remove()">Fermer</button>
                </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
        }


        // Fermer la modale en cliquant à l'extérieur
        window.onclick = function(event) {
            const profileModal = document.getElementById('profile-modal');
            const resultsModal = document.getElementById('results-modal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === resultsModal) {
                closeResultsModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            const profileModal = document.getElementById('profile-modal');
            const resultsModal = document.getElementById('results-modal');
            if (event.key === 'Escape') {
                if (resultsModal) { closeResultsModal(); }
                if (profileModal) { closeProfileModal(); }
            }
        });

        // Permettre la saisie du code avec Entrée
        document.addEventListener('DOMContentLoaded', function() {
            const profileCodeInput = document.getElementById('profile-code');
            if (profileCodeInput) {
                profileCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkProfileCode();
                    }
                });
                
                // Forcer la saisie en majuscules
                profileCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
        });
    </script>

    <!-- Modales pour les descriptions détaillées -->
    <div id="modal-container"></div>

    <!-- Modale Espace Personnel -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900" data-i18n="profileModal.title">Mon Espace Personnel</h2>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Étape 1: Saisie du code -->
                <div id="code-input-step" class="profile-step">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                            <i class="fas fa-key text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="profileModal.step1.title">Accédez à votre profil</h3>
                        <p class="text-sm text-gray-500" data-i18n="profileModal.step1.desc">Entrez votre code unique pour consulter vos résultats</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="profile-code" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="profileModal.codeLabel">Code unique</label>
                            <input type="text" id="profile-code" placeholder="Entrez votre code (ex: ABC123)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono tracking-wider uppercase" data-i18n-placeholder="profileModal.codePlaceholder">
                        </div>
                        <button onclick="checkProfileCode()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            <span data-i18n="profileModal.accessButton">Accéder à mon profil</span>
                        </button>
                    </div>
                </div>

                <!-- Étape 2: Statut des évaluations -->
                <div id="profile-status-step" class="profile-step" style="display: none;">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                            <i class="fas fa-user-circle text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2"><span data-i18n="profileModal.step2.title">Profil de</span> <span id="profile-name"></span></h3>
                        <p class="text-sm text-gray-500"><span data-i18n="profileModal.step2.codeLabel">Code:</span> <span id="display-code" class="font-mono font-bold"></span></p>
                    </div>

                    <!-- Statut des évaluations -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-gray-900 mb-3" data-i18n="profileModal.step2.statusTitle">Statut des évaluations</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600" data-i18n="profileModal.step2.selfEval">Votre auto-évaluation</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i> <span data-i18n="profileModal.step2.completed">Terminée</span>
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600" data-i18n="profileModal.step2.relativesEval">Évaluations des proches</span>
                                <span id="evaluations-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                    <!-- Sera rempli dynamiquement -->
                                </span>
                            </div>
                        </div>
                        
                        <!-- Barre de progression -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span data-i18n="profileModal.step2.progress">Progression globale</span>
                                <span id="progress-text" data-i18n="profileModal.step2.progressText">0/4 terminé</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Message selon le statut -->
                    <div id="status-message" class="rounded-lg p-4 mb-4">
                        <!-- Sera rempli dynamiquement -->
                    </div>

                    <!-- Actions -->
                    <div class="flex space-x-3">
                        <button onclick="shareCode()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <i class="fas fa-share mr-2"></i>
                            <span data-i18n="profile.complete.button.share">Partager mon code</span>
                        </button>
                        <button id="seeResultsBtn" onclick="viewResults()" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <i class="fas fa-chart-pie mr-2"></i>
                            <span data-i18n="profile.complete.button.results">Voir mes résultats</span>
                        </button>
                    </div>
                </div>

                <!-- Message d'erreur -->
                <div id="error-message" class="profile-step" style="display: none;">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="profileModal.error.title">Code introuvable</h3>
                        <p class="text-sm text-gray-500 mb-4" data-i18n="profileModal.error.desc">Le code que vous avez entré n'existe pas ou est incorrect.</p>
                        <button onclick="resetProfileModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">
                            <span data-i18n="profileModal.error.retry">Réessayer</span>
                        </button>
                    </div>
                </div>
    </div>
        </div>
    </div>



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const homeLinks = document.querySelectorAll('.scroll-top-link');
      const brand = document.getElementById('brand-home');

      function handleScrollTop(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.body.classList.add('scroll-highlight');
        setTimeout(() => document.body.classList.remove('scroll-highlight'), 1000);
      }

      homeLinks.forEach(link => link.addEventListener('click', handleScrollTop));
      if (brand) brand.addEventListener('click', handleScrollTop);
    });
  </script>

  <script type="module">
  import { supabase } from "./common.js";

  const externalForm = document.getElementById("external-form");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code")?.toUpperCase();
  const encodedCode = code ? encodeURIComponent(code) : null;

  if (encodedCode) {
    (async () => {
      if (externalForm) {
        externalForm.style.display = "none";
      }

      try {
        const { data: user, error } = await supabase
          .from("users")
          .select("id")
          .eq("code", encodedCode)
          .single();

        if (error || !user) {
          alert("Code invalide ou introuvable.");
          return;
        } else if (externalForm) {
          externalForm.style.display = "";
        }
      } catch (err) {
        console.error("Erreur lors de la vérification du code :", err);
        alert("Code invalide ou introuvable.");
        return;
      }
    })();
  }

  if (externalForm) {
    externalForm.addEventListener("submit", (e) => {
      e.preventDefault();
      alert("Merci pour votre participation. Les résultats sont disponibles dans la section 'Mon profil'.");
      externalForm.reset();
      externalForm.style.display = "none";
    });
  }
</script>

<script>
  document.querySelectorAll('.type-card').forEach((card, idx) => {
    card.setAttribute('data-aos', 'fade-up');
    card.setAttribute('data-aos-delay', (idx % 3) * 100);
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 600,
    easing: 'ease-out',
    once: true
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (function(){
  const wrap = (()=>{
    // Essaie plusieurs sélecteurs raisonnables
    return document.querySelector('section#hero, section.hero, .hero, .banner, [data-hero]') ||
           [...document.querySelectorAll('section')].find(s => /vraiment|analyse/i.test(s.textContent)) ||
           document.body;
  })();
  wrap.classList.add('pc-hero');

  // Si pas déjà présent, injecte le canvas
  let canvas = document.getElementById('pc-constellation');
  if(!canvas){
    canvas = document.createElement('canvas');
    canvas.id = 'pc-constellation';
    wrap.prepend(canvas);
  }
  // Classe de position déjà ajoutée pour garantir la superposition correcte

  const ctx = canvas.getContext('2d', { alpha: true });
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  const N = 80;               // nombre de points
  let LINK_DIST = 100;        // distance de connexion
  let MAX_LINKS = N;          // connexions maximales par point
  let BASE_OPACITY = 0.25;    // opacité maximale des lignes
  const mouse = { x:0, y:0, inside:false };
  const DRIFT = 0.008;                  // amplitude du drift autonome
  const ALLOW_DRIFT = matchMedia('(pointer: coarse)').matches;
  let pts = [], W=0, H=0;

  function resize(){
    const { width, height } = wrap.getBoundingClientRect();
    W = canvas.width  = Math.floor(width * DPR);
    H = canvas.height = Math.floor(height * DPR);
    canvas.style.width  = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    if(!pts.length){
      pts = Array.from({length:N}, ()=>({
        x: Math.random()*width,
        y: Math.random()*height,
        vx: (Math.random()-.5)*.25,
        vy: (Math.random()-.5)*.25
      }));
    }
  }

  function updateConnectivity(){
    if (window.innerWidth <= 768) {
      LINK_DIST = 65;         // distance de connexion augmentée
      MAX_LINKS = 3;          // un peu plus de liaisons par point
      BASE_OPACITY = 0.55;    // mobile
    } else {
      LINK_DIST = 120;        // distance de connexion augmentée
      MAX_LINKS = N;          // inchangé pour desktop
      BASE_OPACITY = 0.45;    // desktop
    }
  }

  resize();
  updateConnectivity();
  addEventListener('resize', () => { resize(); updateConnectivity(); });

  // Suivi souris uniquement dans la bannière
  wrap.addEventListener('mouseenter', ()=>mouse.inside = true);
  wrap.addEventListener('mouseleave', ()=>mouse.inside = false);
  wrap.addEventListener('mousemove', e=>{
    const r = canvas.getBoundingClientRect();
    mouse.x = e.clientX - r.left;
    mouse.y = e.clientY - r.top;
  });

  let stop = matchMedia('(prefers-reduced-motion: reduce)').matches;
  matchMedia('(prefers-reduced-motion: reduce)').addEventListener?.('change', e=>{ stop = e.matches; });

  function frame(){
    if(stop) return; // respect R.M.
    const r = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,r.width,r.height);

    // --- Move
    for(const p of pts){
      if(mouse.inside){
        const dx = mouse.x - p.x, dy = mouse.y - p.y;
        const d = Math.hypot(dx,dy) || 1;
        // Attraction "un cran au-dessus de modéré"
        const force = Math.min(0.035, 9/(d*d));
        p.vx += (dx/d)*force;
        p.vy += (dy/d)*force;
      } else if(ALLOW_DRIFT){
        // léger mouvement autonome sur mobile
        p.vx += (Math.random()-.5)*DRIFT;
        p.vy += (Math.random()-.5)*DRIFT;
      }
      // friction + clamp
      p.vx *= 0.991; p.vy *= 0.991;
      const vmax = 0.9; // vitesse max
      const sp = Math.hypot(p.vx,p.vy);
      if(sp>vmax){ p.vx = p.vx/sp*vmax; p.vy = p.vy/sp*vmax; }

      p.x += p.vx; p.y += p.vy;
      if(p.x<0||p.x>r.width)  p.vx *= -1;
      if(p.y<0||p.y>r.height) p.vy *= -1;
    }

    // --- Lines
    ctx.lineWidth = 0.6;
    const linksCount = new Array(N).fill(0);
    for(let i=0;i<N;i++){
      for(let j=i+1;j<N;j++){
        const a=pts[i], b=pts[j];
        const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
        if(d<LINK_DIST && linksCount[i] < MAX_LINKS && linksCount[j] < MAX_LINKS){
          const o = 1 - d/LINK_DIST;
          ctx.strokeStyle = `rgba(59,130,246,${(o*BASE_OPACITY).toFixed(3)})`; // bleu #3B82F6
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          linksCount[i]++;
          linksCount[j]++;
        }
      }
    }
    ctx.fillStyle = 'rgba(10,15,26,.62)';
    for(const p of pts){
      ctx.beginPath();
      const r = (window.innerWidth <= 768) ? 1.3 : 1.6;
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  })();
});
</script>

<!-- Typed doit être chargé avant notre script pour l’effet progressif -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>

<script>
  // Styles (arrondis + grille des suggestions)
  (function addChatStyles(){
    const s=document.createElement('style');
    s.textContent=`
      #chat-window{border-radius:32px!important;overflow:hidden!important;}
      #chat-input{border-radius:9999px 0 0 9999px!important;}
      #chat-send{border-radius:0 9999px 9999px 0!important;}
      #chat-box{display:flex;flex-direction:column;gap:8px;}
      .user-bubble{align-self:flex-end;background:#e8f0ff;padding:10px 12px;border-radius:14px;max-width:85%;}
      .assistant-bubble{align-self:flex-start;background:#f6f6f6;padding:10px 12px;border-radius:14px;max-width:85%;}
      /* Grille: 2 boutons sur la 1ère ligne, 3e centré en dessous */
      #chat-suggestions{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;}
      #chat-suggestions .suggestion-bubble:nth-child(3){grid-column:1 / -1;justify-self:center;}
    `;
    document.head.appendChild(s);
  })();

  // ===== Mémoire locale + trim =====
  let messages = JSON.parse(localStorage.getItem("chatHistory")) || [];
  const MAX_CONTEXT_TOKENS_CLIENT = 1600;

  function estimateTokens(str){ return Math.ceil((str||"").length/4); }
  function trimHistoryClient(msgs,budgetTokens){
    const keep=[]; let total=0;
    for(let i=msgs.length-1;i>=0;i--){
      const m=msgs[i];
      const c=typeof m.content==="string"?m.content:JSON.stringify(m.content);
      const cost=estimateTokens(c)+8;
      if(total+cost>budgetTokens) break;
      keep.push(m); total+=cost;
    }
    return keep.reverse();
  }

  // ===== UI helpers =====
  function setTyping(on){ const el=document.getElementById("pc-typing-indicator"); if(el) el.hidden=!on; }
  function safeScrollToBottom(el){ el.scrollTo({top:el.scrollHeight,behavior:'smooth'}); }

  function toggleSuggestions(){
    const sugg=document.getElementById('chat-suggestions');
    if(!sugg) return;
    // si conversation existante -> cachées, sinon -> visibles en grille
    sugg.style.display = messages.length ? 'none' : 'grid';
  }

  function appendMessage(role,text,{typing=(role==='assistant'),skipPersist=false}={}){
    const chatBox=document.getElementById("chat-box"); if(!chatBox) return;
    const row=document.createElement('div'); row.className=`chat-row ${role==='user'?'user':'assistant'}`;
    const bubble=document.createElement('div'); bubble.className=`chat-bubble ${role==='user'?'user-bubble':'assistant-bubble'}`;
    row.appendChild(bubble); chatBox.appendChild(row);

    if(role==='assistant' && typing && window.Typed){
      const obs=new MutationObserver(()=>safeScrollToBottom(chatBox));
      obs.observe(bubble,{childList:true,subtree:true,characterData:true});
      new Typed(bubble,{strings:[text],typeSpeed:30,showCursor:false,loop:false,contentType:'html',onComplete:()=>{obs.disconnect();safeScrollToBottom(chatBox);}});
    }else{
      bubble.textContent=text;
    }
    safeScrollToBottom(chatBox);

    if(!skipPersist){
      messages.push({role,content:text});
      messages=trimHistoryClient(messages,MAX_CONTEXT_TOKENS_CLIENT);
      localStorage.setItem("chatHistory",JSON.stringify(messages));
      toggleSuggestions(); // cacher si un message vient d’être ajouté
    }
  }

  function afficherConversation(){
    const box=document.getElementById("chat-box"); if(!box) return;
    box.innerHTML="";
    messages.forEach(m=>appendMessage(m.role,m.content,{skipPersist:true,typing:false}));
    box.scrollTop=box.scrollHeight;
    toggleSuggestions(); // afficher/cacher selon l’état au chargement
  }

  async function envoyerMessage(texte){
    if(!texte || !texte.trim()) return;
    const q=texte.trim();

    toggleSuggestions(); // les cacher si ce n’est pas déjà le cas
    appendMessage('user',q);
    // Tracking : message utilisateur envoyé
    saveEvent('chat_message_sent', null, null, { messageLength: q.length });
    setTyping(true);

    try{
      const res=await fetch("/api/text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
      const data=await res.json();
      const botMsg = data.message || "(pas de réponse)";
      appendMessage('assistant', botMsg, {typing:true});
      // Tracking : réponse du bot
      saveEvent('chat_message_received', null, null, { messageLength: botMsg.length });
    }catch(e){
      console.error(e);
      const errMsg = "Oups, problème de connexion. Réessaye dans quelques secondes.";
      appendMessage('assistant', errMsg,{typing:false});
      // Tracking même en cas d'erreur réseau
      saveEvent('chat_message_received', null, null, { messageLength: errMsg.length });
    }finally{
      setTyping(false);
    }
  }

  // Bouton reset (appelé par onclick sur le HTML)
  window.resetConversation=function(){
    messages=[];
    localStorage.removeItem("chatHistory");
    const box=document.getElementById("chat-box"); if(box) box.innerHTML="";
    toggleSuggestions(); // re-affiche en grille (2 + 1 centré)
  };

  // Brancher contrôles
  (function bindUI(){
    const sendBtn=document.getElementById("chat-send");
    const input=document.getElementById("chat-input");
    if(sendBtn && input){
      sendBtn.addEventListener("click",()=>{ envoyerMessage(input.value); input.value=""; input.focus(); });
      input.addEventListener("keypress",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }});
    }
    document.querySelectorAll('#chat-suggestions .suggestion-bubble').forEach(btn=>{
      const q=btn.dataset.question||btn.textContent.trim();
      btn.addEventListener('click',()=>envoyerMessage(q));
    });
  })();

  // Init
  afficherConversation();
</script>

<script>
function addChatStyles() {
  const style = document.createElement("style");
  style.textContent = `
    /* SCOPÉ AU CHATBOT UNIQUEMENT */
    #home-ia #chat-suggestions .suggestion-bubble {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: rgba(255, 255, 255, 0.18) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border: 1px solid rgba(255, 255, 255, 0.28) !important;
      border-radius: 50px !important;
      padding: 10px 22px !important;
      margin: 6px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      color: rgba(0, 0, 0, 0.85) !important;
      cursor: pointer !important;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.3s ease !important;
      white-space: nowrap !important; /* desktop par défaut */
      text-align: center !important;
    }
    #home-ia #chat-suggestions .suggestion-bubble:hover {
      transform: translateY(-1px) scale(1.04) !important;
      background: rgba(255, 255, 255, 0.28) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08) !important;
    }
    @media (max-width: 768px) {
      #home-ia #chat-suggestions .suggestion-bubble {
        white-space: normal !important;
        max-width: calc(100% - 12px) !important;
      }
    }
  `;
  document.head.appendChild(style);
}
addChatStyles();
</script>
<style>
  #pc-constellation{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none;}
</style>

<script src="nav.js"></script>
<script src="lang.js"></script>
<script src="i18n.js"></script>

<script>
  function showCookies() {
    const content = `
      <div class="space-y-4">
        <h3 class="text-lg font-semibold text-gray-900" data-i18n="footer.legal.cookies.title">Cookies et stockage local</h3>
        <p class="text-gray-700" data-i18n="footer.legal.cookies.text">
          Ce site n’utilise pas de cookies de suivi.<br>
          Seules certaines données nécessaires au fonctionnement (comme la progression dans le test ou le code d’accès aux résultats) sont stockées localement dans le navigateur ou dans notre base de données Supabase.
        </p>
      </div>
    `;
    showModal('<span data-i18n="footer.legal.cookies.title">Cookies et stockage local</span>', content);
  }

  window.showPrivacyPolicy = showPrivacyPolicy;
  window.showTermsOfService = showTermsOfService;
  window.showLegalNotices = showLegalNotices;
  window.showCookies = showCookies;
  window.showSupport = showSupport;
</script>

<script type="module">
  import { supabase } from "./common.js";

  // -------- Utils --------
  const nowIso = () => new Date().toISOString();
  const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile'
    : /Tablet|iPad/i.test(navigator.userAgent) ? 'tablet' : 'desktop';
  const language = (navigator.language || 'en').slice(0,2);
  const tz_offset = -new Date().getTimezoneOffset(); // en minutes (ex: +120 pour CET)
  const viewport = { width: window.innerWidth, height: window.innerHeight };
  const screenInfo = { width: window.screen?.width || 0, height: window.screen?.height || 0 };
  const parseUTM = () => {
    const p = new URLSearchParams(location.search);
    const keys = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term"];
    const obj = {};
    keys.forEach(k => { if (p.get(k)) obj[k] = p.get(k); });
    return Object.keys(obj).length ? obj : null;
  };

  // -------- Déclaration du session_id --------
  let sessionId;
  let seconds = 0; // pour engagement_ms

  // -------- Insertion/Mise à jour sessions --------
  async function upsertSession(firstLoad=false, lastEventName=null) {
    const payload = {
      session_id: sessionId,
      last_activity_at: nowIso(),
      last_page_url: window.location.href,
      user_agent: navigator.userAgent,
      device_type: deviceType,
      language,
      tz_offset,
      viewport,
      screen: screenInfo
    };
    if (firstLoad) {
      payload.first_seen_at = nowIso();
      payload.first_referrer = document.referrer || null;
      payload.first_utm = parseUTM();
      // calcul simple is_returning via localStorage
      const hasVisited = !!localStorage.getItem("pc_has_visited");
      payload.is_returning = hasVisited;
    }
    if (lastEventName) payload.last_event_name = lastEventName;
    // on envoie engagement_ms en ms (overwrite avec la valeur actuelle)
    payload.engagement_ms = seconds * 1000;

    // upsert sur session_id
    try {
      await supabase.from("sessions")
        .upsert([payload], { onConflict: "session_id" });
    } catch (e) {
      console.error("Erreur upsert sessions:", e);
    }
  }

  // -------- Event tracking (écrit events + rafraîchit sessions.last_activity_at) --------
  async function trackEvent(eventName, extraData = {}) {
    try {
      const { error } = await supabase.from("events").insert([{
        session_id: sessionId,
        event_name: eventName,
        event_category: eventName,   // ✅ ajout pour éviter event_category null
        element_selector: extraData.element_selector || null,
        value: extraData.value || null,
        meta: extraData.meta || {},
        page_url: window.location.href,
        referrer: document.referrer,
        user_agent: navigator.userAgent
      }]);
      if (error) console.error("Erreur enregistrement event:", error);
    } catch (err) {
      console.error("Erreur trackEvent:", err);
    } finally {
      upsertSession(false, eventName);
    }
  }

  // -------- Helper pour sauver un event --------
  async function saveEvent(eventCategory, elementSelector = null, value = null, meta = {}) {
    try {
      await supabase.from("events").insert([{
        session_id: sessionId,
        event_name: eventCategory,          // ⚠️ obligatoire en base
        event_category: eventCategory,
        element_selector: elementSelector,
        value,
        meta,
        page_url: window.location.href,
        referrer: document.referrer,
        user_agent: navigator.userAgent
      }]);
    } catch (err) {
      console.error("Erreur enregistrement event:", err);
    } finally {
      upsertSession(false, eventCategory);
    }
  }
  window.saveEvent = saveEvent;

  // ====== Init ======
  (async () => {
    sessionId = localStorage.getItem("session_id") || crypto.randomUUID();
    localStorage.setItem("session_id", sessionId);

    // upsert initial (crée si nouveau, met à jour sinon)
    await upsertSession(true, "page_view");

    // flag visiteur (pour is_returning sur les prochaines visites)
    localStorage.setItem("pc_has_visited", "1");

    // premier event
    trackEvent("page_view");

    // Clicks
    document.addEventListener('click', (e) => {
      let selector = '';
      if (e.target.id) selector = '#' + e.target.id;
      else if (e.target.className) {
        selector = e.target.tagName.toLowerCase() + '.' +
          e.target.className.toString().trim().replace(/\s+/g, '.');
      } else selector = e.target.tagName.toLowerCase();
      saveEvent('Click', selector, null, { element: selector });
    });
  })();

  // -------- Scroll tracking (25%, 50%, 75%, 100%) --------
  let scrollTracked = {25: false, 50: false, 75: false, 100: false};
  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrolled = Math.round((scrollTop / docHeight) * 100);

    [25,50,75,100].forEach(p => {
      if (scrolled >= p && !scrollTracked[p]) {
        scrollTracked[p] = true;
        saveEvent("Scroll", null, p, { percent: p });
      }
    });
  });

  // -------- Temps passé sur la page (heartbeat toutes les 15s) --------
  setInterval(() => {
    seconds += 15;
    // event "Time" + MAJ sessions (last_activity_at + engagement_ms)
    saveEvent("Time", null, seconds, { url: window.location.href });
  }, 15000);

  // -------- Form Submits --------
  document.addEventListener("submit", (e) => {
    let selector = e.target.id ? `#${e.target.id}` : e.target.tagName.toLowerCase();
    saveEvent("FormSubmit", selector, null, { formAction: e.target.action || null });
  });

  // -------- Stats Form Submits --------
  async function loadFormStats() {
    const { data, error } = await supabase
      .from("events")
      .select("occurred_at")
      .eq("event_category", "FormSubmit");

    if (error) {
      console.error("Erreur récupération stats:", error);
      return;
    }

    // Regroupe par jour
    const stats = {};
    data.forEach(ev => {
      const day = new Date(ev.occurred_at).toISOString().split("T")[0];
      stats[day] = (stats[day] || 0) + 1;
    });

    // Affichage dans ton HTML
    const container = document.getElementById("form-stats");
    if (!container) return;

    container.innerHTML = "";
    let total = 0;
    Object.entries(stats)
      .sort((a, b) => b[0].localeCompare(a[0]))
      .forEach(([day, count]) => {
        total += count;
        const p = document.createElement("p");
        p.textContent = `${day} : ${count} formulaire(s)`;
        container.appendChild(p);
      });

    // Ajoute un total en haut
    const totalDiv = document.createElement("div");
    totalDiv.innerHTML = `<strong>Total formulaires soumis : ${total}</strong>`;
    container.prepend(totalDiv);
  }

  // Charge les stats à l'ouverture
  loadFormStats();
</script>


  
</body>
</html>



      
